===== FILE: ./backend/clear-products.js =====
const mongoose = require("mongoose");
const dotenv = require("dotenv");
const Product = require("./models/Product");

// Load env vars
dotenv.config();

// Connect to MongoDB
mongoose
  .connect(process.env.MONGO_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => console.log("MongoDB connected"))
  .catch((err) => console.error("MongoDB connection error:", err));

// Clear all products
const clearAllProducts = async () => {
  try {
    console.log("Đang xóa tất cả sản phẩm...");

    const result = await Product.deleteMany({});

    console.log(`✅ Đã xóa thành công ${result.deletedCount} sản phẩm`);
    console.log("Database đã được làm sạch!");

    process.exit(0);
  } catch (error) {
    console.error(`❌ Lỗi khi xóa sản phẩm: ${error.message}`);
    process.exit(1);
  }
};

// Run the clear function
clearAllProducts();


===== FILE: ./backend/config/db.js =====
const mongoose = require('mongoose');
// const connectDB = async () => {
//     try{
//         await mongoose.connect(process.env.MONGO_URI, {
//             useNewUrlParser: true,
//             useUnifiedTopology: true,
//         });
//         console.log('MongoDB connected successfully');
//     }
//     catch (error) {
//         console.error('MongoDB connection failed:', error.message);
//         process.exit(1); // Exit process with failure
//     }
// }
const connectDB = async () => {
    try {
        await mongoose.connect(process.env.MONGO_URI);
        console.log('MongoDB connected successfully');
    } catch (error) {
        console.error('MongoDB connection failed:', error.message);
        process.exit(1);
    }
}

module.exports = connectDB;
// Usage in server.js

===== FILE: ./backend/config/passport.js =====
const passport = require('passport');
const GoogleStrategy = require('passport-google-oauth20').Strategy;
const FacebookStrategy = require('passport-facebook').Strategy;
const User = require('../models/User');
const dotenv = require('dotenv');
dotenv.config();
// Google OAuth 2.0 Strategy
passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  callbackURL: process.env.GOOGLE_CALLBACK_URL
}, async (accessToken, refreshToken, profile, done) => {
  try {
    // Kiểm tra xem user đã tồn tại chưa
    let existingUser = await User.findOne({ googleId: profile.id });

    if (existingUser) {
      return done(null, existingUser);
    }

    // Kiểm tra email đã được sử dụng chưa
    let emailUser = await User.findOne({ email: profile.emails[0].value });

    if (emailUser) {
      // Nếu email đã tồn tại, liên kết với Google account
      emailUser.googleId = profile.id;
      await emailUser.save();
      return done(null, emailUser);
    }

    // Tạo user mới
    const newUser = new User({
      googleId: profile.id,
      name: profile.displayName,
      email: profile.emails[0].value,
      // Không cần password cho Google OAuth
      //password: 'google_oauth_user', // Placeholder password
      // Tạo random password an toàn hơn
      password: `google_oauth_${Date.now()}_${Math.random().toString(36)}`,
      gender: 'other', // Default value
      profileImage: profile.photos[0]?.value
    });

    await newUser.save();
    done(null, newUser);

  } catch (error) {
    console.error('Google OAuth error:', error);
    done(error, null);
  }
}));

passport.serializeUser((user, done) => {
  done(null, user.id);
});

passport.deserializeUser(async (id, done) => {
  try {
    const user = await User.findById(id);
    done(null, user);
  } catch (error) {
    done(error, null);
  }
});
// Facebook 
passport.use(new FacebookStrategy({
  clientID: process.env.FACEBOOK_APP_ID,
  clientSecret: process.env.FACEBOOK_APP_SECRET,
  callbackURL: process.env.FACEBOOK_CALLBACK_URL,
  profileFields: ['id', 'displayName', 'email', 'photos']
}, async (accessToken, refreshToken, profile, done) => {
  try {
    let existingUser = await User.findOne({ facebookId: profile.id });

    if (existingUser) {
      return done(null, existingUser);
    }

    let emailUser = await User.findOne({ email: profile.emails?.[0]?.value });

    if (emailUser) {
      emailUser.facebookId = profile.id;
      await emailUser.save();
      return done(null, emailUser);
    }

    const newUser = new User({
      facebookId: profile.id,
      name: profile.displayName,
      email: profile.emails?.[0]?.value || `${profile.id}@facebook.com`,
      password: `facebook_oauth_${Date.now()}_${Math.random().toString(36)}`,
      gender: 'other',
      profileImage: profile.photos?.[0]?.value
    });

    await newUser.save();
    done(null, newUser);

  } catch (error) {
    console.error('Facebook OAuth error:', error);
    done(error, null);
  }
}));

passport.serializeUser((user, done) => {
  done(null, user.id);
});

passport.deserializeUser(async (id, done) => {
  try {
    const user = await User.findById(id);
    done(null, user);
  } catch (error) {
    done(error, null);
  }
});

module.exports = passport;

===== FILE: ./backend/data/collections.js =====
// backend/data/collections.js
const collections = [
  {
    id: "summer",
    name: "Summer Collection",
    bannerUrl:
      "https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=600&fit=crop",
    description:
      "Bộ sưu tập mùa hè 2025 mang đến làn gió mới với những thiết kế trẻ trung, năng động và đầy màu sắc, sử dụng chất liệu nhẹ mát, thoáng khí, phù hợp cho mọi hoạt động ngày hè – từ dạo phố, đi biển đến những buổi hẹn hò đầy cảm hứng.",
    categories: ["Áo phông", "Quần short", "Váy", "Áo khoác nhẹ"],
    products: [],
  },
  {
    id: "winter",
    name: "Winter Collection",
    bannerUrl:
      "https://images.unsplash.com/photo-1544966503-7cc4ac7b6201?w=800&h=600&fit=crop",
    description:
      "Bộ sưu tập mùa đông 2025 là sự kết hợp giữa vẻ đẹp hiện đại và cảm giác ấm áp, với những thiết kế dày dặn, phom dáng ôm vừa vặn, gam màu trung tính sang trọng cùng các chất liệu như len, dạ, lông và nỉ cao cấp – mang đến cho bạn phong cách tinh tế và tự tin trong những ngày đông lạnh giá.",
    categories: ["Áo len", "Áo khoác", "Quần jean", "Áo sweater"],
    products: [],
  },
  {
    id: "autumn",
    name: "Autumn Collection",
    bannerUrl:
      "https://images.unsplash.com/photo-1515372039744-b8f02a3ae446?w=800&h=600&fit=crop",
    description:
      "Bộ sưu tập mùa thu 2025 mang đến hơi thở dịu dàng và sâu lắng của thời khắc chuyển mùa, với những thiết kế tinh tế, gam màu ấm áp như nâu đất, cam cháy, be nhạt cùng chất liệu mềm mại, giữ ấm nhẹ nhàng – lý tưởng cho những buổi chiều se lạnh đầy cảm xúc và phong cách.",
    categories: ["Áo sơ mi", "Quần tây", "Áo blazer", "Chân váy"],
    products: [],
  },
  {
    id: "spring",
    name: "Spring Collection",
    bannerUrl:
      "https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=800&h=600&fit=crop",
    description:
      "Bộ sưu tập mùa xuân 2025 tươi mới như những cánh hoa đầu mùa, với sắc màu rực rỡ, thiết kế nhẹ nhàng và thoải mái, mang đến cảm giác tươi trẻ và đầy năng lượng cho những ngày xuân ấm áp.",
    categories: ["Áo phông", "Quần jean", "Váy", "Áo khoác nhẹ"],
    products: [],
  },
  {
    id: "man",
    name: "Đồ Nam",
    bannerUrl:
      "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&h=600&fit=crop",
    description:
      "Bộ sưu tập thời trang nam hiện đại, thanh lịch và mạnh mẽ. Từ áo sơ mi công sở đến trang phục casual cuối tuần, tất cả đều được thiết kế để tôn lên vẻ đẹp và phong cách riêng của phái mạnh.",
    categories: ["Áo sơ mi", "Quần tây", "Áo polo", "Áo khoác"],
    products: [],
  },
  {
    id: "women",
    name: "Đồ Nữ",
    bannerUrl:
      "https://images.unsplash.com/photo-1566479179817-7c3c8c86e2e1?w=800&h=600&fit=crop",
    description:
      "Bộ sưu tập thời trang nữ đa dạng và quyến rũ. Từ những thiết kế nữ tính, thanh lịch đến phong cách hiện đại, cá tính, mỗi món đồ đều được chăm chút để tôn vinh vẻ đẹp của người phụ nữ Việt.",
    categories: ["Váy", "Áo sơ mi", "Quần jean", "Áo blazer"],
    products: [],
  },
];

module.exports = collections;


===== FILE: ./backend/data/dataManager.js =====
// backend/data/dataManager.js
const users = require('./users');
const products = require('./products');
const collections = require('./collections');
const cloudinary = require('cloudinary').v2;
const fs = require('fs');
const path = require('path');

// Cấu hình Cloudinary (nếu sử dụng)
if (process.env.CLOUDINARY_CLOUD_NAME) {
  cloudinary.config({
    cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
    api_key: process.env.CLOUDINARY_API_KEY,
    api_secret: process.env.CLOUDINARY_API_SECRET,
  });
}

class DataManager {
  constructor() {
    this.users = users;
    this.products = products;
    this.collections = collections;
  }

  // ================== USER MANAGEMENT ==================
  getUsers() {
    return this.users;
  }

  createSampleUsers() {
    // Làm sạch dữ liệu users hiện có (xóa _id, id không hợp lệ)
    const cleanedUsers = this.users.map(user => {
      const { _id, id, ...cleanUser } = user; // Xóa _id và id
      return {
        ...cleanUser,
        // Đảm bảo có đầy đủ các trường bắt buộc
        name: cleanUser.name || 'Unknown User',
        email: cleanUser.email || `user${Date.now()}@example.com`,
        password: cleanUser.password || '123456',
        role: cleanUser.role || 'customer'
      };
    });

    // Tạo thêm users mẫu nếu cần
    const additionalUsers = [
      {
        name: "Sample Customer 1",
        email: "customer1@example.com",
        password: "123456",
        role: "customer",
        gender: "male",
        phone: "0901234567",
        address: "123 Nguyen Hue St",
        city: "Ho Chi Minh",
        district: "District 1",
        ward: "Ben Nghe Ward",
        birth: new Date('1995-06-15')
      },
      {
        name: "Sample Customer 2", 
        email: "customer2@example.com",
        password: "123456",
        role: "customer",
        gender: "female",
        phone: "0907654321",
        address: "456 Le Loi St",
        city: "Ho Chi Minh",
        district: "District 3", 
        ward: "Ward 1",
        birth: new Date('1992-08-22')
      }
    ];

    return [...cleanedUsers, ...additionalUsers];
  }

  // ================== COLLECTION MANAGEMENT ==================
  getCollections() {
    return this.collections;
  }

  createSampleCollections() {
    const sampleCollections = [
      {
        id: "summer",
        name: "Summer Collection",
        bannerUrl: "https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=600&fit=crop",
        description: "Bộ sưu tập mùa hè 2025 mang đến làn gió mới với những thiết kế trẻ trung, năng động và đầy màu sắc, sử dụng chất liệu nhẹ mát, thoáng khí, phù hợp cho mọi hoạt động ngày hè.",
        products: []
      },
      {
        id: "winter", 
        name: "Winter Collection",
        bannerUrl: "https://images.unsplash.com/photo-1544966503-7cc4ac7b6201?w=800&h=600&fit=crop",
        description: "Bộ sưu tập mùa đông 2025 là sự kết hợp giữa vẻ đẹp hiện đại và cảm giác ấm áp, với những thiết kế dày dặn, phom dáng ôm vừa vặn.",
        products: []
      },
      {
        id: "autumn",
        name: "Autumn Collection", 
        bannerUrl: "https://images.unsplash.com/photo-1515372039744-b8f02a3ae446?w=800&h=600&fit=crop",
        description: "Bộ sưu tập mùa thu 2025 mang đến hơi thở dịu dàng và sâu lắng của thời khắc chuyển mùa.",
        products: []
      },
      {
        id: "spring",
        name: "Spring Collection",
        bannerUrl: "https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=800&h=600&fit=crop", 
        description: "Bộ sưu tập mùa xuân 2025 tươi mới với sắc màu rực rỡ và thiết kế nhẹ nhàng.",
        products: []
      }
    ];

    return sampleCollections;
  }

  // ================== PRODUCT MANAGEMENT ==================
  getProducts() {
    return this.products;
  }

  // Hàm upload ảnh lên Cloudinary (tùy chọn)
  async uploadImageToCloudinary(imageUrl, folder = 'wukudada-products') {
    try {
      if (!process.env.CLOUDINARY_CLOUD_NAME) {
        console.log('⚠️ Cloudinary chưa được cấu hình, sử dụng URL gốc từ Unsplash');
        return imageUrl;
      }

      console.log(`📤 Đang upload: ${imageUrl}`);
      const result = await cloudinary.uploader.upload(imageUrl, {
        folder: folder,
        public_id: `product_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        overwrite: true,
        resource_type: "image",
        transformation: [
          { width: 500, height: 600, crop: "fill" },
          { quality: "auto", format: "auto" }
        ]
      });

      console.log(`✅ Upload thành công: ${result.secure_url}`);
      return result.secure_url;
    } catch (error) {
      console.error(`❌ Lỗi upload ảnh: ${error.message}`);
      console.log(`🔄 Fallback: sử dụng URL gốc từ Unsplash`);
      return imageUrl; // Fallback về URL gốc từ Unsplash
    }
  }

  // Xử lý ảnh cho products (có thể upload hoặc giữ nguyên)
  async processProductImages(products, uploadToCloudinary = false) {
    console.log(`🔄 Đang xử lý ${products.length} sản phẩm...`);
    
    for (let i = 0; i < products.length; i++) {
      const product = products[i];
      
      if (uploadToCloudinary && product.images && product.images.length > 0) {
        console.log(`📷 Xử lý ảnh cho sản phẩm: ${product.name}`);
        
        for (let j = 0; j < product.images.length; j++) {
          const currentUrl = product.images[j].url;
          product.images[j].url = await this.uploadImageToCloudinary(currentUrl);
          
          // Thêm delay nhỏ để tránh rate limit
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
    }

    return products;
  }

  // Tạo products với ảnh sample từ Unsplash
  createSampleProducts() {
    // Làm sạch dữ liệu products hiện có
    const cleanedProducts = this.products.map(product => {
      const { _id, ...cleanProduct } = product; // Xóa _id để MongoDB tự tạo
      return cleanProduct;
    });

    const sampleProducts = [
      {
        name: "Áo Thun Nam Basic Premium",
        description: "Áo thun nam basic chất liệu cotton cao cấp, form regular fit thoải mái, phù hợp mặc hàng ngày và dạo phố.",
        price: 350000,
        discountPrice: 299000,
        countInStock: 100,
        sku: `AT-NAM-${Date.now()}-001`,
        // sku: `AT-NAM-PREMIUM-${Date.now()}`, 
        category: "Áo phông",
        brand: "Wukudada",
        sizes: ["S", "M", "L", "XL", "XXL"],
        colors: ["Đen", "Trắng", "Xám", "Navy"],
        collection: "summer",
        material: "100% Cotton",
        gender: "Men",
        images: [
          {
            url: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=500&h=600&fit=crop",
            altText: "Áo thun nam basic đen"
          },
          {
            url: "https://images.unsplash.com/photo-1583743814966-8936f37f27bf?w=500&h=600&fit=crop", 
            altText: "Áo thun nam basic trắng"
          }
        ],
        isFeatured: true,
        isPublished: true,
        rating: 4.5,
        numReviews: 125,
        tags: ["basic", "cotton", "nam", "hàng ngày"],
        metaTitle: "Áo Thun Nam Basic Premium - Wukudada",
        metaDescription: "Áo thun nam basic cotton cao cấp, form regular fit thoải mái",
        metaKeywords: ["áo thun nam", "basic", "cotton"],
        dimensions: {
          length: 70,
          width: 52, 
          height: 1,
          weight: 0.25
        }
      },
      {
        name: "Váy Midi Nữ Elegant", 
        description: "Váy midi nữ thiết kế thanh lịch, chất liệu chiffon mềm mại, form A-line tôn dáng, phù hợp dự tiệc.",
        price: 750000,
        discountPrice: 649000,
        countInStock: 50,
        sku: `V-NU-${Date.now()}-002`,
        category: "Váy",
        brand: "Wukudada", 
        sizes: ["XS", "S", "M", "L", "XL"],
        colors: ["Đen", "Navy", "Đỏ đô"],
        collection: "autumn",
        material: "100% Chiffon",
        gender: "Women",
        images: [
          {
            url: "https://images.unsplash.com/photo-1566479179817-7c3c8c86e2e1?w=500&h=600&fit=crop",
            altText: "Váy midi nữ elegant đen"
          }
        ],
        isFeatured: true,
        isPublished: true,
        rating: 4.8,
        numReviews: 89,
        tags: ["váy", "midi", "elegant", "chiffon"],
        metaTitle: "Váy Midi Nữ Elegant - Wukudada",
        metaDescription: "Váy midi nữ chiffon mềm mại, form A-line tôn dáng",
        metaKeywords: ["váy midi", "elegant", "chiffon"],
        dimensions: {
          length: 85,
          width: 45,
          height: 1, 
          weight: 0.3
        }
      },
      {
        name: "Quần Jean Nam Slim Fit",
        description: "Quần jean nam form slim fit, chất liệu denim cao cấp co giãn nhẹ, tôn dáng và thoải mái.",
        price: 850000,
        discountPrice: 749000,
        countInStock: 75,
        sku: `QJ-NAM-${Date.now()}-003`,
        category: "Quần jean", 
        brand: "Wukudada",
        sizes: ["28", "29", "30", "31", "32", "33", "34"],
        colors: ["Xanh đậm", "Đen", "Xanh nhạt"],
        collection: "winter",
        material: "98% Cotton, 2% Spandex",
        gender: "Men",
        images: [
          {
            url: "https://images.unsplash.com/photo-1542272604-787c3835535d?w=500&h=600&fit=crop",
            altText: "Quần jean nam slim fit xanh đậm"
          }
        ],
        isFeatured: false,
        isPublished: true,
        rating: 4.6,
        numReviews: 156,
        tags: ["jean", "slim fit", "nam", "denim"],
        metaTitle: "Quần Jean Nam Slim Fit - Wukudada", 
        metaDescription: "Quần jean nam slim fit denim cao cấp, tôn dáng",
        metaKeywords: ["quần jean nam", "slim fit", "denim"],
        dimensions: {
          length: 105,
          width: 38,
          height: 2,
          weight: 0.6
        }
      }
    ];

    return [...cleanedProducts, ...sampleProducts];
  }

  // ================== MAIN PROCESSING METHODS ==================
  
  // Lấy tất cả dữ liệu đã xử lý
  async getAllData(options = {}) {
    const {
      uploadImages = false,
      includeExistingData = true,
      createSamples = true
    } = options;

    console.log('🚀 DataManager: Bắt đầu xử lý dữ liệu...');

    // Lấy users
    const users = includeExistingData ? this.getUsers() : [];
    const finalUsers = createSamples ? this.createSampleUsers() : users;

    // Lấy collections  
    const collections = includeExistingData ? this.getCollections() : [];
    const finalCollections = createSamples ? this.createSampleCollections() : collections;

    // Lấy và xử lý products
    const products = includeExistingData ? this.getProducts() : [];
    const sampleProducts = createSamples ? this.createSampleProducts() : [];
    const allProducts = [...products, ...sampleProducts];
    
    const finalProducts = await this.processProductImages(allProducts, uploadImages);

    console.log('✅ DataManager: Hoàn thành xử lý dữ liệu');
    console.log(`📊 Thống kê: ${finalUsers.length} users, ${finalCollections.length} collections, ${finalProducts.length} products`);

    return {
      users: finalUsers,
      collections: finalCollections, 
      products: finalProducts
    };
  }

  // Phương thức lưu vào file JSON (backup)
  async saveToFile(data, filename = 'processed-data.json') {
    try {
      const filePath = path.join(__dirname, filename);
      await fs.promises.writeFile(filePath, JSON.stringify(data, null, 2), 'utf8');
      console.log(`💾 Đã lưu dữ liệu vào: ${filePath}`);
    } catch (error) {
      console.error(`❌ Lỗi lưu file: ${error.message}`);
    }
  }
}

module.exports = new DataManager();

===== FILE: ./backend/data/products.js =====
const products = [
  // ========== ÁO PHÔNG NAM ==========
  {
    name: "Áo Thun Nam Basic Cotton",
    description: "Áo thun nam basic từ chất liệu cotton 100% thoáng mát, form regular fit thoải mái, phù hợp mặc hàng ngày.",
    price: 299000,
    discountPrice: 249000,
    countInStock: 50,
    sku: "AT-NAM-BASIC-001",
    category: "Áo phông",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Đen"],
    collection: "summer",
    material: "100% Cotton",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=500&h=600&fit=crop",
        altText: "Áo thun nam đen basic"
      },
      {
        url: "https://images.unsplash.com/photo-1583743814966-8936f37f27bf?w=500&h=600&fit=crop",
        altText: "Áo thun nam đen - góc nghiêng"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.5,
    numReviews: 89,
    tags: ["basic", "cotton", "nam", "hàng ngày"],
    metaTitle: "Áo Thun Nam Basic Cotton - Thoải Mái Hàng Ngày",
    metaDescription: "Áo thun nam basic cotton 100%, form regular fit, màu đen cơ bản, phù hợp mọi phong cách.",
    metaKeywords: ["áo thun nam", "basic", "cotton", "đen"],
    dimensions: {
      length: 70,
      width: 52,
      height: 1,
      weight: 0.2
    }
  },

  // ========== THÊM SẢN PHẨM Summer ==========
  {
    name: "Áo Tank Top Nam Summer",
    description: "Áo tank top nam chất liệu cotton thấm hút mồ hôi, thiết kế đơn giản thoải mái cho mùa hè.",
    price: 199000,
    discountPrice: 169000,
    countInStock: 70,
    sku: "TT-NAM-SUM-016",
    category: "Áo phông",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Trắng"],
    collection: "summer",
    material: "100% Cotton",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1581803118522-7b72a50f7e9f?w=500&h=600&fit=crop",
        altText: "Áo tank top nam trắng"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.3,
    numReviews: 54,
    tags: ["tank top", "summer", "nam", "cotton"],
    metaTitle: "Áo Tank Top Nam Summer - Mát Mẻ Thoải Mái",
    metaDescription: "Áo tank top nam cotton thoáng mát, thiết kế đơn giản cho mùa hè.",
    metaKeywords: ["tank top nam", "summer", "cotton", "trắng"],
    dimensions: {
      length: 65,
      width: 50,
      height: 1,
      weight: 0.15
    }
  },

  {
    name: "Quần Short Nữ Linen Summer",
    description: "Quần short nữ chất liệu linen thoáng mát, form A-line thoải mái, màu pastel dễ thương cho mùa hè.",
    price: 349000,
    discountPrice: 299000,
    countInStock: 45,
    sku: "QS-NU-LIN-017",
    category: "Quần short",
    brand: "Wukudada",
    sizes: ["XS", "S", "M", "L", "XL"],
    colors: ["Pastel"],
    collection: "summer",
    material: "100% Linen",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1594633312681-425c7b97ccd1?w=500&h=600&fit=crop",
        altText: "Quần short nữ linen pastel"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.6,
    numReviews: 78,
    tags: ["short", "linen", "nữ", "summer"],
    metaTitle: "Quần Short Nữ Linen - Mát Mẻ Mùa Hè",
    metaDescription: "Quần short nữ linen thoáng mát, form A-line thoải mái cho mùa hè.",
    metaKeywords: ["quần short nữ", "linen", "summer", "pastel"],
    dimensions: {
      length: 38,
      width: 34,
      height: 2,
      weight: 0.2
    }
  },

  // ========== THÊM SẢN PHẨM WINTER COLLECTION ==========
  {
    name: "Áo Len Nam Turtleneck",
    description: "Áo len nam cổ lọ ấm áp, chất liệu wool blend cao cấp, thiết kế sang trọng cho mùa đông.",
    price: 899000,
    discountPrice: 799000,
    countInStock: 25,
    sku: "AL-NAM-TN-018",
    category: "Áo khoác",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Xám đậm"],
    collection: "winter",
    material: "70% Wool, 30% Acrylic",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1617127365659-c47fa864d8bc?w=500&h=600&fit=crop",
        altText: "Áo len nam turtleneck xám đậm"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.8,
    numReviews: 67,
    tags: ["len", "turtleneck", "nam", "winter"],
    metaTitle: "Áo Len Nam Turtleneck - Ấm Áp Mùa Đông",
    metaDescription: "Áo len nam cổ lọ wool blend, thiết kế sang trọng cho mùa đông.",
    metaKeywords: ["áo len nam", "turtleneck", "wool", "winter"],
    dimensions: {
      length: 68,
      width: 56,
      height: 3,
      weight: 0.45
    }
  },

  // ========== THÊM SẢN PHẨM AUTUMN COLLECTION ==========
  {
    name: "Áo Cardigan Nữ Autumn",
    description: "Áo cardigan nữ mềm mại, màu nâu đất ấm áp, phù hợp layering cho mùa thu se lạnh.",
    price: 699000,
    discountPrice: 599000,
    countInStock: 30,
    sku: "AC-NU-AUT-019",
    category: "Áo khoác",
    brand: "Wukudada",
    sizes: ["XS", "S", "M", "L", "XL"],
    colors: ["Nâu đất"],
    collection: "autumn",
    material: "60% Acrylic, 40% Cotton",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1544966503-7cc4ac7b6201?w=500&h=600&fit=crop",
        altText: "Áo cardigan nữ nâu đất"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.7,
    numReviews: 89,
    tags: ["cardigan", "nữ", "autumn", "layering"],
    metaTitle: "Áo Cardigan Nữ Autumn - Ấm Áp Mùa Thu",
    metaDescription: "Áo cardigan nữ mềm mại, màu nâu đất cho mùa thu se lạnh.",
    metaKeywords: ["cardigan nữ", "autumn", "nâu đất", "layering"],
    dimensions: {
      length: 65,
      width: 52,
      height: 2,
      weight: 0.4
    }
  },
  {
    name: "Áo Thun Nam Polo Pique",
    description: "Áo polo nam chất liệu pique cao cấp, có cổ bẻ và túi ngực, thiết kế lịch sự phù hợp đi làm.",
    price: 449000,
    discountPrice: 399000,
    countInStock: 35,
    sku: "AT-NAM-POLO-002",
    category: "Áo phông",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Trắng"],
    collection: "winter",
    material: "Pique Cotton",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1594938328870-28be026b5a06?w=500&h=600&fit=crop",
        altText: "Áo polo nam trắng"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.3,
    numReviews: 45,
    tags: ["polo", "formal", "nam", "công sở"],
    metaTitle: "Áo Polo Nam Pique - Lịch Sự Công Sở",
    metaDescription: "Áo polo nam chất liệu pique cao cấp, thiết kế lịch sự cho môi trường công sở.",
    metaKeywords: ["áo polo nam", "pique", "công sở", "trắng"],
    dimensions: {
      length: 72,
      width: 54,
      height: 1,
      weight: 0.25
    }
  },

  // ========== ÁO PHÔNG NỮ ==========
  {
    name: "Áo Thun Nữ Crop Top",
    description: "Áo thun nữ form crop top trendy, chất liệu cotton pha spandex co giãn nhẹ, phù hợp phối với quần high waist.",
    price: 249000,
    discountPrice: 199000,
    countInStock: 60,
    sku: "AT-NU-CROP-003",
    category: "Áo phông",
    brand: "Wukudada",
    sizes: ["XS", "S", "M", "L", "XL"],
    colors: ["Hồng"],
    collection: "autumn",
    material: "95% Cotton, 5% Spandex",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1618354691373-d851c5c3a990?w=500&h=600&fit=crop",
        altText: "Áo crop top nữ màu hồng"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.7,
    numReviews: 76,
    tags: ["crop top", "trendy", "nữ", "thời trang"],
    metaTitle: "Áo Crop Top Nữ - Phong Cách Trẻ Trung",
    metaDescription: "Áo crop top nữ cotton co giãn, thiết kế trendy cho phong cách trẻ trung, năng động.",
    metaKeywords: ["crop top nữ", "cotton", "trendy", "hồng"],
    dimensions: {
      length: 45,
      width: 40,
      height: 1,
      weight: 0.15
    }
  },

  // ========== QUẦN JEAN NAM ==========
  {
    name: "Quần Jean Nam Slim Fit",
    description: "Quần jean nam form slim fit, chất liệu denim cao cấp co giãn nhẹ, tôn dáng và thoải mái khi vận động.",
    price: 699000,
    discountPrice: 599000,
    countInStock: 40,
    sku: "QJ-NAM-SLIM-004",
    category: "Quần jean",
    brand: "Wukudada",
    sizes: ["28", "29", "30", "31", "32", "33", "34"],
    colors: ["Xanh đậm"],
    collection: "man",
    material: "98% Cotton, 2% Spandex",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1542272604-787c3835535d?w=500&h=600&fit=crop",
        altText: "Quần jean nam slim fit xanh đậm"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.6,
    numReviews: 92,
    tags: ["jean", "slim fit", "nam", "denim"],
    metaTitle: "Quần Jean Nam Slim Fit - Phong Cách Hiện Đại",
    metaDescription: "Quần jean nam slim fit chất lượng cao, form chuẩn tôn dáng, phù hợp mọi phong cách.",
    metaKeywords: ["quần jean nam", "slim fit", "denim", "xanh đậm"],
    dimensions: {
      length: 100,
      width: 35,
      height: 2,
      weight: 0.6
    }
  },

  // ========== QUẦN JEAN NỮ ==========
  {
    name: "Quần Jean Nữ High Waist",
    description: "Quần jean nữ cạp cao tôn dáng, form skinny ôm vừa vặn, phù hợp với mọi vóc dáng và độ tuổi.",
    price: 649000,
    discountPrice: 549000,
    countInStock: 45,
    sku: "QJ-NU-HIGH-005",
    category: "Quần jean",
    brand: "Wukudada",
    sizes: ["25", "26", "27", "28", "29", "30", "31"],
    colors: ["Xanh nhạt"],
    collection: "feminine",
    material: "92% Cotton, 6% Polyester, 2% Elastane",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1551048632-d6b8ce3d07d1?w=500&h=600&fit=crop",
        altText: "Quần jean nữ high waist xanh nhạt"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.8,
    numReviews: 134,
    tags: ["jean", "high waist", "nữ", "skinny"],
    metaTitle: "Quần Jean Nữ High Waist - Tôn Dáng Hoàn Hảo",
    metaDescription: "Quần jean nữ cạp cao skinny fit, tôn dáng tuyệt đối cho phái đẹp.",
    metaKeywords: ["quần jean nữ", "high waist", "skinny", "xanh nhạt"],
    dimensions: {
      length: 95,
      width: 32,
      height: 2,
      weight: 0.5
    }
  },

  // ========== ÁO KHOÁC NAM ==========
  {
    name: "Áo Khoác Bomber Nam",
    description: "Áo khoác bomber nam phong cách streetwear, chất liệu polyester chống gió nhẹ, thiết kế năng động.",
    price: 899000,
    discountPrice: 749000,
    countInStock: 25,
    sku: "AK-NAM-BOMBER-006",
    category: "Áo khoác",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Đen"],
    collection: "street",
    material: "100% Polyester",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1551028719-00167b16eac5?w=500&h=600&fit=crop",
        altText: "Áo khoác bomber nam đen"
      }
    ],
    isFeatured: false,
    isPublished: true,
    rating: 4.4,
    numReviews: 58,
    tags: ["bomber", "streetwear", "nam", "khoác"],
    metaTitle: "Áo Khoác Bomber Nam - Phong Cách Streetwear",
    metaDescription: "Áo khoác bomber nam chất liệu cao cấp, thiết kế streetwear hiện đại.",
    metaKeywords: ["áo khoác bomber", "streetwear", "nam", "đen"],
    dimensions: {
      length: 65,
      width: 58,
      height: 3,
      weight: 0.4
    }
  },

  // ========== ÁO KHOÁC NỮ ==========
  {
    name: "Áo Blazer Nữ Công Sở",
    description: "Áo blazer nữ thiết kế thanh lịch cho môi trường công sở, chất liệu polyester pha viscose mềm mại.",
    price: 1299000,
    discountPrice: 1099000,
    countInStock: 20,
    sku: "AK-NU-BLAZER-007",
    category: "Áo khoác",
    brand: "Wukudada",
    sizes: ["XS", "S", "M", "L", "XL"],
    colors: ["Xám"],
    collection: "office",
    material: "70% Polyester, 30% Viscose",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1594633312681-425c7b97ccd1?w=500&h=600&fit=crop",
        altText: "Áo blazer nữ xám công sở"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.7,
    numReviews: 41,
    tags: ["blazer", "công sở", "nữ", "formal"],
    metaTitle: "Áo Blazer Nữ Công Sở - Thanh Lịch Chuyên Nghiệp",
    metaDescription: "Áo blazer nữ thiết kế thanh lịch, chất liệu cao cấp cho môi trường công sở.",
    metaKeywords: ["áo blazer nữ", "công sở", "thanh lịch", "xám"],
    dimensions: {
      length: 60,
      width: 48,
      height: 2,
      weight: 0.35
    }
  },

  // ========== VÁY NỮ ==========
  {
    name: "Váy Midi Nữ A-Line",
    description: "Váy midi nữ form A-line thanh lịch, chất liệu chiffon nhẹ nhàng, phù hợp dự tiệc và đi làm.",
    price: 799000,
    discountPrice: 649000,
    countInStock: 30,
    sku: "V-NU-MIDI-008",
    category: "Váy",
    brand: "Wukudada",
    sizes: ["XS", "S", "M", "L", "XL"],
    colors: ["Navy"],
    collection: "elegant",
    material: "100% Chiffon",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1595777457583-95e059d581b8?w=500&h=600&fit=crop",
        altText: "Váy midi nữ A-line navy"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.9,
    numReviews: 67,
    tags: ["váy", "midi", "nữ", "elegant"],
    metaTitle: "Váy Midi Nữ A-Line - Thanh Lịch Đa Dụng",
    metaDescription: "Váy midi nữ form A-line chất liệu chiffon, thiết kế thanh lịch phù hợp nhiều dịp.",
    metaKeywords: ["váy midi nữ", "A-line", "chiffon", "navy"],
    dimensions: {
      length: 85,
      width: 45,
      height: 1,
      weight: 0.25
    }
  },

  // ========== QUẦN SHORT NAM ==========
  {
    name: "Quần Short Nam Kaki",
    description: "Quần short nam chất liệu kaki thoáng mát, form regular fit thoải mái, phù hợp mùa hè và dạo phố.",
    price: 399000,
    discountPrice: 349000,
    countInStock: 55,
    sku: "QS-NAM-KAKI-009",
    category: "Quần short",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Be"],
    collection: "summer",
    material: "100% Cotton Kaki",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1591195853828-11db59a44f6b?w=500&h=600&fit=crop",
        altText: "Quần short nam kaki màu be"
      }
    ],
    isFeatured: false,
    isPublished: true,
    rating: 4.2,
    numReviews: 73,
    tags: ["short", "kaki", "nam", "summer"],
    metaTitle: "Quần Short Nam Kaki - Thoải Mái Mùa Hè",
    metaDescription: "Quần short nam kaki thoáng mát, thiết kế đơn giản phù hợp mọi hoạt động.",
    metaKeywords: ["quần short nam", "kaki", "mùa hè", "be"],
    dimensions: {
      length: 50,
      width: 35,
      height: 2,
      weight: 0.3
    }
  },

  // ========== QUẦN SHORT NỮ ==========
  {
    name: "Quần Short Nữ Denim",
    description: "Quần short nữ chất liệu denim wash nhẹ, form high waist trendy, phối cùng áo crop top rất hợp.",
    price: 449000,
    discountPrice: 399000,
    countInStock: 40,
    sku: "QS-NU-DENIM-010",
    category: "Quần short",
    brand: "Wukudada",
    sizes: ["25", "26", "27", "28", "29", "30"],
    colors: ["Xanh wash"],
    collection: "casual",
    material: "98% Cotton, 2% Elastane",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1594633312681-425c7b97ccd1?w=500&h=600&fit=crop",
        altText: "Quần short nữ denim xanh wash"
      }
    ],
    isFeatured: false,
    isPublished: true,
    rating: 4.5,
    numReviews: 86,
    tags: ["short", "denim", "nữ", "casual"],
    metaTitle: "Quần Short Nữ Denim - Phong Cách Casual",
    metaDescription: "Quần short nữ denim high waist, thiết kế trendy cho phong cách casual.",
    metaKeywords: ["quần short nữ", "denim", "high waist", "xanh"],
    dimensions: {
      length: 35,
      width: 32,
      height: 2,
      weight: 0.25
    }
  },

  // ========== ÁO SƠ MI NAM ==========
  {
    name: "Áo Sơ Mi Nam Công Sở",
    description: "Áo sơ mi nam công sở chất liệu cotton cao cấp, form slim fit lịch lãm, màu trắng cơ bản dễ phối đồ.",
    price: 599000,
    discountPrice: 499000,
    countInStock: 35,
    sku: "ASM-NAM-CS-011",
    category: "Áo sơ mi",
    brand: "Wukudada",
    sizes: ["S", "M", "L", "XL", "XXL"],
    colors: ["Trắng"],
    collection: "business",
    material: "100% Cotton",
    gender: "Men",
    images: [
      {
        url: "https://images.unsplash.com/photo-1602810318383-e386cc2a3ccf?w=500&h=600&fit=crop",
        altText: "Áo sơ mi nam trắng công sở"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.6,
    numReviews: 95,
    tags: ["sơ mi", "công sở", "nam", "business"],
    metaTitle: "Áo Sơ Mi Nam Công Sở - Lịch Lãm Chuyên Nghiệp",
    metaDescription: "Áo sơ mi nam cotton cao cấp, form slim fit lịch lãm cho môi trường công sở.",
    metaKeywords: ["áo sơ mi nam", "công sở", "cotton", "trắng"],
    dimensions: {
      length: 75,
      width: 55,
      height: 1,
      weight: 0.3
    }
  },

  // ========== ÁO SƠ MI NỮ ==========
  {
    name: "Áo Sơ Mi Nữ Oversize",
    description: "Áo sơ mi nữ form oversize trendy, chất liệu cotton mềm mại, có thể mặc như áo khoác ngoài.",
    price: 549000,
    discountPrice: 459000,
    countInStock: 42,
    sku: "ASM-NU-OS-012",
    category: "Áo sơ mi",
    brand: "Wukudada",
    sizes: ["XS", "S", "M", "L", "XL"],
    colors: ["Xanh pastel"],
    collection: "trendy",
    material: "100% Cotton",
    gender: "Women",
    images: [
      {
        url: "https://images.unsplash.com/photo-1551698618-1dfe5d97d256?w=500&h=600&fit=crop",
        altText: "Áo sơ mi nữ oversize xanh pastel"
      }
    ],
    isFeatured: false,
    isPublished: true,
    rating: 4.4,
    numReviews: 52,
    tags: ["sơ mi", "oversize", "nữ", "trendy"],
    metaTitle: "Áo Sơ Mi Nữ Oversize - Phong Cách Hiện Đại",
    metaDescription: "Áo sơ mi nữ oversize cotton, thiết kế hiện đại cho phong cách trẻ trung.",
    metaKeywords: ["áo sơ mi nữ", "oversize", "cotton", "xanh pastel"],
    dimensions: {
      length: 70,
      width: 60,
      height: 1,
      weight: 0.28
    }
  },

  // ========== QUẦN TÂY NAM ==========
  {
    name: "Quần Tây Nam Slim Fit",
    description: "Quần tây nam form slim fit lịch lãm, chất liệu wool pha polyester, phù hợp môi trường công sở và sự kiện.",
    price: 899000,
    discountPrice: 749000,
    countInStock: 28,
    sku: "QT-NAM-SLIM-014",
    category: "Quần tây",
    brand: "Wukudada",
    sizes: ["28", "29", "30", "31", "32", "33", "34"],
    colors: ["Đen"],
    collection: "formal",
    material: "65% Wool, 35% Polyester",
    gender: "Men",
    images: [
      {
        url: "https://th.bing.com/th/id/OIP.rZ6xm0lw1fGWRYH6wFv30QAAAA?r=0&w=364&h=364&rs=1&pid=ImgDetMain&cb=idpwebpc1",
        altText: "Quần tây nam slim fit đen"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.7,
    numReviews: 63,
    tags: ["quần tây", "slim fit", "nam", "formal"],
    metaTitle: "Quần Tây Nam Slim Fit - Lịch Lãm Đẳng Cấp",
    metaDescription: "Quần tây nam slim fit chất liệu wool cao cấp, thiết kế lịch lãm cho môi trường công sở.",
    metaKeywords: ["quần tây nam", "slim fit", "wool", "đen"],
    dimensions: {
      length: 105,
      width: 38,
      height: 2,
      weight: 0.7
    }
  },

  // ========== ÁO THUN TRẺ EM ==========
  {
    name: "Áo Thun Trẻ Em Hoạt Hình",
    description: "Áo thun trẻ em in hoạt hình dễ thương, chất liệu cotton organic an toàn cho da bé, màu sắc tươi vui.",
    price: 199000,
    discountPrice: 149000,
    countInStock: 80,
    sku: "AT-TE-HH-014",
    category: "Áo phông",
    brand: "Wukudada Kids",
    sizes: ["2-3T", "4-5T", "6-7T", "8-9T", "10-11T"],
    colors: ["Vàng"],
    collection: "kids",
    material: "100% Organic Cotton",
    gender: "unisex",
    images: [
      {
        url: "https://images.unsplash.com/photo-1503944583220-79d8926ad1ef?w=500&h=600&fit=crop",
        altText: "Áo thun trẻ em hoạt hình vàng"
      }
    ],
    isFeatured: true,
    isPublished: true,
    rating: 4.8,
    numReviews: 127,
    tags: ["trẻ em", "hoạt hình", "organic", "kids"],
    metaTitle: "Áo Thun Trẻ Em Hoạt Hình - An Toàn Cho Bé",
    metaDescription: "Áo thun trẻ em cotton organic, in hoạt hình dễ thương, an toàn cho làn da nhạy cảm của bé.",
    metaKeywords: ["áo thun trẻ em", "organic cotton", "hoạt hình", "vàng"],
    dimensions: {
      length: 45,
      width: 35,
      height: 1,
      weight: 0.12
    }
  },

  // ========== QUẦN JEAN TRẺ EM ==========
  {
    name: "Quần Jean Trẻ Em Straight",
    description: "Quần jean trẻ em form straight thoải mái, chất liệu denim mềm mại không gây khó chịu khi vận động.",
    price: 349000,
    discountPrice: 299000,
    countInStock: 45,
    sku: "QJ-TE-STR-015",
    category: "Quần jean",
    brand: "Wukudada Kids",
    sizes: ["2-3T", "4-5T", "6-7T", "8-9T", "10-11T"],
    colors: ["Xanh nhạt"],
    collection: "kids-casual",
    material: "98% Cotton, 2% Elastane",
    gender: "unisex",
    images: [
      {
        url: "https://images.unsplash.com/photo-1519238263530-99bdd11df2ea?w=500&h=600&fit=crop",
        altText: "Quần jean trẻ em straight xanh nhạt"
      }
    ],
    isFeatured: false,
    isPublished: true,
    rating: 4.5,
    numReviews: 89,
    tags: ["trẻ em", "jean", "straight", "kids"],
    metaTitle: "Quần Jean Trẻ Em Straight - Thoải Mái Vận Động",
    metaDescription: "Quần jean trẻ em denim mềm mại, form straight thoải mái cho bé hoạt động.",
    metaKeywords: ["quần jean trẻ em", "straight", "denim", "xanh nhạt"],
    dimensions: {
      length: 70,
      width: 28,
      height: 2,
      weight: 0.35
    }
  }
];

module.exports = products;

===== FILE: ./backend/data/users.js =====
// backend/data/users.js
const users = [
    {
        name: 'John Doe Admin',
        email: 'john@example.com',
        password: 'admin123',
        role: 'admin',
        gender: 'male',
        phone: '1234567890',
        address: '123 Admin St',
        city: 'Admin City',
        district: 'Admin District',
        ward: 'Admin Ward',
        birth: new Date('1985-01-15')
    },
    {
        name: 'Jane Smith Customer',
        email: 'jane@example.com',
        password: 'user123',
        role: 'customer',
        gender: 'female',
        phone: '0987654321',
        address: '456 User St',
        city: 'User City',
        district: 'User District', 
        ward: 'User Ward',
        birth: new Date('1990-05-20')
    },
    {
        name: 'Mike Johnson',
        email: 'mike@example.com',
        password: 'mike123',
        role: 'customer',
        gender: 'male',
        phone: '0912345678',
        address: '789 Customer St',
        city: 'Ho Chi Minh',
        district: 'District 1',
        ward: 'Ben Nghe Ward',
        birth: new Date('1988-03-10')
    }
];

module.exports = users;

===== FILE: ./backend/debug-cart-merge.js =====
// File: debug-cart-merge.js
// Script để test từng bước và debug lỗi cart merge

const axios = require('axios');

// Cấu hình base URL
const BASE_URL = 'http://localhost:9000/api'; // Thay đổi theo port của bạn

// Biến lưu trữ dữ liệu test
let adminToken = '';
let guestId = '';
let productId = '';
let testUserId = '';

// Helper function để log response
const logResponse = (step, response) => {
    console.log(`\n=== ${step} ===`);
    console.log('Status:', response.status);
    console.log('Data:', JSON.stringify(response.data, null, 2));
};

// Helper function để log error
const logError = (step, error) => {
    console.log(`\n❌ ${step} - ERROR ===`);
    if (error.response) {
        console.log('Status:', error.response.status);
        console.log('Error:', JSON.stringify(error.response.data, null, 2));
    } else {
        console.log('Error:', error.message);
    }
};

// Step 1: Login admin để lấy token
const loginAdmin = async () => {
    try {
        const response = await axios.post(`${BASE_URL}/users/login`, {
            email: 'admin@example.com',
            password: '123456'
        });
        
        adminToken = response.data.token;
        logResponse('Step 1: Login Admin', response);
        return true;
    } catch (error) {
        logError('Step 1: Login Admin', error);
        return false;
    }
};

// Step 2: Lấy danh sách products
const getProducts = async () => {
    try {
        const response = await axios.get(`${BASE_URL}/products?limit=1`);
        
        if (response.data.products && response.data.products.length > 0) {
            productId = response.data.products[0]._id;
            logResponse('Step 2: Get Products', response);
            console.log('Selected Product ID:', productId);
            return true;
        } else {
            console.log('❌ No products found');
            return false;
        }
    } catch (error) {
        logError('Step 2: Get Products', error);
        return false;
    }
};

// Step 3: Tạo guest cart
const createGuestCart = async () => {
    try {
        // Tạo guestId ngẫu nhiên
        guestId = `guest_${Date.now()}`;
        
        const response = await axios.post(`${BASE_URL}/cart`, {
            productId: productId,
            quantity: 2,
            size: 'M',
            color: 'Red',
            guestId: guestId
        });
        
        logResponse('Step 3: Create Guest Cart', response);
        console.log('Guest ID:', guestId);
        return true;
    } catch (error) {
        logError('Step 3: Create Guest Cart', error);
        return false;
    }
};

// Step 4: Kiểm tra guest cart
const checkGuestCart = async () => {
    try {
        const response = await axios.get(`${BASE_URL}/cart?guestId=${guestId}`);
        logResponse('Step 4: Check Guest Cart', response);
        return true;
    } catch (error) {
        logError('Step 4: Check Guest Cart', error);
        return false;
    }
};

// Step 5: Tạo user mới để test merge
const createTestUser = async () => {
    try {
        const testEmail = `testuser_${Date.now()}@example.com`;
        const response = await axios.post(`${BASE_URL}/users/register`, {
            name: 'Test User',
            email: testEmail,
            password: '123456'
        });
        
        testUserId = response.data.user.id;
        logResponse('Step 5: Create Test User', response);
        return response.data.token;
    } catch (error) {
        logError('Step 5: Create Test User', error);
        return null;
    }
};

// Step 6: Test merge cart
const testMergeCart = async (userToken) => {
    try {
        console.log('\n=== Step 6: Test Merge Cart ===');
        console.log('Using token:', userToken);
        console.log('Guest ID:', guestId);
        
        const response = await axios.post(`${BASE_URL}/cart/merge`, 
            {
                guestId: guestId
            },
            {
                headers: {
                    'Authorization': `Bearer ${userToken}`,
                    'Content-Type': 'application/json'
                }
            }
        );
        
        logResponse('Step 6: Merge Cart SUCCESS', response);
        return true;
    } catch (error) {
        logError('Step 6: Merge Cart', error);
        return false;
    }
};

// Step 7: Kiểm tra user cart sau khi merge
const checkUserCart = async (userToken) => {
    try {
        const response = await axios.get(`${BASE_URL}/cart?userId=${testUserId}`, {
            headers: {
                'Authorization': `Bearer ${userToken}`
            }
        });
        logResponse('Step 7: Check User Cart After Merge', response);
        return true;
    } catch (error) {
        logError('Step 7: Check User Cart After Merge', error);
        return false;
    }
};

// Main test function
const runTest = async () => {
    console.log('🚀 Starting Cart Merge Debug Test...\n');
    
    // Step 1: Login admin
    if (!(await loginAdmin())) {
        console.log('❌ Test stopped: Cannot login admin');
        return;
    }
    
    // Step 2: Get products
    if (!(await getProducts())) {
        console.log('❌ Test stopped: Cannot get products');
        return;
    }
    
    // Step 3: Create guest cart
    if (!(await createGuestCart())) {
        console.log('❌ Test stopped: Cannot create guest cart');
        return;
    }
    
    // Step 4: Check guest cart
    if (!(await checkGuestCart())) {
        console.log('❌ Test stopped: Cannot check guest cart');
        return;
    }
    
    // Step 5: Create test user
    const userToken = await createTestUser();
    if (!userToken) {
        console.log('❌ Test stopped: Cannot create test user');
        return;
    }
    
    // Step 6: Test merge cart
    if (!(await testMergeCart(userToken))) {
        console.log('❌ Merge failed - checking details...');
        
        // Debug thêm: kiểm tra guest cart có tồn tại không
        console.log('\n🔍 Debug: Checking if guest cart still exists...');
        await checkGuestCart();
        
        return;
    }
    
    // Step 7: Check final result
    await checkUserCart(userToken);
    
    console.log('\n✅ All tests completed!');
};

// Chạy test
runTest().catch(console.error);

/* 
Cách chạy script này:
1. npm install axios (nếu chưa có)
2. node debug-cart-merge.js

Script này sẽ:
- Tự động test từng bước
- Hiển thị chi tiết response/error ở mỗi bước
- Giúp xác định chính xác lỗi ở đâu
*/

===== FILE: ./backend/env.txt =====
# Server
PORT=9000
# Database
MONGO_URI=mongodb+srv://:@cluster0..mongodb.net/Wukudada?retryWrites=true&w=majority&appName=Cluster0
# JWT openssl rand -hex 64
JWT_SECRET=
# Google OAuth
GOOGLE_CLIENT_ID=-.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX--
GOOGLE_CALLBACK_URL=/api/auth/google/callback
# Session openssl rand -base64 64
SESSION_SECRET=/==
# Cloudinary
CLOUDINARY_CLOUD_NAME=
CLOUDINARY_API_KEY=
CLOUDINARY_API_SECRET=
FRONTEND_URL=http://localhost:5173
# NODE_ENV=development
# facebook
FACEBOOK_APP_ID=
FACEBOOK_APP_SECRET=
FACEBOOK_CALLBACK_URL=http://localhost:9000/api/auth/facebook/callback


# Cookie settings
COOKIE_MAX_AGE=604800000  # 7 days in milliseconds
COOKIE_DOMAIN=localhost   # Use your domain in production

# Rate limiting
API_RATE_LIMIT=5
API_RATE_WINDOW=900000    # 15 minutes in milliseconds

===== FILE: ./backend/middleware/authMiddleware.js =====
const jwt = require("jsonwebtoken");
const User = require("../models/User");

//Middleware to check if user is authenticated 
const authMiddleware = async (req, res, next) => {
  try {
    // Ưu tiên lấy từ cookie, fallback về header
    let token = req.cookies?.authToken || req.headers.authorization?.split(" ")[1];

    if (!token) {
      return res.status(401).json({ message: "No token provided" });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET || "your_jwt_secret_key");

    const user = await User.findById(decoded.id).select("-password");

    if (!user) {
      return res.status(404).json({ message: "User not found" });
    }

    req.user = user;
    next();
  } catch (error) {
    console.error(error);
    if (error.name === "TokenExpiredError") {
      // Clear expired cookie
      res.clearCookie('authToken');
      return res.status(401).json({ message: "Token expired" });
    }
    return res.status(401).json({ message: "Invalid token" });
  }
};

// Middleware to check if user is an admin
const isAdmin = (req, res, next) => {
  if (req.user && req.user.role === 'admin') {
    next();
  } else {
    return res.status(403).json({ message: "Access denied. Admin access required" });
  }
};

// Chỉ export một lần ở cuối file
module.exports = { authMiddleware, isAdmin };

===== FILE: ./backend/middleware/errorHandler.js =====
// middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
    let error = { ...err };
    error.message = err.message;

    // Log to console for dev
    console.error(err);

    // Mongoose bad ObjectId
    if (err.name === 'CastError') {
        const message = 'Resource not found';
        error = { message, statusCode: 404 };
    }

    // Mongoose duplicate key
    if (err.code === 11000) {
        const message = 'Duplicate field value entered';
        error = { message, statusCode: 400 };
    }

    // Mongoose validation error
    if (err.name === 'ValidationError') {
        const message = Object.values(err.errors).map(val => val.message).join(', ');
        error = { message, statusCode: 400 };
    }

    // JWT errors
    if (err.name === 'JsonWebTokenError') {
        const message = 'Invalid token';
        error = { message, statusCode: 401 };
    }

    if (err.name === 'TokenExpiredError') {
        const message = 'Token expired';
        error = { message, statusCode: 401 };
    }

    res.status(error.statusCode || 500).json({
        success: false,
        message: error.message || 'Server Error',
        ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
    });
};

// Async error handler wrapper
const asyncHandler = fn => (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
};

module.exports = { errorHandler, asyncHandler };

===== FILE: ./backend/models/Cart.js =====
const mongoose = require('mongoose');

const cartItemSchema = new mongoose.Schema({
    productId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Product',
        required: true
    },
    name: {
        type: String,
        required: true
    },
    image: {
        type: String,
        required: true
    },
    price: {
        type: Number,
        required: true,
        min: 0
    },
    size: {
        type: String,
        required: true
    },
    color: {
        type: {
            name: {
                type: String,
                required: true
            },
            code: {
                type: String,
                required: true
            }
        },
        required: true
    },
    quantity: {
        type: Number,
        default: 1,
        min: 1,
        required: true
    },
}, { _id: false });

const cartSchema = new mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        default: null
    },
    guestId: {
        type: String,
        default: null
    },
    products: {
        type: [cartItemSchema],
        default: [],
        validate: {
            validator: function (products) {
                return products.length >= 0;
            },
            message: 'Products array cannot be negative length'
        }
    },
    totalPrice: {
        type: Number,
        default: 0,
        min: 0,
        required: true
    },
}, {
    timestamps: true,
    // Đảm bảo ít nhất có user hoặc guestId
    validate: {
        validator: function () {
            return this.user || this.guestId;
        },
        message: 'Either user or guestId must be provided'
    }
});

// Index để tối ưu performance
cartSchema.index({ user: 1 });
cartSchema.index({ guestId: 1 });
cartSchema.index({ user: 1, guestId: 1 });

// Pre-save middleware để tính toán totalPrice
cartSchema.pre('save', function (next) {
    if (this.products && this.products.length > 0) {
        this.totalPrice = this.products.reduce((total, item) => {
            return total + (item.price * item.quantity);
        }, 0);
    } else {
        this.totalPrice = 0;
    }
    next();
});

// Để tránh lỗi OverwriteModelError khi require model nhiều lần,
// hãy kiểm tra model đã được khai báo chưa trước khi khai báo mới.
let Cart;
try {
    Cart = mongoose.model('Cart');
} catch (e) {
    Cart = mongoose.model('Cart', cartSchema);
}
module.exports = Cart;

===== FILE: ./backend/models/Checkout.js =====
const mongoose = require('mongoose');

const checkoutItemSchema = new mongoose.Schema({
    productId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Product',
        required: true
    },
    name: {
        type: String,
        required: true
    },
    image: {
        type: String,
        required: true
    },
    price: {
        type: Number,
        required: true
    },
    size: {
        type: String
    },
    color: {
        type: {
            name: {
                type: String,
                required: true
            },
            code: {
                type: String,
                required: true
            }
        },
        required: true
    },
    quantity: {
        type: Number,
        required: true
    }
},
    { _id: false }
);

const checkoutSchema = new mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        required: true
    },
    checkoutItems: [checkoutItemSchema],
    shippingAddress: {
        address: {
            type: String,
            required: true
        },
        city: {
            type: String,
            required: true
        },
        postalCode: {
            type: String,
            required: true
        },
        country: {
            type: String,
            required: true
        }
    },
    paymentMethod: {
        type: String,
        required: true
    },
    totalPrice: {
        type: Number,
        required: true
    },
    isPaid: {
        type: Boolean,
        default: false
    },
    paidAt: {
        type: Date
    },
    paymentStatus: {
        type: String,
        default: 'Pending'
    },
    paymentDetails: {
        type: mongoose.Schema.Types.Mixed, // Can store various payment details
    },
    isFinalized: {
        type: Boolean,
        default: false
    },
    finalizedAt: {
        type: Date
    }
},
    { timestamps: true }
);

module.exports = mongoose.model('Checkout', checkoutSchema);


===== FILE: ./backend/models/Collection.js =====
const mongoose = require("mongoose");

const collectionSchema = new mongoose.Schema(
  {
    id: {
      type: String,
      required: true,
      unique: true,
      trim: true,
    },
    name: {
      type: String,
      required: true,
      trim: true,
    },
    bannerUrl: {
      type: String,
      required: true,
    },
    description: {
      type: String,
      default: "",
    },
    categories: [
      {
        type: String,
        trim: true,
      },
    ],
    status: {
      type: String,
      enum: ["active", "inactive"],
      default: "active",
    },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Collection", collectionSchema);


===== FILE: ./backend/models/Order.js =====
const mongoose = require("mongoose");

const orderItemSchema = new mongoose.Schema(
  {
    productId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Product",
      required: true,
    },
    name: {
      type: String,
      required: true,
    },
    image: {
      type: String,
      required: true,
    },
    price: {
      type: Number,
      required: true,
    },
    size: {
      type: String,
    },
    color: {
      type: String,
    },
    quantity: {
      type: Number,
      required: true,
      //default: 1
    },
  },
  { _id: false }
);

const orderSchema = new mongoose.Schema(
  {
    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },
    orderItems: [orderItemSchema],
    shippingAddress: {
      address: {
        type: String,
        required: true,
      },
      city: {
        type: String,
        required: true,
      },
      district: {
        type: String,
        required: false,
      },
      ward: {
        type: String,
        required: false,
      },
      postalCode: {
        type: String,
        required: true,
      },
      country: {
        type: String,
        required: true,
      },
      notes: {
        type: String,
        required: false,
      },
    },
    paymentMethod: {
      type: String,
      required: true,
    },
    totalPrice: {
      type: Number,
      required: true,
    },
    isPaid: {
      type: Boolean,
      default: false,
    },
    paidAt: {
      type: Date,
    },
    isDelivered: {
      type: Boolean,
      default: false,
    },
    deliveredAt: {
      type: Date,
    },
    paymentStatus: {
      type: String,
      default: "Pending",
    },
    status: {
      type: String,
      enum: ["Processing", "Shipped", "Delivered", "Cancelled"],
      default: "Processing",
    },
  },
  { timestamps: true }
);

module.exports = mongoose.model("Order", orderSchema);


===== FILE: ./backend/models/Product.js =====
const mongoose = require("mongoose");
const productSchema = new mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
      trim: true,
    },

    description: {
      type: String,
      required: true,
      // trim: true
    },

    price: {
      type: Number,
      required: true,
      min: 0,
    },

    discountPrice: {
      type: Number,
      min: 0,
    },

    countInStock: {
      type: Number,
      required: true,
      min: 0,
      default: 0,
    },

    sku: {
      type: String,
      required: true,
      unique: true,
      trim: true,
    },

    category: {
      type: String,
      trim: true,
    },

    // brand: {
    //     type: String,
    //     required: true,
    //     trim: true,
    // },

    sizes: {
      type: [String],
      required: true,
      trim: true,
    },

    colors: [
      {
        name: {
          type: String,
          required: true,
          trim: true,
        },
        code: {
          type: String,
          required: true,
          trim: true,
        },
      },
    ],

    collection: {
      type: String,
      trim: true,
    },

    material: {
      type: String,
      required: true,
      trim: true,
    },

    gender: {
      type: String,
      required: true,
      enum: ["man", "woman", "unisex"],
    },

    images: [
      {
        url: {
          type: String,
          required: true,
        },
        altText: {
          type: String,
          required: true,
        },
        isFeatured: {
          type: Boolean,
          default: false,
        },
      },
    ],

    isPublished: {
      type: Boolean,
      default: true,
    },

    rating: {
      type: Number,
      default: 0,
      min: 0,
      max: 5,
    },

    numReviews: {
      type: Number,
      default: 0,
      min: 0,
    },

    tags: [
      {
        type: String,
        trim: true,
      },
    ],

    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },

    metaTitle: {
      type: String,
      trim: true,
    },

    metaDescription: {
      type: String,
      trim: true,
    },

    metaKeywords: [
      {
        type: String,
        trim: true,
      },
    ],

    dimensions: {
      length: {
        type: Number,
        required: true,
        min: 0,
      },
      width: {
        type: Number,
        required: true,
        min: 0,
      },
      height: {
        type: Number,
        required: true,
        min: 0,
      },
      weight: {
        type: Number,
        required: true,
        min: 0,
      },
    },
  },
  {
    timestamps: true,
    suppressReservedKeysWarning: true,
  }
);

module.exports = mongoose.model("Product", productSchema);


===== FILE: ./backend/models/User.js =====
const mongoose = require("mongoose");
const bcrypt = require("bcryptjs");

const userSchema = new mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
      trim: true,
    },
    email: {
      type: String,
      required: true,
      unique: true,
      trim: true,
      lowercase: true,
      match: [/.+\@.+\..+/, "Please enter a valid email address"],
    },
    password: {
      type: String,
      required: function () {
        // Password only required if no OAuth IDs
        return !this.googleId && !this.facebookId;
      },
      minlength: 6,
    },
    role: {
      type: String,
      enum: ["customer", "admin"],
      default: "customer",
    },
    gender: {
      type: String,
      enum: ["male", "female", "other"],
    },
    birth: {
      type: Date,
    },
    // Thêm trường mới
    address: {
      type: String,
    },
    city: {
      type: String,
      default: "",
    },
    district: {
      type: String,
      default: "",
    },
    ward: {
      type: String,
      default: "",
    },
    phone: {
      type: String,
    },
    // Thêm fields cho Google OAuth
    googleId: {
      type: String,
      sparse: true, // Cho phép null và unique
    },
    facebookId: {
      type: String,
      sparse: true,
    },
    profileImage: {
      type: String,
    },
    // Đánh dấu account type
    accountType: {
      type: String,
      enum: ["local", "google", "facebook", "hybrid"],
      default: "local",
    },
  },
  {
    timestamps: true,
  }
);

// Hash mật khẩu trước khi lưu (chỉ cho local accounts)
userSchema.pre("save", async function (next) {
  if (!this.isModified("password") || this.googleId || this.facebookId)
    return next();

  try {
    const salt = await bcrypt.genSalt(10);
    this.password = await bcrypt.hash(this.password, salt);
    next();
  } catch (err) {
    next(err);
  }
});

// Cập nhật account type trước khi lưu
userSchema.pre("save", function (next) {
  if (
    (this.googleId || this.facebookId) &&
    this.password !== "google_oauth_user" &&
    this.password !== "facebook_oauth_user"
  ) {
    this.accountType = "hybrid";
  } else if (this.googleId) {
    this.accountType = "google";
  } else if (this.facebookId) {
    this.accountType = "facebook";
  } else {
    this.accountType = "local";
  }
  next();
});
// Vấn đề: comparePassword không xử lý trường hợp password là null/undefined
// Phương thức kiểm tra mật khẩu
// userSchema.methods.comparePassword = async function (candidatePassword) {
//   // Không thể so sánh password cho Google OAuth users
//   if (this.accountType === 'google') {
//     return false;
//   }
//   return await bcrypt.compare(candidatePassword, this.password);
// };

userSchema.methods.comparePassword = async function (candidatePassword) {
  if (
    this.accountType === "google" ||
    this.accountType === "facebook" ||
    !this.password
  ) {
    return false;
  }
  return await bcrypt.compare(candidatePassword, this.password);
};

const User = mongoose.model("User", userSchema);
module.exports = User;


===== FILE: ./backend/routes/adminOrderRoutes.js =====
const express = require("express");
const Order = require("../models/Order");
const { authMiddleware, isAdmin } = require("../middleware/authMiddleware");

const router = express.Router();

// @route  GET /api/admin/orders
// @desc   Get all orders (Only for Admin)
// @access Private/Admin
router.get("/", authMiddleware, isAdmin, async (req, res) => {
  try {
    const orders = await Order.find().populate("user", "name email"); // Populate user details
    res.json(orders);
  } catch (error) {
    console.error("Error fetching orders:", error);
    res.status(500).json({ message: "Server error" });
  }
});

// @route  PUT /api/admin/orders/:id
// @desc   Update order status by ID (Only for Admin)
// @access Private/Admin
router.put("/:id", authMiddleware, isAdmin, async (req, res) => {
  const { status, paymentStatus } = req.body;

  try {
    const order = await Order.findById(req.params.id);

    if (!order) {
      return res.status(404).json({ message: "Order not found" });
    }

    console.log("PUT order body:", req.body);
    console.log("Order paymentStatus before:", order.paymentStatus);

    if (status) {
      order.status = status;
      order.isDelivered = status === "Delivered" ? true : order.isDelivered;
      order.deliveredAt =
        status === "Delivered" ? new Date() : order.deliveredAt;
    }
    if (paymentStatus) {
      order.paymentStatus = paymentStatus;
    }

    console.log("Order paymentStatus after:", order.paymentStatus);

    const updatedOrder = await order.save();
    res.json(updatedOrder);
  } catch (error) {
    console.error("Error updating order:", error);
    res.status(500).json({ message: "Server error" });
  }
});

// @route  DELETE /api/admin/orders/:id
// @desc   Delete an order by ID (Only for Admin)
// @access Private/Admin
router.delete("/:id", authMiddleware, isAdmin, async (req, res) => {
  try {
    const order = await Order.findById(req.params.id);

    if (!order) {
      return res.status(404).json({ message: "Order not found" });
    }

    await order.deleteOne();
    res.json({ message: "Order removed successfully" });
  } catch (error) {
    console.error("Error deleting order:", error);
    res.status(500).json({ message: "Server error" });
  }
});

module.exports = router;


===== FILE: ./backend/routes/adminRoutes.js =====
const express = require('express');
const User = require('../models/User');
const { authMiddleware, isAdmin } = require('../middleware/authMiddleware');
const router = express.Router();

// @route  GET /api/admin/users
// @desc   Get all users
// @access Private/Admin
router.get("/users", authMiddleware, isAdmin, async (req, res) => {
    try {
        const users = await User.find().select("-password"); // Exclude password field
        res.json(users);
    } catch (error) {
        console.error('Error fetching users:', error);
        res.status(500).json({ message: 'Server error' });
    }
});
// @route POST /api/admin/users/
// @desc  Create a new user (admin only)
// @access Private/Admin
router.post("/", authMiddleware, isAdmin, async (req, res) => {
    const { name, email, password, role } = req.body;

    try {
        const user = new User({
            name,
            email,
            password,
            role: role || 'customer', 
            //isAdmin
        });

        const createdUser = await user.save();
        res.status(201).json({message: "User created successfully",createdUser});
    } catch (error) {
        console.error('Error creating user:', error);
        res.status(500).json({ message: 'Server error' });
    }
});

// @route PUT /api/admin/users/:id
// @desc  Update a user (admin only)
// @access Private/Admin
router.put("/:id", authMiddleware, isAdmin, async (req, res) => {
    const { name, email, password, role } = req.body;

    try {
        const user = await User.findById(req.params.id);

        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        user.name = name || user.name;
        user.email = email || user.email;
        if (password) {
            user.password = password; // Hashing should be handled in the User model
        }
        user.role = role || user.role;

        const updatedUser = await user.save();
        res.json({ message: "User updated successfully", updatedUser });
    } catch (error) {
        console.error('Error updating user:', error);
        res.status(500).json({ message: 'Server error' });
    }
});
// @route DELETE /api/admin/users/:id
// @desc  Delete a user (admin only)
// @access Private/Admin
router.delete("/:id", authMiddleware, isAdmin, async (req, res) => {
    try {
        const user = await User.findById(req.params.id);
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }
        await user.deleteOne();
        res.json({ message: 'User deleted successfully' });
    } catch (error) {
        console.error('Error deleting user:', error);
        res.status(500).json({ message: 'Server error' });
    }
});
module.exports = router;

===== FILE: ./backend/routes/authRoutes.js =====
const express = require('express');
const passport = require('passport');
const jwt = require('jsonwebtoken');
const router = express.Router();
const User = require('../models/User'); // Import User model

// @route   GET /auth/google
// @desc    Authenticate with Google
// @access  Public
router.get('/google',
  passport.authenticate('google', {
    scope: ['profile', 'email']
  })
);

// @route   GET /auth/google/callback
// @desc    Google OAuth callback
// @access  Public
router.get('/google/callback',
  passport.authenticate('google', {
    failureRedirect: '/login',
    session: false
  }),
  (req, res) => {
    try {
      const frontendURL = process.env.FRONTEND_URL || 'http://localhost:5173';

      // Tạo JWT token
      const token = jwt.sign(
        { id: req.user._id, role: req.user.role },
        process.env.JWT_SECRET || "your_jwt_secret_key",
        { expiresIn: "7d" }
      );

      // Redirect về frontend với token
      res.redirect(`${frontendURL}/auth/success?token=${token}`);

    } catch (error) {
      console.error('Google callback error:', error);
      const frontendURL = process.env.FRONTEND_URL || 'http://localhost:5173';
      res.redirect(`${frontendURL}/login?error=auth_failed`);
    }
  }
);

// @route   POST /auth/google/mobile
// @desc    Google OAuth cho mobile app (nhận Google token từ client)
// @access  Public
router.post('/google/mobile', async (req, res) => {
  try {
    const { googleToken } = req.body;

    if (!googleToken) {
      return res.status(400).json({ message: 'Google token is required' });
    }

    // Verify Google token
    const { OAuth2Client } = require('google-auth-library');
    const client = new OAuth2Client(process.env.GOOGLE_CLIENT_ID);

    const ticket = await client.verifyIdToken({
      idToken: googleToken,
      audience: process.env.GOOGLE_CLIENT_ID,
    });

    const payload = ticket.getPayload();
    const { sub: googleId, name, email, picture } = payload;

    // Tìm hoặc tạo user
    let user = await User.findOne({ googleId });

    if (!user) {
      // Kiểm tra email đã tồn tại chưa
      const existingUser = await User.findOne({ email });
      if (existingUser) {
        // Liên kết account
        existingUser.googleId = googleId;
        existingUser.profileImage = picture;
        await existingUser.save();
        user = existingUser;
      } else {
        // Tạo user mới
        user = new User({
          googleId,
          name,
          email,
          password: 'google_oauth_user',
          gender: 'other',
          profileImage: picture
        });
        await user.save();
      }
    }

    // Tạo JWT token
    const token = jwt.sign(
      { id: user._id, role: user.role },
      process.env.JWT_SECRET || "your_jwt_secret_key",
      { expiresIn: "7d" }
    );

    res.status(200).json({
      message: "Google login successful",
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
        profileImage: user.profileImage,
        accountType: user.accountType
      },
      token,
    });

  } catch (error) {
    console.error('Google mobile auth error:', error);
    res.status(500).json({ message: 'Google authentication failed' });
  }
});

// @route   GET /auth/facebook
// @desc    Authenticate with Facebook
// @access  Public
router.get('/facebook',
  passport.authenticate('facebook', {
    scope: ['email', 'public_profile']
  })
);

// @route   GET /auth/facebook/callback
// @desc    Facebook OAuth callback
// @access  Public
router.get('/facebook/callback',
  passport.authenticate('facebook', {
    failureRedirect: '/login',
    session: false
  }),
  (req, res) => {
    try {
      const frontendURL = process.env.FRONTEND_URL || 'http://localhost:5173';

      // Create JWT token
      const token = jwt.sign(
        { id: req.user._id, role: req.user.role },
        process.env.JWT_SECRET || "your_jwt_secret_key",
        { expiresIn: "7d" }
      );

      // Redirect to frontend with token
      res.redirect(`${frontendURL}/auth/success?token=${token}`);

    } catch (error) {
      console.error('Facebook callback error:', error);
      const frontendURL = process.env.FRONTEND_URL || 'http://localhost:5173';
      res.redirect(`${frontendURL}/login?error=auth_failed`);
    }
  }
);

// @route   POST /auth/facebook/mobile
// @desc    Facebook OAuth for mobile/web SDK (receives Facebook token from client)
// @access  Public
router.post('/facebook/mobile', async (req, res) => {
  try {
    const { accessToken } = req.body;

    if (!accessToken) {
      return res.status(400).json({ message: 'Facebook access token is required' });
    }

    // Get user profile from Facebook
    const response = await fetch(`https://graph.facebook.com/v19.0/me?fields=id,name,email,picture&access_token=${accessToken}`);
    const profile = await response.json();

    if (profile.error) {
      throw new Error(profile.error.message);
    }

    const { id: facebookId, name, email, picture } = profile;

    // Find or create user
    let user = await User.findOne({ facebookId });

    if (!user) {
      // Check if email exists
      const existingUser = await User.findOne({ email });
      if (existingUser) {
        // Link account
        existingUser.facebookId = facebookId;
        existingUser.profileImage = picture?.data?.url;
        await existingUser.save();
        user = existingUser;
      } else {
        // Create new user
        user = new User({
          facebookId,
          name,
          email: email || `${facebookId}@facebook.com`,
          password: `facebook_oauth_${Date.now()}_${Math.random().toString(36)}`,
          gender: 'other',
          profileImage: picture?.data?.url
        });
        await user.save();
      }
    }

    // Create JWT token
    const token = jwt.sign(
      { id: user._id, role: user.role },
      process.env.JWT_SECRET || "your_jwt_secret_key",
      { expiresIn: "7d" }
    );

    res.status(200).json({
      message: "Facebook login successful",
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
        profileImage: user.profileImage,
        accountType: user.accountType
      },
      token,
    });

  } catch (error) {
    console.error('Facebook mobile auth error:', error);
    res.status(500).json({ message: 'Facebook authentication failed' });
  }
});

module.exports = router;

===== FILE: ./backend/routes/cartRoutes.js =====
const express = require("express");
const Cart = require("../models/Cart");
const Product = require("../models/Product");
const { authMiddleware } = require("../middleware/authMiddleware");
const mongoose = require("mongoose");

const router = express.Router();

// Helper function to validate ObjectId
const isValidObjectId = (id) => {
  return mongoose.Types.ObjectId.isValid(id);
};

// Helper function to get a cart by user ID or guest ID
const getCartByUserOrGuestId = async (userId, guestId) => {
  try {
    if (userId && isValidObjectId(userId)) {
      return await Cart.findOne({ user: userId }).populate(
        "products.productId",
        "name price images"
      );
    } else if (guestId) {
      return await Cart.findOne({ guestId: guestId }).populate(
        "products.productId",
        "name price images"
      );
    }
    return null;
  } catch (error) {
    console.error("Error in getCartByUserOrGuestId:", error);
    return null;
  }
};

// @route POST /api/cart
// @desc Add item to cart for a guest or logged-in user
// @access Public
router.post("/", async (req, res) => {
  const { productId, quantity = 1, size, color, guestId, userId } = req.body;

  try {
    // Log dữ liệu thêm vào giỏ hàng
    console.log("[ADD TO CART]", {
      productId,
      quantity,
      size,
      color,
      guestId,
      userId,
    });

    // Input validation
    if (!productId || !size || !color) {
      return res
        .status(400)
        .json({ message: "Product ID, size, and color are required" });
    }

    if (!isValidObjectId(productId)) {
      return res.status(400).json({ message: "Invalid product ID format" });
    }

    if (quantity < 1) {
      return res.status(400).json({ message: "Quantity must be at least 1" });
    }

    if (!userId && !guestId) {
      return res
        .status(400)
        .json({ message: "Either userId or guestId must be provided" });
    }

    // Validate product existence
    const product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }

    if (!product.isPublished) {
      return res.status(400).json({ message: "Product is not available" });
    }

    // Check if product has enough stock
    if (product.countInStock < quantity) {
      return res.status(400).json({ message: "Insufficient stock" });
    }

    // Determine if the user is logged in or a guest
    let cart = await getCartByUserOrGuestId(userId, guestId);

    // If cart exists, update it
    if (cart) {
      const productIndex = cart.products.findIndex(
        (p) =>
          p.productId._id.toString() === productId &&
          p.size === size &&
          p.color.name === color.name &&
          p.color.code === color.code
      );

      if (productIndex > -1) {
        // Check total quantity after addition
        const newQuantity = cart.products[productIndex].quantity + quantity;
        if (newQuantity > product.countInStock) {
          return res
            .status(400)
            .json({ message: "Not enough stock available" });
        }
        cart.products[productIndex].quantity = newQuantity;
      } else {
        // Add new product to cart
        cart.products.push({
          productId,
          name: product.name,
          image: product.images[0]?.url || "",
          price: product.discountPrice || product.price,
          quantity,
          size,
          color: {
            name: color.name,
            code: color.code,
          },
        });
      }

      await cart.save();
      return res.status(200).json(cart);
    } else {
      // Create new cart
      const finalGuestId =
        guestId ||
        `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

      const newCart = new Cart({
        user: userId && isValidObjectId(userId) ? userId : undefined,
        guestId: !userId ? finalGuestId : undefined,
        products: [
          {
            productId,
            name: product.name,
            image: product.images[0]?.url || "",
            price: product.discountPrice || product.price,
            quantity,
            size,
            color: {
              name: color.name,
              code: color.code,
            },
          },
        ],
      });

      await newCart.save();
      return res.status(201).json(newCart);
    }
  } catch (error) {
    console.error("Error adding item to cart:", error);
    return res
      .status(500)
      .json({ message: "Error adding item to cart", error: error.message });
  }
});

// @route PUT /api/cart
// @desc Update item in cart for a guest or logged-in user
// @access Public
router.put("/", async (req, res) => {
  const { productId, quantity, size, color, guestId, userId } = req.body;

  try {
    // Input validation
    if (!productId || !size || !color || quantity === undefined) {
      return res.status(400).json({
        message: "Product ID, size, color, and quantity are required",
      });
    }

    if (!isValidObjectId(productId)) {
      return res.status(400).json({ message: "Invalid product ID format" });
    }

    if (quantity < 0) {
      return res.status(400).json({ message: "Quantity cannot be negative" });
    }

    // Validate product existence
    const product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }

    if (quantity > product.countInStock) {
      return res.status(400).json({ message: "Not enough stock available" });
    }

    // Get the cart
    const cart = await getCartByUserOrGuestId(userId, guestId);
    if (!cart) {
      return res.status(404).json({ message: "Cart not found" });
    }

    // Find the product in the cart
    const productIndex = cart.products.findIndex(
      (p) =>
        p.productId._id.toString() === productId &&
        p.size === size &&
        p.color.name === color.name &&
        p.color.code === color.code
    );

    if (productIndex > -1) {
      if (quantity === 0) {
        // Remove product if quantity is 0
        cart.products.splice(productIndex, 1);
      } else {
        // Update quantity
        cart.products[productIndex].quantity = quantity;
      }

      await cart.save();
      return res.status(200).json(cart);
    } else {
      return res.status(404).json({ message: "Product not found in cart" });
    }
  } catch (error) {
    console.error("Error updating item in cart:", error);
    return res
      .status(500)
      .json({ message: "Error updating item in cart", error: error.message });
  }
});

// @route DELETE /api/cart
// @desc Remove item from cart for a guest or logged-in user
// @access Public
router.delete("/", async (req, res) => {
  const { productId, size, color, guestId, userId } = req.body;

  try {
    // Input validation
    if (!productId || !size || !color) {
      return res
        .status(400)
        .json({ message: "Product ID, size, and color are required" });
    }

    if (!isValidObjectId(productId)) {
      return res.status(400).json({ message: "Invalid product ID format" });
    }

    // Get the cart
    const cart = await getCartByUserOrGuestId(userId, guestId);
    if (!cart) {
      return res.status(404).json({ message: "Cart not found" });
    }

    // Find the product in the cart
    const productIndex = cart.products.findIndex(
      (p) =>
        p.productId._id.toString() === productId &&
        p.size === size &&
        p.color.name === color.name &&
        p.color.code === color.code
    );

    if (productIndex > -1) {
      cart.products.splice(productIndex, 1);
      await cart.save();
      return res.status(200).json(cart);
    } else {
      return res.status(404).json({ message: "Product not found in cart" });
    }
  } catch (error) {
    console.error("Error removing item from cart:", error);
    return res
      .status(500)
      .json({ message: "Error removing item from cart", error: error.message });
  }
});

// @route GET /api/cart
// @desc Get cart for a guest or logged-in user
// @access Public
router.get("/", async (req, res) => {
  const { guestId, userId } = req.query;

  try {
    if (!userId && !guestId) {
      return res
        .status(400)
        .json({ message: "Either userId or guestId must be provided" });
    }

    const cart = await getCartByUserOrGuestId(userId, guestId);
    if (!cart) {
      return res.status(404).json({ message: "Cart not found" });
    }

    return res.status(200).json(cart);
  } catch (error) {
    console.error("Error fetching cart:", error);
    return res
      .status(500)
      .json({ message: "Error fetching cart", error: error.message });
  }
});

// @route POST /api/cart/merge
// @desc Merge guest cart with user cart on login
// @access Private
router.post("/merge", authMiddleware, async (req, res) => {
  const { guestId } = req.body;

  try {
    console.log("=== CART MERGE START ===");
    console.log("User ID:", req.user._id);
    console.log("Guest ID:", guestId);

    // Input validation
    if (!guestId) {
      console.log("❌ No guestId provided");
      return res.status(400).json({ message: "Guest ID is required" });
    }

    // Find both carts with proper error handling
    const [userCart, guestCart] = await Promise.all([
      Cart.findOne({ user: req.user._id }).catch(() => null),
      Cart.findOne({ guestId: guestId }).catch(() => null),
    ]);

    console.log("Cart status:", {
      userCartExists: !!userCart,
      userCartProductCount: userCart?.products?.length || 0,
      guestCartExists: !!guestCart,
      guestCartProductCount: guestCart?.products?.length || 0,
    });

    // Case 1: No guest cart found
    if (!guestCart) {
      console.log("ℹ️ No guest cart found");
      if (userCart) {
        return res.status(200).json({
          message: "No guest cart found, returning existing user cart",
          cart: userCart,
        });
      } else {
        return res.status(200).json({
          message: "No carts found",
          cart: null,
        });
      }
    }

    // Case 2: Guest cart is empty
    if (!guestCart.products || guestCart.products.length === 0) {
      console.log("ℹ️ Guest cart is empty");
      await Cart.findOneAndDelete({ guestId: guestId });

      return res.status(200).json({
        message: "Guest cart was empty and has been cleaned up",
        cart: userCart || null,
      });
    }

    // Validate all products in guest cart still exist and get current prices
    const productIds = guestCart.products.map((item) => item.productId);
    const existingProducts = await Product.find({
      _id: { $in: productIds },
      isPublished: true,
    }).lean();

    const productMap = new Map(
      existingProducts.map((p) => [p._id.toString(), p])
    );

    // Case 3: User has existing cart - merge products
    if (userCart) {
      console.log("🔄 Merging into existing user cart...");

      let mergeCount = 0;
      let updateCount = 0;
      let skippedCount = 0;

      for (const guestItem of guestCart.products) {
        const productIdStr = guestItem.productId.toString();
        const currentProduct = productMap.get(productIdStr);

        if (!currentProduct) {
          console.log(
            `⚠️ Skipping product ${productIdStr} - no longer available`
          );
          skippedCount++;
          continue;
        }

        // Update price to current price
        const currentPrice =
          currentProduct.discountPrice || currentProduct.price;

        const existingIndex = userCart.products.findIndex(
          (userItem) =>
            userItem.productId.toString() === productIdStr &&
            userItem.size === guestItem.size &&
            userItem.color.name === guestItem.color.name &&
            userItem.color.code === guestItem.color.code
        );

        if (existingIndex > -1) {
          // Product exists - add quantities
          const newQuantity =
            userCart.products[existingIndex].quantity + guestItem.quantity;

          // Check stock limit
          if (newQuantity <= currentProduct.countInStock) {
            userCart.products[existingIndex].quantity = newQuantity;
            userCart.products[existingIndex].price = currentPrice;
            updateCount++;
          } else {
            // Set to max available stock
            userCart.products[existingIndex].quantity =
              currentProduct.countInStock;
            userCart.products[existingIndex].price = currentPrice;
            console.log(
              `⚠️ Limited quantity for ${guestItem.name} due to stock`
            );
            updateCount++;
          }
        } else {
          // New product - add to cart
          const quantity = Math.min(
            guestItem.quantity,
            currentProduct.countInStock
          );
          userCart.products.push({
            productId: guestItem.productId,
            name: currentProduct.name,
            image: currentProduct.images[0]?.url || guestItem.image,
            price: currentPrice,
            quantity: quantity,
            size: guestItem.size,
            color: {
              name: guestItem.color.name,
              code: guestItem.color.code,
            },
          });
          mergeCount++;
        }
      }

      // Save merged cart
      await userCart.save();

      // Delete guest cart
      await Cart.findOneAndDelete({ guestId: guestId });

      console.log("✅ Merge completed:", {
        mergeCount,
        updateCount,
        skippedCount,
      });
      return res.status(200).json({
        message: `Cart merged successfully. Added ${mergeCount} new items, updated ${updateCount} existing items${
          skippedCount > 0 ? `, skipped ${skippedCount} unavailable items` : ""
        }.`,
        cart: userCart,
        stats: {
          merged: mergeCount,
          updated: updateCount,
          skipped: skippedCount,
        },
      });
    } else {
      // Case 4: No user cart - convert guest cart to user cart
      console.log("🔄 Converting guest cart to user cart...");

      // Filter out non-existent products and update prices
      const validProducts = [];
      let skippedCount = 0;

      for (const item of guestCart.products) {
        const productIdStr = item.productId.toString();
        const currentProduct = productMap.get(productIdStr);

        if (currentProduct) {
          validProducts.push({
            productId: item.productId,
            name: currentProduct.name,
            image: currentProduct.images[0]?.url || item.image,
            price: currentProduct.discountPrice || currentProduct.price,
            quantity: Math.min(item.quantity, currentProduct.countInStock),
            size: item.size,
            color: {
              name: item.color.name,
              code: item.color.code,
            },
          });
        } else {
          skippedCount++;
        }
      }

      // Update guest cart and convert to user cart
      guestCart.user = req.user._id;
      guestCart.guestId = undefined;
      guestCart.products = validProducts;

      await guestCart.save();

      console.log("✅ Guest cart converted to user cart");
      return res.status(200).json({
        message: `Guest cart converted to user cart successfully${
          skippedCount > 0
            ? `. ${skippedCount} unavailable items were removed.`
            : ""
        }.`,
        cart: guestCart,
      });
    }
  } catch (error) {
    console.error("❌ Error merging carts:", error);
    return res.status(500).json({
      message: "Error merging carts",
      error: error.message,
    });
  }
});

// @route DELETE /api/cart/clear
// @desc Clear entire cart
// @access Public
router.delete("/clear", async (req, res) => {
  const userId = req.body.userId || req.query.userId;
  const guestId = req.body.guestId || req.query.guestId;

  try {
    console.log("=== CLEAR CART REQUEST ===");
    console.log("Request body:", req.body);
    console.log("Request query:", req.query);
    console.log("Headers:", req.headers);

    if (!userId && !guestId) {
      console.log("❌ No userId or guestId provided");
      return res
        .status(400)
        .json({ message: "Either userId or guestId must be provided" });
    }

    // Xóa theo cả hai điều kiện nếu có
    const query = [];
    if (userId && isValidObjectId(userId)) query.push({ user: userId });
    if (guestId) query.push({ guestId: guestId });

    console.log("Query:", query);

    let result = null;
    if (query.length === 1) {
      result = await Cart.findOneAndDelete(query[0]);
    } else if (query.length === 2) {
      // Xóa cả hai, ưu tiên user trước
      result = await Cart.findOneAndDelete(query[0]);
      if (!result) result = await Cart.findOneAndDelete(query[1]);
    }

    console.log("Delete result:", result);

    if (!result) {
      console.log("❌ Cart not found");
      return res.status(404).json({ message: "Cart not found" });
    }

    console.log("✅ Cart cleared successfully");
    return res.status(200).json({ message: "Cart cleared successfully" });
  } catch (error) {
    console.error("❌ Error clearing cart:", error);
    return res
      .status(500)
      .json({ message: "Error clearing cart", error: error.message });
  }
});

module.exports = router;


===== FILE: ./backend/routes/checkoutRoutes.js =====
const express = require('express');
const Checkout = require('../models/Checkout');
const { authMiddleware, isAdmin } = require('../middleware/authMiddleware');
const Cart = require('../models/Cart');
const Product = require('../models/Product');
const Order = require('../models/Order');

const router = express.Router();

// @route POST /api/checkout
// @desc Create a new checkout session
// @access Private
router.post('/', authMiddleware, async (req, res) => {
    const { checkoutItems, shippingAddress, paymentMethod, totalPrice } = req.body;

    if (!checkoutItems || checkoutItems.length === 0 || !shippingAddress || !paymentMethod || !totalPrice) {
        return res.status(400).json({ message: 'All fields are required' });
    }

    try {
        // Validate all products exist and have enough stock
        const productIds = checkoutItems.map(item => item.productId);
        const products = await Product.find({
            _id: { $in: productIds },
            isPublished: true
        });

        const productMap = new Map(
            products.map(p => [p._id.toString(), p])
        );

        // Check each item
        for (const item of checkoutItems) {
            const product = productMap.get(item.productId.toString());

            if (!product) {
                return res.status(400).json({
                    message: `Product ${item.name} is no longer available`
                });
            }

            if (product.countInStock < item.quantity) {
                return res.status(400).json({
                    message: `Not enough stock for ${item.name}. Available: ${product.countInStock}`
                });
            }
        }

        const newCheckout = await Checkout.create({
            user: req.user._id,
            checkoutItems: checkoutItems,
            shippingAddress,
            paymentMethod,
            totalPrice,
            paymentStatus: 'Pending',
            isPaid: false
        });

        console.log(`Checkout created for user: ${req.user._id}`);
        res.status(201).json(newCheckout);
    } catch (error) {
        console.error("Error Creating checkout session", error);
        return res.status(500).json({ message: 'Server error' });
    }
});

// @route PUT /api/checkout/:id/pay
// @desc Update checkout to mark as paid after successful payment
// @access Private
router.put('/:id/pay', authMiddleware, async (req, res) => {
    const { paymentStatus, paymentDetails } = req.body;

    try {
        const checkout = await Checkout.findById(req.params.id);
        if (!checkout) {
            return res.status(404).json({ message: 'Checkout not found' });
        }

        // Verify checkout belongs to user
        if (checkout.user.toString() !== req.user._id.toString()) {
            return res.status(403).json({ message: 'Not authorized' });
        }

        if (paymentStatus === 'Paid') {
            checkout.isPaid = true;
            checkout.paymentStatus = paymentStatus;
            checkout.paidAt = new Date();
            checkout.paymentDetails = paymentDetails;
            await checkout.save();
            res.status(200).json(checkout);
        } else {
            return res.status(400).json({ message: 'Invalid payment status' });
        }
    } catch (error) {
        console.error("Error updating checkout payment status", error);
        return res.status(500).json({ message: 'Server error' });
    }
});

// @route POST /api/checkout/:id/finalize
// @desc Finalize checkout and convert to order after payment confirmation
// @access Private
router.post('/:id/finalize', authMiddleware, async (req, res) => {
    try {
        const checkout = await Checkout.findById(req.params.id);
        if (!checkout) {
            return res.status(404).json({ message: 'Checkout not found' });
        }

        // Verify checkout belongs to user
        if (checkout.user.toString() !== req.user._id.toString()) {
            return res.status(403).json({ message: 'Not authorized' });
        }

        if (!checkout.isFinalized) {
            // Final validation before creating order
            const productIds = checkout.checkoutItems.map(item => item.productId);
            const products = await Product.find({
                _id: { $in: productIds },
                isPublished: true
            });

            const productMap = new Map(
                products.map(p => [p._id.toString(), p])
            );

            // Update stock for each product
            for (const item of checkout.checkoutItems) {
                const product = productMap.get(item.productId.toString());

                if (!product) {
                    return res.status(400).json({
                        message: `Product ${item.name} is no longer available`
                    });
                }

                if (product.countInStock < item.quantity) {
                    return res.status(400).json({
                        message: `Not enough stock for ${item.name}. Available: ${product.countInStock}`
                    });
                }

                // Reduce stock
                product.countInStock -= item.quantity;
                await product.save();
            }

            // Tạo order với trạng thái phù hợp với phương thức thanh toán
            const isPaidOrder = checkout.paymentMethod === 'bank_transfer';

            const finalOrder = await Order.create({
                user: checkout.user,
                orderItems: checkout.checkoutItems,
                shippingAddress: checkout.shippingAddress,
                paymentMethod: checkout.paymentMethod,
                totalPrice: checkout.totalPrice,
                isPaid: isPaidOrder, // true nếu là bank_transfer, false nếu là COD
                paidAt: isPaidOrder ? new Date() : null,
                isDelivered: false,
                paymentStatus: isPaidOrder ? "Paid" : "Pending",
                status: 'Processing'
            });

            // Mark checkout as finalized
            checkout.isFinalized = true;
            checkout.finalizedAt = Date.now();
            await checkout.save();

            // Delete the cart
            if (checkout.user) {
                await Cart.findOneAndDelete({ user: checkout.user });
            } else if (checkout.guestId) {
                await Cart.findOneAndDelete({ guestId: checkout.guestId });
            }

            res.status(201).json(finalOrder);
        } else {
            return res.status(400).json({ message: 'Checkout already finalized' });
        }
    } catch (error) {
        console.error("Error finalizing checkout", error);
        return res.status(500).json({ message: 'Server error' });
    }
});

// @route GET /api/checkout/:id
// @desc Get checkout details
// @access Private
router.get('/:id', authMiddleware, async (req, res) => {
    try {
        const checkout = await Checkout.findById(req.params.id)
            .populate('user', 'name email')
            .populate('checkoutItems.productId', 'name price images');

        if (!checkout) {
            return res.status(404).json({ message: 'Checkout not found' });
        }

        // Verify checkout belongs to user (unless admin)
        if (checkout.user._id.toString() !== req.user._id.toString() && req.user.role !== 'admin') {
            return res.status(403).json({ message: 'Not authorized' });
        }

        res.status(200).json(checkout);
    } catch (error) {
        console.error("Error fetching checkout", error);
        return res.status(500).json({ message: 'Server error' });
    }
});

module.exports = router;

===== FILE: ./backend/routes/collectionRoutes.js =====
const express = require("express");
const router = express.Router();
const Collection = require("../models/Collection");
const Product = require("../models/Product");

// Lấy tất cả bộ sưu tập
router.get("/", async (req, res) => {
  try {
    const collections = await Collection.find();
    // Với mỗi collection, tìm các sản phẩm thuộc collection đó
    const collectionsWithProducts = await Promise.all(
      collections.map(async (col) => {
        const products = await Product.find({
          collection: col.id,
          isPublished: true,
        });
        return { ...col.toObject(), products };
      })
    );
    res.json(collectionsWithProducts);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// Lấy bộ sưu tập theo MongoDB _id
router.get("/:id", async (req, res) => {
  try {
    const collection = await Collection.findOne({ id: req.params.id });
    if (!collection)
      return res.status(404).json({ message: "Không tìm thấy bộ sưu tập" });

    // Tìm các sản phẩm thuộc collection này
    const products = await Product.find({
      collection: collection.id,
      isPublished: true,
    });
    res.json({ ...collection.toObject(), products });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// Lấy sản phẩm theo collection id (tự nhập)
router.get("/:id/products", async (req, res) => {
  try {
    const { color, size, material, category, price, sortBy } = req.query;
    console.log("Filter params received:", {
      color,
      size,
      material,
      category,
      price,
      sortBy,
    });

    const query = { collection: req.params.id }; // Sử dụng id tự nhập

    if (color) {
      const colors = color.split(",").map(c => c.toUpperCase());
      query["colors.code"] = {
        $in: colors.map(c => new RegExp(c.startsWith("#") ? c : `#${c}`, "i"))
      };
    }
    if (size) query.sizes = { $in: size.split(",") };
    if (material) {
      const materials = material.split(",");
      query.material = materials.length > 1 ? { $in: materials } : material;
    }
    if (category) {
      const categories = category.split(",");
      query.category = categories.length > 1 ? { $in: categories } : category;
    }
    if (price) {
      if (price.startsWith("under-")) {
        query.price = { $lt: Number(price.replace("under-", "")) * 1000 };
      } else if (price.startsWith("above-")) {
        query.price = { $gt: Number(price.replace("above-", "")) * 1000 };
      } else if (price.includes("-")) {
        const [min, max] = price.split("-").map(Number);
        query.price = { $gte: min * 1000, $lte: max * 1000 };
      }
    }

    let sortOptions = {};
    switch (sortBy) {
      case "price_asc":
        sortOptions = { price: 1 };
        break;
      case "price_desc":
        sortOptions = { price: -1 };
        break;
      case "newest":
        sortOptions = { createdAt: -1 };
        break;
      case "name_asc":
        sortOptions = { name: 1 };
        break;
      case "name_desc":
        sortOptions = { name: -1 };
        break;
    }

    const products = await Product.find(query).sort(sortOptions);
    res.json(products);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// Tạo mới bộ sưu tập
router.post("/", async (req, res) => {
  try {
    const { id, name, bannerUrl, description, categories, status } = req.body;
    const collection = new Collection({
      id,
      name,
      bannerUrl,
      description,
      categories: categories || [],
      status: status || "active",
    });
    await collection.save();
    res.status(201).json(collection);
  } catch (err) {
    if (err.code === 11000) {
      // Duplicate key error
      return res.status(400).json({
        message: "ID bộ sưu tập đã tồn tại, vui lòng chọn ID khác",
      });
    }
    res.status(400).json({ message: err.message });
  }
});

// Cập nhật bộ sưu tập theo _id
router.put("/:id", async (req, res) => {
  try {
    const { name, bannerUrl, description, categories, status } = req.body;
    const collection = await Collection.findOne({ id: req.params.id });
    if (!collection)
      return res.status(404).json({ message: "Không tìm thấy bộ sưu tập" });

    if (name) collection.name = name;
    if (bannerUrl) collection.bannerUrl = bannerUrl;
    if (description) collection.description = description;
    if (categories !== undefined) {
      console.log(
        "Cập nhật categories cho collection",
        req.params.id,
        categories
      );
      collection.categories = categories;
    }
    if (status) collection.status = status;

    await collection.save();
    res.json(collection);
  } catch (err) {
    res.status(400).json({ message: err.message });
  }
});

// Xóa bộ sưu tập theo _id
router.delete("/:id", async (req, res) => {
  try {
    const collection = await Collection.findOne({ id: req.params.id });
    if (!collection)
      return res.status(404).json({ message: "Không tìm thấy bộ sưu tập" });
    await collection.remove();
    res.json({ message: "Đã xóa bộ sưu tập" });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

module.exports = router;


===== FILE: ./backend/routes/orderRoutes.js =====
const express = require("express");
const Order = require("../models/Order");
const { authMiddleware, isAdmin } = require("../middleware/authMiddleware");

const router = express.Router();

// @route   GET /api/orders/my-orders
// @desc    Get logged in user's orders
// @access  Private
router.get("/my-orders", authMiddleware, async (req, res) => {
  try {
    const orders = await Order.find({ user: req.user._id }).sort({
      createdAt: -1,
    });
    res.json(orders);
  } catch (error) {
    console.error("Error fetching user orders:", error);
    res.status(500).json({ message: "Server error" });
  }
});

// @route   GET /api/orders/:id
// @desc    Get order by ID
// @access  Private
router.get("/:id", authMiddleware, async (req, res) => {
  try {
    const order = await Order.findById(req.params.id).populate(
      "user",
      "name email"
    );
    if (!order) {
      return res.status(404).json({ message: "Order not found" });
    }
    res.json(order);
  } catch (error) {
    console.error("Error fetching order:", error);
    res.status(500).json({ message: "Server error" });
  }
});

// @route   POST /api/orders
// @desc    Create a new order
// @access  Private
router.post("/", authMiddleware, async (req, res) => {
  try {
    // Nhận toàn bộ dữ liệu form và cartItems từ frontend
    const { formData, cartItems, totalPrice } = req.body;
    if (!cartItems || cartItems.length === 0) {
      return res.status(400).json({ message: "No order items" });
    }
    // Validate thông tin giao hàng
    if (
      !formData ||
      !formData.fullName ||
      !formData.phone ||
      !formData.address ||
      !formData.city ||
      !formData.district ||
      !formData.ward
    ) {
      return res.status(400).json({ message: "Thiếu thông tin giao hàng" });
    }
    // Chuẩn hóa dữ liệu orderItems từ cartItems (lấy thông tin sản phẩm từ DB)
    const productIds = cartItems.map((item) => item.productId);
    const products = await require("../models/Product").find({
      _id: { $in: productIds },
    });
    const productMap = new Map(products.map((p) => [p._id.toString(), p]));
    const orderItems = cartItems.map((item) => {
      const product = productMap.get((item.productId || "").toString());
      if (!product)
        throw new Error(`Không tìm thấy sản phẩm với id ${item.productId}`);
      return {
        productId: product._id,
        name: product.name,
        image: product.images?.[0]?.url || "",
        price: product.discountPrice || product.price,
        size: item.size,
        color: item.color,
        quantity: item.quantity,
      };
    });
    // Địa chỉ giao hàng
    const shippingAddress = {
      address: formData.address,
      city: formData.city,
      district: formData.district,
      ward: formData.ward,
      postalCode: formData.postalCode,
      country: formData.country,
      notes: formData.notes,
    };
    // Xử lý trạng thái thanh toán phía backend
    let isPaid = false;
    let paidAt = null;
    let paymentStatus = "Pending";
    if (formData.paymentMethod === "bank_transfer") {
      isPaid = true;
      paidAt = new Date();
      paymentStatus = "Paid";
    }
    const order = new Order({
      user: req.user._id,
      orderItems,
      shippingAddress,
      paymentMethod: formData.paymentMethod,
      totalPrice,
      isPaid,
      paidAt,
      paymentStatus,
      status: "Processing",
    });
    // Ghi log chi tiết khi tạo đơn hàng mới
    console.log("[ORDER] Dữ liệu nhận từ frontend:", {
      formData,
      cartItems,
      totalPrice,
    });
    console.log("[ORDER] Tạo đơn hàng mới:", {
      user: req.user?._id,
      orderItems,
      shippingAddress,
      paymentMethod: formData.paymentMethod,
      totalPrice,
      isPaid,
      paidAt,
      paymentStatus,
      status: "Processing",
      createdAt: new Date(),
    });
    const createdOrder = await order.save();
    res.status(201).json(createdOrder);
  } catch (error) {
    console.error("Error creating order:", error);
    // Ghi log chi tiết lỗi để debug
    if (error instanceof Error) {
      res.status(500).json({
        message: "Server error",
        error: error.message,
        stack: error.stack,
      });
    } else {
      res.status(500).json({ message: "Server error", error });
    }
  }
});

// @route   PUT /api/orders/:id/update-stock
// @desc    Update product stock after order is placed
// @access  Private
router.put("/:id/update-stock", authMiddleware, async (req, res) => {
  try {
    const order = await Order.findById(req.params.id);
    if (!order) {
      return res.status(404).json({ message: "Order not found" });
    }

    // Verify order belongs to user
    if (order.user.toString() !== req.user._id.toString()) {
      return res.status(403).json({ message: "Not authorized" });
    }

    // Update stock for each product in the order
    const Product = require("../models/Product");
    for (const item of order.orderItems) {
      const product = await Product.findById(item.productId);
      if (product) {
        if (product.countInStock >= item.quantity) {
          product.countInStock -= item.quantity;
          await product.save();
          console.log(
            `[STOCK] Updated product ${product.name}: -${item.quantity}, remaining: ${product.countInStock}`
          );
        } else {
          console.warn(
            `[STOCK] Insufficient stock for product ${product.name}: requested ${item.quantity}, available ${product.countInStock}`
          );
          return res.status(400).json({
            message: `Không đủ hàng tồn kho cho sản phẩm ${product.name}`,
          });
        }
      } else {
        console.warn(`[STOCK] Product not found: ${item.productId}`);
        return res.status(404).json({
          message: `Không tìm thấy sản phẩm với ID ${item.productId}`,
        });
      }
    }

    res.json({ message: "Stock updated successfully", order });
  } catch (error) {
    console.error("Error updating stock:", error);
    res.status(500).json({ message: "Server error", error: error.message });
  }
});

module.exports = router;


===== FILE: ./backend/routes/paymentRoutes.js =====
const express = require("express");
const router = express.Router();
const axios = require("axios");

// GET /api/payment/check?orderCode=...&amount=...&phone=...
router.get("/check", async (req, res) => {
  const { orderCode, amount, phone } = req.query;
  if (!orderCode || !amount || !phone) {
    return res.status(400).json({
      error: true,
      message: "Thiếu tham số orderCode, amount hoặc phone",
    });
  }
  const API_URL =
    "https://script.google.com/macros/s/AKfycbxMRUJYZWJdNtr4k2pcD4-T7OR8k4nz8jPnDFCm2F6ChwEYP3IT6v-x0OnZIfmmPKdl/exec";
  try {
    const response = await axios.get(API_URL);
    const transactions = response.data;
    // Log giao dịch lấy được
    console.log("[API/payment/check] transactions:", transactions);
    // Log nội dung đối chiếu
    console.log("[API/payment/check] Đối chiếu với:", {
      orderCode,
      amount,
      phone,
    });
    res.json({ transactions });
  } catch (err) {
    console.error("[API/payment/check] Lỗi:", err);
    res.status(500).json({
      error: true,
      message: "Không thể xác thực thanh toán. Vui lòng thử lại sau!",
    });
  }
});

module.exports = router;


===== FILE: ./backend/routes/productAdminRoutes.js =====
const express = require('express');
const Product = require('../models/Product');
const { authMiddleware, isAdmin } = require('../middleware/authMiddleware');
const router = express.Router();

// @route  GET /api/admin/products
// @desc   Get all products
// @access Private/Admin
router.get("/", authMiddleware, isAdmin, async (req, res) => {
    try {
        const products = await Product.find();
        res.json(products);
    } catch (error) {
        console.error('Error fetching products:', error);
        res.status(500).json({ message: 'Server error' });
    }
});

module.exports = router;

===== FILE: ./backend/routes/productRoutes.js =====
const express = require("express");
const Product = require("../models/Product");
const { authMiddleware, isAdmin } = require("../middleware/authMiddleware");
const router = express.Router();

// @route   POST /api/products
// @desc    Create a new product
// @access  Private/Admin
router.get("/search", async (req, res) => {
  const { query } = req.query;
  try {
    // Tìm kiếm không phân biệt hoa thường, có thể dùng regex
    const products = await Product.find({
      name: { $regex: query, $options: "i" },
    });
    res.json({ products }); // Đảm bảo trả về object có key "products"
  } catch (error) {
    res
      .status(500)
      .json({ message: "Error searching products", error: error.message });
  }
});

router.post("/", authMiddleware, isAdmin, async (req, res) => {
  try {
    const {
      name,
      description,
      price,
      discountPrice,
      countInStock,
      sku,
      category,
      // brand,
      sizes,
      colors,
      collection,
      material,
      gender,
      images,
      isFeatured,
      isPublished,
      tags,
      metaTitle,
      metaDescription,
      metaKeywords,
      dimensions,
    } = req.body;

    // Validate required fields
    if (
      !name ||
      !description ||
      !price ||
      !sku ||
      !category ||
      // !brand || !sizes || !sizes.length || !color || !collection || !material || !gender ||
      !sizes ||
      !sizes.length ||
      !colors ||
      !colors.length ||
      !collection ||
      !material ||
      !gender ||
      !images ||
      !dimensions ||
      !dimensions.weight
    ) {
      return res.status(400).json({ message: "Missing required fields" });
    }

    const product = new Product({
      name,
      description,
      price,
      discountPrice,
      countInStock,
      sku,
      category,
      // brand,
      sizes,
      colors,
      collection,
      material,
      gender,
      images,
      isFeatured,
      isPublished,
      tags,
      metaTitle,
      metaDescription,
      metaKeywords,
      dimensions,
      user: req.user._id, // Set the user who created the product
    });

    const newProduct = await product.save();
    // await product.save();
    res.status(201).json(newProduct);
  } catch (error) {
    console.error(error);
    if (error.code === 11000) {
      return res
        .status(400)
        .json({ message: "Product with this SKU already exists" });
    }
    res.status(500).json({ message: "Server error" });
  }
});

// @route   PUT /api/products/:id
// @desc    Update an existing product
// @access  Private/Admin
router.put("/:id", authMiddleware, isAdmin, async (req, res) => {
  try {
    const productId = req.params.id;

    // Tìm sản phẩm hiện có
    const product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }

    // Cập nhật chỉ những trường được cung cấp trong request body
    Object.keys(req.body).forEach((key) => {
      // Đảm bảo chỉ cập nhật những trường hợp lệ
      if (product.schema.paths[key]) {
        product[key] = req.body[key];
      }
    });

    const updatedProduct = await product.save();
    res.status(200).json(updatedProduct);
  } catch (error) {
    console.error(error);
    if (error.code === 11000) {
      return res
        .status(400)
        .json({ message: "Product with this SKU already exists" });
    }
    res.status(500).json({ message: "Server error" });
  }
});
// @route   DELETE /api/products/:id
// @desc    Delete a product
// @access  Private/Admin
router.delete("/:id", authMiddleware, isAdmin, async (req, res) => {
  try {
    const productId = req.params.id;

    const product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }

    // Cách 1: Sử dụng deleteOne()
    await product.deleteOne();

    // HOẶC Cách 2: Sử dụng findByIdAndDelete (không cần tìm trước)
    // await Product.findByIdAndDelete(productId);

    res.status(200).json({ message: "Product deleted successfully" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
});

// @route   GET /api/products
// @desc    Get all products
router.get("/", async (req, res) => {
  try {
    const {
      collection,
      sizes,
      color,
      gender,
      minPrice,
      maxPrice,
      sortBy,
      search,
      category,
      material,
      brand,
      limit,
      page = 1,
      featured,
      published,
      onSale,
      fields,
    } = req.query;

    let query = {};

    // Filtering by collection (support comma-separated values)
    if (collection) {
      const collections = collection.split(",");
      query.collection =
        collections.length > 1 ? { $in: collections } : collection;
    }

    // Filtering by sizes (support comma-separated values)
    if (sizes) {
      const sizess = sizes.split(",");
      query.sizes = sizess.length > 1 ? { $in: sizess } : sizes;
    }

    // Filtering by color (support comma-separated values)
    if (color) {
      const colors = color.split(",").map(c => c.toUpperCase());
      query["colors.code"] = {
        $in: colors.map(c => new RegExp(c.startsWith("#") ? c : `#${c}`, "i"))
      };
    }

    // Filtering by gender (support comma-separated values)
    if (gender) {
      const genders = gender.split(",");
      query.gender = genders.length > 1 ? { $in: genders } : gender;
    }

    // Filtering by price (from price param: under-500, 500-1000, ...)
    if (req.query.price) {
      let min, max;
      if (req.query.price === "under-500") {
        max = 500000;
      } else if (req.query.price === "500-1000") {
        min = 500000;
        max = 1000000;
      } else if (req.query.price === "1000-1500") {
        min = 1000000;
        max = 1500000;
      } else if (req.query.price === "above-1500") {
        min = 1500000;
      }
      query.price = {};
      if (min) query.price.$gte = min;
      if (max) query.price.$lte = max;
    }

    // Filtering by price range (minPrice, maxPrice)
    if (minPrice || maxPrice) {
      query.price = query.price || {};
      if (minPrice) query.price.$gte = Number(minPrice);
      if (maxPrice) query.price.$lte = Number(maxPrice);
    }

    // Filtering by category (support comma-separated values)
    if (category) {
      const categories = category.split(",");
      query.category = categories.length > 1 ? { $in: categories } : category;
    }

    // Filtering by material (support comma-separated values)
    if (material) {
      const materials = material.split(",");
      query.material = materials.length > 1 ? { $in: materials } : material;
    }

    // Filtering by brand (support comma-separated values)
    if (brand) {
      const brands = brand.split(",");
      query.brand = brands.length > 1 ? { $in: brands } : brand;
    }

    // Filter by featured products
    if (featured !== undefined) {
      query.isFeatured = featured === "true";
    }

    // Filter by published status
    if (published !== undefined) {
      query.isPublished = published === "true";
    }

    // Filter products on sale (with discount)
    if (onSale === "true") {
      query.discountPrice = { $ne: null, $gt: 0 };
    }

    // Search by name or description
    if (search) {
      query.$or = [
        { name: { $regex: search, $options: "i" } },
        { description: { $regex: search, $options: "i" } },
      ];
    }

    // Thêm log để debug
    console.log("[PRODUCT SEARCH] search:", search);
    console.log("[PRODUCT SEARCH] final query:", JSON.stringify(query));

    // Sorting
    let sortOptions = {};
    if (sortBy) {
      switch (sortBy) {
        case "price_asc":
          sortOptions = { price: 1 };
          break;
        case "price_desc":
          sortOptions = { price: -1 };
          break;
        case "newest":
          sortOptions = { createdAt: -1 };
          break;
        case "popularity":
          sortOptions = { popularity: -1 };
          break;
        case "name_asc":
          sortOptions = { name: 1 };
          break;
        case "name_desc":
          sortOptions = { name: -1 };
          break;
        case "discount":
          sortOptions = { discountPrice: 1, price: -1 };
          break;
        default:
          sortOptions = { createdAt: -1 }; // Default sorting
      }
    }

    // Field selection/projection
    let projection = {};
    if (fields) {
      fields.split(",").forEach((field) => {
        projection[field] = 1;
      });
    }

    // Pagination
    const pagesizes = parseInt(limit) || 10;
    const skip = (parseInt(page) - 1) * pagesizes;

    // Execute query with pagination
    const totalProducts = await Product.countDocuments(query);
    const products = await Product.find(query, projection)
      .sort(sortOptions)
      .skip(skip)
      .limit(pagesizes);

    // Return products with pagination metadata
    res.status(200).json({
      products,
      page: parseInt(page),
      pages: Math.ceil(totalProducts / pagesizes),
      totalProducts,
      filters: {
        appliedFilters: Object.keys(query).length,
        query: query,
      },
      // message: totalProducts === 0 ? "No products found matching your criteria" : null
    });
  } catch (error) {
    console.error(error);
    if (error.name === "CastError") {
      return res.status(400).json({ message: "Invalid parameter format" });
    }
    res.status(500).json({ message: "Server error", error: error.message });
  }
});

// @route   GET /api/products/similar/:id
// @desc    Get similar products based on category, brand, or collection
// @access  Public
router.get("/similar/:id", async (req, res) => {
  try {
    const productId = req.params.id;
    const product = await Product.findById(productId);
    if (!product) {
      return res.status(404).json({ message: "Không tìm thấy sản phẩm" });
    }

    // Tạo truy vấn tìm sản phẩm tương tự
    const similarQuery = {
      _id: { $ne: productId },
      isPublished: true,
      $or: [
        { category: product.category },
        { brand: product.brand },
        { collection: product.collection },
      ],
    };

    // Thêm điều kiện về gender nếu có
    if (product.gender) {
      similarQuery.gender = product.gender;
    }

    // Tìm và sắp xếp sản phẩm tương tự
    // $facet cho phép tạo các nhóm kết quả khác nhau
    const similarProducts = await Product.aggregate([
      { $match: similarQuery },
      {
        $addFields: {
          similarity: {
            $add: [
              { $cond: [{ $eq: ["$category", product.category] }, 3, 0] },
              { $cond: [{ $eq: ["$brand", product.brand] }, 2, 0] },
              { $cond: [{ $eq: ["$collection", product.collection] }, 1, 0] },
            ],
          },
        },
      },
      {
        $facet: {
          // Nhóm 1: Sản phẩm cùng danh mục
          sameCategory: [
            { $match: { category: product.category } },
            { $sort: { createdAt: -1 } },
            { $limit: 5 },
            {
              $project: {
                name: 1,
                price: 1,
                discountPrice: 1,
                images: 1,
                category: 1,
                brand: 1,
                collection: 1,
              },
            },
          ],
          // Nhóm 2: Sản phẩm cùng thương hiệu
          sameBrand: [
            { $match: { brand: product.brand } },
            { $sort: { createdAt: -1 } },
            { $limit: 5 },
            {
              $project: {
                name: 1,
                price: 1,
                discountPrice: 1,
                images: 1,
                category: 1,
                brand: 1,
                collection: 1,
              },
            },
          ],
          // Nhóm 3: Sản phẩm tổng hợp theo điểm tương đồng
          recommended: [
            { $sort: { similarity: -1, createdAt: -1 } },
            { $limit: 10 },
            {
              $project: {
                name: 1,
                price: 1,
                discountPrice: 1,
                images: 1,
                category: 1,
                brand: 1,
                collection: 1,
                similarity: 1,
              },
            },
          ],
        },
      },
    ]);

    res.status(200).json(similarProducts[0]); // $facet luôn trả về một mảng, nên lấy phần tử đầu tiên
  } catch (error) {
    console.error(error);
    if (error.name === "CastError") {
      return res.status(400).json({ message: "ID sản phẩm không hợp lệ" });
    }
    res.status(500).json({ message: "Lỗi server", error: error.message });
  }
});

// @route   GET /api/products/best-sellers
// @desc    Get best-selling products rating
// @access Public
router.get("/best-sellers", async (req, res) => {
  try {
    const bestSellers = await Product.find({ isPublished: true })
      .sort({ rating: -1, numReviews: -1 }) // Sắp xếp theo rating và số lượng review
      .limit(10)
      .select("name price discountPrice images category brand collection");

    res.status(200).json(bestSellers);
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error", error: error.message });
  }
});

// @route   GET /api/products/new-arrivals
// @desc    Get new arrivals products
// @access Public
router.get("/new-arrivals", async (req, res) => {
  try {
    const newArrivals = await Product.find({ isPublished: true })
      .sort({ createdAt: -1 }) // Sắp xếp theo ngày tạo mới nhất
      .limit(10)
      .select("name price discountPrice images category brand collection");

    res.status(200).json(newArrivals);
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error", error: error.message });
  }
});

// Gợi ý tìm kiếm sản phẩm theo tên
router.get("/suggest", async (req, res) => {
  try {
    const { query } = req.query;
    if (!query || query.trim() === "") {
      return res.json([]);
    }
    // Tìm các sản phẩm có tên chứa query (không phân biệt hoa thường)
    const suggestions = await Product.find({
      name: { $regex: query, $options: "i" },
    })
      .limit(8)
      .select("name"); // chỉ lấy tên

    res.json(suggestions.map((p) => p.name));
  } catch (error) {
    res.status(500).json({ message: "Server error" });
  }
});

// Route động :id phải đặt sau tất cả các route đặc biệt
router.get("/:id", async (req, res) => {
  try {
    const productId = req.params.id;
    const product = await Product.findById(productId).populate(
      "user",
      "name email"
    ); // Populate user details
    // .populate('category', 'name') // Populate category details
    // .populate('brand', 'name') // Populate brand details
    // .populate('collection', 'name') // Populate collection details
    // .populate('material', 'name') // Populate material details
    // .populate('sizes', 'name') // Populate sizes details
    // .populate('color', 'name'); // Populate color details
    if (!product) {
      return res.status(404).json({ message: "Product not found" });
    }
    res.status(200).json(product);
  } catch (error) {
    console.error(error);
    if (error.name === "CastError") {
      return res.status(400).json({ message: "Invalid product ID format" });
    }
    res.status(500).json({ message: "Server error", error: error.message });
  }
});

module.exports = router;


===== FILE: ./backend/routes/uploadRoutes.js =====
const express = require('express');
const multer = require('multer');
const cloudinary = require('cloudinary').v2;  
const streamifier = require('streamifier');

const router = express.Router(); 

require('dotenv').config();

// Cloudinary configuration
cloudinary.config({  
    cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
    api_key: process.env.CLOUDINARY_API_KEY,
    api_secret: process.env.CLOUDINARY_API_SECRET,
});

// Multer configuration
const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

router.post('/', upload.single('image'), async (req, res) => {
    try {
        if (!req.file) {
            return res.status(400).json({ message: 'No file uploaded' });
        }
        
        // Function to handle the upload to Cloudinary
        const streamUpload = (fileBuffer) => {
            return new Promise((resolve, reject) => {
                const stream = cloudinary.uploader.upload_stream((error, result) => {  
                    if (error) {
                        return reject(error);
                    }
                    resolve(result);
                });
                // Chỉ giữ dòng này ở trong Promise
                streamifier.createReadStream(fileBuffer).pipe(stream);
            });
        }
        
        // Call the streamUpload function with the file buffer
        const result = await streamUpload(req.file.buffer);
        
        // Respond with the uploaded image URL
        res.json({ imageUrl: result.secure_url });
        
    } catch (error) {
        console.error('Error uploading image:', error);
        res.status(500).json({ message: 'Server error' });
    }
});

module.exports = router;

===== FILE: ./backend/routes/userRoutes.js =====
const express = require("express");
const router = express.Router();
const User = require("../models/User");
const jwt = require("jsonwebtoken");
const { authMiddleware } = require("../middleware/authMiddleware");


// @route   POST /api/users/register
// @desc    Register a new user
// @access  Public
router.post("/register", async (req, res) => {
  try {
    const { name, email, password, gender, birth } = req.body;

    // Kiểm tra user đã tồn tại chưa
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ message: "User already exists." });
    }

    // Tạo user mới
    const newUser = new User({
      name,
      email,
      password, // sẽ được hash trong schema
      gender,
      birth,
    });

    await newUser.save();

    // Tạo token
    const token = jwt.sign(
      { id: newUser._id, role: newUser.role },
      process.env.JWT_SECRET || "your_jwt_secret_key",
      { expiresIn: "7d" }
    );

    // CẢI THIỆN: Set secure cookie với các options bảo mật
    const cookieOptions = {
      httpOnly: true,                    // Không thể access từ JavaScript
      secure: process.env.NODE_ENV === 'production', // HTTPS only in production
      sameSite: 'lax',                   // CSRF protection
      maxAge: 7 * 24 * 60 * 60 * 1000,  // 7 ngày
      path: '/'                          // Available for all paths
    };

    res.cookie('authToken', token, cookieOptions);

    // Chuẩn bị response data
    const responseData = {
      message: "User registered successfully",
      user: {
        id: newUser._id,
        name: newUser.name,
        email: newUser.email,
        role: newUser.role,
      },
      token: token
    };

    // Chỉ gửi token trong response khi development (để frontend có thể sử dụng)
    if (process.env.NODE_ENV === 'development') {
      responseData.token = token;
    }

    res.status(201).json(responseData);
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
});

// @route   POST /api/users/login
// @desc    Login user
// @access  Public
router.post("/login", async (req, res) => {
  try {
    const { email, password } = req.body;

    // Tìm user theo email
    const user = await User.findOne({ email });
    if (!user) {
      return res.status(400).json({ message: "Invalid email or password." });
    }
    // Kiểm tra mật khẩu
    const isMatch = await user.comparePassword(password);
    if (!isMatch) {
      return res.status(400).json({ message: "Invalid email or password." });
    }
    // Tạo token
    const token = jwt.sign(
      { id: user._id, role: user.role },
      process.env.JWT_SECRET || "your_jwt_secret_key",
      { expiresIn: "7d" }
    );
    const cookieOptions = {
      httpOnly: true,                    // Không thể access từ JavaScript
      secure: process.env.NODE_ENV === 'production', // HTTPS only in production
      sameSite: 'lax',                   // CSRF protection
      maxAge: 7 * 24 * 60 * 60 * 1000,  // 7 ngày
      path: '/'                          // Available for all paths
    };

    res.cookie('authToken', token, cookieOptions);

    // Chuẩn bị response data
    const responseData = {
      message: "Login successful",
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
        gender: user.gender,
        birth: user.birth,
        address: user.address,
        city: user.city,
        district: user.district,
        ward: user.ward,
        phone: user.phone,
        profileImage: user.profileImage,
        accountType: user.accountType,
        createdAt: user.createdAt,
      },
    };

    // Chỉ gửi token trong response khi development (để frontend có thể sử dụng)
    if (process.env.NODE_ENV === 'development') {
      responseData.token = token;
    }

    res.status(200).json(responseData);
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
});

router.post("/logout", authMiddleware, async (req, res) => {
  try {
    // Clear tất cả cookies có thể
    const cookieOptions = {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      path: '/'
    };

    res.clearCookie('authToken', cookieOptions);
    res.clearCookie('userToken', cookieOptions);
    res.clearCookie('token', cookieOptions);

    // Optional: Thêm token vào blacklist nếu muốn
    // await addToBlacklist(req.headers.authorization?.split(" ")[1]);

    res.json({ 
      message: "Đăng xuất thành công",
      success: true 
    });
  } catch (error) {
    console.error("Logout error:", error);
    res.status(500).json({ 
      message: "Lỗi khi đăng xuất",
      success: false 
    });
  }
});


// @route   GET /api/users/profile
// @desc    Get user profile
// @access  Private

// Lấy profile user, đã xác thực qua middleware
// router.get("/profile", authMiddleware, async (req, res) => {
//   try {
//     // Sử dụng trực tiếp user đã được tìm trong middleware
//     // Không cần query lại database
//     res.status(200).json(req.user);
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: "Server error" });
//   }
// });
// @route   GET /api/users/profile
// @desc    Get user profile
// @access  Private
router.get("/profile", authMiddleware, async (req, res) => {
  try {
    // Lấy thông tin user từ middleware auth (req.user chứa ID)
    const user = await User.findById(req.user.id).select("-password");

    if (!user) {
      return res.status(404).json({ message: "User not found" });
    }

    // Trả về đầy đủ thông tin cần thiết
    res.status(200).json({
      id: user._id,
      name: user.name,
      email: user.email,
      role: user.role,
      gender: user.gender,
      birth: user.birth,
      address: user.address,
      city: user.city,
      district: user.district,
      ward: user.ward,
      phone: user.phone,
      profileImage: user.profileImage,
      accountType: user.accountType,
      createdAt: user.createdAt,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
});

// Thêm route update profile vào userRoutes.js
router.put("/update-profile", authMiddleware, async (req, res) => {
  try {
    const { name, gender, birth, address, phone, city, district, ward } =
      req.body;

    // Tìm user dựa vào ID từ middleware
    const user = await User.findById(req.user.id);

    if (!user) {
      return res.status(404).json({ message: "User not found" });
    }

    // Cập nhật thông tin
    if (name) user.name = name;
    if (gender) user.gender = gender;
    if (birth) user.birth = birth;
    if (address) user.address = address;
    if (city) user.city = city;
    if (phone) user.phone = phone;
    if (district) user.district = district;
    if (ward) user.ward = ward;

    // Lưu vào database
    const updatedUser = await user.save();

    // Trả về thông tin đã cập nhật
    res.status(200).json({
      id: updatedUser._id,
      name: updatedUser.name,
      email: updatedUser.email,
      role: updatedUser.role,
      gender: updatedUser.gender,
      birth: updatedUser.birth,
      address: updatedUser.address,
      city: updatedUser.city,
      district: updatedUser.district,
      ward: updatedUser.ward,
      phone: updatedUser.phone,
      profileImage: updatedUser.profileImage,
      accountType: updatedUser.accountType,
      createdAt: updatedUser.createdAt,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
});

module.exports = router;


===== FILE: ./backend/seeder.js =====
// const mongoose = require("mongoose");
// const dotenv = require("dotenv");
// const Product = require("./models/Product");
// const User = require("./models/User");
// const products = require("./data/products"); // Dữ liệu sản phẩm mẫu
// const users = require("./data/users"); // Dữ liệu người dùng mẫu (nếu có)
// const cart = require("./models/cart"); // Nếu cần sử dụng Cart
// const bcrypt = require("bcryptjs");

// // Load env vars
// dotenv.config();

// // Connect to MongoDB
// mongoose
//   .connect(process.env.MONGO_URI, {
//     useNewUrlParser: true,
//     useUnifiedTopology: true,
//   })
//   .then(() => console.log("MongoDB connected"))
//   .catch((err) => console.error("MongoDB connection error:", err));

// // Import data
// const importData = async () => {
//   try {
//     // Xóa dữ liệu hiện có
//     await Product.deleteMany();
//     await User.deleteMany();
//     await cart.deleteMany();

//     console.log("Data deleted successfully");

//     // Tạo admin user
//     const adminUser = await User.create({
//       name: "Admin User",
//       email: "admin@example.com",
//       password: "123456",
//       role: "admin",
//     });

//     console.log("Admin user created");

//     // Thêm user Id vào mỗi sản phẩm
//     const sampleProducts = products.map((product) => {
//       return { ...product, user: adminUser._id };
//     });

//     // Import sản phẩm vào database
//     await Product.insertMany(sampleProducts);

//     console.log("Data imported successfully");
//     process.exit();
//   } catch (error) {
//     console.error(`Error: ${error.message}`);
//     process.exit(1);
//   }
// };

// // Destroy data
// const destroyData = async () => {
//   try {
//     await Product.deleteMany();
//     await User.deleteMany();

//     console.log("Data destroyed successfully");
//     process.exit();
//   } catch (error) {
//     console.error(`Error: ${error.message}`);
//     process.exit(1);
//   }
// };

// // Xử lý tham số dòng lệnh để quyết định import hay destroy
// if (process.argv[2] === "-d") {
//   destroyData();
// } else {
//   importData();
// }

// backend/seeder.js
const mongoose = require("mongoose");
const dotenv = require("dotenv");
const Product = require("./models/Product");
const User = require("./models/User");
const Collection = require("./models/Collection");
const dataManager = require("./data/dataManager");

// Load env vars
dotenv.config();

// Connect to MongoDB
mongoose
  .connect(process.env.MONGO_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => console.log("MongoDB connected"))
  .catch((err) => console.error("MongoDB connection error:", err));

// Import data
const importData = async (options = {}) => {
  try {
    console.log("🚀 Bắt đầu import dữ liệu...");

    // Parse command line options
    const uploadImages = process.argv.includes('--upload-images');
    const skipClear = process.argv.includes('--skip-clear');
    const onlyProducts = process.argv.includes('--only-products');
    const onlyUsers = process.argv.includes('--only-users');
    const onlyCollections = process.argv.includes('--only-collections');

    console.log("⚙️ Tùy chọn:");
    console.log(`   - Upload images to Cloudinary: ${uploadImages ? '✅' : '❌'}`);
    console.log(`   - Skip clearing data: ${skipClear ? '✅' : '❌'}`);
    console.log(`   - Only products: ${onlyProducts ? '✅' : '❌'}`);
    console.log(`   - Only users: ${onlyUsers ? '✅' : '❌'}`);  
    console.log(`   - Only collections: ${onlyCollections ? '✅' : '❌'}`);

    // Xóa dữ liệu hiện có (trừ khi skip)
    if (!skipClear) {
      console.log("🗑️ Đang xóa dữ liệu cũ...");
      if (!onlyUsers && !onlyCollections) await Product.deleteMany();
      if (!onlyProducts && !onlyCollections) await User.deleteMany();
      if (!onlyProducts && !onlyUsers) await Collection.deleteMany();
      console.log("✅ Đã xóa dữ liệu cũ");
    }

    // Lấy dữ liệu từ DataManager
    const data = await dataManager.getAllData({
      uploadImages: uploadImages,
      includeExistingData: true,
      createSamples: true
    });

    let adminUser = null;

    // Import Users (nếu không chỉ products/collections)
    if (!onlyProducts && !onlyCollections) {
      console.log("👥 Đang import users...");
      
      // Tạo admin user trước
      adminUser = await User.create({
        name: "Admin User",
        email: "admin@example.com", 
        password: "123456",
        role: "admin",
      });
      console.log("👑 Admin user đã được tạo");

      // Import các users khác
      if (data.users.length > 0) {
        await User.insertMany(data.users);
        console.log(`✅ Đã import ${data.users.length} users`);
      }
    } else {
      // Nếu không import users, tìm admin user hiện có
      adminUser = await User.findOne({ email: "admin@example.com" });
      if (!adminUser) {
        console.log("⚠️ Không tìm thấy admin user, tạo mới...");
        adminUser = await User.create({
          name: "Admin User",
          email: "admin@example.com",
          password: "123456", 
          role: "admin",
        });
      }
    }

    // Import Collections (nếu không chỉ products/users)
    if (!onlyProducts && !onlyUsers) {
      console.log("🏷️ Đang import collections...");
      if (data.collections.length > 0) {
        await Collection.insertMany(data.collections);
        console.log(`✅ Đã import ${data.collections.length} collections`);
      }
    }

    // Import Products (nếu không chỉ users/collections)
    if (!onlyUsers && !onlyCollections) {
      console.log("📦 Đang import products...");
      
      // Thêm user ID vào tất cả products
      const productsWithUser = data.products.map(product => ({
        ...product,
        user: adminUser._id,
        // Xóa _id nếu có để MongoDB tự tạo
        _id: undefined
      }));

      if (productsWithUser.length > 0) {
        const insertedProducts = await Product.insertMany(productsWithUser);
        console.log(`✅ Đã import ${insertedProducts.length} products`);
      }
    }

    // Hiển thị thống kê cuối cùng
    await displayStatistics();

    // Lưu backup nếu cần
    if (uploadImages) {
      await dataManager.saveToFile(data, `backup-${Date.now()}.json`);
    }

    console.log("\n🎉 Import dữ liệu hoàn thành!");
    process.exit(0);

  } catch (error) {
    console.error(`❌ Lỗi: ${error.message}`);
    console.error(error);
    process.exit(1);
  }
};

// Destroy data
const destroyData = async () => {
  try {
    const confirmArgs = ['--confirm', '-y', '--yes'];
    const isConfirmed = confirmArgs.some(arg => process.argv.includes(arg));
    
    if (!isConfirmed) {
      console.log("⚠️ Cảnh báo: Bạn sắp xóa TẤT CẢ dữ liệu!");
      console.log("Thêm --confirm để xác nhận: npm run seed:destroy -- --confirm");
      process.exit(1);
    }

    console.log("🗑️ Đang xóa tất cả dữ liệu...");
    
    await Product.deleteMany();
    await User.deleteMany(); 
    await Collection.deleteMany();

    console.log("✅ Đã xóa tất cả dữ liệu");
    process.exit(0);
  } catch (error) {
    console.error(`❌ Lỗi: ${error.message}`);
    process.exit(1);
  }
};

// Hiển thị thống kê
const displayStatistics = async () => {
  try {
    const [userCount, productCount, collectionCount] = await Promise.all([
      User.countDocuments(),
      Product.countDocuments(), 
      Collection.countDocuments()
    ]);

    console.log("\n📊 THỐNG KÊ DATABASE:");
    console.log(`   👥 Users: ${userCount}`);
    console.log(`   📦 Products: ${productCount}`);
    console.log(`   🏷️ Collections: ${collectionCount}`);

    // Thống kê products theo collection
    if (productCount > 0) {
      const productStats = await Product.aggregate([
        {
          $group: {
            _id: "$collection",
            count: { $sum: 1 },
            avgPrice: { $avg: "$price" }
          }
        },
        { $sort: { count: -1 } }
      ]);

      console.log("\n📈 THỐNG KÊ PRODUCTS THEO COLLECTION:");
      productStats.forEach(stat => {
        console.log(`   ${stat._id}: ${stat.count} sản phẩm (TB: ${Math.round(stat.avgPrice).toLocaleString()}đ)`);
      });
    }

  } catch (error) {
    console.error("Lỗi khi hiển thị thống kê:", error.message);
  }
};

// Xử lý tham số dòng lệnh
const action = process.argv[2];

switch (action) {
  case '-d':
  case '--destroy':
    destroyData();
    break;
  case '--stats':
    mongoose
      .connect(process.env.MONGO_URI, {
        useNewUrlParser: true,
        useUnifiedTopology: true,
      })
      .then(async () => {
        await displayStatistics();
        process.exit(0);
      })
      .catch((err) => {
        console.error("MongoDB connection error:", err);
        process.exit(1);
      });
    break;
  default:
    importData();
    break;
}

/* 
CÁCH SỬ DỤNG:

1. Import tất cả dữ liệu (không upload ảnh):
   npm run seed
   
2. Import tất cả dữ liệu + upload ảnh lên Cloudinary:
   npm run seed -- --upload-images
   
3. Import chỉ products:
   npm run seed -- --only-products
   
4. Import chỉ users: 
   npm run seed -- --only-users
   
5. Import chỉ collections:
   npm run seed -- --only-collections
   
6. Import mà không xóa dữ liệu cũ:
   npm run seed -- --skip-clear
   
7. Xóa tất cả dữ liệu:
   npm run seed -- --destroy --confirm
   
8. Xem thống kê:
   npm run seed -- --stats

CẤU HÌNH CLOUDINARY (tùy chọn):
Thêm vào file .env:
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key  
CLOUDINARY_API_SECRET=your_api_secret
*/

===== FILE: ./backend/server.js =====
const express = require("express");
const cors = require("cors");
const dotenv = require("dotenv");
const cookieParser = require("cookie-parser");

// Load env vars first
dotenv.config();

const rateLimit = require("express-rate-limit");
const helmet = require("helmet");
const session = require("express-session");
const passport = require("passport");
const connectDB = require("./config/db");
const userRoutes = require("./routes/userRoutes");
const productRoutes = require("./routes/productRoutes");
const cartRoutes = require("./routes/cartRoutes");
const checkoutRoutes = require("./routes/checkoutRoutes");
const authRoutes = require("./routes/authRoutes");
const orderRoutes = require("./routes/orderRoutes");
const uploadRoutes = require("./routes/uploadRoutes");
const adminRoutes = require("./routes/adminRoutes");
const productAdminRoutes = require("./routes/productAdminRoutes");
const adminOrderRoutes = require("./routes/adminOrderRoutes");
const collectionRoutes = require("./routes/collectionRoutes");
const paymentRoutes = require("./routes/paymentRoutes");
const app = express();

// Connect to MongoDB
connectDB();

// Basic middleware - nên đặt trước các middleware khác
app.use(express.json());
app.use(
  cors({
    origin: ["http://localhost:5173", "http://localhost:3000"],
    credentials: true,
    methods: ["GET", "POST", "PUT", "DELETE"],
    allowedHeaders: ["Content-Type", "Authorization"],
  })
);

app.use(cookieParser());

// Security middleware
app.use(helmet());

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100000000000000, // limit each IP to 100 requests per windowMs
  message: {
    error: "Too many authentication attempts, please try again later.",
  },
  standardHeaders: true,
  legacyHeaders: false,
});

// Apply rate limiting to all API requests
app.use("/api/", limiter);

// Session configuration for Passport
app.use(
  session({
    secret: process.env.SESSION_SECRET || "your_session_secret",
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: process.env.NODE_ENV === "production",
      maxAge: 24 * 60 * 60 * 1000, // 24 hours
    },
  })
);

// Import passport config
require("./config/passport");

// Passport middleware
app.use(passport.initialize());
app.use(passport.session());

// Routes
app.get("/", (req, res) => {
  res.send("Hello from the server!");
});

// API routes
app.use("/api/users", userRoutes);
app.use("/api/products", productRoutes);
app.use("/api/cart", cartRoutes);
app.use("/api/checkout", checkoutRoutes);
app.use("/api/auth", authRoutes);
app.use("/api/orders", orderRoutes);
app.use("/api/upload", uploadRoutes);
app.use("/api/payment", paymentRoutes);

// Admin routes
app.use("/api/admin", adminRoutes);
app.use("/api/admin/products", productAdminRoutes);
app.use("/api/admin/orders", adminOrderRoutes);

// Collection routes
app.use("/api/collections", collectionRoutes);

// Error handling middleware - phải đặt sau tất cả các routes
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ message: "Internal Server Error" });
});

const PORT = process.env.PORT || 3000;

// Start the server
app.listen(PORT, () => {
  console.log(`Server is running on http://localhost:${PORT}`);
});


===== FILE: ./backend/vercel.json =====
{
    "version": 2,
    "name": "my-backend",
    "builds": [
        {
        "src": "server.js",
        "use": "@vercel/node"
        }
    ],
    "routes": [
        {
        "src": "/(.*)",
        "dest": "server.js"
        }
    ]
}

===== FILE: ./frontend/env.txt =====
VITE_PAYPLA_CLIENT_ID=your_paypal_client_id
# VITE_PAYPAL_SECRET=your_paypal_secret
VITE_BACKEND_URL=http://localhost:9000
# VITE_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key
VITE_FACEBOOK_APP_ID=
# API
VITE_API_URL=http://localhost:9000

===== FILE: ./frontend/src/App.jsx =====
import React from "react";
import { BrowserRouter, Route, Routes } from "react-router-dom";
// user
import UserLayout from "./components/Layout/UserLayout";
import Home from "./pages/Home";
import MyOdersPage from "./components/profile/MyOdersPage";

import ProfileLayout from "./components/profile/ProfileLayout";
import ProfileInfo from "./components/profile/ProfileInfo";
import OrderDetailPage from "./components/profile/OrderDetailPage";
import { OrderProvider } from "./components/profile/OrderContext";
import { CartProvider } from "./components/Cart/CartContext";
import Login from "./pages/Login";
import Signup from "./pages/Signup";
import Collection from "./pages/Collection";
import { Toaster } from "sonner";
import ProductDetails from "./components/Products/ProductDetails";
import Information from "./pages/Information";
import About from "./components/information/About";
import Sponsorship from "./components/information/Sponsorship";
import Policy from "./pages/Policy";
import Cart from "./pages/Cart";
import Checkout from "./pages/Checkout";
import { Provider } from "react-redux";
import store from "./redux/store";
import GoogleCallback from "./pages/GoogleCallback";
import GenderCollection from "./pages/GenderCollection";
import CheckoutBuyNow from "./pages/CheckoutBuyNow";
// ==================================================
// admin
import AdminHomePage from "./pages/AdminHomePage";
import AdminLayout from "./components/Admin/AdminLayout";
import UserManagement from "./components/Admin/UserManagement";
import ProductManagement from "./components/Admin/ProductManagement";
import EditProductPage from "./components/Admin/EditProductPage";
import OrderManagement from "./components/Admin/OrderManagement";
import CollectionManagement from "./components/Admin/CollectionManagement";
import EditCollection from "./components/Admin/EditCollection";
// ==================================================
import PublicOnlyRoute from "./components/Auth/PublicOnlyRoute";
import PrivateRoute from "./components/Auth/PrivateRoute";
import AdminRoute from "./components/Auth/AdminRoute";
import axios from 'axios';
axios.defaults.withCredentials = true;
const App = () => {
  return (
    <Provider store={store}>
      <BrowserRouter>
        <CartProvider>
          <OrderProvider>
            <Toaster position="top-right" duration={2000} />
            <Routes>
              <Route path="/" element={<UserLayout />}>
                <Route index element={<Home />} />

                {/* Public only routes (redirect to home if logged in) */}
                <Route element={<PublicOnlyRoute />}>
                  <Route path="login" element={<Login />} />
                  <Route path="signup" element={<Signup />} />
                </Route>

                <Route path="collections/:id" element={<Collection />} />
                <Route path="gendercollections/:id" element={<GenderCollection />} />
                <Route path="product/:id" element={<ProductDetails />} />
                <Route path="cart" element={<Cart />} />

                {/* Protected routes (require authentication) */}
                <Route element={<PrivateRoute />}>
                  <Route path="checkout" element={<Checkout />} />
                  <Route path="checkout-buy-now" element={<CheckoutBuyNow />} />
                  <Route path="profile" element={<ProfileLayout />}>
                    <Route index element={<ProfileInfo />} />
                    <Route path="info" element={<ProfileInfo />} />
                    <Route path="orders" element={<MyOdersPage />} />
                    <Route path="orders/:id" element={<OrderDetailPage />} />
                  </Route>
                </Route>

                <Route path="auth/success" element={<GoogleCallback />} />
                <Route path="information" element={<Information />}>
                  <Route path="about" element={<About />} />
                  <Route path="sponsorship" element={<Sponsorship />} />
                </Route>
                <Route path="policy" element={<Policy />} />
              </Route>

              {/* Admin routes (require admin role) */}
              <Route element={<AdminRoute />}>
                <Route path="/admin" element={<AdminLayout />}>
                  <Route index element={<AdminHomePage />} />
                  <Route path="users" element={<UserManagement />} />
                  <Route path="products" element={<ProductManagement />} />
                  <Route path="products/:id" element={<EditProductPage />} />
                  <Route path="orders" element={<OrderManagement />} />
                  <Route path="collections" element={<CollectionManagement />} />
                  <Route path="collections/:id" element={<EditCollection />} />
                </Route>
              </Route>
            </Routes>
          </OrderProvider>
        </CartProvider>
      </BrowserRouter>
    </Provider>
  );
};

export default App;


===== FILE: ./frontend/src/assets/dummyData.js =====
// src/dummyData.js
import linenWomenBanner from "../assets/images/linen/banner-linen-collection-men.jpg";

function generateProducts(prefix, startIndex) {
  const products = [];
  const categories = [
    "Áo phông",
    "Áo sơ mi",
    "Quần tây",
    "Quần short",
    "Áo khoác",
  ];

  for (let i = 0; i < 20; i++) {
    products.push({
      _id: `${prefix}${i + 1}`,
      name: `${prefix} Product ${i + 1}`,
      price: Math.floor(Math.random() * 2000000 + 500000),
      discountPrice: Math.floor(Math.random() * 2000000 + 500000),
      category: categories[Math.floor(Math.random() * categories.length)],
      sizes: ["S", "M", "L", "XL", "XXL"],
      colors: ["red", "blue", "green", "yellow", "purple"],
      material: "cotton",
      description: "This is a description for the product",
      images: [
        {
          url: `https://picsum.photos/500/500?random=${startIndex + i}`,
          altText: `${prefix} Product ${i + 1}`,
        },
        {
          url: `https://picsum.photos/500/500?random=${startIndex + i + 75}`,
          altText: `${prefix} Product ${i + 1}`,
        },
        {
          url: `https://picsum.photos/500/500?random=${startIndex + i + 150}`,
          altText: `${prefix} Product ${i + 1}`,
        },
        {
          url: `https://picsum.photos/500/500?random=${startIndex + i + 225}`,
          altText: `${prefix} Product ${i + 1}`,
        },
      ],
      featured: i < 4, // 4 sản phẩm đầu là nổi bật
    });
  }
  return products;
}

export const collections = [
  {
    id: "summer",
    name: "Summer Collection",
    bannerUrl: linenWomenBanner,
    description: "Bộ sưu tập mùa hè 2025 mang đến làn gió mới với những thiết kế trẻ trung, năng động và đầy màu sắc, sử dụng chất liệu nhẹ mát, thoáng khí, phù hợp cho mọi hoạt động ngày hè – từ dạo phố, đi biển đến những buổi hẹn hò đầy cảm hứng.",
    products: generateProducts("Summer", 1),
  },
  {
    id: "winter",
    name: "Winter Collection",
    bannerUrl: "https://picsum.photos/500/500?random=100",
    description: "Bộ sưu tập mùa đông 2025 là sự kết hợp giữa vẻ đẹp hiện đại và cảm giác ấm áp, với những thiết kế dày dặn, phom dáng ôm vừa vặn, gam màu trung tính sang trọng cùng các chất liệu như len, dạ, lông và nỉ cao cấp – mang đến cho bạn phong cách tinh tế và tự tin trong những ngày đông lạnh giá.",
    products: generateProducts("Winter", 21),
  },
  {
    id: "autumn",
    name: "Autumn Collection",
    bannerUrl: "https://picsum.photos/500/500?random=111",
    description: "Bộ sưu tập mùa thu 2025 mang đến hơi thở dịu dàng và sâu lắng của thời khắc chuyển mùa, với những thiết kế tinh tế, gam màu ấm áp như nâu đất, cam cháy, be nhạt cùng chất liệu mềm mại, giữ ấm nhẹ nhàng – lý tưởng cho những buổi chiều se lạnh đầy cảm xúc và phong cách.",
    products: generateProducts("Autumn", 41),
  },
  {
    id: "man",
    name: "Đồ nam",
    bannerUrl: "https://picsum.photos/500/500?random=200",
    products: generateProducts("Linen", 61),
  },
  {
    id: "women",
    name: "Đồ nữ",
    bannerUrl: "https://picsum.photos/500/500?random=200",
    products: generateProducts("Casual", 81),
  },
];


===== FILE: ./frontend/src/components/Admin/AdminLayout.jsx =====
import React, { useState } from 'react'
import { GrClose, GrMenu } from "react-icons/gr";
import AdminSidebar from './AdminSidebar';
import { Outlet } from 'react-router-dom';

const AdminLayout = () => {
    const [isSidebarOpen, setIsSidebarOpen] = useState(false)

    const toggleSidebar = () => {
        setIsSidebarOpen(!isSidebarOpen)
    };
    return (
        <div className='min-h-screen flex flex-col md:flex-row relative'>
            {/* mobile toggle button */}
            <div className=' flex md:hidden p-4 bg-gray-800 text-white z-20'>
                <button onClick={toggleSidebar}>
                    <GrMenu size={24} />
                </button>
                <h1 className='ml-4 text-xl font-medium'>Bảng điều khiển</h1>
            </div>

            {/* overlay for mobile sidebar */}
            {isSidebarOpen && (
                <div
                    className='fixed inset-0 bg-black/50 z-10 md:hidden'
                    onClick={toggleSidebar}
                >

                </div>
            )}

            {/* sidebar */}
            <div className={`bg-black w-64 min-h-screen text-white absolute md:relative transform ${isSidebarOpen ? "translate-x-0" : "-translate-x-full"} transition-transform duration-300 md:translate-x-0 md:static ease-in-out z-20`}>
                {/* sidebar */}
                <AdminSidebar />
            </div>

            {/* main content */}
            <div className='flex-grow p-6 overflow-auto'>
                <Outlet />
            </div>

        </div>
    )
}

export default AdminLayout

===== FILE: ./frontend/src/components/Admin/AdminSidebar.jsx =====
import React from 'react'
import { FaBoxOpen, FaClipboardList, FaSignOutAlt, FaStore, FaUser } from 'react-icons/fa';
import { Link, NavLink, useNavigate } from 'react-router-dom';
import { BsCollectionFill } from "react-icons/bs";

const AdminSidebar = () => {
    const navigate = useNavigate();
    const handleLogout = () => {
        navigate("/");
    }
    return (
        <div className='p-6'>
            <div className='mb-3'>
                <Link to="/admin" className='text-2xl font-medium'>
                    Wukudada
                </Link>
            </div>
            <nav className='flex flex-col space-y-2'>
                {/* users */}
                <NavLink
                    to="/admin/users"
                    className={({ isActive }) =>
                        isActive
                            ? "bg-gray-800 text-white py-3 px-4 flex items-center space-x-2"
                            : "text-gray-300 hover:bg-gray-800 hover:text-white py-3 px-4 flex items-center space-x-2"}
                >
                    <FaUser size={20} />
                    <span>Tài khoản</span>
                </NavLink>
                {/* products */}
                <NavLink
                    to="/admin/products"
                    className={({ isActive }) =>
                        isActive
                            ? "bg-gray-800 text-white py-3 px-4 flex items-center space-x-2"
                            : "text-gray-300 hover:bg-gray-800 hover:text-white py-3 px-4 flex items-center space-x-2"}
                >
                    <FaBoxOpen size={20} />
                    <span>Sản phẩm  </span>
                </NavLink>
                {/* collections */}
                <NavLink
                    to="/admin/collections"
                    className={({ isActive }) =>
                        isActive
                            ? "bg-gray-800 text-white py-3 px-4 flex items-center space-x-2"
                            : "text-gray-300 hover:bg-gray-800 hover:text-white py-3 px-4 flex items-center space-x-2"}
                >
                    <BsCollectionFill size={20} />
                    <span>Bộ sưu tập  </span>
                </NavLink>
                {/* orders */}
                <NavLink
                    to="/admin/orders"
                    className={({ isActive }) => isActive
                        ? "bg-gray-800 text-white py-3 px-4 flex items-center space-x-2"
                        : "text-gray-300 hover:bg-gray-800 hover:text-white py-3 px-4 flex items-center space-x-2"}
                >
                    <FaClipboardList size={20} />
                    <span>Đơn hàng</span>
                </NavLink>
                {/* shop */}
                <NavLink
                    to="/"
                    className={({ isActive }) =>
                        isActive
                            ? "bg-gray-800 text-white py-3 px-4 flex items-center space-x-2"
                            : "text-gray-300 hover:bg-gray-800 hover:text-white py-3 px-4 flex items-center space-x-2"}
                >
                    <FaStore size={20} />
                    <span>Cửa hàng</span>
                </NavLink>
            </nav>
        </div>
    )
}

export default AdminSidebar;



===== FILE: ./frontend/src/components/Admin/CollectionManagement.jsx =====
import { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const CollectionManagement = () => {
  const [collections, setCollections] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [filteredCollections, setFilteredCollections] = useState([]);

  useEffect(() => {
    const fetchCollections = async () => {
      try {
        const res = await axios.get(`${API_URL}/api/collections`);
        setCollections(res.data || []);
        setFilteredCollections(res.data || []);
      } catch (err) {
        setCollections([]);
        setFilteredCollections([]);
      } finally {
        setLoading(false);
      }
    };
    fetchCollections();
  }, []);

  // Hàm xử lý tìm kiếm
  useEffect(() => {
    const searchResults = collections.filter((collection) => {
      const searchLower = searchTerm.toLowerCase();
      return (
        collection.id.toLowerCase().includes(searchLower) ||
        collection.name.toLowerCase().includes(searchLower) ||
        (collection.description || "").toLowerCase().includes(searchLower) ||
        (collection.status || "").toLowerCase().includes(searchLower) ||
        (collection.categories || []).some((cat) =>
          cat.toLowerCase().includes(searchLower)
        )
      );
    });
    setFilteredCollections(searchResults);
  }, [searchTerm, collections]);

  const handleDelete = async (id) => {
    if (window.confirm("Bạn có chắc chắn muốn xóa bộ sưu tập này không?")) {
      try {
        const userToken =
          localStorage.getItem("userToken") || localStorage.getItem("token");
        await axios.delete(`${API_URL}/api/collections/${id}`, {
          headers: { Authorization: `Bearer ${userToken}` },
        });
        setCollections(collections.filter((c) => c._id !== id));
        alert("Xóa bộ sưu tập thành công!");
      } catch (err) {
        alert("Xóa bộ sưu tập thất bại!");
      }
    }
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold">Quản lý bộ sưu tập</h2>
        <Link
          to="/admin/collections/new"
          className="bg-black text-white px-4 py-2 hover:bg-gray-700 cursor-pointer"
        >
          Thêm bộ sưu tập
        </Link>
      </div>

      {/* Thanh tìm kiếm */}
      <div className="mb-6">
        <div className="relative">
          <input
            type="text"
            placeholder="Tìm kiếm theo tên, ID, mô tả hoặc danh mục..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          {searchTerm && (
            <button
              onClick={() => setSearchTerm("")}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
            >
              ✕
            </button>
          )}
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-left text-gray-500 border border-gray-100 border-collapse table-fixed">
          <thead className="text-xs text-gray-700 uppercase bg-gray-100">
            <tr>
              <th className="w-1/3 px-3 py-3">Tên bộ sưu tập</th>
              <th className="w-1/3 px-3 py-3">ID</th>
              <th className="w-1/3 px-3 py-3">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={3} className="p-4 text-center">
                  Đang tải...
                </td>
              </tr>
            ) : filteredCollections.length > 0 ? (
              filteredCollections.map((collection) => (
                <tr
                  key={collection._id}
                  className="bg-white border-b border-gray-100"
                >
                  <td className="p-4 font-medium text-gray-900 whitespace-nowrap">
                    {collection.name}
                  </td>
                  <td className="p-4">{collection.id}</td>
                  <td className="p-4">
                    <Link
                      to={`/admin/collections/${collection.id}`}
                      className="inline-flex items-center bg-black text-white px-3 py-1 mr-2 hover:bg-gray-700 cursor-pointer"
                    >
                      Sửa
                    </Link>
                    <button
                      onClick={() => handleDelete(collection.id)}
                      className="inline-flex items-center text-black px-3 py-1 border border-black hover:border-gray-700 hover:text-gray-700 cursor-pointer"
                    >
                      Xóa
                    </button>
                  </td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan={3} className="p-4 text-center">
                  {searchTerm
                    ? "Không tìm thấy bộ sưu tập phù hợp"
                    : "Không có bộ sưu tập nào."}
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default CollectionManagement;


===== FILE: ./frontend/src/components/Admin/EditCollection.jsx =====
import React, { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const EditCollection = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const isEdit = id && id !== "new";
  const [collectionData, setCollectionData] = useState({
    id: "",
    name: "",
    description: "",
    image: "",
    status: "active",
    categories: [],
  });
  const [loading, setLoading] = useState(true);
  const [newCategory, setNewCategory] = useState("");
  const userToken =
    localStorage.getItem("userToken") || localStorage.getItem("token") || "";

  useEffect(() => {
    if (isEdit) {
      const fetchCollection = async () => {
        try {
          const res = await axios.get(`${API_URL}/api/collections/${id}`);
          setCollectionData({
            id: res.data.id || "",
            name: res.data.name || "",
            description: res.data.description || "",
            image: res.data.bannerUrl || "",
            status: res.data.status || "active",
            categories: res.data.categories || [],
          });
        } catch (err) {
          alert("Không tìm thấy bộ sưu tập!");
        } finally {
          setLoading(false);
        }
      };
      fetchCollection();
    } else {
      setLoading(false);
    }
  }, [id, isEdit]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setCollectionData((prevData) => ({
      ...prevData,
      [name]: value,
    }));
  };

  const handleAddCategory = () => {
    if (!newCategory.trim()) return;
    if (collectionData.categories.includes(newCategory.trim())) {
      alert("Danh mục này đã tồn tại!");
      return;
    }
    setCollectionData((prev) => ({
      ...prev,
      categories: [...prev.categories, newCategory.trim()],
    }));
    setNewCategory("");
  };

  const handleRemoveCategory = (categoryToRemove) => {
    setCollectionData((prev) => ({
      ...prev,
      categories: prev.categories.filter((cat) => cat !== categoryToRemove),
    }));
  };

  const handleImageUpload = async (e) => {
    const file = e.target.files[0];
    if (!userToken) {
      alert("Bạn cần đăng nhập admin để upload ảnh!");
      return;
    }
    if (file) {
      const formData = new FormData();
      formData.append("image", file);
      const response = await axios.post(`${API_URL}/api/upload`, formData, {
        headers: { Authorization: `Bearer ${userToken}` },
      });
      setCollectionData((prev) => ({
        ...prev,
        image: response.data.imageUrl,
      }));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!userToken) {
      alert("Bạn cần đăng nhập admin để thực hiện thao tác này!");
      return;
    }
    if (!collectionData.name) {
      alert("Bạn phải nhập tên bộ sưu tập!");
      return;
    }
    if (!collectionData.image) {
      alert("Bạn phải upload ảnh đại diện cho bộ sưu tập!");
      return;
    }

    try {
      if (isEdit) {
        const payload = {
          name: collectionData.name,
          bannerUrl: collectionData.image,
          description: collectionData.description,
          status: collectionData.status,
          categories: collectionData.categories,
        };
        await axios.put(
          `${API_URL}/api/collections/${collectionData.id}`,
          payload,
          {
            headers: { Authorization: `Bearer ${userToken}` },
          }
        );
        alert("Cập nhật bộ sưu tập thành công!");
      } else {
        if (!collectionData.id) {
          alert("Bạn phải nhập ID cho bộ sưu tập!");
          return;
        }
        const payload = {
          id: collectionData.id,
          name: collectionData.name,
          bannerUrl: collectionData.image,
          description: collectionData.description,
          status: collectionData.status,
          products: [],
          categories: collectionData.categories,
        };
        await axios.post(`${API_URL}/api/collections`, payload, {
          headers: { Authorization: `Bearer ${userToken}` },
        });
        alert("Tạo bộ sưu tập mới thành công!");
      }
      navigate("/admin/collections");
    } catch (err) {
      alert("Thao tác thất bại!");
    }
  };

  if (loading)
    return <div className="text-center mt-10">Đang tải bộ sưu tập...</div>;

  return (
    <div className="w-full mx-auto p-6">
      <form
        onSubmit={handleSubmit}
        className="flex flex-col gap-4 max-w-xl mx-auto"
      >
        {/* ID bộ sưu tập */}
        {!isEdit ? (
          <div>
            <label className="block font-medium text-lg">
              ID bộ sưu tập (phải là duy nhất)
            </label>
            <input
              type="text"
              name="id"
              value={collectionData.id}
              onChange={handleChange}
              className="w-full border border-gray-300 p-2"
              required
            />
          </div>
        ) : (
          <div>
            <label className="block font-medium text-lg">ID bộ sưu tập</label>
            <input
              type="text"
              value={collectionData.id}
              disabled
              className="w-full border border-gray-300 p-2 bg-gray-100 text-gray-500"
            />
          </div>
        )}

        {/* Tên bộ sưu tập */}
        <div>
          <label className="block font-medium text-lg">Tên bộ sưu tập</label>
          <input
            type="text"
            name="name"
            value={collectionData.name}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
            required
          />
        </div>

        {/* Mô tả */}
        <div>
          <label className="block font-medium text-lg">Mô tả</label>
          <textarea
            name="description"
            value={collectionData.description}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
            rows={4}
          />
        </div>

        {/* Danh mục sản phẩm */}
        <div>
          <label className="block font-medium text-lg">Danh mục sản phẩm</label>
          <div className="flex gap-2 mb-2">
            <input
              type="text"
              value={newCategory}
              onChange={(e) => setNewCategory(e.target.value)}
              placeholder="Nhập tên danh mục"
              className="flex-1 border border-gray-300 p-2"
            />
            <button
              type="button"
              onClick={handleAddCategory}
              className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            >
              Thêm
            </button>
          </div>
          <div className="flex flex-wrap gap-2">
            {collectionData.categories.map((category, index) => (
              <div
                key={index}
                className="bg-gray-100 px-3 py-1 rounded-full flex items-center gap-2"
              >
                <span>{category}</span>
                <button
                  type="button"
                  onClick={() => handleRemoveCategory(category)}
                  className="text-red-600 hover:text-red-800"
                >
                  ×
                </button>
              </div>
            ))}
          </div>
        </div>

        {/* Ảnh đại diện */}
        <div>
          <label className="block font-medium text-lg">Ảnh đại diện</label>
          {collectionData.image && (
            <div className="mb-2">
              <img
                src={collectionData.image}
                alt="Collection"
                className="w-32 h-32 object-cover border mb-2"
              />
              <button
                type="button"
                onClick={() =>
                  setCollectionData((prev) => ({ ...prev, image: "" }))
                }
                className="text-red-600 underline text-sm"
              >
                Xóa ảnh
              </button>
            </div>
          )}
          <div className="mb-2">
            <button
              type="button"
              onClick={() => document.getElementById("fileInput").click()}
              className="bg-gray-200 px-2 py-1 border border-gray-300 hover:bg-gray-300"
            >
              Chọn ảnh
            </button>
            <input
              type="file"
              id="fileInput"
              accept="image/*"
              onChange={handleImageUpload}
              style={{ display: "none" }}
            />
          </div>
        </div>

        {/* Trạng thái */}
        <div>
          <label className="block font-medium text-lg">Trạng thái</label>
          <select
            name="status"
            value={collectionData.status}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
          >
            <option value="active">Hoạt động</option>
            <option value="inactive">Ẩn</option>
          </select>
        </div>

        <div className="flex gap-4 mt-8">
          <button
            type="submit"
            className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
          >
            {isEdit ? "Lưu thay đổi" : "Tạo mới"}
          </button>
          <button
            type="button"
            className="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500"
            onClick={() => navigate("/admin/collections")}
          >
            Hủy bỏ
          </button>
        </div>
      </form>
    </div>
  );
};

export default EditCollection;


===== FILE: ./frontend/src/components/Admin/EditProductPage.jsx =====
import React, { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";
const userToken =
  localStorage.getItem("userToken") || localStorage.getItem("token") || "";

const EditProductPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const isEdit = id && id !== "new";
  const [productData, setProductData] = useState({
    name: "",
    description: "",
    price: 0,
    countInStock: 0,
    sku: "",
    category: "",
    sizes: [],
    colors: [],
    collection: "",
    material: "",
    gender: "",
    images: [],
    dimensions: {
      length: "",
      width: "",
      height: "",
      weight: "",
    },
  });
  const [loading, setLoading] = useState(true);
  const [collections, setCollections] = useState([]);
  const [availableCategories, setAvailableCategories] = useState([]);

  // Fetch collections
  useEffect(() => {
    const fetchCollections = async () => {
      try {
        const collectionsRes = await axios.get(`${API_URL}/api/collections`);
        setCollections(collectionsRes.data);
      } catch (err) {
        console.error("Error fetching collections:", err);
      }
    };
    fetchCollections();
  }, []);

  // Update available categories when collection changes
  useEffect(() => {
    if (productData.collection) {
      const selectedCollection = collections.find(
        (c) => c.id === productData.collection
      );
      if (selectedCollection) {
        setAvailableCategories(selectedCollection.categories || []);
        if (!selectedCollection.categories?.includes(productData.category)) {
          setProductData((prev) => ({ ...prev, category: "" }));
        }
      }
    } else {
      setAvailableCategories([]);
      setProductData((prev) => ({ ...prev, category: "" }));
    }
  }, [productData.collection, collections]);

  // Lấy dữ liệu sản phẩm khi vào trang (chỉ khi chỉnh sửa)
  useEffect(() => {
    if (isEdit) {
      const fetchProduct = async () => {
        try {
          const res = await axios.get(`${API_URL}/api/products/${id}`);
          setProductData({
            ...res.data,
            sizes: res.data.sizes || [],
            colors: res.data.colors || [],
            images: res.data.images || [],
            dimensions: res.data.dimensions || {
              length: "",
              width: "",
              height: "",
              weight: "",
            },
          });
        } catch (err) {
          alert("Không tìm thấy sản phẩm!");
        } finally {
          setLoading(false);
        }
      };
      fetchProduct();
    } else {
      setLoading(false); // Nếu là tạo mới thì không cần loading
    }
  }, [id, isEdit]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setProductData((prevData) => ({
      ...prevData,
      [name]: value,
    }));
  };
  // Xử lý upload ảnh
  const handleImageUpload = async (e) => {
    const file = e.target.files[0];
    if (!userToken) {
      alert("Bạn cần đăng nhập admin để upload ảnh!");
      return;
    }
    if (file) {
      const formData = new FormData();
      formData.append("image", file);
      const response = await axios.post(`${API_URL}/api/upload`, formData, {
        headers: { Authorization: `Bearer ${userToken}` },
      });
      setProductData((prev) => ({
        ...prev,
        images: [
          ...prev.images,
          { url: response.data.imageUrl, alt: "Product Image" },
        ],
      }));
    }
  };
  // Xử lý submit cập nhật sản phẩm
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!userToken) {
      alert("Bạn cần đăng nhập admin để thực hiện thao tác này!");
      return;
    }
    const userInfo = JSON.parse(localStorage.getItem("userInfo"));
    if (!productData.images || productData.images.length === 0) {
      alert("Bạn phải upload ít nhất 1 ảnh sản phẩm!");
      return;
    }
    if (
      !productData.dimensions ||
      !productData.dimensions.length ||
      !productData.dimensions.width ||
      !productData.dimensions.height ||
      !productData.dimensions.weight
    ) {
      alert("Bạn phải nhập đầy đủ kích thước (length, width, height, weight)!");
      return;
    }
    const fixedProductData = {
      ...productData,
      user: userInfo?._id || userInfo?.id,
      price: Number(productData.price),
      discountPrice: Number(productData.discountPrice),
      countInStock: Number(productData.countInStock),
      sizes: Array.isArray(productData.sizes) ? productData.sizes : [],
      colors: Array.isArray(productData.colors) ? productData.colors : [],
      images: (productData.images || []).map((img) => ({
        url: img.url,
        altText: img.altText || img.alt || "Product Image",
      })),
      dimensions: {
        length: Number(productData.dimensions.length),
        width: Number(productData.dimensions.width),
        height: Number(productData.dimensions.height),
        weight: Number(productData.dimensions.weight),
      },
      gender:
        productData.gender === "man"
          ? "man"
          : productData.gender === "woman"
          ? "woman"
          : "",
    };
    console.log("Dữ liệu gửi lên:", fixedProductData);
    console.log("Các trường bắt buộc:");
    console.log("name:", fixedProductData.name);
    console.log("description:", fixedProductData.description);
    console.log(
      "price:",
      fixedProductData.price,
      typeof fixedProductData.price
    );
    console.log("sku:", fixedProductData.sku);
    console.log("category:", fixedProductData.category);
    console.log(
      "sizes:",
      fixedProductData.sizes,
      Array.isArray(fixedProductData.sizes)
    );
    console.log(
      "colors:",
      fixedProductData.colors,
      Array.isArray(fixedProductData.colors)
    );
    console.log("collection:", fixedProductData.collection);
    console.log("material:", fixedProductData.material);
    console.log("gender:", fixedProductData.gender);
    console.log(
      "images:",
      fixedProductData.images,
      Array.isArray(fixedProductData.images)
    );
    console.log("dimensions:", fixedProductData.dimensions);
    console.log("user:", fixedProductData.user);
    try {
      if (isEdit) {
        await axios.put(`${API_URL}/api/products/${id}`, fixedProductData, {
          headers: { Authorization: `Bearer ${userToken}` },
        });
        alert("Cập nhật sản phẩm thành công!");
      } else {
        await axios.post(`${API_URL}/api/products`, fixedProductData, {
          headers: { Authorization: `Bearer ${userToken}` },
        });
        alert("Tạo sản phẩm mới thành công!");
      }
      navigate("/admin/products");
    } catch (err) {
      alert("Thao tác thất bại!");
    }
  };
  if (loading)
    return <div className="text-center mt-10">Đang tải sản phẩm...</div>;
  return (
    <div className="w-full mx-auto p-6">
      <form onSubmit={handleSubmit} className="flex flex-col gap-4">
        {/* name */}
        <div className="">
          <label className="block font-medium text-lg">Tên sản phẩm</label>
          <input
            type="text"
            name="name"
            value={productData.name}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
            required
          />
        </div>
        {/* description */}
        <div className="">
          <label className="block font-medium text-lg">Mô tả</label>
          <textarea
            name="description"
            value={productData.description}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
            rows={4}
            required
          />
        </div>
        {/* price */}
        <div className="">
          <label className="block font-medium text-lg">Giá</label>
          <input
            type="number"
            name="price"
            value={productData.price}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
          />
        </div>
        {/* count In Stock */}
        <div className="">
          <label className="block font-medium text-lg">Số lượng</label>
          <input
            type="number"
            name="countInStock"
            value={productData.countInStock}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
          />
        </div>
        {/* SKU */}
        <div className="">
          <label className="block font-medium text-lg">Mã sản phẩm</label>
          <input
            type="text"
            name="sku"
            value={productData.sku}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
          />
        </div>
        {/* size */}
        <div className="">
          <label className="block font-medium text-lg">
            Kích thước (cách nhau bằng dấu phẩy)
          </label>
          <input
            type="text"
            name="sizes"
            value={productData.sizes.join(", ")}
            onChange={(e) =>
              setProductData((prevData) => ({
                ...prevData,
                sizes: e.target.value
                  .split(",")
                  .map((size) => size.trim().toUpperCase()),
              }))
            }
            className="w-full border border-gray-300 p-2"
          />
        </div>
        {/* color */}
        <div className="">
          <label className="block font-medium text-lg">Màu sắc</label>
          {productData.colors.map((color, idx) => (
            <div key={idx} className="flex gap-2 mb-2">
              <input
                type="text"
                placeholder="Tên màu (VD: Navy)"
                value={color.name}
                onChange={(e) =>
                  setProductData((prevData) => {
                    const updatedColors = [...prevData.colors];
                    updatedColors[idx].name = e.target.value;
                    return { ...prevData, colors: updatedColors };
                  })
                }
                className="border p-1 w-1/2"
              />
              <input
                type="text"
                placeholder="Mã màu (VD: #000080)"
                value={color.code}
                onChange={(e) =>
                  setProductData((prevData) => {
                    const updatedColors = [...prevData.colors];
                    updatedColors[idx].code = e.target.value;
                    return { ...prevData, colors: updatedColors };
                  })
                }
                className="border p-1 w-1/2"
              />
              <button
                type="button"
                onClick={() =>
                  setProductData((prevData) => ({
                    ...prevData,
                    colors: prevData.colors.filter((_, i) => i !== idx),
                  }))
                }
                className="text-red-600"
              >
                X
              </button>
            </div>
          ))}
          <button
            type="button"
            onClick={() =>
              setProductData((prevData) => ({
                ...prevData,
                colors: [...prevData.colors, { name: "", code: "" }],
              }))
            }
            className="text-blue-600"
          >
            + Thêm màu
          </button>
        </div>
        {/* category */}
        <div className="">
          <label className="block font-medium text-lg">Danh mục</label>
          <select
            name="category"
            value={productData.category}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
            disabled={!productData.collection}
          >
            <option value="">Chọn danh mục</option>
            {availableCategories.map((category) => (
              <option key={category} value={category}>
                {category}
              </option>
            ))}
          </select>
        </div>
        {/* collection */}
        <div className="">
          <label className="block font-medium text-lg">Bộ sưu tập</label>
          <select
            name="collection"
            value={productData.collection}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
          >
            <option value="">Chọn bộ sưu tập</option>
            {collections.map((collection) => (
              <option key={collection.id} value={collection.id}>
                {collection.name}
              </option>
            ))}
          </select>
        </div>
        {/* material */}
        <div className="">
          <label className="block font-medium text-lg">Chất liệu</label>
          <input
            type="text"
            name="material"
            value={productData.material}
            onChange={handleChange}
            className="w-full border border-gray-300 p-2"
            placeholder="Enter material"
            required
          />
        </div>
        {/* gender */}
        <div className="">
          <label className="block font-medium text-lg">Giới tính</label>
          <div className="flex gap-4">
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="gender"
                value="men"
                checked={productData.gender === "man"}
                onChange={(e) =>
                  setProductData((prevData) => ({
                    ...prevData,
                    gender: e.target.checked ? "man" : "",
                  }))
                }
              />
              Nam
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="gender"
                value="woman"
                checked={productData.gender === "woman"}
                onChange={(e) =>
                  setProductData((prevData) => ({
                    ...prevData,
                    gender: e.target.checked ? "woman" : "",
                  }))
                }
              />
              Nữ
            </label>
          </div>
        </div>
        {/* images */}
        <div className="">
          <label className="block font-medium text-lg">Ảnh</label>
          <div className="flex gap-4 mb-2">
            {productData.images.map((img, idx) => (
              <img
                key={idx}
                src={img.url}
                alt={img.alt || "Product Image"}
                className="w-20 h-20 object-cover border"
              />
            ))}
          </div>
          <input type="file" accept="image/*" onChange={handleImageUpload} />
        </div>
        {/* dimensions */}
        <div className="mb-6">
          <label className="block font-medium text-lg">Kích thước (cm)</label>
          <div className="grid grid-cols-2 gap-4">
            <input
              type="number"
              name="length"
              placeholder="Chiều dài"
              value={productData.dimensions?.length || ""}
              onChange={(e) =>
                setProductData((prev) => ({
                  ...prev,
                  dimensions: { ...prev.dimensions, length: e.target.value },
                }))
              }
              className="border border-gray-300 p-2"
              required
            />
            <input
              type="number"
              name="width"
              placeholder="Chiều rộng"
              value={productData.dimensions?.width || ""}
              onChange={(e) =>
                setProductData((prev) => ({
                  ...prev,
                  dimensions: { ...prev.dimensions, width: e.target.value },
                }))
              }
              className="border border-gray-300 p-2"
              required
            />
            <input
              type="number"
              name="height"
              placeholder="Chiều cao"
              value={productData.dimensions?.height || ""}
              onChange={(e) =>
                setProductData((prev) => ({
                  ...prev,
                  dimensions: { ...prev.dimensions, height: e.target.value },
                }))
              }
              className="border border-gray-300 p-2"
              required
            />
            <input
              type="number"
              name="weight"
              placeholder="Khối lượng (kg)"
              value={productData.dimensions?.weight || ""}
              onChange={(e) =>
                setProductData((prev) => ({
                  ...prev,
                  dimensions: { ...prev.dimensions, weight: e.target.value },
                }))
              }
              className="border border-gray-300 p-2"
              required
            />
          </div>
        </div>
        <div className="flex gap-4 mt-8">
          <button
            type="submit"
            className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
          >
            Lưu thay đổi
          </button>
          <button
            type="button"
            className="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500"
            onClick={() => navigate("/admin/products")}
          >
            Hủy bỏ thay đổi
          </button>
        </div>
      </form>
    </div>
  );
};

export default EditProductPage;


===== FILE: ./frontend/src/components/Admin/OrderManagement.jsx =====
import React, { useEffect, useState } from "react";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const OrderManagement = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [searchTerm, setSearchTerm] = useState("");
  const [filteredOrders, setFilteredOrders] = useState([]);

  useEffect(() => {
    const fetchOrders = async () => {
      setLoading(true);
      setError("");
      try {
        const userToken =
          localStorage.getItem("userToken") || localStorage.getItem("token");
        const res = await axios.get(`${API_URL}/api/admin/orders`, {
          headers: userToken ? { Authorization: `Bearer ${userToken}` } : {},
        });
        setOrders(res.data || []);
        setFilteredOrders(res.data || []);
      } catch (err) {
        setError("Không thể tải danh sách đơn hàng!");
        setOrders([]);
        setFilteredOrders([]);
      } finally {
        setLoading(false);
      }
    };
    fetchOrders();
  }, []);

  // Hàm xử lý tìm kiếm
  useEffect(() => {
    const searchResults = orders.filter((order) => {
      const searchLower = searchTerm.toLowerCase();
      return (
        order._id.toLowerCase().includes(searchLower) ||
        (order.user?.name || "").toLowerCase().includes(searchLower) ||
        (order.user?.email || "").toLowerCase().includes(searchLower) ||
        (order.status || "").toLowerCase().includes(searchLower) ||
        (order.paymentStatus || "").toLowerCase().includes(searchLower)
      );
    });
    setFilteredOrders(searchResults);
  }, [searchTerm, orders]);

  const handleStatusChange = async (orderId, status) => {
    try {
      const userToken =
        localStorage.getItem("userToken") || localStorage.getItem("token");
      await axios.put(
        `${API_URL}/api/admin/orders/${orderId}`,
        { status },
        { headers: { Authorization: `Bearer ${userToken}` } }
      );
      // Sau khi cập nhật, reload lại danh sách đơn hàng
      const res = await axios.get(`${API_URL}/api/admin/orders`, {
        headers: userToken ? { Authorization: `Bearer ${userToken}` } : {},
      });
      setOrders(res.data || []);
    } catch (err) {
      alert("Cập nhật trạng thái đơn hàng thất bại!");
    }
  };

  const handlePaymentStatusChange = async (orderId, paymentStatus) => {
    try {
      const userToken =
        localStorage.getItem("userToken") || localStorage.getItem("token");
      await axios.put(
        `${API_URL}/api/admin/orders/${orderId}`,
        { paymentStatus },
        { headers: { Authorization: `Bearer ${userToken}` } }
      );
      // Reload lại danh sách đơn hàng
      const res = await axios.get(`${API_URL}/api/admin/orders`, {
        headers: userToken ? { Authorization: `Bearer ${userToken}` } : {},
      });
      setOrders(res.data || []);
    } catch (err) {
      alert("Cập nhật trạng thái thanh toán thất bại!");
    }
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <h2 className="text-3xl font-bold mb-6">Quản lý đơn hàng</h2>

      {/* Thanh tìm kiếm */}
      <div className="mb-6">
        <div className="relative">
          <input
            type="text"
            placeholder="Tìm kiếm theo mã đơn hàng, tên người dùng, email hoặc trạng thái..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          {searchTerm && (
            <button
              onClick={() => setSearchTerm("")}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
            >
              ✕
            </button>
          )}
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-left text-gray-600 border border-gray-100 border-collapse">
          <thead className="text-xs text-black uppercase bg-gray-100">
            <tr>
              <th className="px-4 py-3">Mã đơn hàng</th>
              <th className="px-4 py-3">Người dùng</th>
              <th className="px-4 py-3">Số điện thoại</th>
              <th className="px-4 py-3">Địa chỉ</th>
              <th className="px-4 py-3">Phương thức thanh toán</th>
              <th className="px-4 py-3">Sản phẩm</th>
              <th className="px-4 py-3">Tổng tiền</th>
              <th className="px-4 py-3">Trạng thái</th>
              <th className="px-4 py-3">Trạng thái thanh toán</th>
              <th className="px-4 py-3">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={10} className="px-4 py-6 text-center">
                  Đang tải...
                </td>
              </tr>
            ) : error ? (
              <tr>
                <td colSpan={10} className="px-4 py-6 text-center text-red-500">
                  {error}
                </td>
              </tr>
            ) : filteredOrders.length > 0 ? (
              filteredOrders.map((order) => (
                <tr key={order._id} className="border-b border-gray-100">
                  <td className="p-4 font-medium whitespace-nowrap">
                    #{order._id}
                  </td>
                  <td className="p-4 ">
                    {order.user?.name || order.user?.email || ""}
                  </td>
                  <td className="p-4">
                    {order.phone || order.shippingAddress?.phone || ""}
                  </td>
                  <td className="p-4">
                    {order.address || order.shippingAddress?.address || ""}
                  </td>
                  <td className="p-4">{order.paymentMethod}</td>
                  <td className="p-4">
                    {(order.products || order.orderItems || [])
                      .map((product) => product.name)
                      .join(", ")}
                  </td>
                  <td className="p-4">{order.total || order.totalPrice}</td>
                  <td className="p-4">
                    <select
                      value={order.status || "Pending"}
                      onChange={(e) =>
                        handleStatusChange(order._id, e.target.value)
                      }
                      className="p-1 border border-gray-300"
                    >
                      <option value="Pending">Pending</option>
                      <option value="Processing">Processing</option>
                      <option value="Shipped">Shipped</option>
                      <option value="Delivered">Delivered</option>
                      <option value="Cancelled">Cancelled</option>
                    </select>
                  </td>
                  <td className="p-4">
                    <select
                      value={order.paymentStatus || "Unpaid"}
                      onChange={(e) =>
                        handlePaymentStatusChange(order._id, e.target.value)
                      }
                      className="p-1 border border-gray-300"
                    >
                      <option value="Unpaid">Unpaid</option>
                      <option value="Paid">Paid</option>
                      <option value="Refunded">Refunded</option>
                    </select>
                  </td>
                  <td className="p-4">
                    <button
                      onClick={() => handleStatusChange(order._id, "Delivered")}
                      className="bg-blue-500 text-white px-3 py-1 border border-gray-300 hover:bg-blue-600 cursor-pointer w-20"
                    >
                      Đã giao
                    </button>
                  </td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan={10} className="px-4 text-center">
                  {searchTerm
                    ? "Không tìm thấy đơn hàng phù hợp"
                    : "Không có đơn hàng"}
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default OrderManagement;


===== FILE: ./frontend/src/components/Admin/ProductManagement.jsx =====
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const ProductManagement = () => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedCategory, setSelectedCategory] = useState("all");
  const [selectedGender, setSelectedGender] = useState("all");
  const [searchQuery, setSearchQuery] = useState("");

  const categoryGroups = {
    all: "Tất cả",
    tops: {
      label: "Áo",
      categories: ["Áo sơ mi", "Áo hoodie", "Áo blazer", "Áo vest", "Áo sweater", "Áo henley", "Áo khoác", "Áo thun", "Áo polo"]
    },
    bottoms: {
      label: "Quần",
      categories: ["Quần short", "Quần jogger", "Quần cargo", "Quần legging", "Quần palazzo", "Quần jean", "Quần tây", "Quần culottes"]
    },            
    dresses: {
      label: "Váy & Đầm",
      categories: ["Chân váy", "Đầm maxi", "Váy liền"]
    },
    accessories: {
      label: "Phụ kiện",
      categories: ["Túi xách", "Ví", "Thắt lưng", "Mũ", "Khăn"]
    }
  };

  const categoryOptions = [
    { value: "all", label: "Tất cả" },
    { value: "tops", label: "Áo" },
    { value: "bottoms", label: "Quần" },
    { value: "dresses", label: "Váy & Đầm" },
    { value: "accessories", label: "Phụ kiện" }
  ];

  const genderOptions = [
    { value: "all", label: "Tất cả" },
    { value: "man", label: "Nam" },
    { value: "woman", label: "Nữ" },
    { value: "unisex", label: "Unisex" }
  ];

  useEffect(() => {
    const fetchProducts = async () => {
      try {
        const res = await axios.get(`${API_URL}/api/products?limit=100`);
        setProducts(res.data.products || []);
      } catch (err) {
        setProducts([]);
      } finally {
        setLoading(false);
      }
    };
    fetchProducts();
  }, []);

  const handleDelete = async (id) => {
    if (window.confirm("Bạn có chắc chắn muốn xóa sản phẩm này không?")) {
      try {
        const userToken =
          localStorage.getItem("userToken") || localStorage.getItem("token");
        await axios.delete(`${API_URL}/api/products/${id}`, {
          headers: { Authorization: `Bearer ${userToken}` },
        });
        setProducts(products.filter((p) => p._id !== id));
        alert("Xóa sản phẩm thành công!");
      } catch (err) {
        alert("Xóa sản phẩm thất bại!");
      }
    }
  };

  const getFilteredProducts = () => {
    let filtered = [...products];

    // Lọc theo từ khóa tìm kiếm
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase().trim();
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.sku.toLowerCase().includes(query)
      );
    }

    // Lọc theo danh mục
    if (selectedCategory !== "all") {
      const group = categoryGroups[selectedCategory];
      if (group) {
        filtered = filtered.filter(product =>
          group.categories.includes(product.category)
        );
      }
    }

    // Lọc theo giới tính
    if (selectedGender !== "all") {
      filtered = filtered.filter(product =>
        product.gender === selectedGender
      );
    }

    return filtered;
  };

  const getGenderLabel = (gender) => {
    switch (gender) {
      case "man": return "Nam";
      case "woman": return "Nữ";
      case "unisex": return "Unisex";
      default: return gender;
    }
  };

  const filteredProducts = getFilteredProducts();

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <div className="flex items-center gap-4">
          <h2 className="text-2xl font-bold">Quản lý sản phẩm</h2>
          <div className="flex gap-2">
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Tìm theo tên hoặc SKU..."
              className="border border-gray-300 rounded px-3 py-1 min-w-[250px]"
            />
            <select
              value={selectedCategory}
              onChange={(e) => setSelectedCategory(e.target.value)}
              className="border border-gray-300 rounded px-3 py-1"
            >
              {categoryOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
            <select
              value={selectedGender}
              onChange={(e) => setSelectedGender(e.target.value)}
              className="border border-gray-300 rounded px-3 py-1"
            >
              {genderOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>
        </div>
        <Link
          to="/admin/products/new"
          className="bg-black text-white px-4 py-2 hover:bg-gray-700 cursor-pointer"
        >
          Thêm sản phẩm
        </Link>
      </div>
      <div className="overflow-x-auto">
        <table className="min-w-full text-left text-gray-500 border border-gray-100 border-collapse">
          <thead className="text-xs text-gray-700 uppercase bg-gray-100">
            <tr>
              <th className="px-3 py-3">Tên sản phẩm</th>
              <th className="px-3 py-3">Danh mục</th>
              <th className="px-3 py-3">Giới tính</th>
              <th className="px-3 py-3">Giá</th>
              <th className="px-3 py-3">SKU</th>
              <th className="px-3 py-3">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={6} className="p-4 text-center">
                  Đang tải...
                </td>
              </tr>
            ) : filteredProducts.length > 0 ? (
              filteredProducts.map((product) => (
                <tr
                  key={product._id}
                  className="bg-white border-b border-gray-100"
                >
                  <td className="p-4 font-medium text-gray-900 whitespace-nowrap">
                    {product.name}
                  </td>
                  <td className="p-4">
                    {product.category}
                  </td>
                  <td className="p-4">
                    {getGenderLabel(product.gender)}
                  </td>
                  <td className="p-4">{product.price.toLocaleString('vi-VN')} VND</td>
                  <td className="p-4">{product.sku}</td>
                  <td className="p-4">
                    <Link
                      to={`/admin/products/${product._id}`}
                      className="inline-flex items-center bg-black text-white px-3 py-1 mr-2 hover:bg-gray-700 cursor-pointer"
                    >
                      Sửa sản phẩm
                    </Link>
                    <button
                      onClick={() => handleDelete(product._id)}
                      className="inline-flex items-center text-black px-3 py-1 border border-black hover:border-gray-700 hover:text-gray-700 cursor-pointer"
                    >
                      Xóa sản phẩm
                    </button>
                  </td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan={6} className="p-4 text-center">
                  {selectedCategory === "all" && selectedGender === "all"
                    ? "Không tìm thấy sản phẩm nào"
                    : `Không tìm thấy sản phẩm ${selectedCategory !== "all" ? `thuộc danh mục ${categoryGroups[selectedCategory]?.label}` : ''} ${selectedGender !== "all" ? `dành cho ${getGenderLabel(selectedGender).toLowerCase()}` : ''}`
                  }
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default ProductManagement;


===== FILE: ./frontend/src/components/Admin/UserManagement.jsx =====
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { useSelector } from 'react-redux';
import { toast } from 'sonner';

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const UserManagement = () => {
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const { userToken } = useSelector((state) => state.auth);

    const [formData, setFormData] = useState({
        name: "",
        email: "",
        password: "",
        role: "customer",
    });

    // Fetch users
    const fetchUsers = async () => {
        try {
            const response = await axios.get(`${API_URL}/api/admin/users`, {
                headers: {
                    Authorization: `Bearer ${userToken}`,
                },
            });
            setUsers(response.data);
            setLoading(false);
        } catch (err) {
            console.error("Error fetching users:", err);
            setError("Không thể tải danh sách người dùng");
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchUsers();
    }, [userToken]);

    const handleChange = (e) => {
        setFormData({
            ...formData,
            [e.target.name]: e.target.value
        });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await axios.post(`${API_URL}/api/admin`, formData, {
                headers: {
                    Authorization: `Bearer ${userToken}`,
                },
            });
            toast.success("Thêm người dùng thành công!");
            // Reset form
            setFormData({
                name: "",
                email: "",
                password: "",
                role: "customer",
            });
            // Refresh user list
            fetchUsers();
        } catch (err) {
            console.error("Error creating user:", err);
            toast.error(err.response?.data?.message || "Không thể tạo người dùng");
        }
    };

    const handleRoleChange = async (userId, newRole) => {
        try {
            await axios.put(`${API_URL}/api/admin/${userId}`,
                { role: newRole },
                {
                    headers: {
                        Authorization: `Bearer ${userToken}`,
                    },
                }
            );
            toast.success("Cập nhật vai trò thành công!");
            // Update local state
            setUsers(users.map(user =>
                user._id === userId ? { ...user, role: newRole } : user
            ));
        } catch (err) {
            console.error("Error updating user role:", err);
            toast.error("Không thể cập nhật vai trò người dùng");
        }
    };

    const handleDelete = async (userId) => {
        if (window.confirm("Bạn có chắc chắn muốn xóa người dùng này?")) {
            try {
                await axios.delete(`${API_URL}/api/admin/${userId}`, {
                    headers: {
                        Authorization: `Bearer ${userToken}`,
                    },
                });
                toast.success("Xóa người dùng thành công!");
                // Update local state
                setUsers(users.filter(user => user._id !== userId));
            } catch (err) {
                console.error("Error deleting user:", err);
                toast.error("Không thể xóa người dùng");
            }
        }
    };

    if (loading) {
        return (
            <div className="flex justify-center items-center min-h-screen">
                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-900"></div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="max-w-7xl mx-auto p-6">
                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    {error}
                </div>
            </div>
        );
    }

    return (
        <div className='w-full mx-auto p-6 flex gap-6'>
            {/* add new user form */}
            <div className='mb-6 w-1/4'>
                <h2 className='text-2xl font-bold'>Thêm tài khoản mới</h2>
                <form onSubmit={handleSubmit} className='space-y-2'>
                    <div>
                        <label className='block text-gray-700'>Tên người dùng</label>
                        <input
                            type="text"
                            name="name"
                            value={formData.name}
                            onChange={handleChange}
                            className='w-full p-2 border border-gray-300'
                            required
                        />
                    </div>
                    <div>
                        <label className='block text-gray-700'>
                            Email
                        </label>
                        <input
                            type="email"
                            name="email"
                            value={formData.email}
                            onChange={handleChange}
                            className='w-full p-2 border border-gray-300'
                            required
                        />
                    </div>
                    <div>
                        <label className='block text-gray-700'>Mật khẩu</label>
                        <input
                            type="password"
                            name="password"
                            value={formData.password}
                            onChange={handleChange}
                            className='w-full p-2 border border-gray-300'
                            required
                        />
                    </div>
                    <div>
                        <label className='block text-gray-700'>Vai trò</label>
                        <select name="role"
                            value={formData.role}
                            onChange={handleChange}
                            className='w-full p-2 border border-gray-300'
                            required
                        >
                            <option value="customer">Customer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button
                        type='submit'
                        className='bg-black text-white px-4 py-2 hover:bg-gray-700 cursor-pointer'>
                        Thêm người dùng
                    </button>
                </form>
            </div>

            {/* user list */}
            <div className='overflow-x-auto w-3/4'>
                <h2 className='text-2xl font-bold mb-6'>Quản lý tài khoản</h2>
                <table className='min-w-full text-left text-gray-500 border border-gray-100 border-collapse'>
                    <thead className='text-xs text-gray-700 uppercase bg-gray-100'>
                        <tr>
                            <th className='px-3 py-3'>Họ và tên</th>
                            <th className='px-3 py-3'>Email</th>
                            <th className='px-3 py-3'>Vai trò</th>
                            <th className='px-3 py-3'>Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {users.map((user) => (
                            <tr key={user._id} className='bg-white border-b border-gray-100'>
                                <td className='p-4 font-medium text-gray-900 whitespace-nowrap'>{user.name}</td>
                                <td className='p-4'>{user.email}</td>
                                <td className='p-4'>
                                    <select
                                        value={user.role}
                                        onChange={(e) => handleRoleChange(user._id, e.target.value)}
                                        className='p-2 border border-gray-300'
                                    >
                                        <option value="customer">Customer</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </td>
                                <td className='p-4'>
                                    <button
                                        onClick={() => handleDelete(user._id)}
                                        className='text-black px-2 py-1 border border-black hover:border-gray-700 hover:text-gray-700 cursor-pointer'>
                                        Xóa
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

export default UserManagement;

===== FILE: ./frontend/src/components/Auth/AdminRoute.jsx =====
import React from 'react';
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useSelector } from 'react-redux';

const AdminRoute = () => {
    const { userInfo } = useSelector((state) => state.auth);
    const location = useLocation();

    if (!userInfo) {
        // Save the path user was trying to access
        return <Navigate to="/login" state={{ from: location.pathname }} replace />;
    }

    // Check if user is admin
    if (userInfo.role !== 'admin') {
        // If not admin, redirect to home
        return <Navigate to="/" replace />;
    }

    return <Outlet />;
};

export default AdminRoute; 

===== FILE: ./frontend/src/components/Auth/PrivateRoute.jsx =====
import React from 'react';
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useSelector } from 'react-redux';

const PrivateRoute = () => {
    const { userInfo } = useSelector((state) => state.auth);
    const location = useLocation();

    if (!userInfo) {
        // Save the path user was trying to access
        return <Navigate to="/login" state={{ from: location.pathname }} replace />;
    }

    return <Outlet />;
};

export default PrivateRoute; 

===== FILE: ./frontend/src/components/Auth/PublicOnlyRoute.jsx =====
import React from 'react';
import { Navigate, Outlet } from 'react-router-dom';
import { useSelector } from 'react-redux';

const PublicOnlyRoute = () => {
    const { userInfo } = useSelector((state) => state.auth);

    // If user is logged in, redirect to home page
    if (userInfo) {
        return <Navigate to="/" replace />;
    }

    // If user is not logged in, render the child routes
    return <Outlet />;
};

export default PublicOnlyRoute; 

===== FILE: ./frontend/src/components/Cart/CartContext.jsx =====
import React, { createContext, useContext, useState, useEffect } from "react";
import { toast } from "sonner";

const CartContext = createContext();

export const useCart = () => useContext(CartContext);

export const CartProvider = ({ children }) => {
  const [cartItems, setCartItems] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);

  // Load cart from localStorage on mount
  useEffect(() => {
    const savedCart = localStorage.getItem("cart");
    if (savedCart) {
      setCartItems(JSON.parse(savedCart));
    }
  }, []);

  // Save cart to localStorage whenever it changes
  useEffect(() => {
    localStorage.setItem("cart", JSON.stringify(cartItems));
  }, [cartItems]);

  const addToCart = (product, quantity, selectedSize, selectedColor) => {
    setCartItems((prevItems) => {
      // Check if item already exists with same size and color
      const existingItemIndex = prevItems.findIndex(
        (item) =>
          item.product._id === product._id &&
          item.size === selectedSize &&
          item.color === selectedColor
      );
      if (existingItemIndex !== -1) {
        // Update quantity of existing item
        const newItems = [...prevItems];
        newItems[existingItemIndex].quantity += quantity;
        toast.success("Đã cập nhật số lượng trong giỏ hàng", {
          id: "cart-update",
        });
        return newItems;
      } else {
        // Add new item
        toast.success("Đã thêm vào giỏ hàng", {
          id: "cart-add",
        });
        return [
          ...prevItems,
          {
            product,
            quantity,
            size: selectedSize,
            color: selectedColor,
          },
        ];
      }
    });
  };

  const removeFromCart = (index) => {
    setCartItems((prevItems) => {
      const newItems = [...prevItems];
      newItems.splice(index, 1);
      toast.success("Đã xóa sản phẩm khỏi giỏ hàng");
      return newItems;
    });
  };

  const updateQuantity = (index, newQuantity) => {
    if (newQuantity < 1) return;
    setCartItems((prevItems) => {
      const newItems = [...prevItems];
      newItems[index].quantity = newQuantity;
      return newItems;
    });
  };

  const clearCart = () => {
    setCartItems([]);
    toast.success("Đã xóa giỏ hàng");
  };

  const getTotalPrice = () => {
    return cartItems.reduce((total, item) => {
      const price = item.product.discountPrice || item.product.price;
      return total + price * item.quantity;
    }, 0);
  };

  const getTotalItems = () => {
    return cartItems.reduce((total, item) => total + item.quantity, 0);
  };

  return (
    <CartContext.Provider
      value={{
        cartItems,
        isCartOpen,
        setIsCartOpen,
        addToCart,
        removeFromCart,
        updateQuantity,
        clearCart,
        getTotalPrice,
        getTotalItems,
      }}
    >
      {children}
    </CartContext.Provider>
  );
};


===== FILE: ./frontend/src/components/Common/Footer.jsx =====
import React from "react";
import { Link } from "react-router-dom";
import { FaFacebookSquare, FaInstagramSquare, FaYoutube } from "react-icons/fa";
import Newsletter from "./Newsletter";

const Footer = () => {
  return (
    <div className="flex flex-col gap-6 md:gap-[53px] bg-[#F4F4F4]">
      <div className="flex flex-col md:flex-row items-center md:items-start px-4 md:px-[50px] pt-4 md:pt-[30px] gap-6 md:gap-0">
        {/* bên trái */}
        <div className="flex flex-col gap-[15px] flex-1 items-center md:items-start text-center md:text-left">
          <h3 className="font-semibold">Về Wukudada.</h3>
          <Link to="information" className="text-[14px] font-light">
            Thông tin
          </Link>
          <Link to="policy" className="text-[14px] font-light">
            Chính sách
          </Link>
        </div>
        {/* ở giữa */}
        <div className="flex flex-col gap-[15px] flex-1 items-center md:items-start text-center md:text-left">
          <h3 className="font-semibold">Liên hệ Wukudada.</h3>
          <div className="pr-0 md:pr-[50px]">
            <p className="text-[14px] font-light">
              Hotline:{" "}
              <a href="tel:+84567890111" className="font-normal">
                +84 567890111
              </a>
            </p>
            <p className="text-[14px] font-light">
              Email:{" "}
              <a href="mailto:wukudada@gmail.com" className="font-normal">
                wukudada@gmail.com
              </a>
            </p>
          </div>
          <p className="text-[14px] font-light">
            <span className="font-medium">Địa chỉ:</span> 123 Đường ABC, TP. HCM
          </p>
        </div>
        {/* bên phải */}
        <div className="flex flex-col gap-[15px] flex-1 items-center md:items-start text-center md:text-left">
          <h3 className="font-semibold">Theo dõi Wukudada.</h3>
          <div className="flex items-center gap-[15px] justify-center md:justify-start">
            <a
              href="https://www.facebook.com/"
              target="_blank"
              rel="noopener noreferrer"
            >
              <FaFacebookSquare className="h-[30px] w-[30px] text-[#757575]" />
            </a>
            <a
              href="https://www.instagram.com/"
              target="_blank"
              rel="noopener noreferrer"
            >
              <FaInstagramSquare className="h-[30px] w-[30px] text-[#757575]" />
            </a>
            <a
              href="https://www.youtube.com/"
              target="_blank"
              rel="noopener noreferrer"
            >
              <FaYoutube className="h-[30px] w-[30px] text-[#757575]" />
            </a>
          </div>
        </div>
        <div className="hidden md:block">
          <Newsletter />
        </div>
      </div>
      <div className="flex items-center justify-center border-t-[1px] border-t-[#DCDCDC] py-[10px]">
        <p className="text-[14px] font-semibold text-center">
          Bản quyền thuộc Công ty TNHH Wukudada. Bảo lưu mọi quyền.
        </p>
      </div>
    </div>
  );
};

export default Footer;


===== FILE: ./frontend/src/components/Common/Header.jsx =====
import React from "react";
import Navbar from "./Navbar";

const Header = () => {
  return (
    <header className="fixed top-0 left-0 w-full z-10 bg-white border-b border-b-[#DCDCDC]">
      {/* navbar */}
      <Navbar />
    </header>
  );
};

export default Header;


===== FILE: ./frontend/src/components/Common/MenuSide.jsx =====
import React, { useState, useEffect } from "react";
import { Link } from "react-router-dom";
import { GrClose, GrMenu } from "react-icons/gr";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const MenuSide = () => {
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isSubMenuOpen, setIsSubMenuOpen] = useState(false);
  const [isWomanSubMenuOpen, setIsWomanSubMenuOpen] = useState(false);
  const [manCategories, setManCategories] = useState([]);
  const [womanCategories, setWomanCategories] = useState([]);

  useEffect(() => {
    const fetchCategories = async () => {
      try {
        // Lấy danh sách sản phẩm nam
        const manResponse = await axios.get(`${API_URL}/api/products`, {
          params: { gender: "man" },
        });
        // Lấy danh sách sản phẩm nữ
        const womanResponse = await axios.get(`${API_URL}/api/products`, {
          params: { gender: "woman" },
        });

        // Lọc và loại bỏ các danh mục trùng lặp
        const manCategories = [
          ...new Set(manResponse.data.products.map((p) => p.category)),
        ];
        const womanCategories = [
          ...new Set(womanResponse.data.products.map((p) => p.category)),
        ];

        setManCategories(manCategories);
        setWomanCategories(womanCategories);
      } catch (err) {
        console.error("Error fetching categories:", err);
      }
    };

    fetchCategories();
  }, []);

  const toggleMenu = () => {
    setIsMenuOpen(!isMenuOpen);
    setIsSubMenuOpen(false);
    setIsWomanSubMenuOpen(false);
  };

  const toggleSubMenu = () => {
    setIsSubMenuOpen(!isSubMenuOpen);
  };

  const toggleWomanSubMenu = () => {
    setIsWomanSubMenuOpen(!isWomanSubMenuOpen);
  };

  const closeMenu = () => {
    setIsMenuOpen(false);
    setIsSubMenuOpen(false);
    setIsWomanSubMenuOpen(false);
  };

  useEffect(() => {
    if (isMenuOpen) {
      document.body.classList.add("overflow-hidden");
    } else {
      document.body.classList.remove("overflow-hidden");
    }

    return () => {
      document.body.classList.remove("overflow-hidden");
    };
  }, [isMenuOpen]);

  return (
    <>
      <div className="relative z-50">
        <button
          onClick={toggleMenu}
          className="flex items-center gap-2.5 cursor-pointer"
          aria-label={isMenuOpen ? "Đóng menu" : "Mở menu"}
        >
          {isMenuOpen ? (
            <GrClose className="text-[20px]" />
          ) : (
            <GrMenu className="text-[20px]" />
          )}
          <div className="overflow-hidden h-[20px] relative">
            <div
              className={`flex flex-col transition-transform duration-300 ease-in-out ${
                isMenuOpen ? "-translate-y-[20px]" : "translate-y-0"
              }`}
            >
              <span className="text-[14px] font-normal h-[20px] hidden md:flex items-center justify-center">
                Menu
              </span>
              <span className="text-[14px] font-normal h-[20px] hidden md:flex items-center justify-center">
                Đóng
              </span>
            </div>
          </div>
        </button>
      </div>
      {/* Nền tối */}
      <div
        className={`fixed inset-0 w-screen h-full bg-black/75 z-30 transition-[opacity,visibility] duration-200 ease-in-out ${
          isMenuOpen
            ? "opacity-100 visible"
            : "opacity-0 invisible pointer-events-none"
        }`}
        onClick={closeMenu}
      />
      {/* Menu chính */}
      <div
        className={`fixed top-0 left-0 w-[300px] h-full bg-white shadow-lg z-40 transition-all duration-300 ease-in-out transform overflow-y-auto ${
          isMenuOpen ? "translate-x-0" : "-translate-x-full"
        }`}
      >
        <div className="flex flex-col gap-4 mt-[88px]">
          {/* Đồ Nam với submenu */}
          <div className="relative">
            <div className="flex items-center justify-between pl-[50px] pr-[20px]">
              <Link
                to="gendercollections/man"
                className="text-[20px] font-normal hover:underline underline-offset-4"
                onClick={closeMenu}
              >
                Đồ Nam
              </Link>
              <button
                onClick={toggleSubMenu}
                className="text-[16px] font-normal hover:text-gray-600 transition-transform duration-200"
                style={{
                  transform: isSubMenuOpen ? "rotate(180deg)" : "rotate(0deg)",
                }}
              >
                ▼
              </button>
            </div>
            {/* Submenu danh mục */}
            <div
              className={`overflow-hidden transition-all duration-300 ease-in-out ${
                isSubMenuOpen ? "opacity-100" : "max-h-0 opacity-0"
              }`}
            >
              <div className="flex flex-col gap-2 mt-2 pl-[70px] pr-[20px]">
                {manCategories.map((category, index) => (
                  <Link
                    key={index}
                    to={`gendercollections/man?category=${encodeURIComponent(
                      category
                    )}`}
                    className="text-[16px] font-normal text-gray-600 hover:text-black hover:underline underline-offset-2 py-1"
                    onClick={closeMenu}
                  >
                    {category}
                  </Link>
                ))}
              </div>
            </div>
          </div>

          {/* Đồ Nữ với submenu */}
          <div className="relative">
            <div className="flex items-center justify-between pl-[50px] pr-[20px]">
              <Link
                to="gendercollections/women"
                className="text-[20px] font-normal hover:underline underline-offset-4"
                onClick={closeMenu}
              >
                Đồ Nữ
              </Link>
              <button
                onClick={toggleWomanSubMenu}
                className="text-[16px] font-normal hover:text-gray-600 transition-transform duration-200"
                style={{
                  transform: isWomanSubMenuOpen
                    ? "rotate(180deg)"
                    : "rotate(0deg)",
                }}
              >
                ▼
              </button>
            </div>

            {/* Submenu danh mục */}
            <div
              className={`overflow-hidden transition-all duration-300 ease-in-out ${
                isWomanSubMenuOpen ? "opacity-100" : "max-h-0 opacity-0"
              }`}
            >
              <div className="flex flex-col gap-2 mt-2 pl-[70px] pr-[20px]">
                {womanCategories.map((category, index) => (
                  <Link
                    key={index}
                    to={`gendercollections/women?category=${encodeURIComponent(
                      category
                    )}`}
                    className="text-[16px] font-normal text-gray-600 hover:text-black hover:underline underline-offset-2 py-1"
                    onClick={closeMenu}
                  >
                    {category}
                  </Link>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
};

export default MenuSide;


===== FILE: ./frontend/src/components/Common/Navbar.jsx =====
import React, { useState, useRef, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { IoMdHeartEmpty } from "react-icons/io";
import { PiShoppingCartSimple } from "react-icons/pi";
import { AiOutlineUser } from "react-icons/ai";
import { FiLogOut } from "react-icons/fi";
import { logoutUser } from "../../redux/slices/authSlice";
import { CgProfile } from "react-icons/cg";
import { RiAdminLine } from "react-icons/ri";
import { useSelector, useDispatch } from "react-redux";
import { logout } from "../../redux/slices/authSlice";
import { toast } from "sonner";

import MenuSide from "./MenuSide";
import SearchBar from "./SearchBar";
import { useCart } from "../Cart/CartContext";

const Navbar = () => {
  const { getTotalItems } = useCart();
  const { userInfo } = useSelector((state) => state.auth);
  const [showDropdown, setShowDropdown] = useState(false);
  const dropdownRef = useRef(null);
  const dispatch = useDispatch();
  const navigate = useNavigate();

  const { cart } = useSelector((state) => state.cart);
  const uniqueProductCount = cart?.products?.length || 0;

  // Kiểm tra quyền admin
  const isAdmin = userInfo?.role === "admin";

  // Đóng dropdown khi click outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setShowDropdown(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  // Hàm xử lý đăng xuất
  const handleLogout = async () => {
    try {
      // Gọi async logout
      await dispatch(logoutUser()).unwrap();
      
      toast.success("Đăng xuất thành công!");
      navigate("/");
      setShowDropdown(false);
    } catch (error) {
      // Dù có lỗi vẫn logout và hiển thị thông báo
      toast.success("Đăng xuất thành công!");
      navigate("/");
      setShowDropdown(false);
    }
  };

  return (
    <>
      <nav className="relative flex items-center justify-between h-16 md:h-[88px] px-4 md:px-[50px]">
        {/* Menu + SearchBar luôn nằm cùng 1 hàng ngang */}
        <div className="flex items-center gap-2 md:gap-[20px]">
          <MenuSide />
          <div className="flex items-center">
            <SearchBar hideTextOnMobile />
          </div>
        </div>

        {/* Logo */}
        <div className="absolute left-1/2 -translate-x-1/2">
          <button
            type="button"
            className="text-xl md:text-[30px] font-medium font-Jost focus:outline-none cursor-pointer"
            onClick={() => {
              if (window.location.pathname === "/") {
                window.scrollTo({ top: 0, behavior: "smooth" });
              } else {
                navigate("/");
              }
            }}
          >
            Wukudada.
          </button>
        </div>

        {/* tài khoản + giỏ hàng */}
        <div className="flex items-center gap-2 md:gap-[20px]">
          {/* Admin button - chỉ hiển thị cho admin trên desktop */}
          {isAdmin && (
            <Link
              to="/admin"
              className="flex items-center gap-1 bg-black text-white text-sm px-4 py-2 rounded hover:bg-gray-800 transition-colors"
            >
              <RiAdminLine className="text-[16px]" />
              <span className="hidden md:inline">Admin</span>
            </Link>
          )}
          {userInfo ? (
            // Nếu đã đăng nhập, hiển thị avatar với dropdown
            <div className="relative" ref={dropdownRef}>
              <div
                className="flex items-center gap-[10px] cursor-pointer"
                onClick={() => setShowDropdown(!showDropdown)}
              >
                {userInfo.profileImage ? (
                  <img
                    src={userInfo.profileImage}
                    alt={userInfo.name}
                    className="w-[24px] h-[24px] md:w-[30px] md:h-[30px] rounded-full object-cover"
                  />
                ) : (
                  <AiOutlineUser className="text-[18px] md:text-[20px]" />
                )}
                <span className="hidden md:inline text-sm truncate max-w-[120px]">
                  {userInfo.name || "Tài khoản"}
                </span>
              </div>
              {/* Dropdown Menu */}
              {showDropdown && (
                <div className="absolute z-10 right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 animate-fadeIn">
                  <Link
                    to="/profile"
                    className="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    onClick={() => setShowDropdown(false)}
                  >
                    <CgProfile className="mr-2" /> Hồ sơ của tôi
                  </Link>
                  <Link
                    to="/profile/orders"
                    className="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    onClick={() => setShowDropdown(false)}
                  >
                    <svg
                      className="w-4 h-4 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                      />
                    </svg>
                    Đơn hàng của tôi
                  </Link>
                  {/* Admin menu item */}
                  {isAdmin && (
                    <Link
                      to="/admin"
                      className="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      onClick={() => setShowDropdown(false)}
                    >
                      <RiAdminLine className="mr-2" /> Quản trị
                    </Link>
                  )}
                  <button
                    onClick={handleLogout}
                    className="w-full text-left flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100"
                  >
                    <FiLogOut className="mr-2" /> Đăng xuất
                  </button>
                </div>
              )}
            </div>
          ) : (
            // Nếu chưa đăng nhập, hiển thị link đến trang đăng nhập
            <Link to="/login" className="flex items-center gap-[10px]">
              <AiOutlineUser className="text-[20px]" />
              <span className="hidden md:inline text-sm">Tài khoản</span>
            </Link>
          )}
          <Link to="/cart" className="flex items-center gap-[10px] relative">
            {/* Icon giỏ hàng */}
            <div className="relative">
              <PiShoppingCartSimple className="text-[20px] md:text-[24px]" />
              {uniqueProductCount > 0 && (
                <span className="absolute -top-2 -right-2 w-4 h-4 md:w-5 md:h-5 bg-red-500 text-white text-[10px] md:text-xs rounded-full flex items-center justify-center">
                  {uniqueProductCount}
                </span>
              )}
            </div>
            <span className="hidden md:inline text-sm">Giỏ hàng</span>
          </Link>
        </div>
      </nav>
    </>
  );
};

export default Navbar;


===== FILE: ./frontend/src/components/Common/Newsletter.jsx =====
import React, { useState } from "react";
import { toast } from "sonner";

const Newsletter = () => {
  const [email, setEmail] = useState("");
  const [errors, setErrors] = useState({});

  const validateForm = () => {
    if (!email) {
      setErrors({ email: "Vui lòng nhập email" });
      return false;
    } else if (!/\S+@\S+\.\S+/.test(email)) {
      setErrors({ email: "Email không hợp lệ" });
      return false;
    }
    return true;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validateForm()) {
      toast.success("Cảm ơn bạn đã đăng ký!");
      setEmail("");
    }
  };

  return (
    <div className="flex flex-col gap-[15px] flex-1">
      <h3 className="font-semibold">Đăng Ký Nhận Tin</h3>
      <form onSubmit={handleSubmit} className="max-w-md">
        <div className="flex gap-4">
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Nhập email của bạn"
            className="flex-1 px-2 py-2 text-[14px] border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gray-500"
          />
          <button
            type="submit"
            className="px-6 py-2 text-[14px] bg-black text-white hover:bg-gray-800 transition duration-300"
          >
            Đăng Ký
          </button>
        </div>
        {errors.email && (
          <span className="text-red-500 text-sm mt-1">{errors.email}</span>
        )}
      </form>
    </div>
  );
};

export default Newsletter;


===== FILE: ./frontend/src/components/Common/PaymentStatus.jsx =====


===== FILE: ./frontend/src/components/Common/ScrollToTop.jsx =====
import { useEffect } from "react";
import { useLocation } from "react-router-dom";

const ScrollToTop = () => {
  const { pathname } = useLocation();

  useEffect(() => {
    window.scrollTo(0, 0);
  }, [pathname]);

  return null;
};

export default ScrollToTop;


===== FILE: ./frontend/src/components/Common/SearchBar.jsx =====
import React, { useState, useEffect } from "react";
import { GrSearch, GrClose } from "react-icons/gr";
import { useNavigate } from "react-router-dom";
import ProductGrid from "../Products/ProductGrid";
import axios from "axios";

const SearchBar = ({ hideTextOnMobile }) => {
  const [searchTerm, setSearchTerm] = useState("");
  const [isOpen, setIsOpen] = useState(false);
  const [searchResults, setSearchResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const navigate = useNavigate();

  const API_URL = import.meta.env.VITE_BACKEND_URL || "http://localhost:9000";

  const toggleSearch = () => setIsOpen((prev) => !prev);
  const clearSearch = () => {
    setSearchTerm("");
    setSearchResults([]);
  };

  // Debounce search
  useEffect(() => {
    const timer = setTimeout(async () => {
      if (searchTerm.trim()) {
        try {
          setLoading(true);
          // Gọi API tìm kiếm sản phẩm
          const response = await axios.get(`${API_URL}/api/products`, {
            params: {
              search: searchTerm,
              limit: 12,
            },
          });
          setSearchResults(response.data.products || []);
        } catch (error) {
          console.error("Error searching products:", error);
          setSearchResults([]);
        } finally {
          setLoading(false);
        }
      } else {
        setSearchResults([]);
      }
    }, 300);
    return () => clearTimeout(timer);
  }, [searchTerm, API_URL]);

  // Debounce suggest
  useEffect(() => {
    if (!searchTerm.trim()) {
      setSuggestions([]);
      setShowSuggestions(false);
      return;
    }
    const timer = setTimeout(async () => {
      try {
        const res = await axios.get(`${API_URL}/api/products/suggest`, {
          params: { query: searchTerm },
        });
        setSuggestions(res.data || []);
        setShowSuggestions(true);
      } catch {
        setSuggestions([]);
        setShowSuggestions(false);
      }
    }, 250);
    return () => clearTimeout(timer);
  }, [searchTerm, API_URL]);

  // Disable body scroll when search is open
  useEffect(() => {
    if (isOpen) {
      document.body.classList.add("overflow-hidden");
    } else {
      document.body.classList.remove("overflow-hidden");
    }
    return () => {
      document.body.classList.remove("overflow-hidden");
    };
  }, [isOpen]);

  return (
    <>
      {!isOpen && (
        <button
          onClick={toggleSearch}
          className="flex items-center gap-2.5 cursor-pointer z-10 relative"
          aria-label="Mở tìm kiếm"
        >
          <GrSearch className="text-[20px]" />
          <span
            className={
              hideTextOnMobile ? "hidden md:inline text-sm" : "text-sm"
            }
          >
            Tìm kiếm
          </span>
        </button>
      )}

      <div
        className={`fixed top-0 left-0 w-full h-screen bg-white z-50 transition-transform duration-200 ease-in-out ${
          isOpen ? "translate-y-0" : "-translate-y-full"
        }`}
      >
        <div className="flex flex-col w-full h-full overflow-y-auto">
          {/* Header tìm kiếm */}
          <div className="w-full bg-white sticky top-0 z-20">
            <div className="flex items-center justify-between gap-4 flex-wrap px-4 md:px-0">
              {/* Input tìm kiếm */}
              <div className="relative flex-1 min-w-[250px] max-w-[600px] mt-6 md:mt-10 mx-auto">
                <input
                  type="text"
                  placeholder="Tìm sản phẩm"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="bg-gray-100 h-10 px-4 py-2 pl-7 pr-20 rounded-full w-full placeholder:text-gray-700 focus:outline-none text-sm md:text-base"
                  onFocus={() => setShowSuggestions(true)}
                  autoComplete="off"
                />
                {searchTerm && (
                  <button
                    type="button"
                    onClick={clearSearch}
                    className="absolute right-2 top-1/2 transform -translate-y-1/2 h-8 p-2 rounded-full bg-gray-100 text-gray-500 text-xs md:text-sm font-medium cursor-pointer hover:bg-gray-200 transition-colors"
                  >
                    Xóa
                  </button>
                )}
                {/* Gợi ý tìm kiếm */}
                {showSuggestions && suggestions.length > 0 && (
                  <ul className="absolute left-0 right-0 bg-white border rounded shadow z-50 mt-1 max-h-60 overflow-y-auto">
                    {suggestions.map((s, idx) => (
                      <li
                        key={idx}
                        className="px-4 py-2 cursor-pointer hover:bg-gray-100"
                        onClick={() => {
                          setSearchTerm(s);
                          setShowSuggestions(false);
                        }}
                      >
                        {s}
                      </li>
                    ))}
                  </ul>
                )}
              </div>

              {/* Nút đóng */}
              <button
                type="button"
                onClick={toggleSearch}
                className="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 cursor-pointer"
                aria-label="Đóng tìm kiếm"
              >
                <GrClose className="text-[16px] text-gray-500" />
              </button>
            </div>

            {/* Loading indicator */}
            {loading && (
              <div className="flex justify-center my-4">
                <div className="animate-spin rounded-full h-6 w-6 md:h-8 md:w-8 border-b-2 border-gray-900"></div>
              </div>
            )}

            {/* Tiêu đề kết quả nếu có */}
            {searchResults.length > 0 && !loading && (
              <h3 className="text-base md:text-lg font-normal my-2 px-4 md:mx-[50px]">
                Kết quả tìm kiếm ({searchResults.length}):
              </h3>
            )}

            {/* No results message */}
            {searchTerm && !loading && searchResults.length === 0 && (
              <div className="text-center my-4 mx-[50px]">
                <p className="text-gray-500">
                  Không tìm thấy sản phẩm nào cho "{searchTerm}"
                </p>
              </div>
            )}
          </div>

          {/* Danh sách kết quả */}
          {searchResults.length > 0 && !loading && (
            <div className="w-full px-4 md:px-[50px] mb-10">
              <ProductGrid
                products={searchResults}
                onClick={(product) => {
                  setIsOpen(false);
                  navigate(`/products/${product._id}`);
                }}
              />
            </div>
          )}

          {/* Popular searches or suggestions when no search term */}
          {!searchTerm && !loading && (
            <div className="w-full px-4 md:px-[50px] mb-10">
              <h3 className="text-base md:text-lg font-normal my-2">
                Gợi ý tìm kiếm:
              </h3>
              <div className="flex flex-wrap gap-2 mt-4">
                {["Áo phông", "Quần jean", "Áo khoác", "Váy", "Giày"].map(
                  (suggestion) => (
                    <button
                      key={suggestion}
                      onClick={() => {
                        setSearchTerm(suggestion);
                      }}
                      className="px-4 py-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors text-sm"
                    >
                      {suggestion}
                    </button>
                  )
                )}
              </div>
            </div>
          )}
        </div>
      </div>
    </>
  );
};

export default SearchBar;


===== FILE: ./frontend/src/components/Layout/Hero.jsx =====
import React from 'react'
import { Link } from 'react-router-dom'
import heroVideo from '../../assets/videos/Hero_Edit_pc.mp4'

const Hero = () => {
    return (
        <section className='relative'>
            <video src={heroVideo} autoPlay muted loop className='w-full h-[400px] md:h-[600px] lg:h-[800px] object-cover' />
            {/* <img src="https://images4.alphacoders.com/915/thumb-1920-915356.jpg" alt="zerotwo"
                className='w-full h-[400px] md:h-[600px] lg:h-[750px] object-cover' /> */}
            <div className='absolute inset-0 bg-black/25 flex items-center justify-center'>
                <div className='text-center text-white p-6'>
                    <h1 className='text-4xl md:text-9xl font-bold tracking-tighter mb-20'>Wukudada.</h1>
                    <p className='text-sm md:text-lg mb-6'>Bộ sưu tập Wukudada</p>
                    <Link to="#" className='bg-white text-black px-6 py-3 rounded-sm text-sm md:text-lg font-semibold hover:bg-gray-200 transition duration-300'>
                        Khám Phá Ngay
                    </Link>
                </div>
            </div>
        </section>
    )
}

export default Hero

===== FILE: ./frontend/src/components/Layout/UserLayout.jsx =====
import React from 'react'
import Header from '../Common/Header'
import Footer from '../Common/Footer'
import { Outlet } from 'react-router-dom'
import ScrollToTop from '../Common/ScrollToTop'

const UserLayout = () => {
    return (
        <div className="min-h-screen flex flex-col">
            <ScrollToTop />
            {/* Header */}
            <Header />

            {/* Main Content */}
            <main className="flex-grow pt-[88px]">
                <Outlet />
            </main>

            {/* Footer */}
            <Footer />
        </div>
    )
}

export default UserLayout

===== FILE: ./frontend/src/components/Products/FeaturedCollection.jsx =====
import React from "react";
import { Link } from "react-router-dom";

const FeaturedCollection = ({ collections }) => {
  return (
    <div className="flex flex-col items-center">
      <div className="w-full grid grid-cols-1 gap-8">
        {collections.map((col) => {
          const featured = col.products.filter((p) => p.isFeatured);
          // if (featured.length === 0) return null;
          return (
            <div key={col.id} className="featured-collection overflow-hidden">
              <Link to={`/collections/${col.id}`}>
                <div className="relative">
                  <img
                    src={col.bannerUrl}
                    alt={col.name}
                    className="w-full h-48 sm:h-72 md:h-[400px] lg:h-[600px] xl:h-[750px] object-cover"
                  />
                  <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 sm:p-6">
                    <h2 className="text-lg sm:text-2xl font-bold text-white">
                      {col.name}
                    </h2>
                  </div>
                </div>
              </Link>
              <div className="px-2 sm:px-8 md:px-20 lg:px-[150px] pt-5">
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4 ">
                  {featured.map((p) => (
                    <Link
                      key={p._id}
                      to={`/product/${p._id}`}
                      className="group cursor-pointer"
                    >
                      <div className="flex flex-col justify-between w-full aspect-[3/4]">
                        {/* ảnh */}
                        <div className="h-[80%] overflow-hidden">
                          <img
                            src={p.images[0].url}
                            alt={p.images[0].altText || p.name}
                            className="w-full h-full object-cover"
                          />
                        </div>
                        {/* mô tả */}
                        <div className="flex flex-col gap-1 p-4">
                          <h3 className="text-sm group-hover:underline transition-colors duration-300">
                            {p.name}
                          </h3>
                          <p className="text-black font-medium text-lg">
                            {p.discountPrice
                              ? p.discountPrice.toLocaleString("vi-VN", {
                                style: "currency",
                                currency: "VND",
                              })
                              : p.price.toLocaleString("vi-VN", {
                                style: "currency",
                                currency: "VND",
                              })}
                          </p>
                        </div>
                      </div>
                    </Link>
                  ))}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

export default FeaturedCollection;


===== FILE: ./frontend/src/components/Products/FilterSidebar.jsx =====
import React, { useState, useEffect } from "react";
import { useSearchParams } from "react-router-dom";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const FilterSidebar = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const [filters, setFilters] = useState({
    color: [],
    size: [],
    price: [],
    material: [],
    category: [],
  });
  const [colorOptions, setColorOptions] = useState([]);
  const [materialOptions, setMaterialOptions] = useState([]);
  const [categoryOptions, setCategoryOptions] = useState([]);

  const size = ["S", "M", "L", "XL", "XXL"];

  const price = [
    { name: "Dưới 500.000đ", value: "under-500" },
    { name: "500.000đ - 1.000.000đ", value: "500-1000" },
    { name: "1.000.000đ - 1.500.000đ", value: "1000-1500" },
    { name: "Trên 1.500.000đ", value: "above-1500" },
  ];

  useEffect(() => {
    const fetchOptions = async () => {
      try {
        const res = await axios.get(`${API_URL}/api/products`);
        const products = res.data.products || [];

        const uniqueColors = new Map();
        const materialSet = new Set();
        const categorySet = new Set();

        products.forEach((product) => {
          (product.colors || []).forEach((color) => {
            if (color.name && color.code) {
              uniqueColors.set(color.code, {
                name: color.name,
                code: color.code
              });
            }
          });
          if (product.material) materialSet.add(product.material);
          if (product.category) categorySet.add(product.category);
        });

        setColorOptions(Array.from(uniqueColors.values()));
        setMaterialOptions(Array.from(materialSet));
        setCategoryOptions(Array.from(categorySet));
      } catch (err) {
        console.error("Error fetching filter options:", err);
        setColorOptions([]);
        setMaterialOptions([]);
        setCategoryOptions([]);
      }
    };
    fetchOptions();
  }, []);

  useEffect(() => {
    const params = Object.fromEntries(searchParams);

    let colors = [];
    if (params.color) {
      const colorCodes = params.color.split(",");
      colors = colorCodes
        .map(code => {
          // Chuẩn hóa mã màu
          const normalizedCode = code.startsWith("#") ? code.toUpperCase() : `#${code.toUpperCase()}`;
          const foundColor = colorOptions.find(c => c.code.toUpperCase() === normalizedCode);
          return foundColor ? { name: foundColor.name, code: foundColor.code } : null;
        })
        .filter(Boolean);
    }

    setFilters({
      color: colors,
      size: params.size ? params.size.split(",") : [],
      price: params.price ? [params.price] : [],
      material: params.material ? params.material.split(",") : [],
      category: params.category ? params.category.split(",") : [],
    });
  }, [searchParams, colorOptions]);

  const handleFilterChange = (type, value) => {
    const newFilters = { ...filters };

    if (type === "price") {
      newFilters.price = [value];
    } else if (type === "color") {
      const existingColor = newFilters.color.find(c => c.code.toUpperCase() === value.code.toUpperCase());
      if (existingColor) {
        newFilters.color = newFilters.color.filter(c => c.code.toUpperCase() !== value.code.toUpperCase());
      } else {
        newFilters.color = [...newFilters.color, value];
      }
    } else {
      if (newFilters[type].includes(value)) {
        newFilters[type] = newFilters[type].filter((v) => v !== value);
      } else {
        newFilters[type] = [...newFilters[type], value];
      }
    }

    setFilters(newFilters);

    // Cập nhật URL params
    const newParams = { ...Object.fromEntries(searchParams) };

    // Update filter params
    Object.entries(newFilters).forEach(([key, values]) => {
      if (values && values.length > 0) {
        if (key === "color") {
          // Gửi mã màu không có dấu # và in hoa
          newParams[key] = values.map(c => c.code.replace("#", "").toUpperCase()).join(",");
        } else if (key === "price" && values.length === 1) {
          newParams[key] = values[0];
        } else {
          newParams[key] = values.join(",");
        }
      } else {
        delete newParams[key];
      }
    });

    setSearchParams(newParams);
  };

  const clearFilters = () => {
    setFilters({
      color: [],
      size: [],
      price: [],
      material: [],
      category: [],
    });

    // Preserve non-filter params
    const newParams = { ...Object.fromEntries(searchParams) };
    Object.keys(filters).forEach(key => {
      delete newParams[key];
    });
    setSearchParams(newParams);
  };

  return (
    <div className="p-4">
      <div className="flex justify-between items-center mb-6">
        <h3 className="text-xl font-medium">Bộ lọc</h3>
        {Object.values(filters).some((arr) => arr.length > 0) && (
          <button
            onClick={clearFilters}
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            Xóa tất cả
          </button>
        )}
      </div>

      <div className="mb-6">
        <label className="block font-medium text-gray-700 mb-3">Màu sắc</label>
        <div className="flex flex-wrap gap-2">
          {colorOptions.map((color) => (
            <button
              key={color.code}
              onClick={() => handleFilterChange("color", color)}
              className={`w-8 h-8 rounded-full border-2 cursor-pointer ${filters.color.some(c => c.code === color.code)
                ? "border-black"
                : "border-gray-300"
                }`}
              style={{ backgroundColor: color.code }}
              title={color.name}
            >
              {/* {filters.color.some(c => c.code === color.code) && (
                <span className="absolute -top-1 -right-1 w-3 h-3 bg-black rounded-full border-2 border-white" />
              )} */}
            </button>
          ))}
        </div>
      </div>

      {/* Kích thước */}
      <div className="mb-6">
        <label className="block font-medium text-gray-700 mb-3">
          Kích thước
        </label>
        <div className="flex flex-wrap gap-2">
          {size.map((s) => (
            <button
              key={s}
              onClick={() => handleFilterChange("size", s)}
              className={`w-10 h-10 flex items-center justify-center border ${filters.size.includes(s)
                ? "border-black"
                : "border-gray-300 hover:border-black"
                }`}
            >
              {s}
            </button>
          ))}
        </div>
      </div>

      {/* Giá */}
      <div className="mb-6">
        <label className="block font-medium text-gray-700 mb-3">Giá</label>
        <div className="space-y-2">
          {price.map((p) => (
            <label
              key={p.value}
              className="flex items-center cursor-pointer group"
            >
              <input
                type="radio"
                name="price"
                className="w-4 h-4 rounded border-gray-300 accent-black text-black focus:ring-black"
                checked={filters.price[0] === p.value}
                onChange={() => handleFilterChange("price", p.value)}
              />
              <span className="ml-2 text-gray-600 group-hover:text-gray-900">
                {p.name}
              </span>
            </label>
          ))}
        </div>
      </div>

      {/* Chất liệu */}
      <div className="mb-6">
        <label className="block font-medium text-gray-700 mb-3">
          Chất liệu
        </label>
        <div className="space-y-2">
          {materialOptions.map((m, idx) => (
            <label
              key={m + "-" + idx}
              className="flex items-center cursor-pointer group"
            >
              <input
                type="checkbox"
                className="w-4 h-4 rounded border-gray-300 accent-black text-black focus:ring-black"
                checked={filters.material.includes(m)}
                onChange={() => handleFilterChange("material", m)}
              />
              <span className="ml-2 text-gray-600 group-hover:text-gray-900">
                {m}
              </span>
            </label>
          ))}
        </div>
      </div>

      {/* Danh mục */}
      <div className="mb-6">
        <label className="block font-medium text-gray-700 mb-3">Danh mục</label>
        <div className="space-y-2">
          {categoryOptions.map((cat, idx) => (
            <label
              key={cat + "-" + idx}
              className="flex items-center cursor-pointer group"
            >
              <input
                type="checkbox"
                className="w-4 h-4 rounded border-gray-300 accent-black text-black focus:ring-black"
                checked={filters.category.includes(cat)}
                onChange={() => handleFilterChange("category", cat)}
              />
              <span className="ml-2 text-gray-600 group-hover:text-gray-900">
                {cat}
              </span>
            </label>
          ))}
        </div>
      </div>

      {/* Active Filters Summary */}
      {Object.values(filters).some((arr) => arr.length > 0) && (
        <div className="mt-8 pt-6 border-t">
          <h4 className="font-medium text-gray-700 mb-3">Bộ lọc đã chọn</h4>
          <div className="flex flex-wrap gap-2">
            {/* Màu sắc đã chọn */}
            {filters.color.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {filters.color.map((color) => (
                  <button
                    key={color.code}
                    onClick={() => handleFilterChange("color", color)}
                    className="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-sm flex items-center gap-1 hover:bg-gray-200"
                  >
                    <span
                      className="w-3 h-3 rounded-full"
                      style={{ backgroundColor: color.code }}
                    />
                    <span>{color.name}</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      className="w-4 h-4"
                    >
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  </button>
                ))}
              </div>
            )}

            {/* Kích thước đã chọn */}
            {filters.size.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {filters.size.map((s) => (
                  <button
                    key={s}
                    onClick={() => handleFilterChange("size", s)}
                    className="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-sm flex items-center gap-1 hover:bg-gray-200"
                  >
                    <span>{s}</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      className="w-4 h-4"
                    >
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  </button>
                ))}
              </div>
            )}

            {/* Giá đã chọn */}
            {filters.price.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {filters.price.map((p) => (
                  <button
                    key={p}
                    onClick={() => handleFilterChange("price", p)}
                    className="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-sm flex items-center gap-1 hover:bg-gray-200"
                  >
                    <span>{price.find(item => item.value === p)?.name || p}</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      className="w-4 h-4"
                    >
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  </button>
                ))}
              </div>
            )}

            {/* Chất liệu đã chọn */}
            {filters.material.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {filters.material.map((m) => (
                  <button
                    key={m}
                    onClick={() => handleFilterChange("material", m)}
                    className="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-sm flex items-center gap-1 hover:bg-gray-200"
                  >
                    <span>{m}</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      className="w-4 h-4"
                    >
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  </button>
                ))}
              </div>
            )}

            {/* Danh mục đã chọn */}
            {filters.category.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {filters.category.map((c) => (
                  <button
                    key={c}
                    onClick={() => handleFilterChange("category", c)}
                    className="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-sm flex items-center gap-1 hover:bg-gray-200"
                  >
                    <span>{c}</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      className="w-4 h-4"
                    >
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default FilterSidebar;


===== FILE: ./frontend/src/components/Products/ProductDetails.jsx =====
// import products from '../../data/sample-products.json';


import React, { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { toast } from "sonner";
import ProductGrid from "./ProductGrid";
// import { useCart } from "../Cart/CartContext";
import { addToCart } from "../../redux/slices/cartSlice";
import { useDispatch, useSelector } from "react-redux";
import { PiShoppingCartSimple, PiCoins } from "react-icons/pi";


import {
  fetchProductById,
  fetchSimilarProducts,
} from "../../redux/slices/productsSlice";
import { setBuyNowItem } from "../../redux/slices/checkoutSlice";

const ProductDetails = ({ productId }) => {
  const { id } = useParams();
  const productFetchId = productId || id;

  const dispatch = useDispatch();
  const navigate = useNavigate();

  // const { addToCart } = useCart();
  // đây để test, khi đã có backend thì xóa dòng này
  // const selectedProduct = products.find(
  //   (p) => p._id.$oid === productFetchId
  // );
  // // Lấy các sản phẩm cùng category, loại trùng chính nó
  // const similarProducts = products.filter(
  //   (p) => p.category === selectedProduct.category && p._id.$oid !== selectedProduct._id.$oid
  // );


  const { selectedProduct, similarProducts, loading, error } = useSelector(
    (state) => state.products
  );
  const { user, guestId } = useSelector((state) => state.auth);

  const [mainImage, setMainImage] = useState("");
  const [selectedSize, setSelectedSize] = useState("");
  const [selectedColor, setSelectedColor] = useState(null);
  const [quantity, setQuantity] = useState(1);
  const [isButtonDisabled, setIsButtonDisabled] = useState(false);
  const [newReviewRating, setNewReviewRating] = useState(0);
  const [newReviewComment, setNewReviewComment] = useState("");


  useEffect(() => {
    if (productFetchId) {
      dispatch(fetchProductById(productFetchId));
      dispatch(fetchSimilarProducts(productFetchId));
    }
  }, [dispatch, productFetchId]);

  const [expandedSections, setExpandedSections] = useState({
    details: false,
    material: false,
    care: false,
  });

  useEffect(() => {
    if (selectedProduct?.images?.length) {
      setMainImage(selectedProduct.images[0].url);
    }
  }, [selectedProduct]);

  if (loading) {
    return <div className="text-center p-10">Đang tải...</div>;
  }

  if (error) {
    return <div className="text-center text-red-500 p-10">{error}</div>;
  }

  if (!selectedProduct) {
    return (
      <div className="text-center text-xl p-10 text-red-500">
        Không tìm thấy sản phẩm với id: {id}
      </div>
    );
  }

  const handleQuantityChange = (action) => {
    setQuantity((prev) =>
      action === "plus" ? prev + 1 : Math.max(1, prev - 1)
    );
  };

  // const handleAddToCart = () => {
  //   if (!selectedSize || !selectedColor) {
  //     toast.error("Vui lòng chọn kích thước và màu sắc");
  //     return;
  //   }
  const handleAddToCart = () => {
    if (!selectedSize || !selectedColor) {
      toast.error("Vui lòng chọn kích thước và màu sắc");
      return;
    }

    setIsButtonDisabled(true);

    dispatch(
      addToCart({
        productId: productFetchId,
        quantity,
        size: selectedSize,
        color: {
          name: selectedColor.name,
          code: selectedColor.code,
        },
        userId: user?._id,
        guestId,
      })
    )
      .unwrap()
      .then(() => {
        toast.success("Đã thêm vào giỏ hàng", {
          duration: 1000,
        });
      })
      .catch((error) => {
        toast.error(error?.message || "Có lỗi xảy ra khi thêm vào giỏ hàng");
      })
      .finally(() => {
        setIsButtonDisabled(false);
      });
  };

  const handleBuyNow = async () => {
    if (!selectedSize || !selectedColor) {
      toast.error("Vui lòng chọn kích thước và màu sắc");
      return;
    }

    const item = {
      productId: productFetchId,
      name: selectedProduct.name,
      image: selectedProduct.images?.[0]?.url || "",
      price: selectedProduct.discountPrice || selectedProduct.price,
      quantity,
      size: selectedSize,
      color: selectedColor,
    };

    dispatch(setBuyNowItem(item));
    navigate("/checkout-buy-now");
  };


  return (
    <div className="pt-6">
      {selectedProduct && (
        <div className="mx-[50px] bg-white">
          <div className="flex flex-col md:flex-row gap-8">
            {/* left thumbnail */}
            <div className="md:w-2/3 w-full flex flex-col gap-4">
              {/* Desktop: 2 columns, 3 rows grid for images */}
              <div className="hidden md:grid grid-cols-2 w-full">
                {selectedProduct.images.slice(0, 6).map((image, index) => (
                  <div
                    key={index}
                    className="relative w-full aspect-[3/4] bg-gray-100 overflow-hidden"
                  >
                    <img
                      src={image.url}
                      alt={image.altText || `thumbnail ${index + 1}`}
                      className="w-full h-full object-cover"
                    />
                  </div>
                ))}
              </div>
              {/* Mobile: horizontal scrollable thumbnails */}
              <div className="md:hidden flex overflow-x-auto snap-x snap-mandatory">
                {selectedProduct.images.map((image, index) => (
                  <div key={index} className="flex-none w-full snap-center">
                    <img
                      src={image.url}
                      alt={image.altText || `thumbnail ${index + 1}`}
                      className="w-full h-[400px] object-cover"
                    />
                  </div>
                ))}
              </div>
              {/* Product Description */}
              <div className="mt-8 pt-6">
                <div className="flex flex-col gap-2 border-b-2 border-gray-300 pb-4">
                  <h2 className="text-4xl font-normal">Mô tả</h2>
                  <p className="text-gray-500 text-base">
                    {/* Mã sản phẩm: {selectedProduct._id|| "Đang cập nhật"} */}
                    Mã sản phẩm: {selectedProduct._id.$oid || "Đang cập nhật"}
                  </p>
                </div>

                {/* Details Section */}
                <div className="border-b border-gray-300">
                  <button
                    onClick={() =>
                      setExpandedSections((prev) => ({
                        ...prev,
                        details: !prev.details,
                      }))
                    }
                    className="w-full py-3 flex justify-between items-center text-left"
                  >
                    <span className="font-normal text-lg">Chi tiết</span>
                    <span className="text-xl">
                      {expandedSections.details ? "−" : "+"}
                    </span>
                  </button>
                  <div
                    className={`overflow-hidden transition-all duration-300 ${expandedSections.details
                      ? "max-h-[500px] pb-4"
                      : "max-h-0"
                      }`}
                  >
                    <div className="space-y-2 text-gray-600">
                      <p className="text-base">{selectedProduct.description}</p>
                      {selectedProduct.details &&
                        selectedProduct.details.length > 0 && (
                          <ul className="list-disc pl-5 mt-2">
                            {selectedProduct.details.map((detail, idx) => (
                              <li key={idx} className="text-sm">
                                {detail}
                              </li>
                            ))}
                          </ul>
                        )}
                    </div>
                  </div>
                </div>

                {/* Material Section */}
                <div className="border-b border-gray-300">
                  <button
                    onClick={() =>
                      setExpandedSections((prev) => ({
                        ...prev,
                        material: !prev.material,
                      }))
                    }
                    className="w-full py-3 flex justify-between items-center text-left"
                  >
                    <span className="font-normal text-lg">Chất liệu</span>
                    <span className="text-xl">
                      {expandedSections.material ? "−" : "+"}
                    </span>
                  </button>
                  <div
                    className={`overflow-hidden transition-all duration-300 ${expandedSections.material
                      ? "max-h-[500px] pb-4"
                      : "max-h-0"
                      }`}
                  >
                    <div className="space-y-2 text-gray-600">
                      <p className="text-sm">
                        {selectedProduct.material || "Đang cập nhật"}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Care Instructions Section */}
                <div className="border-b border-gray-300">
                  <button
                    onClick={() =>
                      setExpandedSections((prev) => ({
                        ...prev,
                        care: !prev.care,
                      }))
                    }
                    className="w-full py-3 flex justify-between items-center text-left"
                  >
                    <span className="font-normal text-lg">
                      Hướng dẫn bảo quản
                    </span>
                    <span className="text-xl">
                      {expandedSections.care ? "−" : "+"}
                    </span>
                  </button>
                  <div
                    className={`overflow-hidden transition-all duration-300 ${expandedSections.care ? "max-h-[500px] pb-4" : "max-h-0"
                      }`}
                  >
                    <div className="space-y-2 text-gray-600">
                      <p className="text-sm">
                        {selectedProduct.care || "Đang cập nhật"}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {/* right side */}
            <div className="flex flex-col gap-6 md:w-1/3 md:sticky md:top-[88px] md:self-start">
              <h1 className="text-2xl md:text-3xl">{selectedProduct.name}</h1>
              {selectedProduct.discountPrice ? (
                <>
                  <p className="text-lg text-gray-600 line-through">
                    {selectedProduct.price.toLocaleString("vi-VN")} VND
                  </p>
                  <p className="text-xl font-bold text-red-600">
                    {selectedProduct.discountPrice.toLocaleString("vi-VN")} VND
                  </p>
                </>
              ) : (
                <p className="text-xl font-bold text-black">
                  {selectedProduct.price.toLocaleString("vi-VN")} VND
                </p>
              )}
              {/* Color */}
              <div>
                <p className="text-black font-medium">
                  Màu sắc: <span className="text-black font-light">{selectedColor ? selectedColor.name : ''}</span>
                </p>
                <div className="flex gap-3 mt-2">
                  {selectedProduct.colors.map((colorObj) => (
                    <button
                      key={colorObj.name}
                      onClick={() => setSelectedColor(colorObj)}
                      className={`w-10 h-10 rounded-full cursor-pointer ${selectedColor?.name === colorObj.name
                        ? "ring-2 ring-offset-2 ring-black"
                        : "border-2 border-gray-500"
                        }`}
                      style={{
                        backgroundColor: colorObj.code,
                        // filter: "brightness(0.9)",
                      }}
                    />
                  ))}
                </div>
              </div>

              {/* Size */}
              <div>
                <p className="text-black font-medium">Kích cỡ:</p>
                <div className="flex flex-wrap gap-3 mt-2">
                  {selectedProduct.sizes.map((size) => (
                    <button
                      key={size}
                      onClick={() => setSelectedSize(size)}
                      className={`w-10 h-10 flex items-center justify-center border cursor-pointer text-sm font-medium ${selectedSize === size
                        ? "ring-2 ring-offset-2 font-bold"
                        : "border-gray-400 text-gray-400"
                        }`}
                    >
                      {size}
                    </button>
                  ))}
                </div>
              </div>

              {/* Quantity */}
              <div className="flex flex-col items-start gap-2">
                <div className="flex justify-between w-full items-center">
                  <p className="text-gray-700 font-medium">Số lượng:</p>
                  <p className="text-sm text-gray-500">
                    {selectedProduct.countInStock > 10
                      ? "Còn hàng"
                      : selectedProduct.countInStock > 0
                        ? `Còn ${selectedProduct.countInStock} sản phẩm`
                        : "Hết hàng"}
                  </p>
                </div>
                <div className="flex items-center w-[30%] py-2 bg-gray-100 rounded-full">
                  <button
                    onClick={() => handleQuantityChange("minus")}
                    className="w-[30%] text-center hover:font-bold cursor-pointer"
                  >
                    <span>−</span>
                  </button>
                  <input
                    min="1"
                    value={quantity}
                    onChange={(e) => {
                      const value = parseInt(e.target.value);
                      if (!isNaN(value) && value >= 1) {
                        setQuantity(value);
                      } else {
                        setQuantity(1);
                      }
                    }}
                    className="w-[40%] text-center bg-gray-100 text-lg outline-none"
                  />
                  <button
                    onClick={() => handleQuantityChange("plus")}
                    className="w-[30%] text-center hover:font-bold cursor-pointer"
                  >
                    <span>+</span>
                  </button>
                </div>
              </div>

              {/* Add to Cart or Buy Now */}
              <div className="flex gap-2">
                <button
                  onClick={handleAddToCart}
                  disabled={isButtonDisabled}
                  className={`bg-black text-lg text-white flex items-center justify-center gap-2 py-2 w-full cursor-pointer ${isButtonDisabled ? "opacity-50 cursor-not-allowed" : "hover:bg-gray-800"
                    }`}
                >
                  {isButtonDisabled ? "Đang thêm..." : (
                    <>
                      <PiShoppingCartSimple className="inline size-5 text-white" />
                      <p className="text-sm">Thêm vào giỏ hàng </p>
                    </>
                  )}
                </button>
                <button
                  onClick={handleBuyNow}
                  disabled={isButtonDisabled}
                  className={`bg-white text-lg text-black flex items-center justify-center gap-2 py-2 w-full  cursor-pointer border border-black ${isButtonDisabled ? "opacity-50 cursor-not-allowed" : "hover:bg-gray-100"
                    }`}
                >
                  {isButtonDisabled ? "Đang xử lý..." : (
                    <>
                      <PiCoins className="inline size-5 text-black" />
                      <p className="text-sm">Mua ngay </p>
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
          <div className="mt-20 mb-10 mx-[50px]">
            <h2 className="text-2xl text-center font-medium mb-4">
              Sản phẩm tương tự
            </h2>
            {similarProducts &&
              selectedProduct &&
              (() => {
                // Gộp tất cả sản phẩm liên quan thành 1 mảng
                const allRelated = [
                  ...(similarProducts.sameCategory || []),
                  ...(similarProducts.sameBrand || []),
                  ...(similarProducts.recommended || []),
                ];
                // Loại trùng và loại sản phẩm hiện tại
                const uniqueRelated = allRelated
                  .filter((p) => p._id !== selectedProduct._id)
                  .filter(
                    (p, idx, arr) =>
                      arr.findIndex((x) => x._id === p._id) === idx
                  );

                if (uniqueRelated.length === 0) return null;

                return (
                  <div className="mt-12">
                    <h2 className="text-2xl font-semibold mb-4 text-left">
                      Sản phẩm tương tự
                    </h2>
                    <ProductGrid products={uniqueRelated} />
                  </div>
                );
              })()}
          </div>
        </div>
      )}
    </div>
  );
};

export default ProductDetails;


===== FILE: ./frontend/src/components/Products/ProductGrid.jsx =====
import React from "react";
import { Link } from "react-router-dom";

const ProductGrid = ({ products, onClick }) => {
  if (!Array.isArray(products)) {
    return <div className="text-center p-4">Không có sản phẩm nào.</div>;
  }

  return (
    <div className="grid grid-cols-2 lg:grid-cols-4">
      {products.map((product) => (
        <Link
          key={product._id}
          to={`/product/${product._id}`}
          className="block group"
          onClick={onClick}
        >
          {/* Phần ảnh */}
          <div className="flex flex-col justify-between w-full aspect-[3/4]">
            <div className="h-[80%] overflow-hidden">
              <img
                src={
                  product.images[0]?.url || "https://via.placeholder.com/500"
                }
                alt={product.images[0]?.altText || product.name}
                className="w-full h-full object-cover"
              />
            </div>
            {/* Phần mô tả */}
            <div className="flex flex-col gap-1 p-4">
              <h3 className="text-sm group-hover:underline transition-colors duration-300">
                {product.name}
              </h3>
              <div>
                {product.discountPrice ? (
                  <>
                    <p className="text-gray-500 line-through text-sm">
                      {product.price.toLocaleString("vi-VN")} VND
                    </p>
                    <p className="text-red-600 font-medium">
                      {product.discountPrice.toLocaleString("vi-VN")} VND
                    </p>
                  </>
                ) : (
                  <p className="text-black font-medium">
                    {product.price.toLocaleString("vi-VN")} VND
                  </p>
                )}
              </div>
            </div>
          </div>
        </Link>
      ))}
    </div>
  );
};

export default ProductGrid;


===== FILE: ./frontend/src/components/Products/SortOptions.jsx =====
import React from "react";
import { useSearchParams } from "react-router-dom";

const SortOptions = () => {
  const [searchParams, setSearchParams] = useSearchParams();

  const handleSortChange = (e) => {
    const sortBy = e.target.value;
    // Tạo một object mới từ tất cả các params hiện tại
    const currentParams = {};
    searchParams.forEach((value, key) => {
      currentParams[key] = value;
    });

    // Cập nhật hoặc thêm mới param sortBy
    if (sortBy === "default") {
      delete currentParams.sortBy;
    } else {
      currentParams.sortBy = sortBy;
    }

    // Set lại tất cả params
    setSearchParams(currentParams);
  };

  return (
    <div className="flex items-center justify-end">
      <select
        id="sort"
        onChange={handleSortChange}
        value={searchParams.get("sortBy") || "default"}
        className="border border-gray-300 text-sm p-2 cursor-pointer"
      >
        <option value="default">Mặc định</option>
        <option value="price_asc">Giá: Tăng dần</option>
        <option value="price_desc">Giá: Giảm dần</option>
        <option value="name_asc">Tên: A-Z</option>
        <option value="name_desc">Tên: Z-A</option>
      </select>
    </div>
  );
};

export default SortOptions;


===== FILE: ./frontend/src/components/information/About.jsx =====
import React from "react";

const About = () => (
  <div className="mb-6 text-gray-800">
    <div className="mb-4">
      Từ ngày 2 tháng 10 năm 2018
      <br />
      CÔNG TY TNHH WUKUDADA VIỆT NAM
    </div>
    <div className="font-bold mb-1">TÊN CÔNG TY</div>
    <div className="mb-4">CÔNG TY TNHH WUKUDADA VIỆT NAM</div>
    <div className="font-bold mb-1">THÀNH LẬP</div>
    <div className="mb-4">2 tháng 10, 2018</div>
    <div className="font-bold mb-1">VỊ TRÍ</div>
    <div className="mb-4">
      Địa chỉ đăng ký: Tầng 26, Tòa nhà Viettel, Số 285, Đường Cách Mạng Tháng
      Tám, Phường 12, Quận 10, Thành phố Hồ Chí Minh, Việt Nam
    </div>
    <div className="font-bold mb-1">NGÀNH NGHỀ KINH DOANH</div>
    <div className="mb-4">
      Bán lẻ sản phẩm thời trang thiết kế nhãn hiệu WUKUDADA tại Việt Nam
    </div>
    <div className="font-bold mb-1">SỐ CỬA HÀNG</div>
    <div>8 cửa hàng (Tính đến tháng 8 năm 2021)</div>
  </div>
);

export default About;


===== FILE: ./frontend/src/components/information/Sponsorship.jsx =====
import React from "react";
import { FaFacebookSquare, FaInstagram, FaYoutube } from "react-icons/fa";

const SPONSORS = [
  {
    name: "TRỊNH TRẦN PHƯƠNG TUẤN (JACK)",
    image:
      "https://cdnphoto.dantri.com.vn/BWnuv5garDlUBKjRSZrItt4qfWk=/thumb_w/1020/2025/05/26/jack1-1748272770861.jpg",
    description:
      "Sinh ngày 12/04/1997, quê Bến Tre, Việt Nam. Jack là ca sĩ, nhạc sĩ nổi tiếng với nhiều bản hit và đạt nhiều giải thưởng lớn trong làng nhạc Việt.",
    socials: [
      {
        label: "FACEBOOK",
        url: "https://www.facebook.com/jackphuongtuan.official/",
      },
      {
        label: "YOUTUBE",
        url: "https://www.youtube.com/c/J97Official",
      },
      {
        label: "INSTAGRAM",
        url: "https://www.instagram.com/jackj97/",
      },
    ],
  },
  {
    name: "ĐẶNG TIẾN HOÀNG (VIRUSS)",
    image:
      "https://th.bing.com/th/id/OIP.p0zYlMV4xYqqLoY90GsbBAHaD4?w=320&h=180&c=7&r=0&o=5&cb=iwc2&dpr=1.4&pid=1.7",
    description:
      "Sinh ngày 01/05/1990, quê Hà Nội, Việt Nam. ViruSs là streamer, nhạc sĩ, nhà sản xuất âm nhạc nổi tiếng, có sức ảnh hưởng lớn trong cộng đồng mạng Việt Nam.",
    socials: [
      { label: "FACEBOOK", url: "https://www.facebook.com/viruss.official/" },
      { label: "YOUTUBE", url: "https://www.youtube.com/c/ViruSsOfficial/" },
      { label: "INSTAGRAM", url: "https://www.instagram.com/viruss.official/" },
    ],
  },
  {
    name: "PHẠM THOẠI",
    image:
      "https://gamehow.net/upload/suckhoe_post/images/2023/03/03/643/pham-thoai-7.jpg",
    description:
      "Sinh ngày 16/01/1996, quê Hải Phòng, Việt Nam. Phạm Thoại là TikToker, KOL nổi tiếng với phong cách hài hước, sáng tạo và có sức ảnh hưởng lớn trên mạng xã hội.",
    socials: [
      {
        label: "FACEBOOK",
        url: "https://www.facebook.com/PhamThoai.Official/",
      },
      { label: "YOUTUBE", url: "https://www.youtube.com/@phamthoai" },
      {
        label: "INSTAGRAM",
        url: "https://www.instagram.com/phamthoai.official/",
      },
    ],
  },
  {
    name: "NGUYỄN THÚC THUỶ TIÊN (THUỶ TIÊN)",
    image:
      "https://xinhstar.vn/wp-content/uploads/2021/12/xinhstar-nhan-sac-doi-thuong-cua-hoa-hau-hoa-binh-quoc-te-nguyen-thuc-thuy-tien2.jpg",
    description:
      "Sinh ngày 12/08/1998, quê TP. Hồ Chí Minh, Việt Nam. Nguyễn Thúc Thùy Tiên là Hoa hậu Hòa bình Quốc tế 2021, nổi tiếng với các hoạt động thiện nguyện và truyền cảm hứng tích cực cho giới trẻ.",
    socials: [
      { label: "FACEBOOK", url: "https://www.facebook.com/thuytienofficial/" },
      { label: "YOUTUBE", url: "https://www.youtube.com/@thuytienofficial" },
      {
        label: "INSTAGRAM",
        url: "https://www.instagram.com/thuytienofficial/",
      },
    ],
  },
  {
    name: "QUANG LINH VLOG",
    image:
      "https://tudienwiki.com/wp-content/uploads/2023/04/300095820_500185375441609_5755206151203271073_n.jpg",
    description:
      "Sinh ngày 11/12/1997, quê Nghệ An, Việt Nam. Quang Linh là YouTuber nổi tiếng với các hoạt động thiện nguyện tại châu Phi, truyền cảm hứng tích cực đến cộng đồng.",
    socials: [
      {
        label: "FACEBOOK",
        url: "https://www.facebook.com/quanglinhvlogafrica/",
      },
      { label: "YOUTUBE", url: "https://www.youtube.com/@quanglinhvlog" },
      { label: "INSTAGRAM", url: "https://www.instagram.com/quanglinhvlog/" },
    ],
  },
];

const Sponsorship = () => (
  <div>
    <h1 className="text-4xl font-bold mb-6">ĐẠI SỨ THƯƠNG HIỆU</h1>
    <div className="mb-4 text-base">
      WUKUDADA tự hào hợp tác với các KOL hàng đầu Việt Nam
      <br />
    </div>

    <div className="divide-y">
      {SPONSORS.map((s, idx) => (
        <div
          key={s.name}
          className="py-8 flex flex-col md:flex-row gap-6 items-start"
        >
          <img
            src={s.image}
            alt={s.name}
            className="w-48 h-48 object-cover rounded mb-4 md:mb-0"
          />
          <div className="flex-1">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between">
              <h2 className="text-2xl font-bold mb-2 md:mb-0">{s.name}</h2>
              <div className="flex flex-col md:items-end gap-1">
                {s.socials.map((soc) => {
                  let Icon = null;
                  if (soc.label === "FACEBOOK") Icon = FaFacebookSquare;
                  if (soc.label === "YOUTUBE") Icon = FaYoutube;
                  if (soc.label === "INSTAGRAM") Icon = FaInstagram;
                  return (
                    <a
                      key={soc.label}
                      href={soc.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-black text-2xl hover:text-blue-600 flex items-center gap-2"
                      title={soc.label}
                    >
                      {Icon && <Icon />}
                      <span className="sr-only">{soc.label}</span>
                    </a>
                  );
                })}
              </div>
            </div>
            <div className="mt-2 text-base text-black">{s.description}</div>
          </div>
        </div>
      ))}
    </div>
  </div>
);

export default Sponsorship;


===== FILE: ./frontend/src/components/profile/MyOdersPage.jsx =====
import React from "react";
import { useNavigate } from "react-router-dom";
import { useOrders } from "./OrderContext";

const MyOdersPage = () => {
  const { orders, loading, error } = useOrders();
  const navigate = useNavigate();

  // Helper function để format giá tiền
  const formatPrice = (price) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(price);
  };

  // Helper function để translate status
  const getStatusLabel = (status) => {
    const statusMap = {
      Processing: "Đang xử lý",
      Shipped: "Đang giao",
      Delivered: "Đã giao",
      Cancelled: "Đã hủy",
      preparing: "Đang chuẩn bị",
      shipping: "Đang giao",
      delivered: "Đã giao",
    };
    return statusMap[status] || status;
  };

  // Helper function để get status color
  const getStatusColor = (status) => {
    const colorMap = {
      Processing: "text-yellow-600 bg-yellow-100",
      preparing: "text-yellow-600 bg-yellow-100",
      Shipped: "text-blue-600 bg-blue-100",
      shipping: "text-blue-600 bg-blue-100",
      Delivered: "text-green-600 bg-green-100",
      delivered: "text-green-600 bg-green-100",
      Cancelled: "text-red-600 bg-red-100",
    };
    return colorMap[status] || "text-gray-600 bg-gray-100";
  };

  if (loading) {
    return (
      <div className="bg-white border border-gray-200 p-4 sm:p-6 md:p-8">
        <h3 className="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 text-center md:text-left md:mb-10">
          ĐƠN HÀNG CỦA TÔI
        </h3>
        <div className="flex justify-center items-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
          <span className="ml-2">Đang tải đơn hàng...</span>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-white border border-gray-200 p-4 sm:p-6 md:p-8">
        <h3 className="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 text-center md:text-left md:mb-10">
          ĐƠN HÀNG CỦA TÔI
        </h3>
        <div className="text-center py-8">
          <div className="text-red-500 mb-2">❌ {error}</div>
          <button
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          >
            Thử lại
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white border border-gray-200 p-4 sm:p-6 md:p-8">
      <h3 className="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 text-center md:text-left md:mb-10">
        ĐƠN HÀNG CỦA TÔI
      </h3>
      <div className="relative border border-gray-200 overflow-x-auto">
        <div className="w-full min-w-[520px] sm:min-w-[700px]">
          <table className="min-w-full text-left text-gray-500 text-[11px] sm:text-xs md:text-sm">
            <thead className="bg-gray-100 text-[10px] sm:text-xs uppercase text-gray-700">
              <tr>
                <th className="py-1 px-1 sm:px-4 sm:py-3 whitespace-nowrap">
                  Mã đơn
                </th>
                <th className="py-1 px-1 sm:px-4 sm:py-3 whitespace-nowrap">
                  Ngày tạo
                </th>
                <th className="py-1 px-1 sm:px-4 sm:py-3 whitespace-nowrap">
                  Sản phẩm
                </th>
                <th className="py-1 px-1 sm:px-4 sm:py-3 whitespace-nowrap">
                  Tổng tiền
                </th>
                <th className="py-1 px-1 sm:px-4 sm:py-3 whitespace-nowrap">
                  Giao hàng
                </th>
                <th className="py-1 px-1 sm:px-4 sm:py-3 whitespace-nowrap">
                  Thanh toán
                </th>
              </tr>
            </thead>
            <tbody>
              {orders.length > 0 ? (
                orders.map((order) => (
                  <tr
                    key={order._id}
                    className="border-b hover:bg-gray-50 cursor-pointer"
                    onClick={() => navigate(`/profile/orders/${order._id}`)}
                  >
                    <td className="py-2 px-2 sm:px-4 sm:py-4 font-medium text-gray-900 whitespace-nowrap text-xs sm:text-sm">
                      #{order._id.slice(-6)}
                    </td>
                    <td className="py-2 px-4 text-xs sm:text-sm">
                      {new Date(
                        order.createdAt || order.createAt
                      ).toLocaleDateString("vi-VN")}
                    </td>
                    <td className="py-2 px-4 text-xs sm:text-sm">
                      {(order.orderItems || order.oderItems || []).map(
                        (item, index) => (
                          <div key={index} className="mb-1">
                            {item.name || item.product?.name} (x{item.quantity})
                          </div>
                        )
                      )}
                    </td>
                    <td className="py-2 px-4 text-xs sm:text-sm font-medium">
                      {formatPrice(order.totalPrice)}
                    </td>
                    <td className="py-2 px-4">
                      <span
                        className={`flex items-center gap-1 w-max px-2 py-1 rounded-full text-xs sm:text-sm font-medium whitespace-nowrap ${getStatusColor(
                          order.status || order.deliveryStatus
                        )}`}
                      >
                        {getStatusLabel(order.status || order.deliveryStatus)}
                      </span>
                    </td>
                    <td className="py-2 px-4">
                      <span
                        className={`flex items-center gap-1 w-max px-2 py-1 rounded-full text-xs sm:text-sm font-medium whitespace-nowrap ${
                          order.paymentStatus === "Paid"
                            ? "bg-green-100 text-green-700"
                            : order.paymentStatus === "Refunded"
                            ? "bg-yellow-100 text-yellow-700"
                            : "bg-red-100 text-red-700"
                        }`}
                      >
                        {order.paymentStatus === "Paid"
                          ? "Đã thanh toán"
                          : order.paymentStatus === "Refunded"
                          ? "Đã hoàn tiền"
                          : "Chưa thanh toán"}
                      </span>
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td
                    colSpan={6}
                    className="text-center py-8 px-4 text-gray-500 text-sm"
                  >
                    <div className="flex flex-col items-center">
                      <svg
                        className="w-12 h-12 text-gray-300 mb-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                        />
                      </svg>
                      <p>Bạn chưa có đơn hàng nào</p>
                      <button
                        onClick={() => navigate("/")}
                        className="mt-2 px-4 py-2 bg-black text-white text-sm rounded hover:bg-gray-800 transition-colors"
                      >
                        Mua sắm ngay
                      </button>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

export default MyOdersPage;


===== FILE: ./frontend/src/components/profile/OrderContext.jsx =====
import React, { createContext, useContext, useState, useEffect } from "react";
import axios from "axios";
import { getAuthToken, removeAuthTokens } from "../../utils/auth";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

// Tạo context
const OrderContext = createContext();

export const useOrders = () => useContext(OrderContext);

export const OrderProvider = ({ children }) => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null); // Hàm fetch đơn hàng từ API
  const fetchOrders = async () => {
    try {
      setLoading(true);
      setError(null);

      const token = getAuthToken();
      if (!token) {
        console.warn("No auth token found");
        console.log(
          "To test orders functionality, please login first or check localStorage for userToken"
        );
        console.log("Using fallback mock data for demo purposes");
        setOrders(getMockOrders());
        setLoading(false);
        return;
      }

      const response = await axios.get(`${API_URL}/api/orders/my-orders`, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });

      console.log("Orders fetched successfully:", response.data);
      setOrders(response.data || []);
    } catch (error) {
      console.error("Error fetching orders:", error); // Nếu token hết hạn hoặc không hợp lệ
      if (error.response?.status === 401) {
        console.warn("Token expired or invalid");
        removeAuthTokens();
        setOrders([]);
      } else {
        setError(
          error.response?.data?.message || "Có lỗi xảy ra khi tải đơn hàng"
        );

        // Fallback to mock data nếu server không có data
        if (error.response?.status === 500 || !error.response) {
          console.warn("Using fallback mock data");
          setOrders(getMockOrders());
        }
      }
    } finally {
      setLoading(false);
    }
  };

  // Mock data làm fallback
  const getMockOrders = () => {
    const deliveryStatuses = ["preparing", "shipping", "delivered"];
    const getRandomStatus = () =>
      deliveryStatuses[Math.floor(Math.random() * deliveryStatuses.length)];

    return [
      {
        _id: "mock-12345",
        createdAt: new Date().toISOString(),
        shippingAddress: {
          address: "123 Main St",
          city: "Ho Chi Minh",
          country: "Viet Nam",
          postalCode: "700000",
        },
        orderItems: [
          {
            productId: "prod1",
            name: "Áo Thun Nam Basic Cotton",
            image:
              "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=500&h=600&fit=crop",
            quantity: 2,
            price: 299000,
            size: "M",
            color: "Đen",
          },
          {
            productId: "prod2",
            name: "Quần Jean Nam Slim Fit",
            image:
              "https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=500&h=600&fit=crop",
            quantity: 1,
            price: 750000,
            size: "32",
            color: "Xanh",
          },
        ],
        totalPrice: 1348000,
        isPaid: true,
        isDelivered: false,
        status: getRandomStatus(),
        paymentMethod: "Credit Card",
      },
      {
        _id: "mock-23456",
        createdAt: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
        shippingAddress: {
          address: "456 Nguyen Hue St",
          city: "Ha Noi",
          country: "Viet Nam",
          postalCode: "100000",
        },
        orderItems: [
          {
            productId: "prod3",
            name: "Váy Midi Nữ Elegant",
            image:
              "https://images.unsplash.com/photo-1566479179817-7c3c8c86e2e1?w=500&h=600&fit=crop",
            quantity: 1,
            price: 680000,
            size: "M",
            color: "Đen",
          },
        ],
        totalPrice: 680000,
        isPaid: false,
        isDelivered: false,
        status: getRandomStatus(),
        paymentMethod: "Cash on Delivery",
      },
    ];
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  // Hàm refresh đơn hàng
  const refreshOrders = () => {
    fetchOrders();
  };

  // Hàm cập nhật một đơn hàng cụ thể
  const updateOrder = (orderId, updatedData) => {
    setOrders((prevOrders) =>
      prevOrders.map((order) =>
        order._id === orderId ? { ...order, ...updatedData } : order
      )
    );
  };

  const value = {
    orders,
    loading,
    error,
    setOrders,
    refreshOrders,
    updateOrder,
    fetchOrders,
  };

  return (
    <OrderContext.Provider value={value}>{children}</OrderContext.Provider>
  );
};


===== FILE: ./frontend/src/components/profile/OrderDetailPage.jsx =====
import React, { useState, useEffect } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { useOrders } from "./OrderContext";
import axios from "axios";
import { getAuthToken } from "../../utils/auth";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const OrderDetailPage = () => {
  const { orders, loading } = useOrders();
  const navigate = useNavigate();
  const { id } = useParams();
  const [order, setOrder] = useState(null);
  const [orderLoading, setOrderLoading] = useState(false);
  const [orderError, setOrderError] = useState(null);

  // Helper function để format giá tiền
  const formatPrice = (price) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(price);
  };

  // Helper function để translate status
  const getStatusLabel = (status) => {
    const statusMap = {
      Processing: "Đang xử lý",
      Shipped: "Đang giao",
      Delivered: "Đã giao",
      Cancelled: "Đã hủy",
      preparing: "Đang chuẩn bị",
      shipping: "Đang giao",
      delivered: "Đã giao",
    };
    return statusMap[status] || status;
  };

  // Lấy chi tiết đơn hàng từ API nếu cần
  useEffect(() => {
    const foundOrder = orders?.find((o) => o._id === id);
    if (foundOrder) {
      setOrder(foundOrder);
    } else if (!loading && orders.length > 0) {
      // Nếu không tìm thấy trong context, gọi API để lấy chi tiết
      fetchOrderDetail();
    }
  }, [id, orders, loading]);
  const fetchOrderDetail = async () => {
    try {
      setOrderLoading(true);
      const token = getAuthToken();
      if (!token) {
        setOrderError("Vui lòng đăng nhập để xem đơn hàng");
        return;
      }

      const response = await axios.get(`${API_URL}/api/orders/${id}`, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });

      setOrder(response.data);
    } catch (error) {
      console.error("Error fetching order detail:", error);
      setOrderError("Không thể tải chi tiết đơn hàng");
    } finally {
      setOrderLoading(false);
    }
  };

  if (loading || orderLoading) {
    return (
      <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-4 sm:p-8 mt-4">
        <div className="flex justify-center items-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
          <span className="ml-2">Đang tải chi tiết đơn hàng...</span>
        </div>
      </div>
    );
  }

  if (!order || orderError) {
    return (
      <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-4 sm:p-8 mt-4">
        <button
          className="mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm"
          onClick={() => navigate(-1)}
        >
          ← Quay lại danh sách đơn hàng
        </button>
        <div className="text-red-500 font-semibold">
          {orderError || "Không tìm thấy đơn hàng!"}
        </div>
      </div>
    );
  }

  const orderItems = order.orderItems || order.oderItems || [];

  return (
    <div className="max-w-5xl mx-auto bg-white rounded-lg shadow-lg p-2 sm:p-4 md:p-8 mt-2 sm:mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8 text-sm sm:text-base">
      {/* Cột trái: Sản phẩm trong đơn hàng */}
      <div className="md:col-span-1 border-b md:border-b-0 md:border-r border-gray-200 pr-0 md:pr-4 pb-4 md:pb-0">
        <h4 className="font-bold text-sm sm:text-base mb-2 sm:mb-4">
          Đơn hàng của bạn
        </h4>
        <div className="divide-y divide-gray-200">
          {orderItems.map((item, idx) => (
            <div
              key={idx}
              className="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 py-2 sm:py-4"
            >
              <img
                src={
                  item.image ||
                  item.product?.imageUrl ||
                  "https://via.placeholder.com/150"
                }
                alt={item.name || item.product?.name}
                className="w-20 h-20 sm:w-16 sm:h-16 object-cover rounded border"
              />
              <div className="flex-1">
                <div className="font-medium text-gray-900 text-xs sm:text-sm">
                  {item.name || item.product?.name}
                </div>
                <div className="text-gray-600 text-xs">
                  Giá: {formatPrice(item.price)}
                </div>
                {item.size && (
                  <div className="text-gray-600 text-xs">Size: {item.size}</div>
                )}
                {item.color && (
                  <div className="text-gray-600 text-xs">Màu: {item.color}</div>
                )}{" "}
                <div className="text-gray-600 text-xs">
                  Số lượng: {item.quantity}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
      {/* Cột giữa: Địa chỉ giao hàng và thanh toán */}
      <div className="md:col-span-1 flex flex-col gap-4 md:gap-6">
        <div className="bg-gray-50 rounded border border-gray-200 p-2 sm:p-4">
          <div className="font-semibold mb-1 text-xs sm:text-sm">
            Địa chỉ giao hàng
          </div>
          <div className="text-xs sm:text-sm">
            {order.shippingAddress?.detail}
          </div>
          <div className="text-xs sm:text-sm">
            {order.shippingAddress?.city}, {order.shippingAddress?.country}
          </div>
        </div>
        <div className="bg-gray-50 rounded border border-gray-200 p-2 sm:p-4">
          <div className="font-semibold mb-2 text-xs sm:text-sm">
            Thanh toán
          </div>
          <div className="mb-1 text-gray-700 text-xs sm:text-sm">
            <span className="font-semibold">Trạng thái:</span>{" "}
            {order.isPaid ? "Đã thanh toán" : "Chưa thanh toán"}
          </div>
          <div className="mb-1 text-gray-700 text-xs sm:text-sm">
            <span className="font-semibold">Ngày tạo:</span>{" "}
            {new Date(order.createAt).toLocaleString("vi-VN")}
          </div>
          <div className="mb-1 text-gray-700 text-xs sm:text-sm">
            <span className="font-semibold">Trạng thái giao hàng:</span>{" "}
            {order.deliveryStatus === "delivered"
              ? "Giao hàng thành công"
              : order.deliveryStatus === "shipping"
              ? "Đang giao hàng"
              : "Đang chuẩn bị hàng"}
          </div>
        </div>
      </div>
      {/* Cột phải: Tổng đơn hàng */}
      <div className="md:col-span-1 border-t md:border-t-0 md:border-l border-gray-200 pl-0 md:pl-4 pt-4 md:pt-0 flex flex-col gap-4 md:gap-6">
        <div className="bg-gray-50 rounded border border-gray-200 p-2 sm:p-4">
          <div className="font-bold mb-2 text-xs sm:text-sm">TỔNG ĐƠN HÀNG</div>
          <div className="flex justify-between text-xs mb-1">
            <span>Tổng cộng</span>
            <span>
              {order.totalPrice.toLocaleString("vi-VN", {
                style: "currency",
                currency: "VND",
              })}
            </span>
          </div>
          {/* Có thể thêm phí vận chuyển, mã giảm giá nếu muốn */}
          <div className="flex justify-between text-xs mb-1">
            <span>Phí vận chuyển</span>
            <span>50.000 VND</span>
          </div>
          <div className="flex justify-between text-sm font-semibold mt-2">
            <span>TỔNG</span>
            <span>
              {(order.totalPrice + 50000).toLocaleString("vi-VN", {
                style: "currency",
                currency: "VND",
              })}
            </span>
          </div>
        </div>
        <button
          className="w-full bg-black text-white py-2 sm:py-3 rounded font-semibold hover:bg-gray-900 transition text-xs sm:text-sm"
          onClick={() => navigate(-1)}
        >
          Quay lại danh sách đơn hàng
        </button>
      </div>
    </div>
  );
};

export default OrderDetailPage;


===== FILE: ./frontend/src/components/profile/OrderSearch.jsx =====


===== FILE: ./frontend/src/components/profile/ProfileInfo.jsx =====
import React, { useState, useEffect } from "react";
import { useSelector, useDispatch } from "react-redux";
import { Navigate } from "react-router-dom";
import axios from "axios";
import { toast } from "sonner";
import { getUserProfile } from "../../redux/slices/authSlice";
import { fetchCities, fetchDistricts, fetchWards } from "../../utils/wards";

const ProfileInfo = () => {
  const [isEdit, setIsEdit] = useState(false);
  const [form, setForm] = useState({
    email: "",
    name: "",
    phone: "",
    birthday: "",
    gender: "",
    address: "",
    city: "",
    district: "",
    ward: "",
  });

  const [errors, setErrors] = useState({});
  const [loading, setLoading] = useState(false);
  // State cho dropdown địa chỉ
  const [cities, setCities] = useState([]);
  const [districts, setDistricts] = useState([]);
  const [wards, setWards] = useState([]);
  const [selectedCityCode, setSelectedCityCode] = useState(null);
  const [selectedDistrictCode, setSelectedDistrictCode] = useState(null);

  // Lấy thông tin user từ Redux store
  const { userInfo, userToken } = useSelector((state) => state.auth);
  const API_URL = import.meta.env.VITE_BACKEND_URL || "http://localhost:9000";
  const dispatch = useDispatch();

  // Redirect to login if not authenticated
  const token = userToken || localStorage.getItem("userToken") || localStorage.getItem("token");
  if (!token || !userInfo) {
    return <Navigate to="/login" replace />;
  }

  // Cập nhật form với thông tin người dùng từ Redux
  useEffect(() => {
    if (userInfo) {
      setForm({
        email: userInfo.email || "",
        name: userInfo.name || "",
        phone: userInfo.phone || "",
        birthday: userInfo.birth
          ? new Date(userInfo.birth).toLocaleDateString("vi-VN")
          : "",
        gender:
          userInfo.gender === "male"
            ? "Nam"
            : userInfo.gender === "female"
            ? "Nữ"
            : "Khác",
        address: userInfo.address || "",
        city: userInfo.city || "",
        district: userInfo.district || "",
        ward: userInfo.ward || "",
      });
    }
  }, [userInfo]);

  // Lấy danh sách tỉnh/thành khi mở form
  useEffect(() => {
    fetchCities().then((data) => setCities(data));
  }, []);

  // Khi userInfo thay đổi hoặc cities đã load, tự động set code cho city nếu có
  useEffect(() => {
    if (userInfo && cities.length > 0) {
      const cityObj = cities.find((c) => c.name === userInfo.city);
      if (cityObj) setSelectedCityCode(cityObj.code);
    }
  }, [userInfo, cities]);

  // Fetch districts khi chọn city
  useEffect(() => {
    if (selectedCityCode) {
      fetchDistricts(selectedCityCode).then((data) => setDistricts(data));
    } else {
      setDistricts([]);
      setWards([]);
    }
  }, [selectedCityCode]);

  // Khi userInfo thay đổi hoặc districts đã load, tự động set code cho district nếu có
  useEffect(() => {
    if (userInfo && districts.length > 0) {
      const districtObj = districts.find((d) => d.name === userInfo.district);
      if (districtObj) setSelectedDistrictCode(districtObj.code);
    }
  }, [userInfo, districts]);

  // Fetch wards khi chọn district
  useEffect(() => {
    if (selectedDistrictCode) {
      fetchWards(selectedDistrictCode).then((data) => setWards(data));
    } else {
      setWards([]);
    }
  }, [selectedDistrictCode]);

  const validate = () => {
    const newErrors = {};
    if (!form.email) {
      newErrors.email = "Vui lòng nhập email";
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email)) {
      newErrors.email = "Email không hợp lệ";
    }

    if (!form.name) newErrors.name = "Vui lòng nhập tên";
    if (!form.address) newErrors.address = "Vui lòng nhập địa chỉ";
    if (!form.city) newErrors.city = "Vui lòng nhập thành phố";
    if (!form.district) newErrors.district = "Vui lòng nhập quận/huyện";
    if (!form.ward) newErrors.ward = "Vui lòng nhập phường/xã";
    if (!form.phone) {
      newErrors.phone = "Vui lòng nhập số điện thoại";
    } else if (!/^\d{9,11}$/.test(form.phone)) {
      newErrors.phone = "Số điện thoại không hợp lệ";
    }
    if (!form.birthday) newErrors.birthday = "Vui lòng nhập ngày sinh";
    if (!form.gender) newErrors.gender = "Vui lòng chọn giới tính";
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm((prev) => ({ ...prev, [name]: value }));
  };

  const handleSave = async (e) => {
    e.preventDefault();
    if (!validate()) return;

    setLoading(true);

    try {
      // Chuyển đổi giới tính về dạng lưu trong database
      const genderMapping = {
        Nam: "male",
        Nữ: "female",
        Khác: "other",
      };

      // Chuyển đổi ngày sinh về định dạng ISO
      let birthDate = form.birthday;
      if (form.birthday && form.birthday.includes("/")) {
        const parts = form.birthday.split("/");
        if (parts.length === 3) {
          birthDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
      }

      const userData = {
        name: form.name,
        gender: genderMapping[form.gender] || "other",
        birth: birthDate,
        address: form.address,
        city: form.city,
        district: form.district,
        ward: form.ward,
        phone: form.phone,
      };

      const response = await axios.put(
        `${API_URL}/api/users/update-profile`,
        userData,
        {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${userToken}`,
          },
        }
      );

      toast.success("Cập nhật thông tin thành công!");
      setIsEdit(false);

      // Cập nhật lại profile từ backend và Redux
      await dispatch(getUserProfile());
    } catch (error) {
      console.error("Lỗi khi cập nhật thông tin:", error);
      toast.error("Có lỗi xảy ra khi cập nhật thông tin!");
    } finally {
      setLoading(false);
    }
  };

  return (
    <section className="bg-white border border-gray-200 p-4 sm:p-6 md:p-8 mb-8">
      <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
        <h3 className="text-xl sm:text-2xl font-medium">HỒ SƠ CÁ NHÂN</h3>
        {isEdit ? (
          <button
            className=""
            onClick={() => setIsEdit(false)}
            disabled={loading}
          >
            Hủy
          </button>
        ) : (
          <button
            className="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 w-full sm:w-auto"
            onClick={() => setIsEdit(true)}
          >
            Sửa thông tin
          </button>
        )}
      </div>
      {isEdit ? (
        <form
          className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6"
          onSubmit={handleSave}
        >
          <div>
            <div className="mb-2 text-gray-600 font-semibold">
              ĐỊA CHỈ EMAIL
            </div>
            <input
              type="email"
              name="email"
              value={form.email}
              onChange={handleChange}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.email ? "border-red-500" : ""
              }`}
              disabled={true} // Email không thể thay đổi
              required
            />
            {errors.email && (
              <div className="text-red-500 text-sm mb-3">{errors.email}</div>
            )}
            <div className="mb-2 text-gray-600 font-semibold">TÊN</div>
            <input
              type="text"
              name="name"
              value={form.name}
              onChange={handleChange}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.name ? "border-red-500" : ""
              }`}
              required
            />
            {errors.name && (
              <div className="text-red-500 text-sm mb-3">{errors.name}</div>
            )}
            <div className="mb-2 text-gray-600 font-semibold">ĐỊA CHỈ</div>
            <input
              type="text"
              name="address"
              value={form.address}
              onChange={handleChange}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.address ? "border-red-500" : ""
              }`}
              required
            />
            {errors.address && (
              <div className="text-red-500 text-sm mb-3">{errors.address}</div>
            )}
            {/* Thành phố */}
            <div className="mb-2 text-gray-600 font-semibold">THÀNH PHỐ</div>
            <select
              name="city"
              value={form.city}
              onChange={(e) => {
                const cityName = e.target.options[e.target.selectedIndex].text;
                setForm((prev) => ({
                  ...prev,
                  city: cityName,
                  district: "",
                  ward: "",
                }));
                const cityObj = cities.find((c) => c.name === cityName);
                setSelectedCityCode(cityObj ? cityObj.code : null);
                setSelectedDistrictCode(null);
              }}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.city ? "border-red-500" : ""
              }`}
              required
            >
              <option value="">Chọn thành phố</option>
              {cities.map((city) => (
                <option key={city.code} value={city.name}>
                  {city.name}
                </option>
              ))}
            </select>
            {errors.city && (
              <div className="text-red-500 text-sm mb-3">{errors.city}</div>
            )}
            {/* Quận/huyện */}
            <div className="mb-2 text-gray-600 font-semibold">QUẬN/HUYỆN</div>
            <select
              name="district"
              value={form.district}
              onChange={(e) => {
                const districtName =
                  e.target.options[e.target.selectedIndex].text;
                setForm((prev) => ({
                  ...prev,
                  district: districtName,
                  ward: "",
                }));
                const districtObj = districts.find(
                  (d) => d.name === districtName
                );
                setSelectedDistrictCode(districtObj ? districtObj.code : null);
              }}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.district ? "border-red-500" : ""
              }`}
              required
              disabled={!selectedCityCode || districts.length === 0}
            >
              <option value="">Chọn quận/huyện</option>
              {districts.map((d) => (
                <option key={d.code} value={d.name}>
                  {d.name}
                </option>
              ))}
            </select>
            {errors.district && (
              <div className="text-red-500 text-sm mb-3">{errors.district}</div>
            )}
            {/* Phường/xã */}
            <div className="mb-2 text-gray-600 font-semibold">PHƯỜNG/XÃ</div>
            <select
              name="ward"
              value={form.ward}
              onChange={(e) => {
                const wardName = e.target.options[e.target.selectedIndex].text;
                setForm((prev) => ({ ...prev, ward: wardName }));
              }}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.ward ? "border-red-500" : ""
              }`}
              required
              disabled={!selectedDistrictCode || wards.length === 0}
            >
              <option value="">Chọn phường/xã</option>
              {wards.map((w) => (
                <option key={w.code} value={w.name}>
                  {w.name}
                </option>
              ))}
            </select>
            {errors.ward && (
              <div className="text-red-500 text-sm mb-3">{errors.ward}</div>
            )}
          </div>
          <div>
            <div className="mb-2 text-gray-600 font-semibold">
              ĐIỆN THOẠI DI ĐỘNG
            </div>
            <input
              type="text"
              name="phone"
              value={form.phone}
              onChange={handleChange}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.phone ? "border-red-500" : ""
              }`}
              required
            />
            {errors.phone && (
              <div className="text-red-500 text-sm mb-3">{errors.phone}</div>
            )}
            <div className="mb-2 text-gray-600 font-semibold">SINH NHẬT</div>
            <input
              type="date"
              name="birthday"
              value={form.birthday.split("/").reverse().join("-")}
              onChange={(e) => {
                const val = e.target.value;
                setForm((prev) => ({
                  ...prev,
                  birthday: val.split("-").reverse().join("/"),
                }));
              }}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.birthday ? "border-red-500" : ""
              }`}
              required
            />
            {errors.birthday && (
              <div className="text-red-500 text-sm mb-3">{errors.birthday}</div>
            )}
            <div className="mb-2 text-gray-600 font-semibold">GIỚI TÍNH</div>
            <select
              name="gender"
              value={form.gender}
              onChange={handleChange}
              className={`mb-1 w-full border rounded px-3 py-2 ${
                errors.gender ? "border-red-500" : ""
              }`}
              required
            >
              <option value="">Chọn giới tính</option>
              <option value="Nam">Nam</option>
              <option value="Nữ">Nữ</option>
              <option value="Khác">Khác</option>
            </select>
            {errors.gender && (
              <div className="text-red-500 text-sm mb-3">{errors.gender}</div>
            )}
          </div>
          <div className="col-span-1 md:col-span-2 flex flex-col md:flex-row justify-end gap-3 mt-2">
            <button
              type="submit"
              className="px-6 py-2 bg-black text-white rounded hover:bg-gray-800 w-full md:w-auto"
              disabled={loading}
            >
              {loading ? "Đang lưu..." : "Lưu"}
            </button>
          </div>
        </form>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
          <div>
            <div className="mb-2 text-gray-600 font-semibold">
              ĐỊA CHỈ EMAIL
            </div>
            <div className="mb-4">{form.email}</div>
            <div className="mb-2 text-gray-600 font-semibold">TÊN</div>
            <div className="mb-4">{form.name}</div>
            <div className="mb-2 text-gray-600 font-semibold">ĐỊA CHỈ</div>
            <div className="mb-4">{form.address}</div>
            <div className="mb-2 text-gray-600 font-semibold">THÀNH PHỐ</div>
            <div className="mb-4">{form.city}</div>
            <div className="mb-2 text-gray-600 font-semibold">QUẬN/HUYỆN</div>
            <div className="mb-4">{form.district}</div>
            <div className="mb-2 text-gray-600 font-semibold">PHƯỜNG/XÃ</div>
            <div className="mb-4">{form.ward}</div>
          </div>
          <div>
            <div className="mb-2 text-gray-600 font-semibold">
              ĐIỆN THOẠI DI ĐỘNG
            </div>
            <div className="mb-4">{form.phone}</div>
            <div className="mb-2 text-gray-600 font-semibold">SINH NHẬT</div>
            <div className="mb-4">{form.birthday}</div>
            <div className="mb-2 text-gray-600 font-semibold">GIỚI TÍNH</div>
            <div className="mb-4">{form.gender}</div>
          </div>
        </div>
      )}
    </section>
  );
};

export default ProfileInfo;


===== FILE: ./frontend/src/components/profile/ProfileLayout.jsx =====
import React from "react";
import { NavLink, Outlet } from "react-router-dom";

const ProfileLayout = () => {
  return (
    <div className="bg-white mx-2 sm:mx-8 md:mx-20 lg:mx-[150px] my-6 md:my-[50px]">
      <h2 className="text-base sm:text-2xl font-medium mb-3 sm:mb-4 text-center md:text-left md:mb-10">
        THÔNG TIN TÀI KHOẢN
      </h2>
      <div className="flex flex-col md:flex-row max-w-6xl mx-auto w-full gap-1">
        {/* Sidebar */}{" "}
        <aside className="md:w-[25%] border-gray-200 pr-0 md:pr-4 mb-3 md:mb-0 flex-shrink-0">
          <nav className="flex flex-row md:flex-col gap-2 text-[15px] justify-center md:justify-start">
            <NavLink
              to="info"
              className={({ isActive }) =>
                `text-lg hover:underline px-2 py-1 md:px-0 md:py-0 text-center md:text-left ${
                  isActive ? "font-medium" : "font-normal"
                }`
              }
              end
            >
              Hồ sơ cá nhân
            </NavLink>
            <NavLink
              to="orders"
              className={({ isActive }) =>
                `text-lg hover:underline px-2 py-1 md:px-0 md:py-0 text-center md:text-left ${
                  isActive ? "font-medium" : "font-normal"
                }`
              }
            >
              Lịch sử đơn hàng
            </NavLink>
          </nav>
        </aside>
        {/* Main content */}
        <main className="flex-1 w-full">
          <Outlet />
        </main>
      </div>
    </div>
  );
};

export default ProfileLayout;


===== FILE: ./frontend/src/hooks/usePaymentChecker.js =====


===== FILE: ./frontend/src/main.jsx =====
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import "./index.css";
import App from "./App.jsx";

createRoot(document.getElementById("root")).render(
  <StrictMode>
    <App />
  </StrictMode>
);


===== FILE: ./frontend/src/pages/About.jsx =====
import React from "react";

const About = () => (
  <div className="mb-6 text-gray-800">
    <div className="mb-4">
      Từ ngày 2 tháng 10 năm 2018
      <br />
      CÔNG TY TNHH WUKUDADA VIỆT NAM
    </div>
    <div className="font-bold mb-1">TÊN CÔNG TY</div>
    <div className="mb-4">CÔNG TY TNHH WUKUDADA VIỆT NAM</div>
    <div className="font-bold mb-1">THÀNH LẬP</div>
    <div className="mb-4">2 tháng 10, 2018</div>
    <div className="font-bold mb-1">VỊ TRÍ</div>
    <div className="mb-4">
      Địa chỉ đăng ký: Tầng 26, Tòa nhà Viettel, Số 285, Đường Cách Mạng Tháng
      Tám, Phường 12, Quận 10, Thành phố Hồ Chí Minh, Việt Nam
    </div>
    <div className="font-bold mb-1">NGÀNH NGHỀ KINH DOANH</div>
    <div className="mb-4">
      Bán lẻ sản phẩm thời trang thiết kế nhãn hiệu WUKUDADA tại Việt Nam
    </div>
    <div className="font-bold mb-1">SỐ CỬA HÀNG</div>
    <div>8 cửa hàng (Tính đến tháng 8 năm 2021)</div>
  </div>
);

export default About;


===== FILE: ./frontend/src/pages/AdminHomePage.jsx =====
import React, { useState, useEffect } from "react";
import { Link } from "react-router-dom";
import axios from "axios";
import { useSelector } from "react-redux";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const AdminHomePage = () => {
  const [orders, setOrders] = useState([]);
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [stats, setStats] = useState({
    totalRevenue: 0,
    totalOrders: 0,
    totalProducts: 0,
  });

  // Get auth token from Redux state
  const { userToken } = useSelector((state) => state.auth);

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        // Fetch orders
        const ordersResponse = await axios.get(`${API_URL}/api/admin/orders`, {
          headers: {
            Authorization: `Bearer ${userToken}`,
          },
        });
        const ordersData = ordersResponse.data;
        setOrders(ordersData);

        // Fetch products
        const productsResponse = await axios.get(`${API_URL}/api/admin/products`, {
          headers: {
            Authorization: `Bearer ${userToken}`,
          },
        });
        const productsData = productsResponse.data;
        setProducts(productsData);

        // Calculate statistics
        const totalRevenue = ordersData.reduce((acc, order) => {
          if (order.paymentStatus === "Paid") {
            return acc + order.totalPrice;
          }
          return acc;
        }, 0);

        setStats({
          totalRevenue,
          totalOrders: ordersData.length,
          totalProducts: productsData.length,
        });

        setLoading(false);
      } catch (err) {
        console.error("Error fetching admin data:", err);
        setError("Không thể tải dữ liệu. Vui lòng thử lại sau.");
        setLoading(false);
      }
    };

    fetchData();
  }, [userToken]);

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-900"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto p-6">
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          {error}
        </div>
      </div>
    );
  }

  // Format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">Bảng điều khiển</h1>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h2 className="text-lg font-semibold mb-4">Doanh thu</h2>
          <p className="text-2xl">{formatCurrency(stats.totalRevenue)}</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h2 className="text-lg font-semibold mb-4">Tổng đơn hàng</h2>
          <p className="text-2xl">{stats.totalOrders}</p>
          <Link to="/admin/orders" className="text-blue-500 hover:underline">
            Quản lý đơn hàng
          </Link>
        </div>
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h2 className="text-lg font-semibold mb-4">Tổng sản phẩm</h2>
          <p className="text-2xl">{stats.totalProducts}</p>
          <Link to="/admin/products" className="text-blue-500 hover:underline">
            Quản lý sản phẩm
          </Link>
        </div>
      </div>
      <div className="mt-6">
        <h2 className="text-lg font-bold mb-4">Đơn hàng gần nhất</h2>
        <div className="overflow-x-auto">
          <table className="min-w-full text-left text-gray-600 border border-gray-100 border-collapse">
            <thead className="text-xs text-black uppercase bg-gray-100">
              <tr>
                <th scope="col" className="px-3 py-3">
                  Mã đơn hàng
                </th>
                <th scope="col" className="px-3 py-3">
                  Người dùng
                </th>
                <th scope="col" className="px-3 py-3">
                  Tổng tiền
                </th>
                <th scope="col" className="px-3 py-3">
                  Trạng thái
                </th>
              </tr>
            </thead>
            <tbody>
              {orders.length > 0 ? (
                orders.slice(0, 5).map((order) => (
                  <tr key={order._id} className="border-b border-gray-100">
                    <td className="px-3 py-3">{order._id}</td>
                    <td className="px-3 py-3">{order.user?.name || "N/A"}</td>
                    <td className="px-3 py-3">{formatCurrency(order.totalPrice)}</td>
                    <td className="px-3 py-3">{order.status}</td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan={4} className="px-3 py-3 text-center">
                    Không có đơn hàng
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

export default AdminHomePage;


===== FILE: ./frontend/src/pages/Cart.jsx =====
import React, { useEffect, useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";
import {
  clearCart,
  removeFromCart,
  updateCartItemQuantity,
  fetchCart,
  clearCartServer,
} from "../redux/slices/cartSlice";

const Cart = () => {
  const navigate = useNavigate();
  const { userInfo, guestId } = useSelector((state) => state.auth);
  const { cart, loading, error } = useSelector((state) => state.cart);
  const [shippingCost, setShippingCost] = useState(0);

  const userId = userInfo ? userInfo._id : null;
  const dispatch = useDispatch();
  useEffect(() => {
    console.log("Auth state:", { userInfo, guestId });
    console.log("User ID:", userId);
    console.log("User structure:", userInfo);

    // Kiểm tra localStorage
    const userFromStorage = localStorage.getItem("userInfo");
    const tokenFromStorage = localStorage.getItem("userToken");

    console.log("UserInfo from localStorage:", userFromStorage);
    console.log("Token from localStorage:", tokenFromStorage);

    if (userFromStorage) {
      try {
        const parsedUser = JSON.parse(userFromStorage);
        console.log("Parsed user:", parsedUser);
      } catch (e) {
        console.error("Error parsing user from localStorage:", e);
      }
    }
  }, [userInfo, guestId, userId]);
  // Fetch cart khi component mount
  useEffect(() => {
    if (userId || guestId) {
      dispatch(fetchCart({ userId, guestId }));
    }
  }, [dispatch, userId, guestId]);

  const calculateShippingCost = (city) => {
    if (!city) return 30000; // Mặc định là 30.000 VND nếu chưa có thành phố
    return city.trim().toLowerCase().includes("hồ chí minh") ? 0 : 30000;
  };

  const getShippingCost = () => {
    return calculateShippingCost(userInfo?.city);
  };

  const getTotalAmount = () => {
    return getTotalPrice() + getShippingCost();
  };

  const getTotalPrice = () => {
    if (!cart?.products || cart.products.length === 0) return 0;

    return cart.products.reduce((total, item) => {
      const product = item.productId || item.product;
      const price = product?.discountPrice || product?.price || item.price || 0;
      return total + price * item.quantity;
    }, 0);
  };

  const handleCheckout = () => {
    if (!userInfo) {
      navigate("/login?redirect=checkout");
      return;
    }
    navigate("/checkout");
  };

  const handleAddToCart = (productId, quantity, size, color, delta) => {
    const newQuantity = quantity + delta;
    if (newQuantity >= 1) {
      dispatch(
        updateCartItemQuantity({
          productId,
          quantity: newQuantity,
          size,
          color,
          userId,
          guestId,
        })
      );
    }
  };

  const handleRemoveFromCart = (productId, size, color) => {
    dispatch(removeFromCart({ productId, size, color, userId, guestId }));
  };

  const handleClearCart = () => {
    if (userId || guestId) {
      dispatch(clearCartServer({ userId, guestId }));
    } else {
      dispatch(clearCart());
    }
  };

  // Xử lý trường hợp error
  if (error && error !== "Cart not found") {
    return (
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="text-center text-red-500">
          <p>Có lỗi xảy ra: {error}</p>
          <button
            onClick={() => window.location.reload()}
            className="mt-4 px-4 py-2 bg-blue-500 text-white rounded"
          >
            Thử lại
          </button>
        </div>
      </div>
    );
  }

  // Xử lý trường hợp cart chưa được khởi tạo hoặc cart not found (coi như giỏ hàng trống)
  if (!cart || !cart.products || error === "Cart not found") {
    return (
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="flex flex-col items-center justify-center py-12">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
            className="w-16 h-16 text-gray-400 mb-4"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
            />
          </svg>
          <p className="text-gray-500 mb-4">Giỏ hàng của bạn đang trống</p>
          <Link
            to="/"
            className="px-6 py-2 bg-black text-white rounded-full hover:bg-gray-800"
          >
            Tiếp tục mua sắm
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-medium mb-8">
        Giỏ hàng ({cart.products?.length || 0})
      </h1>

      {loading ? (
        <div className="flex items-center justify-center py-12">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      ) : cart.products.length === 0 ? (
        <div className="flex flex-col items-center justify-center py-12">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
            className="w-16 h-16 text-gray-400 mb-4"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
            />
          </svg>
          <p className="text-gray-500 mb-4">Giỏ hàng của bạn đang trống</p>
          <Link
            to="/"
            className="px-6 py-2 bg-black text-white rounded-full hover:bg-gray-800"
          >
            Tiếp tục mua sắm
          </Link>
        </div>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Cart items */}
          <div className="lg:col-span-2 space-y-4">
            {cart.products.map((item, index) => {
              // SỬA: Xử lý cả hai cấu trúc dữ liệu có thể có
              const product = item.productId || item.product;
              const productId = product?._id || item.productId;

              // Nếu không có thông tin sản phẩm, bỏ qua item này
              if (!product) {
                console.warn("Missing product data for cart item:", item);
                return null;
              }

              return (
                <div
                  key={`${productId}-${item.size}-${item.color}-${index}`}
                  className="flex gap-4 p-4 bg-white border border-[#DCDCDC]"
                >
                  {/* Product image */}
                  <Link
                    to={`/product/${productId}`}
                    className="w-32 flex-shrink-0"
                  >
                    <img
                      src={
                        product.images?.[0]?.url ||
                        item.image ||
                        "/placeholder-image.jpg"
                      }
                      alt={product.name || item.name}
                      className="w-full h-full object-cover"
                      onError={(e) => {
                        e.target.src = "/placeholder-image.jpg";
                      }}
                    />
                  </Link>

                  <div className="flex-1 flex flex-col justify-between">
                    {/* Product details */}
                    <div className="flex justify-between items-start">
                      <div>
                        <Link
                          to={`/product/${productId}`}
                          className="text-xl font-medium hover:underline"
                        >
                          {product.name || item.name}
                        </Link>
                        <div className="text-lg text-gray-500 mt-1">
                          <p>Màu: {item.color?.name || "N/A"}</p>
                          <p>Size: {item.size}</p>
                        </div>
                      </div>
                      <button
                        onClick={() =>
                          handleRemoveFromCart(productId, item.size, item.color)
                        }
                        className="text-red-500 hover:text-red-600"
                      >
                        Xóa
                      </button>
                    </div>
                    {/* Price and quantity */}
                    <div className="flex items-center justify-between mt-4">
                      {/* Quantity */}
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() =>
                            handleAddToCart(
                              productId,
                              item.quantity,
                              item.size,
                              item.color,
                              -1
                            )
                          }
                          className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 cursor-pointer"
                        >
                          -
                        </button>
                        <span className="w-8 text-center">{item.quantity}</span>
                        <button
                          onClick={() =>
                            handleAddToCart(
                              productId,
                              item.quantity,
                              item.size,
                              item.color,
                              1
                            )
                          }
                          className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 cursor-pointer"
                        >
                          +
                        </button>
                      </div>
                      {/* Price */}
                      <div className="text-right">
                        <p className="font-medium">
                          {(
                            (product.discountPrice ||
                              product.price ||
                              item.price ||
                              0) * item.quantity
                          ).toLocaleString("vi-VN")}{" "}
                          VND
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* Order summary */}
          <div className="lg:col-span-1">
            <div className="bg-white border border-[#DCDCDC] p-6 sticky top-4">
              <h2 className="text-2xl font-medium mb-4">Tổng đơn hàng</h2>

              <div className="space-y-2 mb-4">
                <div className="flex justify-between">
                  <span>Tạm tính</span>
                  <span>{getTotalPrice().toLocaleString("vi-VN")} VND</span>
                </div>
                <div className="flex justify-between">
                  <span>Phí vận chuyển</span>
                  <span>
                    {getShippingCost() === 0 ? (
                      <span className="text-green-600 font-bold">Miễn phí</span>
                    ) : (
                      <span>
                        {getShippingCost().toLocaleString("vi-VN")} VND
                      </span>
                    )}
                  </span>
                </div>
                <div className="border-t pt-2 mt-2">
                  <div className="flex justify-between font-medium">
                    <span>Tổng tiền</span>
                    <span>{getTotalAmount().toLocaleString("vi-VN")} VND</span>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <button
                  onClick={handleCheckout}
                  className="block w-full py-2 px-4 bg-red-500 text-white text-center hover:bg-red-400"
                >
                  Thanh toán
                </button>
                <button
                  onClick={handleClearCart}
                  className="block w-full py-2 px-4 border border-black text-black text-center hover:bg-gray-100"
                >
                  Xóa giỏ hàng
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Cart;


===== FILE: ./frontend/src/pages/Checkout.jsx =====
import React, { useState, useEffect } from "react";
import { useSelector, useDispatch } from "react-redux";
import { createCheckoutSession } from "../redux/slices/checkoutSlice";
import { useNavigate } from "react-router-dom";
import { toast } from "sonner";
import {
  BANK_INFO,
  generateVietQRUrl,
  generateOrderCode,
  QR_FALLBACK_SVG,
  fetchRecentTransactionsAndCheckPayment,
} from "../utils/bankInfo";
import {
  clearCart,
  clearCartServer,
  fetchCart,
} from "../redux/slices/cartSlice";
import { useCart } from "../components/Cart/CartContext";
import axios from "axios";

const Checkout = () => {
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const { cart } = useSelector((state) => state.cart);
  const cartItems = cart?.products || [];
  const getTotalPrice = () => {
    if (!cartItems || cartItems.length === 0) return 0;
    return cartItems.reduce((total, item) => {
      const product = item.productId || item.product;
      const price = product?.discountPrice || product?.price || item.price || 0;
      return total + price * item.quantity;
    }, 0);
  };
  const { loading, error } = useSelector((state) => state.checkout);
  const { userInfo, guestId } = useSelector((state) => state.auth);
  const userId = userInfo ? userInfo.id || userInfo._id : null;
  const { clearCart: clearCartContext } = useCart();

  // Helper function to parse address from user profile
  const parseAddress = (addressString) => {
    if (!addressString)
      return { address: "", city: "", district: "", ward: "" };

    // Try to parse Vietnamese address format: "street, district, city"
    const parts = addressString.split(",").map((part) => part.trim());

    if (parts.length >= 3) {
      return {
        address: parts[0] || "",
        district: parts[1] || "",
        city: parts[2] || "",
        ward: parts.length > 3 ? parts.slice(1, -2).join(", ") : "",
      };
    } else if (parts.length === 2) {
      return {
        address: parts[0] || "",
        city: parts[1] || "",
        district: "",
        ward: "",
      };
    } else {
      return {
        address: addressString,
        city: "",
        district: "",
        ward: "",
      };
    }
  };
  // Initialize form with user data from Redux store
  const initializeFormData = () => {
    const user = userInfo || {};
    const parsedAddress = parseAddress(user.address);
    // Chuẩn hóa ngày sinh về yyyy-MM-dd nếu có
    let birth = "";
    if (user.birth) {
      const d = new Date(user.birth);
      if (!isNaN(d.getTime())) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        birth = `${yyyy}-${mm}-${dd}`;
      }
    }
    return {
      fullName: user.name || "",
      email: user.email || "",
      phone: user.phone || "",
      address: parsedAddress.address,
      city: user.city || parsedAddress.city || "",
      district: user.district || parsedAddress.district || "",
      ward: user.ward || parsedAddress.ward || "",
      postalCode: "700000",
      country: "Vietnam",
      paymentMethod: "cod",
      notes: "",
      birth, // thêm birth nếu cần dùng cho input type="date"
    };
  };
  // Form state
  const [formData, setFormData] = useState(initializeFormData());
  const [errors, setErrors] = useState({});
  const [isProcessing, setIsProcessing] = useState(false);
  const [isPaymentVerified, setIsPaymentVerified] = useState(false);
  const [isCheckingPayment, setIsCheckingPayment] = useState(false);
  const [paymentCheckResult, setPaymentCheckResult] = useState(null);
  // Calculate shipping cost (free for HCM, otherwise 30000)
  const [shippingCost, setShippingCost] = useState(0);
  useEffect(() => {
    if (
      formData.city &&
      formData.city.trim().toLowerCase().includes("hồ chí minh")
    ) {
      setShippingCost(0);
    } else {
      setShippingCost(30000);
    }
  }, [formData.city]);
  const totalAmount = getTotalPrice() + shippingCost;

  // Redirect if cart is empty
  useEffect(() => {
    if (!cartItems || cartItems.length === 0) {
      toast.error("Giỏ hàng của bạn đang trống!");
      navigate("/cart");
    }
  }, [cartItems, navigate]); // Handle input changes (only for payment method and notes)
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));

    // Kiểm tra thông tin khi chuyển sang phương thức chuyển khoản
    if (name === "paymentMethod" && value === "bank_transfer") {
      const requiredFields = [
        { field: "fullName", label: "Họ và tên" },
        { field: "email", label: "Email" },
        { field: "phone", label: "Số điện thoại" },
        { field: "address", label: "Địa chỉ" },
        { field: "city", label: "Thành phố" },
        { field: "district", label: "Quận/Huyện" },
        { field: "ward", label: "Phường/Xã" },
      ];

      const missingFields = requiredFields.filter(
        ({ field }) => !formData[field] || formData[field].trim() === ""
      );

      if (missingFields.length > 0) {
        toast.error(
          `Vui lòng cập nhật đầy đủ thông tin: ${missingFields
            .map(({ label }) => label)
            .join(", ")} trong hồ sơ cá nhân!`
        );
      }
    }
  };

  // Validate form
  const validateForm = () => {
    const newErrors = {};
    if (!formData.fullName.trim())
      newErrors.fullName = "Vui lòng cập nhật tên trong hồ sơ";
    if (!formData.email.trim())
      newErrors.email = "Vui lòng cập nhật email trong hồ sơ";
    if (!formData.phone.trim())
      newErrors.phone = "Vui lòng cập nhật số điện thoại trong hồ sơ";
    if (!formData.address.trim())
      newErrors.address = "Vui lòng cập nhật địa chỉ trong hồ sơ";

    // Email validation (only if email exists)
    if (formData.email && formData.email.trim()) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(formData.email)) {
        newErrors.email = "Email trong hồ sơ không hợp lệ";
      }
    }

    // Phone validation (only if phone exists)
    if (formData.phone && formData.phone.trim()) {
      const phoneRegex = /^[0-9]{10,11}$/;
      if (!phoneRegex.test(formData.phone.replace(/\s/g, ""))) {
        newErrors.phone = "Số điện thoại trong hồ sơ không hợp lệ";
      }
    }

    setErrors(newErrors);
    if (Object.keys(newErrors).length > 0) {
      toast.error(
        "Vui lòng nhập đầy đủ thông tin giao hàng trong hồ sơ cá nhân!"
      );
    }
    return Object.keys(newErrors).length === 0;
  };
  // Handle form submission
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!validateForm()) {
      toast.error("Vui lòng kiểm tra lại thông tin đơn hàng!");
      return;
    }

    const requiredFields = [
      "address",
      "city",
      "district",
      "ward",
      "postalCode",
      "country",
    ];
    for (const field of requiredFields) {
      if (!formData[field] || formData[field].trim() === "") {
        toast.error(`Thiếu thông tin: ${field}`);
        return;
      }
    }

    setIsProcessing(true);
    try {
      // Prepare order data cho flow cũ, chỉ gửi productId
      const orderData = {
        formData: {
          fullName: formData.fullName,
          email: formData.email,
          phone: formData.phone,
          address: formData.address,
          city: formData.city,
          district: formData.district,
          ward: formData.ward,
          postalCode: formData.postalCode,
          country: formData.country,
          notes: formData.notes,
          paymentMethod: formData.paymentMethod, // Thêm paymentMethod vào formData
        },
        cartItems: cartItems.map((item) => ({
          productId: item.productId?._id || item.productId || item.product?._id,
          size: item.size,
          color: item.color,
          quantity: item.quantity,
        })),
        totalPrice: getTotalPrice() + shippingCost,
      };
      // Log dữ liệu gửi lên để kiểm tra
      console.log("orderData gửi lên:", orderData);
      // Create order
      const response = await axios.post(
        `${import.meta.env.VITE_API_URL}/api/orders`,
        orderData,
        {
          headers: {
            Authorization: `Bearer ${
              localStorage.getItem("userToken") || localStorage.getItem("token")
            }`,
          },
        }
      );
      if (response.data) {
        // Xử lý hàng tồn kho và cập nhật số lượng sản phẩm
        try {
          const token =
            localStorage.getItem("userToken") || localStorage.getItem("token");

          // Gọi API để cập nhật hàng tồn kho cho các sản phẩm trong đơn hàng
          await axios.post(
            `${import.meta.env.VITE_API_URL}/api/orders/${
              response.data._id
            }/update-stock`,
            {},
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          console.log("✅ Đã cập nhật hàng tồn kho thành công");
        } catch (stockError) {
          console.error("❌ Lỗi khi cập nhật hàng tồn kho:", stockError);
          toast.warning(
            "Đặt hàng thành công nhưng có lỗi khi cập nhật tồn kho!"
          );
        }

        // ✅ Xoá giỏ hàng
        try {
          clearCartContext();
          localStorage.removeItem("cart");
          dispatch(clearCart());

          if (userId || guestId) {
            const token =
              localStorage.getItem("userToken") ||
              localStorage.getItem("token");
            await axios.delete(
              `${import.meta.env.VITE_API_URL}/api/cart/clear`,
              {
                data: { userId, guestId },
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }
            );
            await dispatch(fetchCart({ userId, guestId }));
          }

          dispatch({ type: "cart/clearCart" });
          toast.success("Đặt hàng thành công! Giỏ hàng đã được xóa.");
        } catch (error) {
          console.error("Lỗi khi xóa giỏ hàng:", error);
          toast.error("Đặt hàng thành công nhưng có lỗi khi xóa giỏ hàng.");
        }

        // ✅ Điều hướng tuỳ theo phương thức thanh toán
        if (formData.paymentMethod === "bank_transfer") {
          toast.success(
            "Đặt hàng thành công! Đơn hàng đã được ghi nhận là ĐÃ THANH TOÁN."
          );
          setIsPaymentVerified(true);
          return;
        } else {
          toast.success("Đặt hàng thành công!");
          navigate("/");
        }
      }
    } catch (error) {
      console.log("[DEBUG] error:", error);
      toast.error(error.message || "Có lỗi xảy ra khi đặt hàng!");
    } finally {
      setIsProcessing(false);
    }
  };
  // Check payment status
  const handleCheckPayment = async () => {
    // Kiểm tra thông tin ProfileInfo trước khi cho phép kiểm tra thanh toán
    if (!validateForm()) {
      toast.error(
        "Vui lòng cập nhật đầy đủ thông tin giao hàng trong hồ sơ cá nhân trước khi kiểm tra thanh toán!"
      );
      return;
    }

    // Kiểm tra các trường bắt buộc
    const requiredFields = [
      { field: "fullName", label: "Họ và tên" },
      { field: "email", label: "Email" },
      { field: "phone", label: "Số điện thoại" },
      { field: "address", label: "Địa chỉ" },
      { field: "city", label: "Thành phố" },
      { field: "district", label: "Quận/Huyện" },
      { field: "ward", label: "Phường/Xã" },
    ];

    const missingFields = requiredFields.filter(
      ({ field }) => !formData[field] || formData[field].trim() === ""
    );

    if (missingFields.length > 0) {
      toast.error(
        `Vui lòng cập nhật đầy đủ thông tin: ${missingFields
          .map(({ label }) => label)
          .join(", ")} trong hồ sơ cá nhân!`
      );
      return;
    }

    // Kiểm tra định dạng email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email)) {
      toast.error("Email không hợp lệ!");
      return;
    }

    // Kiểm tra định dạng số điện thoại
    const phoneRegex = /^[0-9]{10,11}$/;
    if (!phoneRegex.test(formData.phone.replace(/\s/g, ""))) {
      toast.error("Số điện thoại không hợp lệ!");
      return;
    }

    setIsCheckingPayment(true);
    setPaymentCheckResult(null);
    setIsPaymentVerified(false);
    const orderCode =
      document
        .querySelector(".font-mono.text-xs.bg-white.p-2.border.rounded.mt-1")
        ?.textContent?.split(" ")[0] || generateOrderCode();
    const amount = getTotalPrice() + shippingCost;
    // Lấy phone từ userInfo nếu có, fallback rỗng
    const phone = userInfo?.phone || formData.phone || "";
    const result = await fetchRecentTransactionsAndCheckPayment(
      orderCode,
      amount,
      phone
    );
    setIsCheckingPayment(false);
    if (result) {
      setIsPaymentVerified(true);
      setPaymentCheckResult({
        success: true,
        message: "Đã xác nhận thanh toán thành công!",
      });
      toast.success("Đã xác nhận thanh toán thành công!");
    } else {
      setIsPaymentVerified(false);
      setPaymentCheckResult({
        success: false,
        message:
          "Chưa tìm thấy giao dịch phù hợp. Vui lòng kiểm tra lại sau khi chuyển khoản!",
      });
      toast.error("Chưa tìm thấy giao dịch phù hợp.");
    }
  };

  if (!cartItems || cartItems.length === 0) {
    return null; // Will be redirected by useEffect
  }
  return (
    <div className="bg-white min-h-screen flex flex-col items-center justify-center py-6 mx-20 sm:px-4">
      <div className="flex flex-col md:flex-row gap-6 md:gap-8 w-full ">
        {/* Payment Method & Form */}
        <div className="flex-1 border p-4 sm:p-6 md:p-8 bg-white min-w-0">
          <h2 className="text-lg sm:text-xl font-bold mb-4 sm:mb-6 uppercase tracking-wide">
            PHƯƠNG THỨC THANH TOÁN
          </h2>{" "}
          <div className="flex flex-col items-start sm:flex-row sm:items-center mb-4 sm:mb-6 gap-4 sm:gap-8">
            <label className="flex items-center font-medium text-base">
              <input
                type="radio"
                name="paymentMethod"
                value="cod"
                checked={formData.paymentMethod === "cod"}
                onChange={handleInputChange}
                className="mr-2 accent-black"
              />
              <span className="text-sm sm:text-base">
                Thanh toán khi giao hàng
              </span>
            </label>
            <label className="flex items-center font-medium text-base">
              <input
                type="radio"
                name="paymentMethod"
                value="bank_transfer"
                checked={formData.paymentMethod === "bank_transfer"}
                onChange={handleInputChange}
                className="mr-2 accent-black"
              />
              <span className="text-sm sm:text-base">
                Chuyển khoản ngân hàng
              </span>{" "}
            </label>{" "}
          </div>
          {/* Bank Transfer Information with VietQR */}
          {formData.paymentMethod === "bank_transfer" && (
            <div className="space-y-4 mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
              <h3 className="font-bold text-lg mb-3">THÔNG TIN CHUYỂN KHOẢN</h3>{" "}
              {/* Bank Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <div className="text-sm">
                    <span className="font-semibold">Ngân hàng:</span>{" "}
                    {BANK_INFO.bankName}
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">Số tài khoản:</span>{" "}
                    {BANK_INFO.accountNumber}
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">Tên tài khoản:</span>{" "}
                    {BANK_INFO.accountName}
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">Số tiền:</span>
                    <span className="font-bold text-red-600 ml-1">
                      {(getTotalPrice() + shippingCost).toLocaleString("vi-VN")}{" "}
                      VND
                    </span>
                  </div>{" "}
                  <div className="text-sm">
                    <span className="font-semibold">
                      Nội dung chuyển khoản:
                    </span>{" "}
                    <div className="font-mono text-xs bg-white p-2 border rounded mt-1">
                      {generateOrderCode()}{" "}
                      {userInfo?.phone || formData.phone || ""}
                    </div>
                  </div>
                </div>{" "}
                {/* VietQR Code */}
                <div className="flex flex-col items-center">
                  <div className="text-sm font-semibold mb-2">
                    Quét mã QR để chuyển khoản
                  </div>
                  <div className="bg-white p-4 border border-gray-300 rounded">
                    {" "}
                    <img
                      src={generateVietQRUrl(
                        getTotalPrice() + shippingCost,
                        generateOrderCode(),
                        userInfo?.phone || formData.phone || ""
                      )}
                      alt="VietQR Code"
                      className="w-56 h-56 object-contain"
                      onError={(e) => {
                        e.target.src = QR_FALLBACK_SVG;
                      }}
                    />
                  </div>
                  <div className="text-xs text-gray-600 mt-2 text-center">
                    Sử dụng app ngân hàng để quét mã QR
                  </div>
                </div>
              </div>{" "}
              {/* Important Notes */}
              <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mt-4">
                <div className="text-sm text-yellow-800">
                  <div className="font-semibold mb-1">📋 Lưu ý quan trọng:</div>
                  <ul className="list-disc list-inside space-y-1 text-xs">
                    <li>
                      Vui lòng chuyển khoản đúng số tiền và nội dung như trên
                    </li>
                    <li>
                      Đơn hàng sẽ được xác nhận sau khi chúng tôi nhận được tiền
                    </li>
                    <li>Thời gian xử lý: {BANK_INFO.contact.processingTime}</li>
                    <li>
                      Liên hệ hotline: {BANK_INFO.contact.hotline} nếu cần hỗ
                      trợ
                    </li>
                  </ul>
                </div>
              </div>
              {/* Nút kiểm tra thanh toán và trạng thái */}
              <div className="mt-4">
                <button
                  type="button"
                  onClick={handleCheckPayment}
                  disabled={isCheckingPayment}
                  className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors flex items-center"
                >
                  {isCheckingPayment ? (
                    <span className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>
                  ) : (
                    <svg
                      className="w-4 h-4 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-7 4h12l-1 1H6l-1-1z"
                      />
                    </svg>
                  )}
                  Kiểm tra thanh toán
                </button>
                {paymentCheckResult && (
                  <div
                    className={`mt-2 text-sm ${
                      paymentCheckResult.success
                        ? "text-green-600"
                        : "text-red-600"
                    }`}
                  >
                    {paymentCheckResult.message}
                  </div>
                )}
              </div>
            </div>
          )}
          {/* Shipping Information for COD */}
          {formData.paymentMethod === "cod" && (
            <div className="space-y-4 mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
              <h3 className="font-bold text-lg mb-3">THÔNG TIN GIAO HÀNG</h3>
              <div className="text-sm">
                <span className="font-semibold">Họ và tên:</span>
                <span className="ml-2">{formData.fullName}</span>
              </div>
              <div className="text-sm">
                <span className="font-semibold">Địa chỉ giao hàng:</span>
                <span className="ml-2">
                  {formData.address}, {formData.ward}, {formData.district},{" "}
                  {formData.city}
                </span>
              </div>
              <div className="text-sm">
                <span className="font-semibold">Số điện thoại:</span>
                <span className="ml-2">{formData.phone}</span>
              </div>
              <div className="text-sm">
                <span className="font-semibold">Phương thức thanh toán:</span>
                <span className="ml-2 text-green-600 font-medium">
                  Thanh toán khi giao hàng
                </span>
              </div>
              <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded p-3">
                <div className="text-sm text-yellow-800">
                  <div className="font-semibold mb-1">📋 Lưu ý:</div>
                  <ul className="list-disc list-inside space-y-1 text-xs">
                    <li>Bạn sẽ thanh toán khi nhận được hàng</li>
                    <li>Vui lòng kiểm tra hàng trước khi thanh toán</li>
                    <li>Đơn hàng sẽ được giao trong vòng 2-3 ngày làm việc</li>
                  </ul>
                </div>
              </div>
            </div>
          )}
          <button
            type="submit"
            onClick={handleSubmit}
            disabled={
              isProcessing ||
              loading ||
              (formData.paymentMethod === "bank_transfer" && !isPaymentVerified)
            }
            className="w-full sm:w-48 h-12 bg-red-600 hover:bg-red-700 text-white font-bold text-base sm:text-lg uppercase transition-colors duration-150 mt-2"
            style={{ letterSpacing: 1 }}
          >
            ĐẶT HÀNG
          </button>
        </div>

        {/* Order Summary */}
        <div className="flex-1 border p-4 sm:p-6 md:p-8 bg-white max-w-full md:max-w-md mt-8 md:mt-0">
          <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
            <span className="font-bold uppercase text-base sm:text-lg tracking-wide">
              TỔNG ĐƠN HÀNG
            </span>
            <span className="font-bold text-sm sm:text-base">
              {cartItems.length} SẢN PHẨM
            </span>
          </div>
          <div className="mb-2 flex justify-between text-xs sm:text-sm">
            <span>Tổng cộng</span>
            <span>{getTotalPrice().toLocaleString("vi-VN")} VND</span>
          </div>
          <div className="mb-2 flex justify-between text-xs sm:text-sm">
            <span>Phí vận chuyển</span>
            {shippingCost === 0 ? (
              <span className="text-green-600 font-bold">Miễn phí</span>
            ) : (
              <span>{shippingCost.toLocaleString("vi-VN")} VND</span>
            )}
          </div>
          <div className="border-t border-black my-2"></div>
          <div className="mb-2 flex justify-between items-center text-base sm:text-lg font-bold">
            <span>TỔNG</span>
            <span>{totalAmount.toLocaleString("vi-VN")} VND</span>
          </div>
          <div className="text-xs text-gray-500 mb-2">
            Đã bao gồm thuế giá trị gia tăng
            <span className="float-right">
              {Math.round(totalAmount / 11).toLocaleString("vi-VN")} VND
            </span>
          </div>
          <div className="border-t border-black my-2"></div>
          <div className="mb-2 flex justify-between items-center text-xs sm:text-base font-bold">
            <span>TỔNG ĐƠN ĐẶT HÀNG</span>
            <span>{totalAmount.toLocaleString("vi-VN")} VND</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Checkout;


===== FILE: ./frontend/src/pages/CheckoutBuyNow.jsx =====
import React, { useState, useEffect } from "react";
import { useSelector, useDispatch } from "react-redux";
import {
  createCheckoutSession,
  clearCheckout,
} from "../redux/slices/checkoutSlice";
import { useNavigate, useLocation } from "react-router-dom";
import { toast } from "sonner";
import {
  BANK_INFO,
  generateVietQRUrl,
  generateOrderCode,
  QR_FALLBACK_SVG,
  fetchRecentTransactionsAndCheckPayment,
} from "../utils/bankInfo";
import axios from "axios";

const CheckoutBuyNow = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const dispatch = useDispatch();
  const { buyNowItem } = useSelector((state) => state.checkout);
  const { userInfo } = useSelector((state) => state.auth);

  const cartItems = buyNowItem ? [buyNowItem] : [];

  // Calculate shipping cost
  const calculateShippingCost = (city) => {
    if (city && city.trim().toLowerCase().includes("hồ chí minh")) {
      return 0;
    }
    return 30000;
  };

  const getTotalPrice = () => {
    if (!cartItems || cartItems.length === 0) return 0;
    return cartItems.reduce((total, item) => {
      return total + item.price * item.quantity;
    }, 0);
  };

  const getShippingCost = () => {
    return calculateShippingCost(formData.city);
  };

  const getTotalAmount = () => {
    return getTotalPrice() + getShippingCost();
  };

  // Check login status and redirect if needed
  useEffect(() => {
    if (!userInfo) {
      // Save current path for redirect after login
      const returnUrl = encodeURIComponent(location.pathname);
      toast.error("Vui lòng đăng nhập để tiếp tục mua hàng!");
      navigate(`/login?returnUrl=${returnUrl}`);
      return;
    }
  }, [userInfo, navigate, location]);

  // Redirect if no buy now item
  useEffect(() => {
    if (!buyNowItem) {
      toast.error("Không có sản phẩm để mua ngay");
      navigate("/");
    }
  }, [buyNowItem, navigate]);

  // Helper function to parse address from user profile
  const parseAddress = (addressString) => {
    if (!addressString)
      return { address: "", city: "", district: "", ward: "" };

    const parts = addressString.split(",").map((part) => part.trim());

    if (parts.length >= 3) {
      return {
        address: parts[0] || "",
        district: parts[1] || "",
        city: parts[2] || "",
        ward: parts.length > 3 ? parts.slice(1, -2).join(", ") : "",
      };
    } else if (parts.length === 2) {
      return {
        address: parts[0] || "",
        city: parts[1] || "",
        district: "",
        ward: "",
      };
    } else {
      return {
        address: addressString,
        city: "",
        district: "",
        ward: "",
      };
    }
  };

  // Initialize form with user data
  const initializeFormData = () => {
    const user = userInfo || {};
    const parsedAddress = parseAddress(user.address);
    let birth = "";
    if (user.birth) {
      const d = new Date(user.birth);
      if (!isNaN(d.getTime())) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        birth = `${yyyy}-${mm}-${dd}`;
      }
    }
    return {
      fullName: user.name || "",
      email: user.email || "",
      phone: user.phone || "",
      address: parsedAddress.address,
      city: user.city || parsedAddress.city || "",
      district: user.district || parsedAddress.district || "",
      ward: user.ward || parsedAddress.ward || "",
      postalCode: "700000",
      country: "Vietnam",
      paymentMethod: "cod",
      notes: "",
      birth,
    };
  };

  // Form state
  const [formData, setFormData] = useState(initializeFormData());
  const [errors, setErrors] = useState({});
  const [isProcessing, setIsProcessing] = useState(false);
  const [isPaymentVerified, setIsPaymentVerified] = useState(false);
  const [isCheckingPayment, setIsCheckingPayment] = useState(false);
  const [paymentCheckResult, setPaymentCheckResult] = useState(null);

  // Handle input changes
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));

    // Kiểm tra thông tin khi chuyển sang phương thức chuyển khoản
    if (name === "paymentMethod" && value === "bank_transfer") {
      const requiredFields = [
        { field: "fullName", label: "Họ và tên" },
        { field: "email", label: "Email" },
        { field: "phone", label: "Số điện thoại" },
        { field: "address", label: "Địa chỉ" },
        { field: "city", label: "Thành phố" },
        { field: "district", label: "Quận/Huyện" },
        { field: "ward", label: "Phường/Xã" },
      ];

      const missingFields = requiredFields.filter(
        ({ field }) => !formData[field] || formData[field].trim() === ""
      );

      if (missingFields.length > 0) {
        toast.error(
          `Vui lòng cập nhật đầy đủ thông tin: ${missingFields
            .map(({ label }) => label)
            .join(", ")} trong hồ sơ cá nhân!`
        );
      }
    }
  };

  // Validate form
  const validateForm = () => {
    const newErrors = {};
    if (!formData.fullName.trim())
      newErrors.fullName = "Vui lòng cập nhật tên trong hồ sơ";
    if (!formData.email.trim())
      newErrors.email = "Vui lòng cập nhật email trong hồ sơ";
    if (!formData.phone.trim())
      newErrors.phone = "Vui lòng cập nhật số điện thoại trong hồ sơ";
    if (!formData.address.trim())
      newErrors.address = "Vui lòng cập nhật địa chỉ trong hồ sơ";

    // Kiểm tra định dạng email
    if (formData.email && formData.email.trim()) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(formData.email)) {
        newErrors.email = "Email trong hồ sơ không hợp lệ";
      }
    }

    // Kiểm tra định dạng số điện thoại
    if (formData.phone && formData.phone.trim()) {
      const phoneRegex = /^[0-9]{10,11}$/;
      if (!phoneRegex.test(formData.phone.replace(/\s/g, ""))) {
        newErrors.phone = "Số điện thoại trong hồ sơ không hợp lệ";
      }
    }

    setErrors(newErrors);
    if (Object.keys(newErrors).length > 0) {
      toast.error(
        "Vui lòng nhập đầy đủ thông tin giao hàng trong hồ sơ cá nhân!"
      );
    }
    return Object.keys(newErrors).length === 0;
  };

  // Handle form submission
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!validateForm()) {
      toast.error("Vui lòng kiểm tra lại thông tin đơn hàng!");
      return;
    }

    const requiredFields = [
      "address",
      "city",
      "district",
      "ward",
      "postalCode",
      "country",
    ];
    for (const field of requiredFields) {
      if (!formData[field] || formData[field].trim() === "") {
        toast.error(`Thiếu thông tin: ${field}`);
        return;
      }
    }

    setIsProcessing(true);
    try {
      const orderData = {
        checkoutItems: cartItems.map((item) => ({
          ...item,
          productId: item.productId,
        })),
        shippingAddress: {
          address: formData.address,
          city: formData.city,
          district: formData.district,
          ward: formData.ward,
          postalCode: formData.postalCode,
          country: formData.country,
          fullName: formData.fullName,
          phone: formData.phone,
          email: formData.email,
          notes: formData.notes,
        },
        paymentMethod: formData.paymentMethod,
        totalPrice: getTotalAmount(),
      };

      const response = await dispatch(
        createCheckoutSession(orderData)
      ).unwrap();

      if (response) {
        // Finalize checkout
        try {
          const token =
            localStorage.getItem("userToken") || localStorage.getItem("token");
          const finalizeRes = await axios.post(
            `${import.meta.env.VITE_API_URL}/api/checkout/${
              response._id
            }/finalize`,
            {},
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          console.log("✅ Finalized checkout:", finalizeRes.data);
        } catch (finalizeError) {
          console.error("❌ Lỗi khi finalize checkout:", finalizeError);
          toast.error("Đặt hàng thành công nhưng có lỗi khi xử lý tồn kho!");
        }

        // Clear checkout data
        dispatch(clearCheckout());

        // Handle payment method specific actions
        if (formData.paymentMethod === "bank_transfer") {
          toast.success(
            "Đặt hàng thành công! Đơn hàng đã được ghi nhận là ĐÃ THANH TOÁN."
          );
          setIsPaymentVerified(true);
          return;
        } else {
          toast.success("Đặt hàng thành công!");
          navigate("/");
        }
      }
    } catch (error) {
      console.log("[DEBUG] error:", error);
      toast.error(error.message || "Có lỗi xảy ra khi đặt hàng!");
    } finally {
      setIsProcessing(false);
    }
  };

  // Check payment status
  const handleCheckPayment = async () => {
    // Kiểm tra thông tin ProfileInfo trước khi cho phép kiểm tra thanh toán
    if (!validateForm()) {
      toast.error(
        "Vui lòng cập nhật đầy đủ thông tin giao hàng trong hồ sơ cá nhân trước khi kiểm tra thanh toán!"
      );
      return;
    }

    // Kiểm tra các trường bắt buộc
    const requiredFields = [
      { field: "fullName", label: "Họ và tên" },
      { field: "email", label: "Email" },
      { field: "phone", label: "Số điện thoại" },
      { field: "address", label: "Địa chỉ" },
      { field: "city", label: "Thành phố" },
      { field: "district", label: "Quận/Huyện" },
      { field: "ward", label: "Phường/Xã" },
    ];

    const missingFields = requiredFields.filter(
      ({ field }) => !formData[field] || formData[field].trim() === ""
    );

    if (missingFields.length > 0) {
      toast.error(
        `Vui lòng cập nhật đầy đủ thông tin: ${missingFields
          .map(({ label }) => label)
          .join(", ")} trong hồ sơ cá nhân!`
      );
      return;
    }

    // Kiểm tra định dạng email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email)) {
      toast.error("Email không hợp lệ!");
      return;
    }

    // Kiểm tra định dạng số điện thoại
    const phoneRegex = /^[0-9]{10,11}$/;
    if (!phoneRegex.test(formData.phone.replace(/\s/g, ""))) {
      toast.error("Số điện thoại không hợp lệ!");
      return;
    }

    setIsCheckingPayment(true);
    setPaymentCheckResult(null);
    setIsPaymentVerified(false);
    const orderCode = generateOrderCode();
    const amount = getTotalAmount();
    const phone = userInfo?.phone || formData.phone || "";
    const result = await fetchRecentTransactionsAndCheckPayment(
      orderCode,
      amount,
      phone
    );
    setIsCheckingPayment(false);
    if (result) {
      setIsPaymentVerified(true);
      setPaymentCheckResult({
        success: true,
        message: "Đã xác nhận thanh toán thành công!",
      });
      toast.success("Đã xác nhận thanh toán thành công!");
    } else {
      setIsPaymentVerified(false);
      setPaymentCheckResult({
        success: false,
        message:
          "Chưa tìm thấy giao dịch phù hợp. Vui lòng kiểm tra lại sau khi chuyển khoản!",
      });
      toast.error("Chưa tìm thấy giao dịch phù hợp.");
    }
  };

  if (!cartItems || cartItems.length === 0) {
    return null; // Will be redirected by useEffect
  }

  return (
    <div className="bg-white min-h-screen flex flex-col items-center justify-center py-6 mx-20 sm:px-4">
      <div className="flex flex-col items-start md:flex-row gap-6 md:gap-8 w-full">
        {/* Payment Method & Form */}
        <div className="flex-1 border p-4 sm:p-6 md:p-8 bg-white min-w-0">
          <h2 className="text-lg sm:text-xl font-bold mb-4 sm:mb-6 uppercase tracking-wide">
            PHƯƠNG THỨC THANH TOÁN
          </h2>
          <div className="flex flex-col sm:flex-row sm:items-center mb-4 sm:mb-6 gap-4 sm:gap-8">
            <label className="flex items-center font-medium text-base">
              <input
                type="radio"
                name="paymentMethod"
                value="cod"
                checked={formData.paymentMethod === "cod"}
                onChange={handleInputChange}
                className="mr-2 accent-black"
              />
              <span className="text-sm sm:text-base">
                Thanh toán khi giao hàng
              </span>
            </label>
            <label className="flex items-center font-medium text-base">
              <input
                type="radio"
                name="paymentMethod"
                value="bank_transfer"
                checked={formData.paymentMethod === "bank_transfer"}
                onChange={handleInputChange}
                className="mr-2 accent-black"
              />
              <span className="text-sm sm:text-base">
                Chuyển khoản ngân hàng
              </span>
            </label>
          </div>

          {/* Bank Transfer Information */}
          {formData.paymentMethod === "bank_transfer" && (
            <div className="space-y-4 mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
              <h3 className="font-bold text-lg mb-3">THÔNG TIN CHUYỂN KHOẢN</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <div className="text-sm">
                    <span className="font-semibold">Ngân hàng:</span>{" "}
                    {BANK_INFO.bankName}
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">Số tài khoản:</span>{" "}
                    {BANK_INFO.accountNumber}
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">Tên tài khoản:</span>{" "}
                    {BANK_INFO.accountName}
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">Số tiền:</span>
                    <span className="font-bold text-red-600 ml-1">
                      {getTotalAmount().toLocaleString("vi-VN")} VND
                    </span>
                  </div>
                  <div className="text-sm">
                    <span className="font-semibold">
                      Nội dung chuyển khoản:
                    </span>
                    <div className="font-mono text-xs bg-white p-2 border rounded mt-1">
                      {generateOrderCode()}{" "}
                      {userInfo?.phone || formData.phone || ""}
                    </div>
                  </div>
                </div>

                {/* VietQR Code */}
                <div className="flex flex-col items-center">
                  <div className="text-sm font-semibold mb-2">
                    Quét mã QR để chuyển khoản
                  </div>
                  <div className="bg-white p-4 border border-gray-300 rounded">
                    <img
                      src={generateVietQRUrl(
                        getTotalAmount(),
                        generateOrderCode(),
                        userInfo?.phone || formData.phone || ""
                      )}
                      alt="VietQR Code"
                      className="w-56 h-56 object-contain"
                      onError={(e) => {
                        e.target.src = QR_FALLBACK_SVG;
                      }}
                    />
                  </div>
                  <div className="text-xs text-gray-600 mt-2 text-center">
                    Sử dụng app ngân hàng để quét mã QR
                  </div>
                </div>
              </div>

              {/* Important Notes */}
              <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mt-4">
                <div className="text-sm text-yellow-800">
                  <div className="font-semibold mb-1">📋 Lưu ý quan trọng:</div>
                  <ul className="list-disc list-inside space-y-1 text-xs">
                    <li>
                      Vui lòng chuyển khoản đúng số tiền và nội dung như trên
                    </li>
                    <li>
                      Đơn hàng sẽ được xác nhận sau khi chúng tôi nhận được tiền
                    </li>
                    <li>Thời gian xử lý: {BANK_INFO.contact.processingTime}</li>
                    <li>
                      Liên hệ hotline: {BANK_INFO.contact.hotline} nếu cần hỗ
                      trợ
                    </li>
                  </ul>
                </div>
              </div>

              {/* Payment Check Button */}
              <div className="mt-4">
                <button
                  type="button"
                  onClick={handleCheckPayment}
                  disabled={isCheckingPayment}
                  className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors flex items-center"
                >
                  {isCheckingPayment ? (
                    <span className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>
                  ) : (
                    <svg
                      className="w-4 h-4 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-7 4h12l-1 1H6l-1-1z"
                      />
                    </svg>
                  )}
                  Kiểm tra thanh toán
                </button>
                {paymentCheckResult && (
                  <div
                    className={`mt-2 text-sm ${
                      paymentCheckResult.success
                        ? "text-green-600"
                        : "text-red-600"
                    }`}
                  >
                    {paymentCheckResult.message}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Shipping Information for COD */}
          {formData.paymentMethod === "cod" && (
            <div className="space-y-4 mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
              <h3 className="font-bold text-lg mb-3">THÔNG TIN GIAO HÀNG</h3>
              <div className="text-sm">
                <span className="font-semibold">Họ và tên:</span>
                <span className="ml-2">{formData.fullName}</span>
              </div>
              <div className="text-sm">
                <span className="font-semibold">Địa chỉ giao hàng:</span>
                <span className="ml-2">
                  {formData.address}, {formData.ward}, {formData.district},{" "}
                  {formData.city}
                </span>
              </div>
              <div className="text-sm">
                <span className="font-semibold">Số điện thoại:</span>
                <span className="ml-2">{formData.phone}</span>
              </div>
              <div className="text-sm">
                <span className="font-semibold">Phương thức thanh toán:</span>
                <span className="ml-2 text-green-600 font-medium">
                  Thanh toán khi giao hàng
                </span>
              </div>
              <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded p-3">
                <div className="text-sm text-yellow-800">
                  <div className="font-semibold mb-1">📋 Lưu ý:</div>
                  <ul className="list-disc list-inside space-y-1 text-xs">
                    <li>Bạn sẽ thanh toán khi nhận được hàng</li>
                    <li>Vui lòng kiểm tra hàng trước khi thanh toán</li>
                    <li>Đơn hàng sẽ được giao trong vòng 2-3 ngày làm việc</li>
                    <li>
                      Phí vận chuyển:{" "}
                      {getShippingCost() === 0 ? (
                        <span className="text-green-600 font-bold">
                          Miễn phí
                        </span>
                      ) : (
                        <span>
                          {getShippingCost().toLocaleString("vi-VN")} VND
                        </span>
                      )}
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          )}

          <button
            type="submit"
            onClick={handleSubmit}
            disabled={
              isProcessing ||
              (formData.paymentMethod === "bank_transfer" && !isPaymentVerified)
            }
            className="w-full sm:w-48 h-12 bg-red-600 hover:bg-red-700 text-white font-bold text-base sm:text-lg uppercase transition-colors duration-150 mt-2"
            style={{ letterSpacing: 1 }}
          >
            ĐẶT HÀNG
          </button>
        </div>

        {/* Order Summary */}
        <div className="flex-1 border p-4 sm:p-6 md:p-8 bg-white max-w-full md:max-w-md mt-8 md:mt-0">
          <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
            <span className="font-bold uppercase text-base sm:text-lg tracking-wide">
              TỔNG ĐƠN HÀNG
            </span>
            <span className="font-bold text-sm sm:text-base">
              {cartItems.length} SẢN PHẨM
            </span>
          </div>
          <div className="mb-2 flex justify-between text-xs sm:text-sm">
            <span>Tổng cộng</span>
            <span>{getTotalPrice().toLocaleString("vi-VN")} VND</span>
          </div>
          <div className="mb-2 flex justify-between text-xs sm:text-sm">
            <span>Phí vận chuyển</span>
            {formData.city &&
            formData.city.trim().toLowerCase().includes("hồ chí minh") ? (
              <span className="text-green-600 font-bold">Miễn phí</span>
            ) : (
              <span>30.000 VND</span>
            )}
          </div>
          <div className="border-t border-black my-2"></div>
          <div className="mb-2 flex justify-between items-center text-base sm:text-lg font-bold">
            <span>TỔNG</span>
            <span>
              {(
                getTotalPrice() +
                (formData.city &&
                formData.city.trim().toLowerCase().includes("hồ chí minh")
                  ? 0
                  : 30000)
              ).toLocaleString("vi-VN")}{" "}
              VND
            </span>
          </div>
          <div className="text-xs text-gray-500 mb-2">
            Đã bao gồm thuế giá trị gia tăng
            <span className="float-right">
              {Math.round(getTotalAmount() / 11).toLocaleString("vi-VN")} VND
            </span>
          </div>
          <div className="border-t border-black my-2"></div>
          <div className="mb-2 flex justify-between items-center text-xs sm:text-base font-bold">
            <span>TỔNG ĐƠN ĐẶT HÀNG</span>
            <span>{getTotalAmount().toLocaleString("vi-VN")} VND</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CheckoutBuyNow;


===== FILE: ./frontend/src/pages/Collection.jsx =====
import { useParams, useSearchParams } from "react-router-dom";
import { useRef, useState, useEffect } from "react";
import axios from "axios";
import ProductGrid from "../components/Products/ProductGrid";
import FilterSidebar from "../components/Products/FilterSidebar";
import SortOptions from "../components/Products/SortOptions";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

function Collection() {
  const { id } = useParams();
  const [searchParams] = useSearchParams();
  const [collection, setCollection] = useState(null);
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const sidebarRef = useRef(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  useEffect(() => {
    const fetchCollectionAndProducts = async () => {
      try {
        // Tìm collection theo id (string)
        const collections = await axios.get(`${API_URL}/api/collections`);
        const collection = collections.data.find((c) => c.id === id);

        if (!collection) {
          setError("Không tìm thấy bộ sưu tập");
          setLoading(false);
          return;
        }

        setCollection(collection);

        // Lấy params filter từ URL
        const params = Object.fromEntries(searchParams.entries());

        // Gọi API lấy sản phẩm theo collection id
        const productsRes = await axios.get(
          `${API_URL}/api/collections/${id}/products`,
          { params }
        );
        setProducts(productsRes.data);
        setLoading(false);
      } catch (err) {
        setError("Không thể tải dữ liệu bộ sưu tập");
        setLoading(false);
      }
    };
    fetchCollectionAndProducts();
  }, [id, searchParams]);

  const toggleSidebar = () => {
    setIsSidebarOpen(!isSidebarOpen);
  };

  const handleOutsideClick = (e) => {
    if (sidebarRef.current && !sidebarRef.current.contains(e.target)) {
      setIsSidebarOpen(false);
    }
  };

  useEffect(() => {
    if (isSidebarOpen) {
      document.body.classList.add("overflow-hidden");
    } else {
      document.body.classList.remove("overflow-hidden");
    }
    document.addEventListener("mousedown", handleOutsideClick);
    return () => {
      document.body.classList.remove("overflow-hidden");
      document.removeEventListener("mousedown", handleOutsideClick);
    };
  }, [isSidebarOpen]);

  if (loading) return <div className="text-center mt-10">Đang tải...</div>;
  if (error)
    return <div className="text-center text-red-500 mt-10">{error}</div>;
  if (!collection) return <h2>Không tìm thấy bộ sưu tập!</h2>;

  console.log("collection state:", collection);

  return (
    <div className="flex flex-col">
      {/* banner */}
      <div className="w-full px-4 md:px-[100px] my-6 md:my-[50px]">
        <div className="flex flex-row justify-center items-center border w-full border-gray-400">
          <div className="flex flex-col w-1/2 p-6 md:p-10 gap-2 justify-center">
            <h2 className="text-xl md:text-4xl font-medium uppercase">
              {collection.name}
            </h2>
            <p className="text-xs md:text-xl font-light">
              {collection.description}
            </p>
          </div>
          <img
            src={collection.bannerUrl}
            alt={collection.name}
            className="w-full md:w-1/2 h-[300px] md:h-[500px] items-center object-cover overflow-hidden"
          />
        </div>
      </div>
      {/* filter and sort */}
      <div className="w-full h-10 px-[50px] flex items-center justify-between">
        <button
          onClick={toggleSidebar}
          className="filter-button flex items-center gap-2 rounded-full border border-black px-4 py-1.5 transition-all hover:shadow-[inset_0_0_0_1px_black] cursor-pointer"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
            className="w-5 h-5"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75"
            />
          </svg>
          <span className="text-sm">Bộ lọc</span>
        </button>
        {/* overlay */}
        <div
          className={`fixed inset-0 w-screen h-full bg-black/75 z-50 transition-[opacity,visibility] duration-200 ease-in-out ${
            isSidebarOpen
              ? "opacity-100 visible"
              : "opacity-0 invisible pointer-events-none"
          }`}
          onClick={() => setIsSidebarOpen(false)}
        />
        {/* filter sidebar */}
        <div
          ref={sidebarRef}
          className={`${
            isSidebarOpen ? "translate-x-0" : "-translate-x-full"
          } fixed inset-y-0 z-50 left-0 w-80 overflow-y-auto transition-transform duration-300 ease-in-out bg-white`}
        >
          <FilterSidebar />
        </div>
        {/* sort options */}
        <div>
          <SortOptions />
        </div>
      </div>
      <p className="text-black text-[20px] font-medium my-2 px-[50px]">
        {products.length} sản phẩm
      </p>
      {console.log("products state:", products)}
      {/* Hiển thị "Không tìm thấy sản phẩm" nếu không có kết quả */}
      {products.length === 0 ? (
        <div className="w-full px-[50px] text-center py-10">
          <p className="text-gray-500">
            Không tìm thấy sản phẩm phù hợp với bộ lọc đã chọn
          </p>
        </div>
      ) : (
        <div className="w-full px-[50px]">
          <ProductGrid products={products} />
        </div>
      )}
    </div>
  );
}

export default Collection;


===== FILE: ./frontend/src/pages/GenderCollection.jsx =====
import { useParams, useSearchParams } from "react-router-dom";
import { useRef, useState, useEffect } from "react";
import axios from "axios";
import { getProducts } from "../services/productService";
import ProductGrid from "../components/Products/ProductGrid";
import FilterSidebar from "../components/Products/FilterSidebar";
import SortOptions from "../components/Products/SortOptions";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

function GenderCollection() {
  const { id } = useParams();
  const [searchParams] = useSearchParams();
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const sidebarRef = useRef(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  useEffect(() => {
    const fetchProducts = async () => {
      try {
        // Lấy sản phẩm theo gender (và các filter khác)
        const filters = { gender: id === "women" ? "woman" : id };
        const color = searchParams.get("color");
        const size = searchParams.get("size");
        const material = searchParams.get("material");
        const category = searchParams.get("category");
        const sortBy = searchParams.get("sort");
        const price = searchParams.get("price");
        const search = searchParams.get("search");

        if (color) filters.color = color;
        if (size) filters.sizes = size;
        if (material) filters.material = material;
        if (category) filters.category = category;
        if (sortBy) filters.sortBy = sortBy;
        if (price) filters.price = price;
        if (search) filters.search = search;

        const response = await getProducts(filters);
        setProducts(response.products || []);
        setLoading(false);
      } catch (err) {
        setError("Không thể tải dữ liệu sản phẩm");
        setLoading(false);
      }
    };
    fetchProducts();
  }, [id, searchParams]);

  const toggleSidebar = () => {
    setIsSidebarOpen(!isSidebarOpen);
  };

  const handleOutsideClick = (e) => {
    if (sidebarRef.current && !sidebarRef.current.contains(e.target)) {
      setIsSidebarOpen(false);
    }
  };

  useEffect(() => {
    document.addEventListener("mousedown", handleOutsideClick);
    return () => {
      document.removeEventListener("mousedown", handleOutsideClick);
    };
  }, []);

  if (loading) return <div className="text-center mt-10">Đang tải...</div>;
  if (error)
    return <div className="text-center text-red-500 mt-10">{error}</div>;

  return (
    <div className="flex flex-col items-center justify-center">
      <div className="w-full px-4 md:px-[50px]">
        <h2 className="text-xl md:text-2xl text-left font-medium mb-4 md:mb-6 mt-6 md:mt-10">
          {id === "man"
            ? "Thời Trang Nam"
            : id === "woman"
            ? "Thời Trang Nữ"
            : "Thời Trang"}
        </h2>
      </div>
      {/* filter sidebar */}
      <div className="w-full px-4 md:px-[50px] flex justify-between items-center">
        <button
          onClick={toggleSidebar}
          className="filter-button flex items-center gap-2 rounded-full border border-gray-300 px-3 md:px-4 py-1 md:py-1.5 hover:bg-gray-50 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
            className="w-4 h-4 md:w-5 md:h-5"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75"
            />
          </svg>
          <span className="text-sm md:text-base">Filters</span>
        </button>
        {/* overlay */}
        <div
          className={`fixed inset-0 w-screen h-full bg-black/75 z-50 transition-[opacity,visibility] duration-200 ease-in-out ${
            isSidebarOpen
              ? "opacity-100 visible"
              : "opacity-0 invisible pointer-events-none"
          }`}
          onClick={() => setIsSidebarOpen(false)}
        />
        {/* filter sidebar */}
        <div
          ref={sidebarRef}
          className={`${
            isSidebarOpen ? "translate-x-0" : "-translate-x-full"
          } fixed inset-y-0 z-50 left-0 w-[280px] md:w-80 overflow-y-auto transition-transform duration-300 ease-in-out bg-white`}
        >
          <FilterSidebar />
        </div>
        {/* sort options */}
        <div>
          <SortOptions />
        </div>
      </div>
      {/* Hiển thị số lượng sản phẩm */}
      <p className="text-black text-base md:text-[20px] font-medium my-2 px-4 md:px-[50px]">
        {products.length} sản phẩm
      </p>
      {/* Hiển thị "Không tìm thấy sản phẩm" nếu không có kết quả */}
      {products.length === 0 ? (
        <div className="w-full px-4 md:px-[50px] text-center py-6 md:py-10">
          <p className="text-gray-500 text-sm md:text-base">
            Không tìm thấy sản phẩm phù hợp với bộ lọc đã chọn
          </p>
        </div>
      ) : (
        <div className="w-full px-4 md:px-[50px]">
          <ProductGrid products={products} />
        </div>
      )}
    </div>
  );
}

export default GenderCollection;


===== FILE: ./frontend/src/pages/GoogleCallback.jsx =====
import React, { useEffect } from "react";
import { useSearchParams, useNavigate } from "react-router-dom";
import { useDispatch } from "react-redux";
import { toast } from "sonner";
import axios from "axios";

const GoogleCallback = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const dispatch = useDispatch();

  const API_URL = import.meta.env.VITE_BACKEND_URL || "http://localhost:9000";

  useEffect(() => {
    const handleGoogleCallback = async () => {
      const token = searchParams.get("token");
      const error = searchParams.get("error");

      if (token) {
        try {
          // Lưu token vào localStorage
          localStorage.setItem("userToken", token);

          // Lấy thông tin người dùng từ API
          const response = await axios.get(`${API_URL}/api/users/profile`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = response.data;
          // Chuyển đổi định dạng dữ liệu nếu cần
          if (data.birth) {
            // Format date để hiển thị đúng
            data.birth = new Date(data.birth).toLocaleDateString("vi-VN");
          }

          // Lưu thông tin người dùng vào localStorage
          localStorage.setItem("userInfo", JSON.stringify(data));

          // Cập nhật Redux state - thêm skipToast để ngăn toast kép
          dispatch({
            type: "auth/loginSuccess",
            payload: {
              userInfo: {
                ...data,
                skipToast: true, // Thêm flag để tránh hiển thị toast trùng lặp
              },
              userToken: token,
            },
          });

          toast.success("Đăng nhập Google thành công!");
          navigate("/");
        } catch (error) {
          console.error("Error fetching user profile:", error);
          toast.error("Lỗi khi lấy thông tin người dùng");
          navigate("/login");
        }
      } else if (error) {
        toast.error("Đăng nhập Google thất bại");
        navigate("/login");
      } else {
        navigate("/login");
      }
    };

    handleGoogleCallback();
  }, [searchParams, navigate, dispatch]);

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-50">
      <div className="bg-white p-8 rounded-lg shadow-md">
        <div className="text-center">
          <h2 className="text-2xl font-semibold mb-4">
            Đang xử lý đăng nhập...
          </h2>
          <div className="flex justify-center mb-4">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
          </div>
          <p className="text-gray-600">Vui lòng đợi trong giây lát</p>
        </div>
      </div>
    </div>
  );
};

export default GoogleCallback;


===== FILE: ./frontend/src/pages/Home.jsx =====
import React, { useState, useEffect } from "react";
import Hero from "../components/Layout/Hero";
import FeaturedCollection from "../components/Products/FeaturedCollection";
import { getProducts } from "../services/productService";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

const Home = () => {
  const [collections, setCollections] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchCollections = async () => {
      try {
        // Lấy tất cả sản phẩm
        const response = await getProducts();
        const products = response.products || [];
        // Lấy danh sách collection từ API
        const collectionsRes = await axios.get(`${API_URL}/api/collections`);
        const collectionsData = collectionsRes.data;
        // Map sản phẩm vào từng collection
        const collectionsMap = {};
        collectionsData.forEach((col) => {
          collectionsMap[col.id] = {
            ...col,
            products: [],
          };
        });
        products.forEach((product) => {
          if (collectionsMap[product.collection]) {
            collectionsMap[product.collection].products.push(product);
          }
        });
        const collections = Object.values(collectionsMap);
        setCollections(collections);
        setLoading(false);
      } catch (err) {
        setError("Không thể tải dữ liệu bộ sưu tập");
        setLoading(false);
      }
    };
    fetchCollections();
  }, []);

  if (loading) return <div className="text-center mt-10">Đang tải...</div>;
  if (error)
    return <div className="text-center text-red-500 mt-10">{error}</div>;

  return (
    <>
      {/* <Hero />
      <h1 className="text-center text-4xl font-normal  mb-6 mt-10">
        Khám phá bộ sưu tập độc đáo của Wukudada
      </h1> */}
      <div className="mb-[50px]">
        <FeaturedCollection
          collections={collections.filter((col) => col.status === "active")}
        />
      </div>
    </>
  );
};

export default Home;


===== FILE: ./frontend/src/pages/Information.jsx =====
import React, { useEffect } from "react";
import { NavLink, Outlet, useLocation, useNavigate } from "react-router-dom";

const Information = () => {
  const location = useLocation();
  const navigate = useNavigate();

  useEffect(() => {
    if (
      location.pathname === "/information" ||
      location.pathname === "/information/"
    ) {
      navigate("about", { replace: true });
    }
  }, [location, navigate]);

  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      <h1 className="text-4xl font-bold mb-8">THÔNG TIN</h1>
      <div className="flex flex-col md:flex-row gap-6 md:gap-10">
        {/* Sidebar */}
        <aside className="md:w-1/4 w-full mb-4 md:mb-0">
          <ul className="bg-white border rounded p-4 md:p-0 md:border-0 md:bg-transparent">
            <li>
              <NavLink
                to="about"
                className={({ isActive }) =>
                  `mb-2 block text-gray-700 hover:underline px-0 py-1 text-base${
                    isActive ? " font-bold" : "font-normal"
                  }`
                }
                end
              >
                Thông tin hoạt động
              </NavLink>
            </li>
            <li>
              <NavLink
                to="sponsorship"
                className={({ isActive }) =>
                  `mb-2 block text-gray-700 hover:underline px-0 py-1 text-base${
                    isActive ? " font-bold" : "font-normal"
                  }`
                }
              >
                Đại sứ Thương hiệu
              </NavLink>
            </li>
          </ul>
        </aside>
        {/* Main content */}
        <section className="flex-1 bg-white border rounded p-6 min-h-[300px]">
          <Outlet />
        </section>
      </div>
    </div>
  );
};

export default Information;


===== FILE: ./frontend/src/pages/Login.jsx =====
import React, { useState, useEffect } from 'react';
import { Link, useNavigate, useLocation } from 'react-router-dom';
import { FcGoogle } from 'react-icons/fc';
import { FaFacebook } from 'react-icons/fa';
import { loginUser, clearError, clearSuccess } from '../redux/slices/authSlice';
import { useDispatch, useSelector } from 'react-redux';
import { toast } from 'sonner';
import FacebookLogin from '@greatsumini/react-facebook-login';
import axios from 'axios';

const Login = () => {
    const [formData, setFormData] = useState({
        email: '',
        password: '',
    });
    const [showPassword, setShowPassword] = useState(false);
    const [errors, setErrors] = useState({});

    const dispatch = useDispatch();
    const navigate = useNavigate();
    const location = useLocation();

    // Get the return URL from query parameters or location state
    const searchParams = new URLSearchParams(location.search);
    const returnUrl = searchParams.get('returnUrl') || location.state?.from || '/';

    // Get auth state from Redux
    const { loading, error, success, userInfo } = useSelector((state) => state.auth);

    // Redirect to returnUrl if already logged in
    useEffect(() => {
        if (userInfo) {
            navigate(returnUrl, { replace: true });
        }
    }, [userInfo, navigate, returnUrl]);

    // Handle navigation after successful login
    useEffect(() => {
        if (success && userInfo) {
            if (!userInfo.skipToast) {
                toast.success('Đăng nhập thành công!');
            }
            dispatch(clearSuccess());
            // Navigate to the returnUrl
            navigate(returnUrl);
        }
    }, [success, userInfo, navigate, dispatch, returnUrl]);

    // Handle error display
    useEffect(() => {
        if (error) {
            toast.error(error);
            dispatch(clearError());
        }
    }, [error, dispatch]);

    const validateForm = () => {
        const newErrors = {};

        if (!formData.email) {
            newErrors.email = 'Vui lòng nhập địa chỉ email';
        } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
            newErrors.email = 'Email không hợp lệ';
        }

        if (!formData.password) {
            newErrors.password = 'Vui lòng nhập mật khẩu';
        } else if (formData.password.length < 6) {
            newErrors.password = 'Mật khẩu phải có ít nhất 6 ký tự';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (validateForm()) {
            dispatch(loginUser({
                email: formData.email,
                password: formData.password
            }));
        }
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: value
        }));
        // Clear error for this field
        if (errors[name]) {
            setErrors(prev => ({
                ...prev,
                [name]: ''
            }));
        }
    };

    // Google OAuth handler
    const handleGoogleLogin = () => {
        window.location.href = `${import.meta.env.VITE_BACKEND_URL || 'http://localhost:9000'}/api/auth/google`;
    };

    const handleFacebookLogin = async (response) => {
        try {
            // Get the access token from the response
            const { accessToken } = response;

            // Send the token to your backend
            const backendResponse = await axios.post(
                `${import.meta.env.VITE_BACKEND_URL || 'http://localhost:9000'}/api/auth/facebook/mobile`,
                { accessToken }
            );

            const { user, token } = backendResponse.data;

            // Save to localStorage
            localStorage.setItem('userInfo', JSON.stringify(user));
            localStorage.setItem('userToken', token);

            // Update Redux state
            dispatch({
                type: 'auth/loginSuccess',
                payload: {
                    userInfo: {
                        ...user,
                        skipToast: true,
                    },
                    userToken: token,
                },
            });

            toast.success('Đăng nhập Facebook thành công!');
            navigate(returnUrl);
        } catch (error) {
            console.error('Facebook login error:', error);
            toast.error('Đăng nhập Facebook thất bại. Vui lòng thử lại.');
        }
    };

    return (
        <div className="flex px-23 pt-[50px] pb-[150px] bg-white max-md:p-8 max-sm:px-2.5 max-sm:py-5">
            <div className="flex gap-10 justify-between w-full max-md:flex-col max-md:gap-8 border-[2px] border-[#DCDCDC] p-5">
                <div className="flex flex-col flex-1">
                    <h2 className="text-3xl font-medium text-black mb-5">ĐĂNG NHẬP</h2>
                    <p className='mb-4'>Đăng nhập bằng địa chỉ email và mật khẩu của bạn.</p>
                    <form onSubmit={handleSubmit} noValidate className="flex flex-col items-start gap-5">
                        <div className='w-full'>
                            <label htmlFor="email" className="block text-xl font-medium text-black mb-2">
                                ĐỊA CHỈ EMAIL
                            </label>
                            <div className="flex flex-col">
                                <input
                                    id="email"
                                    name="email"
                                    type="email"
                                    required
                                    disabled={loading}
                                    className="w-full h-12 placeholder-gray-500 px-3 py-2 border-b-2 border-b-[#898989] bg-[#F5F5F5]
                                    focus:bg-white focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-black
                                    disabled:opacity-50 disabled:cursor-not-allowed"
                                    value={formData.email}
                                    onChange={handleChange}
                                    placeholder='Nhập email hợp lệ'
                                />
                                {errors.email && <span className="text-red-500 text-sm mt-1">{errors.email}</span>}
                            </div>
                        </div>

                        <div className='w-full'>
                            <label htmlFor="password" className="block text-xl font-medium text-black mb-2">
                                MẬT KHẨU
                            </label>
                            <div className="flex flex-col">
                                <input
                                    id="password"
                                    name="password"
                                    type={showPassword ? "text" : "password"}
                                    required
                                    disabled={loading}
                                    className="w-full h-12 placeholder-gray-500 px-3 py-2 border-b-2 border-b-[#898989] bg-[#F5F5F5]
                                    focus:bg-white focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-black
                                    disabled:opacity-50 disabled:cursor-not-allowed"
                                    value={formData.password}
                                    onChange={handleChange}
                                    placeholder='Nhập mật khẩu'
                                />
                                {errors.password && <span className="text-red-500 text-sm mt-1">{errors.password}</span>}
                            </div>
                        </div>

                        <div className="flex items-center">
                            <input
                                id="showPassword"
                                name="showPassword"
                                type="checkbox"
                                checked={showPassword}
                                onChange={() => setShowPassword(!showPassword)}
                                className="h-5 w-5 accent-black border-[#FFFFFF]"
                            />
                            <label htmlFor="showPassword" className="ml-2 block text-[16px] text-gray-700">
                                Hiện mật khẩu
                            </label>
                        </div>

                        <div className='flex flex-col gap-2'>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full flex justify-center py-[10px] px-25 border border-transparent text-[20px] font-medium text-white bg-black hover:bg-[#404040] cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Đang đăng nhập...' : 'ĐĂNG NHẬP'}
                            </button>

                            <Link to="/forgot-password" className="block text-[16px] font-medium text-black hover:text-[#444444]">
                                Quên mật khẩu?
                            </Link>
                        </div>
                        <div className='w-full'>
                            <div className="relative mb-2">
                                <div className="absolute inset-0 flex items-center">
                                    <div className="w-full border-t border-gray-300" />
                                </div>
                                <div className="relative flex justify-center text-sm">
                                    <span className="px-2 bg-white text-gray-500">Hoặc đăng nhập với</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    type="button"
                                    onClick={handleGoogleLogin}
                                    disabled={loading}
                                    className="flex items-center justify-center px-4 py-[10px] border border-gray-300 text-[20px] font-medium text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <FcGoogle className="h-5 w-5 mr-2" />
                                    Google
                                </button>

                            </div>
                        </div>
                    </form>
                </div>

                <div className="w-[1px] my-[50px] bg-[#DCDCDC]"></div>

                <div className="flex flex-col flex-1 items-start">
                    <h2 className="mb-5 text-3xl font-semibold text-black">
                        TẠO MỘT TÀI KHOẢN
                    </h2>
                    <p className="mb-4 text-base text-black">
                        Hãy tạo tài khoản ngay ! Bạn có thể nhận được các dịch vụ đặc biệt cho
                        riêng bạn như kiểm tra lịch sử mua hàng và nhận phiếu giảm giá cho thành
                        viên. Đăng ký miễn phí ngay hôm nay!
                    </p>
                    <Link to="/signup">
                        <button className="flex justify-center py-[10px] px-25 text-[20px] font-medium text-black border-2 border-black border-solid cursor-pointer hover:text-[#404040] hover:border-[#404040]">
                            TẠO TÀI KHOẢN
                        </button>
                    </Link>
                </div>
            </div>
        </div>
    )
}

export default Login

===== FILE: ./frontend/src/pages/Policy.jsx =====
import React from "react";

const Policy = () => {
  return (
    <div className="max-w-4xl mx-auto px-4 py-10">
      <h1 className="text-4xl font-bold mb-8">Chính sách đổi trả</h1>
      <div className="border p-6 bg-white text-black text-base rounded">
        <p>
          Chúng tôi cam kết mang đến trải nghiệm mua sắm tốt nhất cho khách
          hàng. Nếu sản phẩm không phù hợp, quý khách có thể đổi/trả theo các
          điều kiện dưới đây.
        </p>
        <ol className="list-decimal ml-6 mt-4 space-y-2">
          <li>
            <b>Điều kiện áp dụng đổi/trả</b>
            <ul className="list-disc ml-6 mt-1">
              <li>
                Sản phẩm chưa qua sử dụng, chưa giặt ủi, còn nguyên tem mác,
                nguyên kiện bao bì như ban đầu.
              </li>
              <li>
                Sản phẩm không bị dơ bẩn, không có mùi lạ, không bị rách hoặc hư
                hỏng do tác động từ khách hàng.
              </li>
              <li>Có hóa đơn mua hàng hoặc bằng chứng giao dịch hợp lệ.</li>
              <li>
                Áp dụng cho sản phẩm mua tại Luon VuiTuoi, không áp dụng cho sản
                phẩm từ bên thứ ba hoặc nhà bán hàng khác.
              </li>
            </ul>
          </li>
          <li>
            <b>Hình thức đổi/trả</b>
            <ul className="list-disc ml-6 mt-1">
              <li>
                <b>Đổi hàng:</b> Được đổi sang sản phẩm khác cùng loại (màu sắc,
                kích cỡ) hoặc sản phẩm khác có giá trị tương đương hoặc cao hơn
                (bù phần chênh lệch).
              </li>
              <li>
                <b>Trả hàng & hoàn tiền:</b>
                <ul className="list-disc ml-6 mt-1">
                  <li>
                    Chỉ áp dụng khi sản phẩm bị lỗi từ nhà sản xuất hoặc giao
                    sai hàng.
                  </li>
                  <li>
                    Tiền hoàn trả qua chuyển khoản ngân hàng hoặc voucher mua
                    sắm trong vòng 07 ngày sau khi xác nhận sản phẩm hợp lệ.
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <b>Quy trình đổi/trả</b>
            <ul className="list-disc ml-6 mt-1">
              <li>
                Liên hệ với bộ phận chăm sóc khách hàng qua hotline: 0901 234
                567 hoặc email: support@luonvuituoi.com để gửi yêu cầu đổi/trả.
              </li>
              <li>
                Đóng gói sản phẩm và gửi về địa chỉ 123 Đường ABC, TP. HCM hoặc
                cửa hàng gần nhất theo hướng dẫn.
              </li>
              <li>
                Chúng tôi kiểm tra sản phẩm và xử lý đổi/trả trong vòng 3 - 5
                ngày làm việc.
              </li>
            </ul>
          </li>
          <li>
            <b>Sản phẩm không áp dụng đổi/trả</b>
            <ul className="list-disc ml-6 mt-1">
              <li>
                Sản phẩm thuộc danh mục đồ lót, đồ bơi, tất/vớ, hoặc các sản
                phẩm giảm giá đặc biệt.
              </li>
              <li>
                Sản phẩm đã qua sử dụng, giặt ủi, bị rách, bị hư hỏng do khách
                hàng.
              </li>
              <li>
                Sản phẩm không có hóa đơn hoặc bằng chứng mua hàng hợp lệ.
              </li>
            </ul>
          </li>
          <li>
            <b>Chi phí đổi/trả</b>
            <ul className="list-disc ml-6 mt-1">
              <li>
                Nếu đổi/trả do lỗi nhà sản xuất hoặc sai sót trong đơn hàng,
                chúng tôi sẽ hỗ trợ toàn bộ chi phí vận chuyển.
              </li>
              <li>
                Nếu khách hàng chủ động muốn đổi ý, khách hàng sẽ tự chịu chi
                phí vận chuyển.
              </li>
            </ul>
          </li>
        </ol>
      </div>
    </div>
  );
};

export default Policy;


===== FILE: ./frontend/src/pages/Signup.jsx =====
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useDispatch, useSelector } from 'react-redux';
import { registerUser, clearError, clearSuccess } from '../redux/slices/authSlice';
import { toast } from 'sonner';

const Signup = () => {
    const [formData, setFormData] = useState({
        name: '',
        email: '',
        password: '',
        birth: '',
        gender: '',
        agreeToTerms: false
    });

    const [showPassword, setShowPassword] = useState(false);
    const [errors, setErrors] = useState({});

    const dispatch = useDispatch();
    const navigate = useNavigate();

    const { loading, error, success, userInfo } = useSelector((state) => state.auth);

    // Redirect to home if already logged in
    useEffect(() => {
        if (userInfo) {
            navigate('/', { replace: true });
        }
    }, [userInfo, navigate]);

    // Handle navigation after successful registration
    useEffect(() => {
        if (success && userInfo) {
            toast.success('Đăng ký thành công!');
            dispatch(clearSuccess());
            navigate('/');
        }
    }, [success, userInfo, navigate, dispatch]);

    // Handle error display
    useEffect(() => {
        if (error) {
            toast.error(error);
            dispatch(clearError());
        }
    }, [error, dispatch]);

    const validateForm = () => {
        const newErrors = {};

        // Name validation
        if (!formData.name) {
            newErrors.name = 'Vui lòng nhập họ tên';
        }

        // Email validation
        if (!formData.email) {
            newErrors.email = 'Vui lòng nhập địa chỉ email';
        } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
            newErrors.email = 'Email không hợp lệ';
        }

        // Password validation
        if (!formData.password) {
            newErrors.password = 'Vui lòng nhập mật khẩu';
        } else if (formData.password.length < 6) {
            newErrors.password = 'Mật khẩu phải có ít nhất 6 ký tự';
        }

        // Birth date validation
        if (!formData.birth) {
            newErrors.birth = 'Vui lòng chọn ngày sinh';
        }

        // Gender validation
        if (!formData.gender) {
            newErrors.gender = 'Vui lòng chọn giới tính';
        }

        // Terms agreement validation
        if (!formData.agreeToTerms) {
            newErrors.agreeToTerms = 'Vui lòng đồng ý với điều khoản sử dụng';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: type === 'checkbox' ? checked : value
        }));
        // Clear error for this field
        if (errors[name]) {
            setErrors(prev => ({
                ...prev,
                [name]: ''
            }));
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        if (validateForm()) {
            dispatch(registerUser({
                name: formData.name,
                email: formData.email,
                password: formData.password,
                gender: formData.gender,
                birth: formData.birth
            }));
        }
    };

    return (
        <div className="ml-24 mt-12 mb-36">
            <h2 className="text-3xl font-medium text-black mb-16">TẠO MỘT TÀI KHOẢN</h2>
            <form onSubmit={handleSubmit} noValidate className="flex flex-col gap-6 items-start border border-[#DCDCDC] p-5 w-[55%]">
                <p className='w-3/4'>Chúng tôi sẽ gửi thư xác nhận đến địa chỉ email được liên kết với tài khoản của bạn. Hãy kiểm tra email đến từ chúng tôi.</p>

                {/* Name */}
                <div className="flex items-baseline gap-5 w-full">
                    <label htmlFor="name" className="w-1/4 text-xl font-medium text-black">
                        HỌ TÊN
                    </label>
                    <div className="w-3/4 flex flex-col">
                        <input
                            id="name"
                            name="name"
                            type="text"
                            value={formData.name}
                            onChange={handleChange}
                            required
                            disabled={loading}
                            placeholder="Nhập họ tên"
                            className="w-full h-12 px-3 py-2 border-b-2 border-b-[#898989] bg-[#F5F5F5] placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-black disabled:opacity-50"
                        />
                        {errors.name && <span className="text-red-500 text-sm mt-1">{errors.name}</span>}
                    </div>
                </div>

                {/* Email */}
                <div className="flex items-baseline gap-5 w-full">
                    <label htmlFor="email" className="w-1/4 text-xl font-medium text-black">
                        ĐỊA CHỈ EMAIL
                    </label>
                    <div className="w-3/4 flex flex-col">
                        <input
                            id="email"
                            name="email"
                            type="email"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            disabled={loading}
                            placeholder="Nhập email hợp lệ"
                            className="w-full h-12 px-3 py-2 border-b-2 border-b-[#898989] bg-[#F5F5F5] placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-black disabled:opacity-50"
                        />
                        {errors.email && <span className="text-red-500 text-sm mt-1">{errors.email}</span>}
                    </div>
                </div>

                {/* Password */}
                <div className="flex items-baseline gap-5 w-full">
                    <label htmlFor="password" className="w-1/4 text-xl font-medium text-black">
                        MẬT KHẨU
                    </label>
                    <div className="w-3/4 flex flex-col">
                        <input
                            id="password"
                            name="password"
                            type={showPassword ? "text" : "password"}
                            value={formData.password}
                            onChange={handleChange}
                            required
                            disabled={loading}
                            placeholder="Nhập mật khẩu"
                            className="w-full h-12 px-3 py-2 border-b-2 border-b-[#898989] bg-[#F5F5F5] placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-black disabled:opacity-50"
                        />
                        {errors.password && <span className="text-red-500 text-sm mt-1">{errors.password}</span>}
                    </div>
                </div>

                <div className="flex items-center">
                    <input
                        id="showPassword"
                        name="showPassword"
                        type="checkbox"
                        checked={showPassword}
                        onChange={() => setShowPassword(!showPassword)}
                        className="h-5 w-5 accent-black border-[#FFFFFF]"
                    />
                    <label htmlFor="showPassword" className="ml-2 block text-[16px] text-gray-700">
                        Hiện mật khẩu
                    </label>
                </div>

                {/* Birth Date */}
                <div className="flex items-baseline gap-5 w-full">
                    <label htmlFor="birth" className="w-1/4 text-xl font-medium text-black">
                        NGÀY SINH
                    </label>
                    <div className="w-3/4 flex flex-col">
                        <input
                            id="birth"
                            name="birth"
                            type="date"
                            value={formData.birth}
                            onChange={handleChange}
                            required
                            disabled={loading}
                            className="w-full h-12 px-3 py-2 border-b-2 border-b-[#898989] bg-[#F5F5F5] placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-black disabled:opacity-50"
                        />
                        {errors.birth && <span className="text-red-500 text-sm mt-1">{errors.birth}</span>}
                    </div>
                </div>

                {/* Gender */}
                <div className="flex items-center gap-5 w-full">
                    <label className="w-1/4 text-xl font-medium text-black">
                        GIỚI TÍNH
                    </label>
                    <div className="w-3/4 flex gap-10">
                        <label className="flex items-center">
                            <input
                                type="radio"
                                name="gender"
                                value="male"
                                checked={formData.gender === 'male'}
                                onChange={handleChange}
                                disabled={loading}
                                className="h-5 w-5 accent-black"
                            />
                            <span className="ml-2">Nam</span>
                        </label>
                        <label className="flex items-center">
                            <input
                                type="radio"
                                name="gender"
                                value="female"
                                checked={formData.gender === 'female'}
                                onChange={handleChange}
                                disabled={loading}
                                className="h-5 w-5 accent-black"
                            />
                            <span className="ml-2">Nữ</span>
                        </label>
                        <label className="flex items-center">
                            <input
                                type="radio"
                                name="gender"
                                value="other"
                                checked={formData.gender === 'other'}
                                onChange={handleChange}
                                disabled={loading}
                                className="h-5 w-5 accent-black"
                            />
                            <span className="ml-2">Bỏ qua</span>
                        </label>
                        {errors.gender && <span className="text-red-500 text-sm">{errors.gender}</span>}
                    </div>
                </div>

                {/* Terms Agreement */}
                <div className="flex items-center">
                    <div className="flex items-center">
                        <input
                            id="agreeToTerms"
                            name="agreeToTerms"
                            type="checkbox"
                            checked={formData.agreeToTerms}
                            onChange={handleChange}
                            disabled={loading}
                            className="h-5 w-5 accent-black border-[#FFFFFF]"
                        />
                        <label htmlFor="agreeToTerms" className="ml-2 block text-[16px] text-gray-700">
                            Tôi đồng ý với ĐIỀU KHOẢN SỬ DỤNG và CHÍNH SÁCH BẢO MẬT của Wukudada.
                        </label>
                    </div>
                </div>
                {errors.agreeToTerms && <span className="text-red-500 text-sm">{errors.agreeToTerms}</span>}

                {/* Submit */}
                <button
                    type="submit"
                    disabled={loading}
                    className="flex justify-center py-[10px] px-25 border border-transparent text-[20px] font-medium text-white bg-black hover:bg-[#404040] cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {loading ? 'Đang xử lý...' : 'ĐĂNG KÝ'}
                </button>
            </form>
        </div>
    )
}

export default Signup

===== FILE: ./frontend/src/redux/slices/adminOrderSlice.js =====
import { createAsyncThunk, createSlice } from '@reduxjs/toolkit';
import axios from 'axios';

// Fetch all orders (admin only)
export const fetchAllOrders = createAsyncThunk(
    'adminOrder/fetchAllOrders',
    async (_, { rejectWithValue }) => {
        try {
            const response = await axios.get(`${import.meta.env.VITE_API_URL}/api/admin/orders`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error fetching orders:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

// Fetch order details by order ID (admin only)
export const fetchOrderDetails = createAsyncThunk(
    'adminOrder/fetchOrderDetails',
    async ({ orderId }, { rejectWithValue }) => {
        try {
            const response = await axios.get(`${import.meta.env.VITE_API_URL}/api/admin/orders/${orderId}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error fetching order details:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);
// Update order status (admin only)
export const updateOrderStatus = createAsyncThunk(
    'adminOrder/updateOrderStatus',
    async ({ orderId, status }, { rejectWithValue }) => {
        try {
            const response = await axios.put(`${import.meta.env.VITE_API_URL}/api/admin/orders/${orderId}`, { status }, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error updating order status:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);
// Delete an order (admin only)
export const deleteOrder = createAsyncThunk(
    'adminOrder/deleteOrder',
    async ({ orderId }, { rejectWithValue }) => {
        try {
            const response = await axios.delete(`${import.meta.env.VITE_API_URL}/api/admin/orders/${orderId}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error deleting order:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

// Admin order slice
const adminOrderSlice = createSlice({
    name: 'adminOrder',
    initialState: {
        orders: [],
        orderDetails: null,
        loading: false,
        error: null,
    },
    reducers: {},
    extraReducers: (builder) => {
        builder
            .addCase(fetchAllOrders.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchAllOrders.fulfilled, (state, action) => {
                state.loading = false;
                state.orders = action.payload;
            })
            .addCase(fetchAllOrders.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to fetch orders';
            })
            .addCase(fetchOrderDetails.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchOrderDetails.fulfilled, (state, action) => {
                state.loading = false;
                state.orderDetails = action.payload;
            })
            .addCase(fetchOrderDetails.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to fetch order details';
            })
            .addCase(updateOrderStatus.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(updateOrderStatus.fulfilled, (state, action) => {
                state.loading = false;
                const updatedOrderIndex = state.orders.findIndex(order => order._id === action.payload._id);
                if (updatedOrderIndex !== -1) {
                    state.orders[updatedOrderIndex] = action.payload;
                }
            })
            .addCase(updateOrderStatus.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to update order status';
            })
            .addCase(deleteOrder.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(deleteOrder.fulfilled, (state, action) => {
                state.loading = false;
                const deletedOrderId = action.payload._id;
                state.orders = state.orders.filter(order => order._id !== deletedOrderId);
            })
            .addCase(deleteOrder.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to delete order';
            });
    }
});
export default adminOrderSlice.reducer;

===== FILE: ./frontend/src/redux/slices/adminProductSlice.js =====
import { createAsyncThunk, createSlice } from '@reduxjs/toolkit';
import axios from 'axios';

// Async thunk to fetch all products (admin only)
export const fetchAllProducts = createAsyncThunk(
    'adminProduct/fetchAllProducts',
    async (_, { rejectWithValue }) => {
        try {
            const response = await axios.get(`${import.meta.env.VITE_API_URL}/api/admin/products`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error fetching products:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

// Async function to create a new product (admin only)
export const createProduct = createAsyncThunk(
    'adminProduct/createProduct',
    async (productData, { rejectWithValue }) => {
        try {
            const response = await axios.post(`${import.meta.env.VITE_API_URL}/api/admin/products`, productData, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error creating product:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

// Async function to update an existing product (admin only)
export const updateProduct = createAsyncThunk(
    'adminProduct/updateProduct',
    async ({ id, productData }, { rejectWithValue }) => {
        try {
            const response = await axios.put(`${import.meta.env.VITE_API_URL}/api/admin/products/${id}`, productData, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error updating product:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

// Async function to delete a product (admin only)
export const deleteProduct = createAsyncThunk(
    'adminProduct/deleteProduct',
    async (id, { rejectWithValue }) => {
        try {
            const response = await axios.delete(`${import.meta.env.VITE_API_URL}/api/admin/products/${id}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error deleting product:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

const adminProductSlice = createSlice({
    name: 'adminProduct',
    initialState: {
        products: [],
        loading: false,
        error: null,
    },
    reducers: {},
    extraReducers: (builder) => {
        builder
            .addCase(fetchAllProducts.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchAllProducts.fulfilled, (state, action) => {
                state.loading = false;
                state.products = action.payload;
            })
            .addCase(fetchAllProducts.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to fetch products';
            })
            .addCase(createProduct.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(createProduct.fulfilled, (state, action) => {
                state.loading = false;
                state.products.push(action.payload);
            })
            .addCase(createProduct.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to create product';
            })
            .addCase(updateProduct.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(updateProduct.fulfilled, (state, action) => {
                state.loading = false;
                const index = state.products.findIndex(product => product.id === action.payload.id);
                if (index !== -1) {
                    state.products[index] = action.payload;
                }
            })
            .addCase(updateProduct.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to update product';
            })
            .addCase(deleteProduct.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(deleteProduct.fulfilled, (state, action) => {
                state.loading = false;
                const index = state.products.findIndex(product => product.id === action.payload.id);
                if (index !== -1) {
                    state.products.splice(index, 1);
                }
            })
            .addCase(deleteProduct.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to delete product';
            });
    },
});

export default adminProductSlice.reducer;

===== FILE: ./frontend/src/redux/slices/adminSlice.js =====
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import axios from 'axios';

// fetch all users (admin only)
export const fetchAllUsers = createAsyncThunk(
    'admin/fetchAllUsers',
    async () => {
        try {
            const response = await axios.get(`${import.meta.env.VITE_API_URL}/api/admin/users`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error fetching users:", error);
            throw error;
        }
    }
);

// Add a new user (admin only)
export const addUser = createAsyncThunk(
    'admin/addUser',
    async (userData) => {
        try {
            const response = await axios.post(`${import.meta.env.VITE_API_URL}/api/admin/users`, userData, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error adding user:", error);
            throw error;
        }
    }
);

// Update user details (admin only)
export const updateUser = createAsyncThunk(
    'admin/updateUser',
    async ({ id, name, email, role }) => {
        try {
            const response = await axios.put(
                `${import.meta.env.VITE_API_URL}/api/admin/users/${id}`,
                { name, email, role },
                {
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    }
                }
            );
            return response.data;
        } catch (error) {
            console.error("Error updating user:", error);
            throw error;
        }
    }
);

// Delete a user (admin only)
export const deleteUser = createAsyncThunk(
    'admin/deleteUser',
    async (userId) => {
        try {
            const response = await axios.delete(`${import.meta.env.VITE_API_URL}/api/admin/users/${userId}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error deleting user:", error);
            throw error;
        }
    }
);

const adminSlice = createSlice({
    name: 'admin',
    initialState: {
        users: [],
        loading: false,
        error: null,
    },
    reducers: {},
    extraReducers: (builder) => {
        builder
            .addCase(fetchAllUsers.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchAllUsers.fulfilled, (state, action) => {
                state.loading = false;
                state.users = action.payload;
            })
            .addCase(fetchAllUsers.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message || 'Failed to fetch users';
            })
            .addCase(addUser.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(addUser.fulfilled, (state, action) => {
                state.loading = false;
                state.users.push(action.payload);
            })
            .addCase(addUser.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message || 'Failed to add user';
            })
            .addCase(updateUser.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(updateUser.fulfilled, (state, action) => {
                state.loading = false;
                const index = state.users.findIndex(user => user.id === action.payload.id);
                if (index !== -1) {
                    state.users[index] = action.payload;
                }
            })
            .addCase(updateUser.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message || 'Failed to update user';
            })
            .addCase(deleteUser.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(deleteUser.fulfilled, (state, action) => {
                state.loading = false;
                const userId = action.meta.arg;
                const index = state.users.findIndex(user => user.id === userId);
                if (index !== -1) {
                    state.users.splice(index, 1);
                }
            })
            .addCase(deleteUser.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message || 'Failed to delete user';
            });
    },
});
export default adminSlice.reducer;

===== FILE: ./frontend/src/redux/slices/authSlice.js =====
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios";

// Base URL for API
const API_URL = import.meta.env.VITE_BACKEND_URL || "http://localhost:9000";

// Retrieve user info and token from localStorage if available
const userFromStorage = localStorage.getItem("userInfo")
  ? JSON.parse(localStorage.getItem("userInfo"))
  : null;

const tokenFromStorage = localStorage.getItem("userToken") || null;

// Check for an existing token in localStorage or generate a new one
const initialGuestId =
  localStorage.getItem("guestId") ||
  `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
localStorage.setItem("guestId", initialGuestId);

// Initialize state with user info and guest ID
const initialState = {
  userInfo: userFromStorage,
  userToken: tokenFromStorage,
  guestId: initialGuestId,
  loading: false,
  error: null,
  success: false,
};

// Async thunk for user login
export const loginUser = createAsyncThunk(
  "auth/loginUser",
  async (userData, { rejectWithValue }) => {
    try {
      const config = {
        headers: {
          "Content-Type": "application/json",
        },
      };

      // Đúng endpoint: /api/users/login
      const response = await axios.post(
        `${API_URL}/api/users/login`,
        userData,
        config
      );

      // Lưu thông tin vào localStorage
      localStorage.setItem("userInfo", JSON.stringify(response.data.user));
      localStorage.setItem("userToken", response.data.token);

      return response.data; // Return cả user và token
    } catch (error) {
      // Handle error response
      if (error.response && error.response.data.message) {
        return rejectWithValue(error.response.data.message);
      } else {
        return rejectWithValue(error.message);
      }
    }
  }
);

export const logoutUser = createAsyncThunk(
  "auth/logoutUser",
  async (_, { rejectWithValue }) => {
    try {
      const token = localStorage.getItem("userToken") || localStorage.getItem("token");
      
      if (token) {
        // Gọi API logout backend
        await axios.post(
          `${API_URL}/api/users/logout`,
          {},
          {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          }
        );
      }

      // Xóa tất cả dữ liệu trong localStorage
      localStorage.removeItem("userInfo");
      localStorage.removeItem("userToken");
      localStorage.removeItem("token");
      localStorage.removeItem("cart");
      
      return { message: "Đăng xuất thành công" };
    } catch (error) {
      // Dù có lỗi API vẫn xóa localStorage
      localStorage.removeItem("userInfo");
      localStorage.removeItem("userToken");
      localStorage.removeItem("token");
      localStorage.removeItem("cart");
      
      console.error("Logout error:", error);
      return rejectWithValue(error.response?.data?.message || "Lỗi khi đăng xuất");
    }
  }
);

// Async thunk for user Registration
export const registerUser = createAsyncThunk(
  "auth/registerUser",
  async (userData, { rejectWithValue }) => {
    try {
      const config = {
        headers: {
          "Content-Type": "application/json",
        },
      };

      // Đúng endpoint: /api/users/register
      const response = await axios.post(
        `${API_URL}/api/users/register`,
        userData,
        config
      );

      // Lưu thông tin vào localStorage
      localStorage.setItem("userInfo", JSON.stringify(response.data.user));
      localStorage.setItem("userToken", response.data.token);

      return response.data; // Return cả user và token
    } catch (error) {
      // Handle error response
      if (error.response && error.response.data.message) {
        return rejectWithValue(error.response.data.message);
      } else {
        return rejectWithValue(error.message);
      }
    }
  }
);

// Async thunk for getting user profile
export const getUserProfile = createAsyncThunk(
  "auth/getUserProfile",
  async (_, { getState, rejectWithValue }) => {
    try {
      const token = getState().auth.userToken;

      const config = {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      };

      const response = await axios.get(`${API_URL}/api/users/profile`, config);

      return response.data;
    } catch (error) {
      if (error.response && error.response.data.message) {
        return rejectWithValue(error.response.data.message);
      } else {
        return rejectWithValue(error.message);
      }
    }
  }
);

// Slice
const authSlice = createSlice({
  name: "auth",
  initialState,
  reducers: {
    logout: (state) => {
      // Force clear tất cả
      localStorage.removeItem("userInfo");
      localStorage.removeItem("userToken");
      localStorage.removeItem("token");
      localStorage.removeItem("cart");
      
      state.userInfo = null;
      state.userToken = null;
      state.loading = false;
      state.error = null;
      state.success = false;
      
      // Generate new guest ID on logout
      state.guestId = `guest_${Date.now()}_${Math.random()
        .toString(36)
        .substr(2, 9)}`;
      localStorage.setItem("guestId", state.guestId);
    },
    loginSuccess: (state, action) => {
      state.loading = false;
      state.userInfo = action.payload.userInfo;
      state.userToken = action.payload.userToken;
      state.success = true;
      state.error = null;
    },
    clearError: (state) => {
      state.error = null;
    },
    clearSuccess: (state) => {
      state.success = false;
    },
    generateNewGuestId: (state) => {
      state.guestId = `guest_${Date.now()}_${Math.random()
        .toString(36)
        .substr(2, 9)}`;
      localStorage.setItem("guestId", state.guestId);
    },
  },
  extraReducers: (builder) => {
    builder
      // Login cases
      .addCase(loginUser.pending, (state) => {
        state.loading = true;
        state.error = null;
        state.success = false;
      })
      .addCase(loginUser.fulfilled, (state, action) => {
        state.loading = false;
        state.userInfo = action.payload.user;
        state.userToken = action.payload.token;
        state.success = true;
        state.error = null;
        state.loading = false;
        // Đảm bảo sync localStorage
        localStorage.setItem("userInfo", JSON.stringify(action.payload.user));
        localStorage.setItem("userToken", action.payload.token);
      })
      .addCase(loginUser.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload;
        state.success = false;
      })
      // Register cases
      .addCase(registerUser.pending, (state) => {
        state.loading = true;
        state.error = null;
        state.success = false;
      })
      .addCase(registerUser.fulfilled, (state, action) => {
        state.loading = false;
        state.userInfo = action.payload.user;
        state.userToken = action.payload.token;
        state.success = true;
        state.error = null;
      })
      .addCase(registerUser.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload;
        state.success = false;
      })
      .addCase(logoutUser.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(logoutUser.fulfilled, (state, action) => {
        state.loading = false;
        state.userInfo = null;
        state.userToken = null;
        state.error = null;
        state.success = false;
        
        // Generate new guest ID
        state.guestId = `guest_${Date.now()}_${Math.random()
          .toString(36)
          .substr(2, 9)}`;
        localStorage.setItem("guestId", state.guestId);
      })
      .addCase(logoutUser.rejected, (state, action) => {
        state.loading = false;
        // Vẫn logout dù có lỗi
        state.userInfo = null;
        state.userToken = null;
        state.error = null;
        
        // Generate new guest ID
        state.guestId = `guest_${Date.now()}_${Math.random()
          .toString(36)
          .substr(2, 9)}`;
        localStorage.setItem("guestId", state.guestId);
      })
      // Get profile cases
      .addCase(getUserProfile.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(getUserProfile.fulfilled, (state, action) => {
        state.loading = false;
        state.userInfo = action.payload;
        state.error = null;
        // Lưu lại userInfo vào localStorage để đồng bộ khi reload
        localStorage.setItem("userInfo", JSON.stringify(action.payload));
      })
      .addCase(getUserProfile.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload;
      });
  },
});

export const { logout, clearError, clearSuccess, generateNewGuestId } =
  authSlice.actions;
export default authSlice.reducer;


===== FILE: ./frontend/src/redux/slices/cartSlice.js =====
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:9000";

// Helper function to load cart from localStorage
const loadCartFromStorage = () => {
  const storedCart = localStorage.getItem("cart");
  return storedCart ? JSON.parse(storedCart) : { products: [] };
};

// Helper function to save cart to localStorage
const saveCartToStorage = (cart) => {
  localStorage.setItem("cart", JSON.stringify(cart));
};

// Fetch cart for a user or guest
export const fetchCart = createAsyncThunk(
  "cart/fetchCart",
  async ({ userId, guestId }, { rejectWithValue }) => {
    try {
      const response = await axios.get(`${API_URL}/api/cart`, {
        params: { userId, guestId },
      });
      return response.data;
    } catch (error) {
      if (error.response && error.response.status === 404) {
        // Không có cart, trả về cart rỗng
        return { products: [] };
      }
      console.error("Error fetching cart:", error);
      return rejectWithValue(error.response?.data || error.message);
    }
  }
);

// Add an item to the cart for a user or guest
export const addToCart = createAsyncThunk(
  "cart/addToCart",
  async (
    { productId, quantity, size, color, guestId, userId },
    { rejectWithValue }
  ) => {
    try {
      const response = await axios.post(`${API_URL}/api/cart`, {
        productId,
        quantity,
        size,
        color,
        guestId,
        userId,
      });
      return response.data;
    } catch (error) {
      console.error("Error adding to cart:", error);
      return rejectWithValue(error.response?.data || error.message);
    }
  }
);

// Update the quantity of an item in the cart - SỬA LỖI Ở ĐÂY
export const updateCartItemQuantity = createAsyncThunk(
  "cart/updateCartItemQuantity",
  async (
    { productId, quantity, guestId, userId, size, color },
    { rejectWithValue }
  ) => {
    try {
      // SỬA: Sử dụng đúng endpoint - bỏ /${productId} ra khỏi URL
      const response = await axios.put(`${API_URL}/api/cart`, {
        productId,
        quantity,
        guestId,
        userId,
        size,
        color,
      });
      return response.data;
    } catch (error) {
      console.error("Error updating cart item:", error);
      return rejectWithValue(error.response?.data || error.message);
    }
  }
);

// Remove an item from the cart
export const removeFromCart = createAsyncThunk(
  "cart/removeFromCart",
  async ({ productId, guestId, userId, size, color }, { rejectWithValue }) => {
    try {
      const response = await axios({
        method: "DELETE",
        url: `${API_URL}/api/cart`,
        data: {
          productId,
          guestId,
          userId,
          size,
          color,
        },
      });
      return response.data;
    } catch (error) {
      console.error("Error removing from cart:", error);
      return rejectWithValue(error.response?.data || error.message);
    }
  }
);

// Merge guest cart with user cart
export const mergeCart = createAsyncThunk(
  "cart/mergeCart",
  async ({ userId, guestId }, { rejectWithValue }) => {
    try {
      const response = await axios.post(
        `${API_URL}/api/cart/merge`,
        {
          userId,
          guestId,
        },
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        }
      );
      return response.data;
    } catch (error) {
      console.error("Error merging cart:", error);
      return rejectWithValue(error.response?.data || error.message);
    }
  }
);

// Clear entire cart on server
export const clearCartServer = createAsyncThunk(
  "cart/clearCartServer",
  async ({ userId, guestId }, { rejectWithValue }) => {
    try {
      const response = await axios.delete(`${API_URL}/api/cart/clear`, {
        data: { userId, guestId },
      });
      // Trả về cart rỗng
      return { products: [] };
    } catch (error) {
      console.error("Error clearing cart on server:", error);
      return rejectWithValue(error.response?.data || error.message);
    }
  }
);

const cartSlice = createSlice({
  name: "cart",
  initialState: {
    cart: loadCartFromStorage(),
    loading: false,
    error: null,
  },
  reducers: {
    clearCart: (state) => {
      state.cart = { products: [] };
      localStorage.removeItem("cart");
    },
  },
  extraReducers: (builder) => {
    builder
      .addCase(fetchCart.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchCart.fulfilled, (state, action) => {
        state.loading = false;
        state.cart = action.payload;
        saveCartToStorage(action.payload); // SỬA: action.payload thay vì state.payload
      })
      .addCase(fetchCart.rejected, (state, action) => {
        state.loading = false;
        state.error =
          action.payload?.message ||
          action.error.message ||
          "Failed to fetch cart";
      })

      .addCase(addToCart.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(addToCart.fulfilled, (state, action) => {
        state.loading = false;
        state.cart = action.payload;
        saveCartToStorage(action.payload); // SỬA: action.payload thay vì state.payload
      })
      .addCase(addToCart.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload?.message || "Failed to add to cart";
      })

      .addCase(removeFromCart.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(removeFromCart.fulfilled, (state, action) => {
        state.loading = false;
        state.cart = action.payload;
        saveCartToStorage(action.payload); // SỬA: action.payload thay vì state.payload
      })
      .addCase(removeFromCart.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload?.message || "Failed to remove from cart";
      })

      .addCase(mergeCart.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(mergeCart.fulfilled, (state, action) => {
        state.loading = false;
        state.cart = action.payload.cart || action.payload; // SỬA: Xử lý cả hai trường hợp
        saveCartToStorage(state.cart);
      })
      .addCase(mergeCart.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload?.message || "Failed to merge cart";
      })

      .addCase(updateCartItemQuantity.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(updateCartItemQuantity.fulfilled, (state, action) => {
        state.loading = false;
        state.cart = action.payload;
        saveCartToStorage(action.payload); // SỬA: action.payload thay vì state.payload
      })
      .addCase(updateCartItemQuantity.rejected, (state, action) => {
        state.loading = false;
        state.error =
          action.payload?.message || "Failed to update cart item quantity";
      })

      .addCase(clearCartServer.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(clearCartServer.fulfilled, (state, action) => {
        state.loading = false;
        state.cart = { products: [] };
        localStorage.removeItem("cart");
      })
      .addCase(clearCartServer.rejected, (state, action) => {
        state.loading = false;
        state.error =
          action.payload?.message || "Failed to clear cart on server";
      });
  },
});

export const { clearCart } = cartSlice.actions;
export default cartSlice.reducer;


===== FILE: ./frontend/src/redux/slices/checkoutSlice.js =====
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios";

// Async thunk to create a checkout session
export const createCheckoutSession = createAsyncThunk(
  "checkout/createCheckoutSession",
  async (orderData, { rejectWithValue }) => {
    try {
      const response = await axios.post(
        `${import.meta.env.VITE_API_URL}/api/checkout`,
        orderData,
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("userToken") || localStorage.getItem("token")}`,
          },
        }
      );
      return response.data;
    } catch (error) {
      console.error("Error creating order:", error);
      return rejectWithValue(
        error.response?.data?.message || error.message || "Unknown error"
      );
    }
  }
);

const checkoutSlice = createSlice({
  name: "checkout",
  initialState: {
    checkout: null,
    loading: false,
    error: null,
    sessionId: null,
    buyNowItem: null, // ✅ thêm biến này
  },

  reducers: {
    clearCheckout: (state) => {
      state.checkout = null;
      state.sessionId = null;
      state.error = null;
      state.buyNowItem = null; // ✅ reset luôn buyNowItem
    },
    setBuyNowItem: (state, action) => {
      state.buyNowItem = action.payload; // ✅ thêm setter
    },
  },

  extraReducers: (builder) => {
    builder
      .addCase(createCheckoutSession.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(createCheckoutSession.fulfilled, (state, action) => {
        state.loading = false;
        state.checkout = action.payload;
        state.sessionId = action.payload._id;
      })
      .addCase(createCheckoutSession.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload || "Failed to create order";
      });
  },
});

// ✅ Export đầy đủ cả 2 action
export const { clearCheckout, setBuyNowItem } = checkoutSlice.actions;

export default checkoutSlice.reducer;


===== FILE: ./frontend/src/redux/slices/orderSlice.js =====
import {createSlice, createAsyncThunk} from '@reduxjs/toolkit';
import axios from 'axios';

// Async thunk for fetching user orders
export const fetchUserOrders = createAsyncThunk(
    'order/fetchUserOrders',
    async ({userId}, {rejectWithValue}) => {
        try {
            const response = await axios.get(`${import.meta.env.VITE_API_URL}/api/orders`, {
                params: { userId },
                headers: {
                    Authorization: localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error fetching user orders:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

// Async thunk for fetching order details by order ID
export const fetchOrderDetails = createAsyncThunk(
    'order/fetchOrderDetails',
    async ({orderId}, {rejectWithValue}) => {
        try {
            const response = await axios.get(`${import.meta.env.VITE_API_URL}/api/orders/${orderId}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            return response.data;
        } catch (error) {
            console.error("Error fetching order details:", error);
            return rejectWithValue(error.response?.data || error.message || 'Unknown error');
        }
    }
);

const orderSlice = createSlice({
    name: 'order',
    initialState: {
        orders: [],
        orderDetails: null,
        totalOrders: 0,
        loading: false,
        error: null,
    },
    reducers: {},
    extraReducers: (builder) => {
        builder
            .addCase(fetchUserOrders.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchUserOrders.fulfilled, (state, action) => {
                state.loading = false;
                state.orders = action.payload;
            })
            .addCase(fetchUserOrders.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to fetch user orders';
            })
            .addCase(fetchOrderDetails.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchOrderDetails.fulfilled, (state, action) => {
                state.loading = false;
                state.orderDetails = action.payload;
            })
            .addCase(fetchOrderDetails.rejected, (state, action) => {
                state.loading = false;
                state.error = action.payload || 'Failed to fetch order details';
            });
    },
});

export default orderSlice.reducer;

===== FILE: ./frontend/src/redux/slices/productsSlice.js =====
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import * as productService from '../../services/productService';

// Async thunk to fetch products by filter
export const fetchProductsByFilter = createAsyncThunk("products/fetchByFilter", async (filters) => {
    const response = await productService.getProducts(filters);
    return response;
});

// Async thunk to fetch a single product by ID
export const fetchProductById = createAsyncThunk("products/fetchProductDetails", async (id) => {
    const response = await productService.getProductById(id);
    return response;
});

// Async thunk to fetch similar products
export const fetchSimilarProducts = createAsyncThunk("products/fetchSimilarProducts", async (id) => {
    const response = await productService.getSimilarProducts(id);
    return response;
});

// Async thunk to fetch best sellers
export const fetchBestSellers = createAsyncThunk("products/fetchBestSellers", async () => {
    const response = await productService.getBestSellers();
    return response;
});

// Async thunk to fetch new arrivals
export const fetchNewArrivals = createAsyncThunk("products/fetchNewArrivals", async () => {
    const response = await productService.getNewArrivals();
    return response;
});

const productsSlice = createSlice({
    name: 'products',
    initialState: {
        products: [],
        selectedProduct: null,
        similarProducts: [],
        bestSellers: [],
        newArrivals: [],
        loading: false,
        error: null,
        filter: {
            category: null,
            size: null,
            color: null,
            gender: null,
            brand: null,
            minPrice: null,
            maxPrice: null,
            sortBy: null,
            search: null,
            material: null,
            limit: null,
            collection: null,
        },
    },
    reducers: {
        setFilter: (state, action) => {
            state.filter = { ...state.filter, ...action.payload };
        },
        clearFilter: (state) => {
            state.filter = {
                size: null,
                color: null,
                gender: null,
                brand: null,
                minPrice: null,
                maxPrice: null,
                sortBy: null,
                search: null,
                material: null,
                limit: null,
                collection: null,
            };
        }
    },
    extraReducers: (builder) => {
        builder
            // Handle fetchProductsByFilter
            .addCase(fetchProductsByFilter.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchProductsByFilter.fulfilled, (state, action) => {
                state.loading = false;
                state.products = action.payload.products || [];
            })
            .addCase(fetchProductsByFilter.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message;
            })
            // Handle fetchProductById
            .addCase(fetchProductById.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchProductById.fulfilled, (state, action) => {
                state.loading = false;
                state.selectedProduct = action.payload;
            })
            .addCase(fetchProductById.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message;
            })
            // Handle fetchSimilarProducts
            .addCase(fetchSimilarProducts.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchSimilarProducts.fulfilled, (state, action) => {
                state.loading = false;
                state.similarProducts = action.payload;
            })
            .addCase(fetchSimilarProducts.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message;
            })
            // Handle fetchBestSellers
            .addCase(fetchBestSellers.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchBestSellers.fulfilled, (state, action) => {
                state.loading = false;
                state.bestSellers = action.payload;
            })
            .addCase(fetchBestSellers.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message;
            })
            // Handle fetchNewArrivals
            .addCase(fetchNewArrivals.pending, (state) => {
                state.loading = true;
                state.error = null;
            })
            .addCase(fetchNewArrivals.fulfilled, (state, action) => {
                state.loading = false;
                state.newArrivals = action.payload;
            })
            .addCase(fetchNewArrivals.rejected, (state, action) => {
                state.loading = false;
                state.error = action.error.message;
            });
    },
});

export const { setFilter, clearFilter } = productsSlice.actions;
export default productsSlice.reducer;

===== FILE: ./frontend/src/redux/store.js =====
import { configureStore } from '@reduxjs/toolkit';
import authReducer from './slices/authSlice';
import prodcutReducer from './slices/productsSlice';
import cartReducer from './slices/cartSlice';
import checkoutReducer from './slices/checkoutSlice';
import orderReducer from './slices/orderSlice';
import adminReducer from './slices/adminSlice';
import adminProductReducer from './slices/adminProductSlice';
import adminOrderReducer from './slices/adminOrderSlice';

const store = configureStore({
    reducer: {
        auth: authReducer,
        products: prodcutReducer,
        cart: cartReducer,
        checkout: checkoutReducer,
        order: orderReducer,
        admin: adminReducer,
        adminProduct: adminProductReducer,
        adminOrder: adminOrderReducer,
    },
});

export default store;

===== FILE: ./frontend/src/services/productService.js =====
import axios from 'axios';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:9000';

// Get all products with filters
export const getProducts = async (filters) => {
    try {
        const response = await axios.get(`${API_URL}/api/products`, { params: filters });
        return response.data;
    } catch (error) {
        throw error.response?.data || error.message;
    }
};

// Get product by ID
export const getProductById = async (id) => {
    try {
        const response = await axios.get(`${API_URL}/api/products/${id}`);
        return response.data;
    } catch (error) {
        throw error.response?.data || error.message;
    }
};

// Get similar products
export const getSimilarProducts = async (id) => {
    try {
        const response = await axios.get(`${API_URL}/api/products/similar/${id}`);
        return response.data;
    } catch (error) {
        throw error.response?.data || error.message;
    }
};

// Get best sellers
export const getBestSellers = async () => {
    try {
        const response = await axios.get(`${API_URL}/api/products/best-sellers`);
        return response.data;
    } catch (error) {
        throw error.response?.data || error.message;
    }
};

// Get new arrivals
export const getNewArrivals = async () => {
    try {
        const response = await axios.get(`${API_URL}/api/products/new-arrivals`);
        return response.data;
    } catch (error) {
        throw error.response?.data || error.message;
    }
}; 

===== FILE: ./frontend/src/utils/auth.js =====
// Utility function to get auth token from localStorage
// Checks both 'userToken' (used by authSlice) and 'token' (legacy) for compatibility
export const getAuthToken = () => {
  return localStorage.getItem("userToken") || localStorage.getItem("token");
};

// Utility function to remove auth tokens
export const removeAuthTokens = () => {
  localStorage.removeItem("userToken");
  localStorage.removeItem("token");
};

// Utility function to set auth token
export const setAuthToken = (token) => {
  localStorage.setItem("userToken", token);
};


===== FILE: ./frontend/src/utils/axiosInterceptor.js =====
// frontend/src/utils/axiosInterceptor.js
import axios from 'axios';
import store from '../redux/store';
import { logoutUser } from '../redux/slices/authSlice';
import { toast } from 'sonner';

// Setup axios interceptor
axios.interceptors.response.use(
  (response) => {
    return response;
  },
  async (error) => {
    const originalRequest = error.config;
    
    if (error.response?.status === 401) {
      const errorData = error.response.data;
      
      // Nếu token expired hoặc invalid thì auto logout
      if (errorData?.expired || errorData?.invalid || errorData?.message === "Token expired") {
        // Prevent infinite loop
        if (!originalRequest._retry) {
          originalRequest._retry = true;
          
          // Dispatch logout
          store.dispatch(logoutUser());
          
          toast.error("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại!");
          
          // Redirect to login
          if (typeof window !== 'undefined') {
            window.location.href = '/login';
          }
        }
      }
    }
    
    return Promise.reject(error);
  }
);

export default axios;

===== FILE: ./frontend/src/utils/bankInfo.js =====
// Thông tin ngân hàng cho chuyển khoản
export const BANK_INFO = {
  bankName: "MB Bank",
  accountNumber: "7318032005",
  accountName: "CONG TY THOI TRANG WUKUDADA",
  bankCode: "970422", // Mã ngân hàng Vietcombank cho VietQR

  // Cấu hình VietQR
  vietqr: {
    template: "compact2",
    baseUrl: "https://img.vietqr.io/image",
  },

  // Thông tin liên hệ
  contact: {
    hotline: "1900 1234",
    processingTime: "1-2 giờ trong giờ hành chính",
  },
};

// Hàm tạo URL VietQR
export const generateVietQRUrl = (amount, orderCode, phone) => {
  const { bankCode, accountNumber, accountName, vietqr } = BANK_INFO;
  const transferContent = `${orderCode} ${phone}`;

  return `${vietqr.baseUrl}/${bankCode}-${accountNumber}-${
    vietqr.template
  }.png?amount=${amount}&addInfo=${encodeURIComponent(
    transferContent
  )}&accountName=${encodeURIComponent(accountName)}`;
};

// Hàm tạo mã đơn hàng
export const generateOrderCode = () => {
  return `DH${Date.now().toString().slice(-6)}`;
};

// Fallback SVG cho QR code (224x224px)
export const QR_FALLBACK_SVG =
  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgdmlld0JveD0iMCAwIDIyNCAyMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjQiIGhlaWdodD0iMjI0IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMTIgMTY4QzE0MS4wNjEgMTY4IDE2NCAxNDUuMDYxIDE2NCAxMTJDMTY0IDc4LjkzOSAxNDEuMDYxIDU2IDExMiA1NkM4Mi45MzkgNTYgNjAgNzguOTM5IDYwIDExMkM2MCAxNDUuMDYxIDgyLjkzOSAxNjggMTEyIDE2OFoiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIzIi8+Cjwvc3ZnPgo=";

// Kiểm tra thanh toán thành công từ danh sách giao dịch
export function checkPaymentSuccess(transactions, orderCode, amount, phone) {
  if (!Array.isArray(transactions)) return null;
  const now = new Date();
  const orderCodeNorm = orderCode.trim().toLowerCase();
  const phoneNorm = phone.replace(/\D/g, "");
  for (const tx of transactions) {
    const moTa = (tx.moTa || "").toLowerCase();
    const hasOrderCode = moTa.includes(orderCodeNorm);
    const hasPhone = moTa.includes(phoneNorm);
    const amountMatch = Math.abs(Number(tx.giaTri) - Number(amount)) <= 1000;
    const timeDiff = now - new Date(tx.ngayDienRa);
    const isRecent = timeDiff >= 0 && timeDiff <= 24 * 60 * 60 * 1000;
    // DEBUG LOG
    console.log("[checkPaymentSuccess]", {
      moTa,
      orderCodeNorm,
      phoneNorm,
      hasOrderCode,
      hasPhone,
      amount: Number(amount),
      txAmount: Number(tx.giaTri),
      amountMatch,
      txTime: tx.ngayDienRa,
      now: now.toISOString(),
      timeDiff,
      isRecent,
    });
    if (hasOrderCode && hasPhone && amountMatch && isRecent) {
      return tx;
    }
  }
  return null;
}

/**
 * Gọi API Google Apps Script lấy 5 giao dịch gần nhất và kiểm tra thanh toán
 * @param {string} orderCode - Mã đơn hàng
 * @param {number} amount - Số tiền
 * @param {string} phone - Số điện thoại
 * @returns {Promise<object|null>} Object giao dịch nếu tìm thấy, null nếu không
 */
export async function fetchRecentTransactionsAndCheckPayment(
  orderCode,
  amount,
  phone
) {
  // Gọi API backend thay vì Google Apps Script trực tiếp để tránh CORS
  const API_URL =
    "/api/payment/check?orderCode=" +
    encodeURIComponent(orderCode) +
    "&amount=" +
    encodeURIComponent(amount) +
    "&phone=" +
    encodeURIComponent(phone);
  try {
    const res = await fetch(API_URL);
    if (!res.ok)
      throw new Error("Không thể lấy dữ liệu giao dịch từ API backend");
    const data = await res.json();
    // DEBUG LOG: In ra danh sách giao dịch lấy được từ backend
    console.log(
      "[fetchRecentTransactionsAndCheckPayment] transactions:",
      data.transactions
    );
    // DEBUG LOG: In ra nội dung đối chiếu
    console.log("[fetchRecentTransactionsAndCheckPayment] Đối chiếu với:", {
      orderCode,
      amount,
      phone,
    });
    return checkPaymentSuccess(data.transactions, orderCode, amount, phone);
  } catch (err) {
    console.error("Lỗi khi kiểm tra thanh toán:", err);
    return {
      error: true,
      message:
        "Không thể kết nối đến máy chủ xác thực thanh toán. Vui lòng thử lại sau!",
    };
  }
}


===== FILE: ./frontend/src/utils/cities.js =====
// Danh sách tỉnh/thành phố Việt Nam (có thể mở rộng thêm)
export const CITIES = [
  "Hồ Chí Minh",
  "Hà Nội",
  "Đà Nẵng",
  "Cần Thơ",
  "Hải Phòng",
  "An Giang",
  "Bà Rịa - Vũng Tàu",
  "Bắc Giang",
  "Bắc Kạn",
  "Bạc Liêu",
  "Bắc Ninh",
  "Bến Tre",
  "Bình Định",
  "Bình Dương",
  "Bình Phước",
  "Bình Thuận",
  "Cà Mau",
  "Cao Bằng",
  "Đắk Lắk",
  "Đắk Nông",
  "Điện Biên",
  "Đồng Nai",
  "Đồng Tháp",
  "Gia Lai",
  "Hà Giang",
  "Hà Nam",
  "Hà Tĩnh",
  "Hải Dương",
  "Hậu Giang",
  "Hoà Bình",
  "Hưng Yên",
  "Khánh Hoà",
  "Kiên Giang",
  "Kon Tum",
  "Lai Châu",
  "Lâm Đồng",
  "Lạng Sơn",
  "Lào Cai",
  "Long An",
  "Nam Định",
  "Nghệ An",
  "Ninh Bình",
  "Ninh Thuận",
  "Phú Thọ",
  "Phú Yên",
  "Quảng Bình",
  "Quảng Nam",
  "Quảng Ngãi",
  "Quảng Ninh",
  "Quảng Trị",
  "Sóc Trăng",
  "Sơn La",
  "Tây Ninh",
  "Thái Bình",
  "Thái Nguyên",
  "Thanh Hoá",
  "Thừa Thiên Huế",
  "Tiền Giang",
  "Trà Vinh",
  "Tuyên Quang",
  "Vĩnh Long",
  "Vĩnh Phúc",
  "Yên Bái",
];


===== FILE: ./frontend/src/utils/districts.js =====
// Ví dụ dữ liệu quận/huyện cho một số thành phố lớn
export const DISTRICTS = {
  "Hồ Chí Minh": [
    "Quận 1",
    "Quận 2",
    "Quận 3",
    "Quận 4",
    "Quận 5",
    "Quận 6",
    "Quận 7",
    "Quận 8",
    "Quận 9",
    "Quận 10",
    "Quận 11",
    "Quận 12",
    "Bình Thạnh",
    "Gò Vấp",
    "Phú Nhuận",
    "Tân Bình",
    "Tân Phú",
    "Bình Tân",
    "Thủ Đức",
    "Bình Chánh",
    "Củ Chi",
    "Hóc Môn",
    "Nhà Bè",
    "Cần Giờ",
  ],
  "Hà Nội": [
    "Ba Đình",
    "Hoàn Kiếm",
    "Tây Hồ",
    "Long Biên",
    "Cầu Giấy",
    "Đống Đa",
    "Hai Bà Trưng",
    "Hoàng Mai",
    "Thanh Xuân",
    "Sóc Sơn",
    "Đông Anh",
    "Gia Lâm",
    "Nam Từ Liêm",
    "Thanh Trì",
    "Bắc Từ Liêm",
    "Mê Linh",
    "Hà Đông",
    "Sơn Tây",
    "Ba Vì",
    "Phúc Thọ",
    "Đan Phượng",
    "Hoài Đức",
    "Quốc Oai",
    "Thạch Thất",
    "Chương Mỹ",
    "Thanh Oai",
    "Thường Tín",
    "Phú Xuyên",
    "Ứng Hòa",
    "Mỹ Đức",
  ],
  // ...có thể bổ sung thêm các tỉnh/thành khác
};


===== FILE: ./frontend/src/utils/googleAppsScript.js =====


===== FILE: ./frontend/src/utils/paymentChecker.js =====


===== FILE: ./frontend/src/utils/testPaymentChecker.js =====


===== FILE: ./frontend/src/utils/wards.js =====
// Sử dụng API https://provinces.open-api.vn/api/ để lấy dữ liệu địa giới hành chính động
// Hàm fetch danh sách tỉnh/thành phố
export async function fetchCities() {
  const res = await fetch("https://provinces.open-api.vn/api/p/");
  if (!res.ok) throw new Error("Không thể lấy danh sách tỉnh/thành");
  return await res.json();
}

// Hàm fetch danh sách quận/huyện theo mã tỉnh/thành
export async function fetchDistricts(provinceCode) {
  const res = await fetch(
    `https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`
  );
  if (!res.ok) throw new Error("Không thể lấy danh sách quận/huyện");
  const data = await res.json();
  return data.districts;
}

// Hàm fetch danh sách phường/xã theo mã quận/huyện
export async function fetchWards(districtCode) {
  const res = await fetch(
    `https://provinces.open-api.vn/api/d/${districtCode}?depth=2`
  );
  if (!res.ok) throw new Error("Không thể lấy danh sách phường/xã");
  const data = await res.json();
  return data.wards;
}


===== FILE: ./frontend/vercel.json =====
{
    "version": 2,
    "builds": [
      {
        "src": "package.json",
        "use": "@vercel/static-build",
        "config": {
          "distDir": "dist"
        }
      }
    ],
    "rewrites": [
      {
        "source": "/(.*)",
        "destination": "/"
      }
    ]
  }

===== FILE: ./tree.txt =====
.
├── backend
│   ├── Guide.md
│   ├── IMPORT_INSTRUCTIONS.md
│   ├── clear-products.js
│   ├── config
│   │   ├── db.js
│   │   └── passport.js
│   ├── data
│   │   ├── collections.js
│   │   ├── dataManager.js
│   │   ├── products.js
│   │   └── users.js
│   ├── debug-cart-merge.js
│   ├── env.txt
│   ├── middleware
│   │   ├── authMiddleware.js
│   │   └── errorHandler.js
│   ├── models
│   │   ├── Cart.js
│   │   ├── Checkout.js
│   │   ├── Collection.js
│   │   ├── Order.js
│   │   ├── Product.js
│   │   └── User.js
│   ├── routes
│   │   ├── adminOrderRoutes.js
│   │   ├── adminRoutes.js
│   │   ├── authRoutes.js
│   │   ├── cartRoutes.js
│   │   ├── checkoutRoutes.js
│   │   ├── collectionRoutes.js
│   │   ├── orderRoutes.js
│   │   ├── paymentRoutes.js
│   │   ├── productAdminRoutes.js
│   │   ├── productRoutes.js
│   │   ├── uploadRoutes.js
│   │   └── userRoutes.js
│   ├── seeder.js
│   ├── server.js
│   └── vercel.json
├── frontend
│   ├── PAYMENT_SETUP_GUIDE.md
│   ├── README.md
│   ├── env.txt
│   ├── eslint.config.js
│   ├── src
│   │   ├── App.jsx
│   │   ├── assets
│   │   │   └── dummyData.js
│   │   ├── components
│   │   │   ├── Admin
│   │   │   │   ├── AdminLayout.jsx
│   │   │   │   ├── AdminSidebar.jsx
│   │   │   │   ├── CollectionManagement.jsx
│   │   │   │   ├── EditCollection.jsx
│   │   │   │   ├── EditProductPage.jsx
│   │   │   │   ├── OrderManagement.jsx
│   │   │   │   ├── ProductManagement.jsx
│   │   │   │   └── UserManagement.jsx
│   │   │   ├── Auth
│   │   │   │   ├── AdminRoute.jsx
│   │   │   │   ├── PrivateRoute.jsx
│   │   │   │   └── PublicOnlyRoute.jsx
│   │   │   ├── Cart
│   │   │   │   └── CartContext.jsx
│   │   │   ├── Common
│   │   │   │   ├── Footer.jsx
│   │   │   │   ├── Header.jsx
│   │   │   │   ├── MenuSide.jsx
│   │   │   │   ├── Navbar.jsx
│   │   │   │   ├── Newsletter.jsx
│   │   │   │   ├── PaymentStatus.jsx
│   │   │   │   ├── ScrollToTop.jsx
│   │   │   │   └── SearchBar.jsx
│   │   │   ├── Layout
│   │   │   │   ├── Hero.jsx
│   │   │   │   └── UserLayout.jsx
│   │   │   ├── Products
│   │   │   │   ├── FeaturedCollection.jsx
│   │   │   │   ├── FilterSidebar.jsx
│   │   │   │   ├── ProductDetails.jsx
│   │   │   │   ├── ProductGrid.jsx
│   │   │   │   └── SortOptions.jsx
│   │   │   ├── information
│   │   │   │   ├── About.jsx
│   │   │   │   └── Sponsorship.jsx
│   │   │   └── profile
│   │   │       ├── MyOdersPage.jsx
│   │   │       ├── OrderContext.jsx
│   │   │       ├── OrderDetailPage.jsx
│   │   │       ├── OrderSearch.jsx
│   │   │       ├── ProfileInfo.jsx
│   │   │       └── ProfileLayout.jsx
│   │   ├── hooks
│   │   │   └── usePaymentChecker.js
│   │   ├── main.jsx
│   │   ├── pages
│   │   │   ├── About.jsx
│   │   │   ├── AdminHomePage.jsx
│   │   │   ├── Cart.jsx
│   │   │   ├── Checkout.jsx
│   │   │   ├── CheckoutBuyNow.jsx
│   │   │   ├── Collection.jsx
│   │   │   ├── GenderCollection.jsx
│   │   │   ├── GoogleCallback.jsx
│   │   │   ├── Home.jsx
│   │   │   ├── Information.jsx
│   │   │   ├── Login.jsx
│   │   │   ├── Policy.jsx
│   │   │   └── Signup.jsx
│   │   ├── redux
│   │   │   ├── slices
│   │   │   │   ├── adminOrderSlice.js
│   │   │   │   ├── adminProductSlice.js
│   │   │   │   ├── adminSlice.js
│   │   │   │   ├── authSlice.js
│   │   │   │   ├── cartSlice.js
│   │   │   │   ├── checkoutSlice.js
│   │   │   │   ├── orderSlice.js
│   │   │   │   └── productsSlice.js
│   │   │   └── store.js
│   │   ├── services
│   │   │   └── productService.js
│   │   └── utils
│   │       ├── auth.js
│   │       ├── axiosInterceptor.js
│   │       ├── bankInfo.js
│   │       ├── cities.js
│   │       ├── districts.js
│   │       ├── googleAppsScript.js
│   │       ├── paymentChecker.js
│   │       ├── testPaymentChecker.js
│   │       └── wards.js
│   └── vercel.json
└── tree.txt
25 directories, 111 files

